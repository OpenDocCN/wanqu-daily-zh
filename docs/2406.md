# AWS 网络、环境和你–charity . wtf

> 原文:[http://charity . wtf/2016/03/23/AWS-networking-environments-and-you/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://charity.wtf/2016/03/23/aws-networking-environments-and-you/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

上周，我们迎来了我们的初创企业生命中的一个重要里程碑:一个功能性的生产环境，真实的数据从接收到存储再到服务查询！(当然，一切都很快爆炸了，但无论如何。)

这让我开始思考如何安全地进行和促进地形变化，以隔离某些破坏性变化的爆炸半径。我在推特上发了一些随机的东西，

…发生了两件令人惊讶的有趣的事情。我学到了一些以前不知道的关于 AWS 的新东西(用了几年之后)。有趣的是，我发现我和许多其他人仍然相信 AWS 的事情，而这些事情实际上已经不再是真的了。

这就是我决定写这个的原因。我不会对你过于虔诚，但我想回顾一下当前 AWS 中管理环境、网络分段和安全自动化的一组常见和/或最佳实践，我还想提醒你，这篇文章一发表就会过时，因为事情变化得非常快。

## 多重环境:为什么我应该关心？

存在一个提供资源隔离的环境。您可能出于安全原因、可测试性原因、性能原因，或者仅仅是为了让您的开发人员有个地方可以自由活动而不会造成任何伤害。

也许你运行一堆相似的生产环境，这样你可以给你的客户安全保证或者避免混乱的性能环境。然后你需要一个模板来消除很多这样的环境，你需要*非常*确定它们不能互相泄露。

或者，除了在笔记本上运行的单元测试或功能测试之外，你可能更关心大量你需要关心的事情。例如:容量规划、负载测试、根据生产工作负载验证存储更改、执行故障转移等。任何可怕的变化，你都需要一个类似产品的环境来练习。

一句话:如果你不能构建一个完整的基础设施副本并进行测试，你实际上就没有“基础设施即代码”。你只需要一些代码和胶带。

[https://twitter.com/phinze/status/710227204349624321](https://twitter.com/phinze/status/710227204349624321)

基本原理很简单:

*   非生产环境必须尽可能与生产环境隔离开来。您应该永远不会意外地从登台连接到生产数据库(或者从一个生产环境连接到另一个生产环境)。
*   生产和非生产环境(或所有其他产品环境)应该尽可能共享相同的工具和代码路径。比如，接近 100%的量。任何差距都会不可避免地，最终咬你的屁股。

## 在 AWS 中管理多个环境

目前，人们在 AWS 中使用三种模式来管理多种环境:

1.  一个 AWS 计费账户和一个平面网络(VPC 或经典)，由路由或安全组执行隔离。
2.  许多 AWS 账户采用合并计费。每个环境都是一个独立的账户(通常每个客户对应一个账户)。
3.  一个 AWS 计费帐户和许多 VPC，其中每个环境都有自己的 VPC。

让我们用一个扁平的网络开始旧的学校。

### 1:一个帐户，一个平面网络

在 VPC 之前，基本上每个人都这么做。(嗯，老实说，我们很多人都坚持了一段时间，因为上帝网络是如此痛苦。)

在 EC2 Classic 中，你得到的最好的是安全组。而且，与 VPC 安全组不同，您不能堆叠它们，或者在不破坏它的情况下更改一个实例类型的安全组，并且有一个非常低的硬上限(# of secgroup rules * # of secgroups)。您可以温和地“建议”环境使用诸如 DNS 子域名和配置管理之类的东西，有时您会看到人们只是求助于$ENV 变量。

大多数人要么 a)放弃了，只有一个扁平的网络，要么 b)发生了这种情况。

在 Parse，我们做了一堆复杂的安全组和 chef 环境，让我们能够为特殊的客户需求建立临时集群和偶尔可怕的孤岛式生产堆栈。糟糕透了。

VPC 做得更好。即使您仍在使用平面网络模型。现在，您可以管理路由表、堆栈安全组和 IAM 规则，并将其重新应用到现有节点，而无需破坏节点或断开互联网连接。可以用 NAT 网关等定义私有网络子网。

[https://twitter.com/sudarkoff/status/710264656367996928](https://twitter.com/sudarkoff/status/710264656367996928)

有些人告诉我，他们使用单个 VPC 和网络 ACL 来分隔环境，以便于使用，因为您可以跨环境重用安全组。老实说，对我来说，这更像是一个 bug，而不是一个特性，因为 a)你放弃了隔离，b)我看不出这对你拥有一个版本化的、经过测试的堆栈有什么帮助。

[https://twitter.com/tomtheguvnor/status/710226892633333762](https://twitter.com/tomtheguvnor/status/710226892633333762)

好了，让我们来看光谱的反面，疯狂的孩子们正在做几十个(或几万个)关联账户。

### 2:每个环境一个 AWS 帐户

在糟糕的 EC2 经典时代，数量惊人的人采用了这种模型，不是因为他们需要它，而是因为他们需要更强大的安全模型和更宽松的资源上限。这就是为什么 AWS 早在 2010 年就发布了合并账单。

事实上，我这周学到了很多关于多账户模型的知识！就像你可以创建跨越账户的 IAM 角色，或者你可以在账户间共享 ami。。这种模式很复杂，但也有一些真正的好处。就像真正的、实际的、核心的安全/性能隔离。与将所有东西都塞进一个帐户相比，您将会遇到更少的资源限制，并且撤销/管理 IAM 信用更加清晰。

安全爱好者喜欢这种模式，但不清楚…实际上任何人都知道。

有些事情让我不屑一顾，甚至没有尝试过:

*   AWS 账单已经是世界上最丑的猫咳出的一团可怕的毛球，我甚至无法想象试图争论多个账户。
*   它更贵，你会产生额外的账单费用。
*   必须明确列出你想在任何账户之间分享的任何资源，这让我想在街角尖叫时一根一根地撕扯自己的头发
*   帐户创建 API 仍然有手动步骤，比如获取证书/密钥对。
*   您不能对帐户进行批量更改，AWS 不喜欢您拥有数千个关联帐户。也限制了您使用保留实例的灵活性。

这里有一个非常合理的博客列出了一些好处，正如你所看到的，有很多其他疯狂的人喜欢它。大多是安全呆子。

### 3:一个 AWS 帐户，每个环境一个 VPC

我把最好的留到了最后。我认为这是最好的模式，也是我正在采用的模式。你旋转了一个生产 VPC，一个舞台 VPC，戴夫 VPC，特拉维斯-CI VPC。每个人都有一个 VPC！#@!

每个人似乎都“知道”的一件事但不是真的是，你不能有很多 VPC。是的，默认情况下上限为 5，许多人都有无法筹集资金的故事，过去也是如此。但是**硬帽现在是 200** ，不是 10，所以 VPC 走开，我的宝贝们！

这是喜欢 VPC 环境映射的另一个原因:编排终于开始流行了。即使是最近，人们仍然试图让 chef-metal 成为一个东西，或者用 Boto 从头开始开发他们自己的协调软件，或者只是使用控制台，区分并提交给 git。

哥们儿，*停。*我们已经过了默认使用 Terraform 或 CloudFormation 作为基础架构的基础的阶段，对于那些很少改变的东西。一旦你做到了这一点，你就离可重用、可测试的栈不远了。

由于 VPC 的存在，account-per-env 解决的大部分问题对我来说都不那么有吸引力了。

VPC 在这里帮助你考虑基础设施，比如常规的旧代码。许多虚拟专用计算机大约像一个 VPC 一样容易管理。不像很多账户，它们会给你带来麻烦，一次性的，定制的脚本，点击式的东西和复杂的可怕的东西。

VPC 有一些自己的警告。就像，你只能分配一个/16 给任何一个 VPC 。如果您使用 4 个可用性区域和公共子网 that 的私有子网，则每个子网/AZ 对只有大约 8k IPs。耸肩。

[您可以跨不同的 VPC](https://aws.amazon.com/about-aws/whats-new/2016/03/announcing-support-for-security-group-references-in-a-peered-vpc/)对等安全组，但不能跨地区对等。此外，如果你是一个 terraform 用户，请注意它可以很好地处理 VPC 对等，但不能很好地处理多个帐户。

许多人似乎对每个 VPC 的安全组限制有问题，尽管限制是 500，并表示可以通过请求提高。我是…不知道该怎么想。我感觉，如果你在一个 VPC 上建立一个超过 500 秒的群体规则，你可能做错了。

## 测试我的代码，你这个混蛋，我谅你也不敢

不过，让我从一开始就对此感到兴奋的是，在将干净的更改提交给 master 之前，能够在分支机构的分级 VPC 上测试 terraform 模块。如果你打算在产品中运行尖端软件，咳，你需要所有你能想到的防护栏和测试覆盖率。 **VPCs 以一种巨大的方式帮助你获得这个**。

举个简单的例子，假设您正在向您的临时集群添加一个 NAT 网关，您将使用远程 git 源进行更改:

[code language = " JavaScript "]
//staging
module " AWS _ VPC " {
source = " git::ssh://git @ github . com/houndsh/infra . git//terra form/modules/AWS _ VPC？ref = charity . adding-NAT-GW "
env = $ { var . env }
…
}
[/code]

然后，一旦您验证了更改，您只需将您的分支合并到 master 并运行 terraform 计划/应用于生产。

[code language = " JavaScript "]
//production
module " AWS _ VPC " {
source = " github . com/houndsh/infra/terra form/modules/AWS _ VPC "
env = " $ { var . env } "
……
}
[/code]

看在上帝的份上，对每个 VPC /环境使用不同的状态文件，好吧，但这是不同的咆哮，而不是 AWS 咆哮，所以让我们继续。

## 最后

有正当的理由使用所有这三种模型，以及它们的无限变化，你的用例不是我的用例，诸如此类。

但是从一个 VPC 迁移到多个 VPC 真的不是什么大事。我知道我们很多人都有伤疤，但这比不上试图从 EC2 Classic 转移到 VPC 的恐惧。

[https://twitter.com/mistofvongola/status/710239882912747524](https://twitter.com/mistofvongola/status/710239882912747524)

VPC 的学习曲线比经典课程更陡峭，但是非常值得。每天我都在玩你从 VPC 那里得到的新玩具(ICMP for ELBs！可组合的 IAM 主机角色！新 VPC NAT 网关！！！).他们为 VPC 发行新电影的速度令人震惊，我都快跟不上了。

好吧，我说过我不会信教，但我完全是在撒谎。

**VPC 是未来，它很棒，除非你有一些非常具体和令人信服的理由，否则你应该在每个环境中旋转一个 VPC，并在每次代码提交时从 CI 进行编排和 prob，就像它就像，你知道，代码**。

你需要测试一下。

因为事实如此。

(谢谢所有和我聊天、教我东西并给我很棒的反馈的人！！指关节纹身@mosheroperandi)

### 像这样:

像 装...