# 漏抽象法则——乔尔谈软件

> 原文:[https://www . joelonsoftware . com/2002/11/11/the-law-of-leaky-abstracts/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

互联网工程中有一个关键的魔法，你每天都要依赖它。它发生在 TCP 协议中，TCP 协议是互联网的基础构件之一。

TCP 是一种*可靠*的数据传输方式。我的意思是:如果你使用 TCP 通过网络发送一条消息，它将会到达，并且不会被篡改或损坏。

我们使用 TCP 做很多事情，比如获取网页和发送电子邮件。TCP 的可靠性是为什么每封邮件都完好无损地到达的原因。即使只是一些愚蠢的垃圾邮件。

相比之下，还有一种叫做 IP 的数据传输方法*不可靠*。没有人保证你的数据会到达，它可能在到达之前就被弄糟了。如果你用 IP 发送一堆消息，如果只有一半到达，不要感到惊讶，其中一些消息的顺序与发送的顺序不同，一些消息被替换为替代消息，可能包含可爱的小猩猩的图片，或者更有可能只是许多不可读的垃圾，看起来像你在外语中收到的垃圾邮件。

神奇的是:TCP 是建立在 IP 之上的。换句话说，TCP 被迫使用不可靠的工具以某种方式可靠地发送数据*。*

为了说明为什么这是神奇的，考虑以下道德上等价的，尽管有点可笑的，来自真实世界的场景。

想象一下，我们有办法把演员从百老汇送到好莱坞，包括把他们装在汽车里，开车穿越整个国家。这些汽车中的一些撞毁了，杀死了可怜的演员。有时，演员们在路上喝醉了，剃了光头或在鼻子上纹身，因此变得太丑，无法在好莱坞工作，而且演员们到达的顺序经常与他们出发时不同，因为他们都走不同的路线。现在想象一下一种叫做好莱坞快递的新服务，它把演员送到好莱坞，保证他们(a)按顺序(b)到达(c)处于完美状态。神奇的是，好莱坞快递没有任何运送演员的方法，除了不可靠的方法，把他们放在汽车里，开车穿越全国。好莱坞快递的工作方式是检查每个演员到达时的状态是否完美，如果没有，就打电话给总部，要求把演员的同卵双胞胎送过来。如果演员到达的顺序不对，好莱坞快递会重新安排他们。如果一个大型不明飞行物在前往 51 区的路上坠毁在内华达州的高速公路上，使其无法通行，所有走那条路的演员都要改道经过亚利桑那州，好莱坞快递甚至不告诉加州的电影导演发生了什么。对他们来说，这看起来就像演员比平时来得慢一点，他们甚至从来没有听说过不明飞行物坠毁的消息。

这大概就是 TCP 的神奇之处。这就是计算机科学家喜欢称之为*抽象*的东西:对隐藏在背后的复杂事物的简化。事实证明，很多计算机编程都是由构建抽象概念组成的。什么是字符串库？这是一种假装计算机可以像操纵数字一样容易地操纵字符串的方法。什么是文件系统？这是一种假装硬盘实际上不是一堆可以在特定位置存储位的旋转磁盘的方式，而是一个文件夹中的文件夹的分层系统，包含单个文件，这些文件又由一个或多个字节串组成。

回到 TCP。之前为了简单起见，我撒了一个小谎，现在你们中的一些人耳朵里已经冒出蒸汽了，因为这个小谎让你们发疯了。我说 TCP 保证你的消息会到达。实际上并没有。如果你的宠物蛇咬断了通向你电脑的网络电缆，并且没有 IP 包可以通过，那么 TCP 就无能为力，你的信息也不会到达。如果你对你公司的系统管理员无礼，他们惩罚你，把你插到一个过载的集线器上，只有你的一些 IP 信息包可以通过，TCP 可以工作，但是一切都很慢。

这就是我所说的*漏抽象*。TCP 试图提供底层不可靠网络的完整抽象，但有时，网络会从抽象中泄漏，您会感觉到抽象无法完全保护您的东西。这只是我称之为泄漏抽象法则的一个例子:

| 在某种程度上，所有非平凡的抽象都是有漏洞的。 |

抽象会失败。有时一点点，有时很多。有渗漏。事情出了差错。当你有抽象概念时，这种情况随处可见。这里有一些例子。

*   像迭代一个大型二维数组这样简单的事情，如果你水平地而不是垂直地做，可能会有完全不同的性能，这取决于“木纹”——一个方向可能会比另一个方向导致更多的页面错误，并且页面错误很慢。即使是汇编程序员也应该被允许假装他们有一个很大的平面地址空间，但虚拟内存意味着它实际上只是一个抽象，当出现页面错误时会泄漏，并且某些内存读取比其他内存读取花费更多的纳秒。
*   SQL 语言旨在抽象出查询数据库所需的过程步骤，而是允许您仅定义您想要的内容，并让数据库计算出查询它的过程步骤。但是在某些情况下，某些 SQL 查询比其他逻辑上等价的查询慢几千倍。一个著名的例子是，即使结果集相同，如果指定“where a=b，b=c，a=c ”,一些 SQL servers 的速度会比只指定“where a=b，b=c”快得多。你不应该关心过程，只关心规格。但是有时抽象会泄漏并导致可怕的性能，您必须打开查询计划分析器，研究它做错了什么，并找出如何使您的查询运行得更快。
*   尽管像 NFS 和 SMB 这样的网络库允许你把远程机器上的文件“当作”本地文件来处理，但有时连接会变得非常慢或中断，文件不再像本地文件一样工作，作为程序员，你必须编写代码来处理这个问题。“远程文件与本地文件相同”的抽象[泄露](https://www.joelonsoftware.com/articles/fog0000000041.html)。下面是 Unix 系统管理员的一个具体例子。如果您将用户的主目录放在 NFS 挂载的驱动器上(一个抽象)，并且您的用户创建。转发文件将他们所有的电子邮件转发到其他地方(另一个抽象)，当新邮件到达时，NFS 服务器关闭，消息将不会被转发，因为。找不到转发文件。抽象中的漏洞实际上导致了一些消息被丢弃在地上。
*   C++字符串类应该让你假装字符串是一级数据。他们试图抽象出[字符串很难](https://www.joelonsoftware.com/articles/fog0000000319.html)的事实，让你表现得好像它们和整数一样简单。几乎所有的 C++字符串类都重载了+操作符，所以你可以写**s+“bar”**来连接。但是你知道吗？无论他们如何努力，地球上没有一个 C++字符串类会让你键入**“foo”+“bar”**，因为 C++中的字符串文字永远是 char*的，而不是字符串。抽象出现了一个漏洞，语言不允许你去堵住它。(有趣的是，随着时间的推移，C++的进化历史可以被描述为试图堵塞字符串抽象漏洞的历史。我现在不明白为什么他们不能给语言本身增加一个本地的字符串类。)
*   下雨的时候你不能开得那么快，尽管你的车有挡风玻璃雨刷、前灯、车顶和加热器，所有这些都保护你不去关心下雨的事实(它们抽象了天气)，但是你必须担心打滑(或者在英国是滑水)，有时雨太大了，你看不到前面很远，所以你在雨中开得慢一些，因为天气永远不会被完全抽象掉，这是因为漏抽象定律。

漏抽象法则有问题的一个原因是，它意味着抽象并没有像它们原本打算的那样真正简化我们的生活。当我培训某人成为 C++程序员时，如果我不必教他们 char*和指针算法就好了。如果能直接上 STL 弦就好了。但是有一天他们会编写代码**“foo”+“bar”**，真正奇怪的事情就会发生，然后我就不得不停下来，教他们所有关于 char*的东西。或者有一天，他们会试图调用一个 Windows API 函数，该函数被记录为有一个 OUT LPTSTR 参数，他们将无法理解如何调用它，直到他们了解了 char*、指针、Unicode、wchar_t 和 t char 头文件，以及所有泄漏出来的东西。

在向某人教授 COM 编程时，如果我能教他们如何使用 Visual Studio 向导和所有代码生成功能就好了，但是如果出现任何问题，他们将完全不知道发生了什么，也不知道如何调试和恢复。我将不得不教他们所有关于我所知的和 CLSIDs 和 ProgIDS 和…哦，人类！

在教别人 ASP.NET 编程时，如果我能教他们可以双击事物，然后编写当用户点击这些事物时在服务器上运行的代码，那就太好了。事实上，ASP.NET 抽象出了编写处理点击超链接(**<>**)的 HTML 代码和处理点击按钮的代码之间的区别。问题:ASP.NET 的设计者需要隐藏一个事实，即在 HTML 中，没有办法通过超链接提交表单。他们通过生成几行 JavaScript 并在超链接上附加一个 onclick 处理程序来实现这一点。然而，抽象泄露了。如果最终用户禁用了 JavaScript，ASP.NET 应用程序就不能正常工作，如果程序员不理解 ASP.NET 抽象出了什么，他们根本就不知道哪里出了问题。

漏抽象法则意味着，每当有人想出一个神奇的新代码生成工具，应该让我们所有人都变得非常高效，你会听到很多人说“先学习如何手动完成，然后使用神奇的工具来节省时间。”假装抽象出某些东西的代码生成工具，像所有的抽象一样，会泄漏，而处理泄漏的唯一方法是了解抽象是如何工作的，以及它们抽象的是什么。所以抽象节省了我们工作的时间，但是没有节省我们学习的时间。

这一切意味着矛盾的是，即使我们拥有越来越高水平的编程工具和越来越好的抽象，成为一名熟练的程序员也越来越难。

在我第一次微软实习期间，我编写了在 Macintosh 上运行的字符串库。一个典型的赋值:编写一个版本的 **strcat** ，返回一个指向新字符串末尾的指针。几行 C 代码。我所做的一切都来自 K&R——一本关于 C 编程语言的薄薄的书。

今天，要在 CityDesk 上工作，我需要了解 Visual Basic、COM、ATL、C++、InnoSetup、Internet Explorer 内部、正则表达式、DOM、HTML、CSS 和 XML。所有高水平的工具相比，老 K&R 的东西，但我仍然必须知道 K&R 的东西，否则我就完蛋了。

十年前，我们可能认为新的编程范例会让编程变得更加容易。事实上，我们多年来创造的抽象概念*确实*允许我们处理软件开发中新的复杂顺序，这是我们在十年或十五年前不必处理的，比如 GUI 编程和网络编程。虽然这些伟大的工具，比如现代的基于面向对象表单的语言，让我们以令人难以置信的速度完成了很多工作，但突然有一天我们需要找出抽象泄漏的问题，这需要 2 周的时间。而当你需要雇佣一个程序员来做大部分 VB 编程的时候，雇佣一个 VB 程序员是不够好的，因为每次 VB 抽象泄露的时候他们都会完全卡在 tar 里。

漏抽象法则正在拖垮我们。