# 免费的坏处。或者:我是如何失去对我的副业的热爱的(第一部分)

> 原文:[https://remysharp.com/2015/09/14/jsbin-toxic-part-1?UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://remysharp.com/2015/09/14/jsbin-toxic-part-1?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

这是一个关于 JS 斌的故事。之前讲过一个 JS Bin 的故事，这个是 b 面:黑暗面。但是请记住我与你分享的一切，JS Bin 是运行时间最长的实时 pastebin，它不会去任何地方。它将继续运行并为其用户服务。即使是人渣。

这个故事被分成 5 个部分，在几天内发布。

## 背景故事

我大部分时间都在布莱顿的卧室里工作(因为我们的公寓很小)，同时还在伦敦和其他设计师和开发商一起全职工作。jQuery 还是新的，我经常被用书面英语问为什么一些代码不能工作(解释经常缺少实际的代码！).

我知道我需要一些包含代码的东西，将问题削减到最小的形式，所以我可以调查。

![2009 office](../Images/b65b3151115656dda6441b8d1eb63c31.png)

JS Bin 于 2008 年 9 月[日](https://remysharp.com/2008/10/06/js-bin-for-collaborative-javascript-debugging)发布，作为我需要看到带有交互组件的 pastebin 的解决方案。

它被发布在 Ajaxian 上，受到了好评。我还通过回答堆栈溢出问题和链接到 JS Bin 中的实时演示开始播种它。时至今日，这种方法取得了巨大的成功——尤其是 Stack Overflow 继续创建他们自己的实时 pastebin 支持(尽管在我看来，这看起来像是 jsfiddle 的一个糟糕的实现)。

从第一天起，这个概念就很简单:你可以匿名创建一个网页，让任何人查看和编辑(创建一个新的“快照”)。

最初大约花了 4 个小时，用了 2 个 PHP 文件([sandbox.php](https://github.com/jsbin/jsbin/blob/e895c32089ac1bd310b5d91aecabda219f2eccea/sandbox.php)和[index.php](https://github.com/jsbin/jsbin/blob/e895c32089ac1bd310b5d91aecabda219f2eccea/index.php))和一个非常简单的 MySQL 数据库。随着时间的推移，它会变得更加复杂，有更多更多的功能——大部分藏在一个非常圆滑的设计后面(由[丹尼·霍普](https://twitter.com/yandle))。

这些年来，JS Bin 一直在成长。我经历了几次大的重写，现在决定在基于 AWS 的架构上使用 Node 作为它的后端(虽然仍然是 MySQL)。

不知何故，JS Bin 是第一个遭受真正虐待的人，但我知道 jsfiddle 近年来受到了相当严重的攻击。我不确定 CodePen 是否真的有太多的滥用*和*(可能因为它是这个街区的新手)。

* * *

这是一个故事，不是一个快乐的故事，是关于一些考验和磨难的故事，这些考验和磨难让我小小的开源项目尝到了有毒的味道。

请记住，在这些故事中，我是唯一的系统管理员，我的知识虽然可行，但也是有限的——正如我口袋里的硬币一样，所以没有负载平衡器和重型哨兵机器来保护我的系统免受疯狂。这是*只是*我。

* * *

## 第 1 部分:DDoS 的开始

我不记得在这个时间点之前我是否在 JS Bin 上看到过任何滥用，但是在 2012 年 4 月下旬，我收到了一封请求我注意的电子邮件:

![First DDoS](../Images/7306574a4a4133829f10d780b307dbd7.png)

当时我正在旅行并主持研讨会，删除垃圾箱是一项手动工作，但我尽可能快地调查并移除了垃圾箱(今天它解析为 404)。

bin 是一个 *script kiddie 的*乐园:输入你的目标的 URL，它会反复创建对目标的图像请求。事实上，这种页面可能是多年来相当多事件的源头。

困扰我，并且至今仍困扰我的是:*他们为什么把这个放在 JS Bin 上？他们必须共享一个链接，为什么不共享一个 HTML 文件呢？*

这意味着 JS Bin 不会被夹在中间。\ *(ツ)* /

### 另类 DDoS:低能的自我攻击

谢天谢地，自我攻击发生在 JS Bin 转移到 Node 之后*，否则我不知道它能不能活下来。*

但事实上，JS Bin 在这些攻击中并不总是保持冷静。*自我攻击？是的。这是当脚本 kiddie 页面请求 URL 时，但该页面不会对 URL 进行任何验证，而且，由于想要策划攻击只需要很少的脑细胞，一些白痴在他们的攻击中省略了前面的“http://”部分。*

结果呢？他们开始附上像 https://jsbin.com/abcef/some-site-the-user-hates.com 这样的网址——这实际上是通过 JS Bin 的子系统。

有时，不总是，但有时它会导致这种情况，这就是它变得非常可怕的时候...

![JS Bin 502](../Images/120a16434865ac43f9d1b1f675d2a416.png)

### “总是在他们睡觉的时候下手……”

![Twitter reports](../Images/8f637252c509783e67ffe9a4591edd3e.png)

好吧，所以这可能不是什么秘密咒语，屁股帽总是在系统管理员睡觉时攻击，实际上可能是因为我在英国，大多数攻击发生在中美洲中午时间...所以，是的，我在睡觉，醒来时(大约早上 6 点)twitter 报告说 JS Bin 不可达。

当大多数对你倾注了心血的产品的@回复是:狗屎砸到粉丝了，这真让人沮丧！

### 当狗屎源源不断的时候

事实上，我有一个针对这种情况的操作手册。当 JS Bin 遭到猛烈攻击时，不管攻击看起来像什么。大多数情况下，解决方案是重启 JS Bin。但是，它也可能来自几个特定的 IP 地址。

当 JS Bin 机器上的 CPU 高速运行时(持续数秒)，我也会收到 AWS CloudWatch 警报。不断撞击节点进程的流量(是的...单个进程)导致进程一直处于“忙碌”状态，即高 CPU 速率，所以我得到了*个*警报。

所以 runbook 会扫描最近的 200 行左右的访问日志，并给出唯一的 IP 和它们的命中数。从那里，将着手`iptable`地址(即阻止 IP 地址)。

一天晚上，情况变得如此糟糕，以至于我不得不在 cronjob 中编写一个脚本，反复扫描日志，查找任何命中 JS Bin 超过某个任意数字的 IP，然后禁止它们。

它确实解决了这个问题。它还随机屏蔽了很多很多渴望通过 Twitter 和 GitHub 问题让我知道的普通用户(这是一件好事，我不是在抱怨——他们陷入交叉火力对他们来说太糟糕了)。

### 失败 2 班

最终，我开始使用 [fail2ban](http://www.fail2ban.org/wiki/index.php/Main_Page) 来保护我的机器免受来自特定 IP 地址的重复攻击。自 2014 年末安装以来，这种攻击已经大幅减少。

不幸的副作用是，它还阻止了 JS Bin 的课堂使用，因为 JS Bin 一直发送 XHR 写的*，fail2ban 看到这一切都来自单个 IP，并继续拒绝渴望学习的年轻班级。*

 *在这种情况下，类通过任何可能的渠道取得联系，我已经手动列出了它们的 IP 地址。我知道这让一些人措手不及，但不幸的是，这是我不得不付出的代价。

### 空

我添加到 JS Bin 中的另一个技巧是，输出被渲染到的 iframe 被强制解析为[http://null.jsbin.com](http://null.jsbin.com)，这又返回一个 [204](http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.5) (这是通过在预览中注入一个`base`标签来完成的)。

这个小小的改变也减少了大量的请求，特别是当用户将占位符图像放入垃圾箱时，垃圾箱会在每次按键时自动重新呈现。预览可能会加载 10 个空白图像，但“空白”实际上意味着它没有来源，这意味着它命中了 JS Bin。

现在，输出简单地解析为[null.jsbin.com](http://null.jsbin.com)，使用 nginx 进行响应，并且从不接触 JS Bin。

* * *

回来看第二部分:对付各种形式的垃圾邮件的试验！*