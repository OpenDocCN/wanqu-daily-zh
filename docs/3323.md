# 谷歌如何备份互联网以及其他数十亿字节的数据-高可扩展性-

> 原文:[http://high scalability . com/blog/2014/2/3/how-Google-backs-up-the-internet-along-exabytes-of-othe . html？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://highscalability.com/blog/2014/2/3/how-google-backs-up-the-internet-along-with-exabytes-of-othe.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

![](../Images/e618cf11a7e558cbccc35dc3c895b625.png)

雷蒙德·布鲁姆 领导着一个网站可靠性工程师团队，负责保护谷歌数据的秘密和安全。当然谷歌永远不会说这实际上是多少数据，但从评论来看，它似乎还不是一个[yottabyte](http://en.wikipedia.org/wiki/Yottabyte)，而是许多[EB](http://en.wikipedia.org/wiki/Exabyte)大小。仅 GMail 就接近低数据量。

布鲁姆先生在视频 [中讲述了谷歌如何备份互联网](http://www.youtube.com/watch?v=eNliOm9NtCM) ，他解释了常见的备份策略对谷歌不起作用的原因，这听起来很有道理:通常它们 **以容量** 来衡量工作。如果备份两倍的数据需要两倍的材料，其中材料是时间、能量、空间等。，没用，没规模。您必须提高效率，使容量扩展速度快于支持该容量所需的努力。从备份 1 EB 到备份 2 EB 需要不同的计划。这次演讲主要是关于谷歌如何实现这一点。

本次演讲的一些主题:

*   **没有数据丢失，曾经** 。即使是臭名昭著的 GMail 宕机也没有丢失数据，但情况比大量磁带备份更复杂。数据是从整个堆栈中检索的，这需要每个级别的工程设计，包括人。

*   **备份无用**。你关心的是恢复。这是一个恢复系统，不是备份系统。备份是您为奢侈的恢复支付的税款。将工作转移到备份，并根据需要使备份变得复杂，从而使恢复变得简单，即使是猫也能做到。

*   **不能线性缩放**。100 倍的数据需要 100 倍的人力或机器资源。寻找力量倍增器。自动化是提高利用率和效率的主要方式。

*   **凡事冗余**。谷歌的东西总是失败。简直是垃圾。就像我们体内的细胞死亡一样。谷歌并不梦想事物不会消亡。它为此做了计划。

*   **。如果您担心站点的局部性，请将数据放在多个站点中。如果你担心用户的错误，那么就要对用户交互进行隔离。如果你想防止软件错误，把它放在不同的软件上。将内容存储在不同的供应商设备上，以减少大型供应商 bug 的影响。**

***   **把人类带出循环** 。GMail 保留了多少份电子邮件副本？这不是人类应该关心的事情。有些参数是由 GMail 配置的，系统会负责处理。这是一个不变的主题。高层次的政策被设定，系统使它如此。只有在异常情况发生时才会打扰人类。

    *   **证明它** 。如果你不去尝试，它就不起作用。备份和恢复会不断接受测试，以验证它们是否正常工作。** 

 **对于任何组织来说，无论大小，都有很多东西需要学习。布鲁姆先生的 [谈话](http://www.youtube.com/watch?v=eNliOm9NtCM) 具有娱乐性、知识性，非常值得观看。他似乎真的很喜欢工作中的挑战。

下面是我对这个非常有趣的演讲的评论，在这个演讲中，我们从野兽体内了解到许多秘密:

*   **数据可用性必须达到 100% 。** **没有数据丢失过**。

    *   从统计数据来看，如果你从一个 2GB 的文件中损失了 20 万英镑，这听起来不错，但这个文件现在可能毫无用处，想想可执行文件或纳税申报表吧。

    *   数据的可用性比访问的可用性更重要。如果一个系统崩溃了，这并不是世界末日。如果数据丢失，它就是。

    *   谷歌保证您在所有可能的组合中都能获得以下保障:

        *   位置隔离

        *   与应用层问题隔离

        *   隔离存储层问题

        *   与媒体故障隔离

    *   **考虑尺寸你可以在** 上左右移动滑块。垂直放置软件，水平放置位置。如果你想覆盖所有的内容，你需要在不同的地方有一个软件层的拷贝。您可以对不同位置的虚拟机执行此操作。

*   **冗余不等同于可恢复性** 。

    *   制作许多副本无助于实现无损失保证。

    *   对于某些种类的停机，多份拷贝是有效的。如果一颗小行星撞上了数据中心，而你在远处有一份拷贝，你就被覆盖了。

    *   如果你的存储栈中有一个 bug，拷贝到 N 个地方并没有帮助，因为这个 bug 会破坏所有的拷贝。以 GMail 宕机为例。

    *   代码中的错误、用户错误或损坏的缓冲区的写入，都不会像小行星那么多。

    *   冗余有利于引用的局部性。当您希望所有数据引用尽可能靠近数据被使用的位置时，复制是一个好方法。

*   整个系统非常坚固，因为它非常强大。

    *   **Google stuff 一直失败**。简直是垃圾。就像我们体内的细胞死亡一样。我们不梦想事物不会消亡。我们为此做了计划。机器无时无刻不在死亡。

    *   **冗余就是答案** 。总的来说，结果比单个高质量的机器更可靠。一颗小行星就能摧毁一台机器。放在 50 个不同位置的机器更难摧毁。

*   **大规模并行系统损失的机会更多** 。

*   **本地副本不防站点宕机。**

     ***   如果您的服务器机房被洪水淹没，RAID 也无济于事。

    *   直到大约一年前，谷歌文件系统(GFS)还在整个谷歌使用，它将 RAID 的概念提升了一个档次。使用 [编码技术](http://en.wikipedia.org/wiki/Erasure_code) 一次性写入不同城市的多个数据中心，这样你只需要 N-1 个碎片就可以重构数据。因此，如果有三个数据中心，即使一个数据中心停止运行，数据仍然可用。** 
***   **可用性和完整性是一个组织广泛的特性** 。

    *   Google 工程师、BigTable、GFS、Colossus 都知道数据的持久性和完整性是首要任务。有很多系统可以检查和纠正数据可用性和完整性方面的任何失误。

        *   **凡事都要多样性。**

     ***   如果你担心站点的局部性，把数据放在多个站点。

    *   如果你担心用户的错误，那么就对用户交互进行隔离。

    *   如果你想防止软件漏洞，把它放在不同的软件上。将内容存储在不同的供应商设备上，以减少大型供应商 bug 的影响。** ***   **用磁带备份东西真的很管用。**

     ***   **磁带伟大是因为它不是磁盘** 。如果可以的话，他们会使用穿孔卡片。

    *   想象一下，如果你在 SATA 磁盘的设备驱动程序中有一个 bug。磁带可以让你远离这些。它增加了你的多样性，因为不同的媒体意味着不同的软件。

    *   磁带容量遵循摩尔定律，因此他们对磁带作为备份介质相当满意，尽管他们正在研究替代方案，但不愿透露是什么。

    *   磁带是加密的，这意味着邪恶势力很难从中获得任何有用的信息。** ***   **备份无用。这是恢复你关心的** 。

    *   在有人需要数据之前发现是否有问题。当您需要恢复时，您真的需要它。

    *   **运行连续恢复** 。不断随机选择 5%的备份并恢复它们以进行比较。为什么？在数据丢失之前查明备份是否有效。发现了很多问题。

    *   **运行自动比较** 。无法与原件进行比较，因为原件已经更改。所以检查所有的东西并比较检查和。将它放回源介质、磁盘或闪存，或者它来自的任何地方。确保数据可以往返。这是一直在做的。

        *   **提高警惕。**

     ***   **如果有什么不同，你可能想知道** 。如果一切正常，不要告诉我。

    *   预计会出现一些失败，但不要对第一次尝试就无法恢复的文件发出警报。

    *   假设第一次尝试的失败率通常是 n。第二次尝试的失败率是 y。如果失败率有变化，那么一定是出了问题。** ***   **。**

     ***   磁盘总是会坏掉，但是你知道它什么时候发生，因为你在监控它。

    *   有了胶带，你不知道它坏了，直到你试着去用它。磁带可以使用很长时间，但是您需要在使用之前测试磁带。** ***   **[raid 4](http://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_4)T5】磁带上** 。

    *   不要只写一盘磁带。它们是子弹。机器人可能会掉落它们，或者会产生一些磁通量。不要冒险。

    *   写入磁带时 **告诉写入者保留数据** 直到我们同意更改。如果你这样做，你就违反了合同。

    *   建立 4 个完整的磁带，然后通过异或运算生成第 5 个代码磁带。您可以丢失 5 盘磁带中的任何一盘并恢复数据。

    *   现在告诉作者他们可以更改源数据，因为数据已经到达最终物理位置，现在是冗余的。

    *   谷歌备份的每一点数据都要经过这个过程。

    *   每月有数百盘磁带丢失，但不要因为这个过程而每月有数百例数据丢失。

    *   如果一盘磁带丢失，可使用连续恢复检测到，并使用同级磁带重建另一盘磁带，一切正常。在两个磁带损坏的罕见情况下，只有当磁带上相同的两个点损坏时，您才会丢失数据，因此重建是在子磁带级别完成的。

    *   不要因为这些技术而丢失数据。很贵，但这是做生意的成本。

        *   **备份是您为奢侈的恢复支付的税款**。

    *   **这是恢复系统不是备份系统** 。恢复是一种不可屏蔽的中断。他们胜过一切。恢复备份。

    *   使备份变得尽可能复杂，并且需要多长时间就进行多长时间。尽可能快速、自动地进行恢复。

    *   恢复应该是愚蠢、快速和简单的。希望一只猫能够触发中央恢复。

    *   当你休息好或者累得不行的时候，恢复可能会发生。因此，您不希望人为因素决定恢复服务数据副本的成功与否。你压力很大。所以，当你有时间的时候，也就是做备份的时候，做所有的工作和思考。

    *   很大一部分系统都是这样工作的。

    *   数据源可能必须能够将数据存储一段时间，也许是几天，然后才能保证它已被备份。但是一旦备份，就可以恢复，恢复的很快。

    *   不再最有效地利用备份介质来加快恢复速度。花两个小时读一盘磁带是不好的。只写半盘磁带，并行读取，这样你可以在一半的时间内取回数据。

        *   **规模成问题** 。

    *   当你拥有数十亿字节的数据时，现实世界会有很多限制。如果您必须拷贝 10eb，那么备份每天的数据可能需要 10 周时间。

    *   对于遍布全球的数据中心，你有几个选择。您是否为每个站点提供了近乎无限的备份容量？您是否按区域对所有备份进行群集？传输数据的带宽怎么样？难道不需要带宽来服务赚钱流量吗？

    *   看相关成本。有妥协。并非每个站点都有备用设施。必须平衡网络上的可用容量。你在哪里能得到最大的回报。例如，备份必须在站点 X 进行，因为它有带宽。

        *   **不能线性缩放**。

    *   不能只说想要更多的网络带宽和更多的磁带机。驱动器损坏，因此如果您有 10，000 个驱动器，您将需要 10，000 倍的操作员来更换它们。您是否有 10，000 倍的装载台来装载磁带驱动器，直到卡车来装载它们。这些都不是线性的。

    *   尽管磁带库的数量增加了一个数量级，但涉及的人数却没有原来的 10 倍多。数字有所增加，但远非直线增长。

    *   一个早期的预测是，随着电话数量的增长，30%的美国人将成为电话接线员。他们没有预见到的是自动切换。

        *   **自动化一切。**

     ***   调度是自动化的。如果您有一项服务，您会说我有一个数据存储区，我需要每 N 个拷贝一次，恢复必须以 m 为单位进行。内部系统会让这种情况发生。安排备份，运行恢复测试，运行完整性测试，等等。当检测到损坏的磁带时，它会被自动处理。

    *   作为人类，你看不到这些。有一天，你可能会问平均有多少盘磁带坏掉了。或者，如果磁带破损率从每天 100 盘磁带变为每天 300 盘磁带，可能会发出警报。但在那之前，不要告诉我一天 100 盘磁带坏掉是否正常。** ***   **人类不应参与稳态作战** 。

    *   包装和运输硬盘仍然是一项人工活动。自动化界面准备运输标签，获取 RMA 编号，检查包裹是否已经发出，获得收据确认，如果出现故障，必须有人干预。

    *   **库软件维护同样** 。如果有固件更新，人类不会跑到每个系统并执行升级。下载吧。让它去金丝雀图书馆吧。让它经受考验。让结果被验证为准确。那就让它被推出去。人类不参与正常的操作。

        *   **自动处理机器死亡。**

     ***   机器每分钟死亡两次。如果一台机器在一个使用 30，000 台机器的 MapReduce 作业中死亡，不要告诉我，只是处理它并继续前进。找到另一台机器，移动工件，重新启动。

    *   **如果存在依赖关系，则安排等待**。如果你等得太久，请告诉我。你自己安排时间。这是算法的工作，不是人的工作。** ***   **保持效率随增长而提高** 。

    *   **2011 年 GMail 大宕机与恢复** 。谷歌如何丢弃数据并取回数据的故事。

    *   在一个周日的上午 10:31，他收到一个页面，上面写着“霍利废话呼叫 xxx-xxxx”。更上此处停电[](http://gmailblog.blogspot.com/2011/02/gmail-back-soon-for-everyone.html)。

    *   Gmail 正在接近低 EB 数据。那有很多磁带。

    *   100%恢复。可用性不是 100%。在第一天或第二天并不都在那里。但是在一个时期结束时，一切都在那里。

    *   在复制发生的那一层发生了一系列的错误和事故。是的，我们有三个相同的文件，但是它们都是空的。即使是单元测试、系统测试和集成测试，错误也能通过。

    *   从磁带上恢复。巨大的工作。这就是恢复时间相对于比例的地方。取回一千兆字节可以在几毫秒到几秒内完成。取回 200，000 个收件箱需要一段时间。

    *   叫醒几个欧洲同事，因为他们更新鲜。分散劳动力的优势。

    *   数据从许多磁带中恢复并得到验证。这不需要几周或几个月，只需要几天。他们对此很满意。处于类似情况的其他公司花了一个月的时间才意识到他们无法取回数据。已经采取措施确保下一次过程会更快。

    *   读取一个磁带机需要 2 个小时。这些带子到处都是。否则，没有一个位置有足够的能力读取恢复过程中涉及的所有磁带。

    *   有了压缩和校验和，他们实际上不需要读取 20 万盘磁带。

    *   从那时起，修复过程已经有了很大改进。

        *   **优先恢复** 。

    *   **备份系统被视为一个庞大的全球有机体** 。

    *   例如，不希望 GMail 备份仅在纽约进行，因为如果该数据中心扩大或缩小，备份将需要相应地扩展。

    *   将备份视为一个巨大的世界跨越系统。当备份发生时，它可能完全在其他地方。

    *   磁带上的恢复必须在磁带所在的位置进行。但在制作磁带之前，数据可能在纽约，备份在俄勒冈州，因为那里有容量。位置隔离是自动处理的，不会告诉任何客户端他们的数据备份在哪里。

    *   容量可以四处移动。只要有全球容量并且网络能够支持，磁带放在哪里并不重要。

        *   **你拥有的数据越多，保存它就越重要** 。

    *   一般来说，越大的东西越重要。谷歌以前只是搜索。现在是 Gmail，保存在驱动器、文档等中的东西。它现在变得更大也更重要。

        *   **基础设施良好** 。

    *   **扩展非常重要，软件、基础设施、硬件、流程等任何方面都不能不扩展**。

    *   **证明它** 。

    *   不要认为任何事情都是理所当然的。希望不是策略。

    *   如果你不去尝试，它是不会起作用的。必须进行恢复才能验证备份。直到你走到最后，你还没有证明任何事情。这种态度发现了很多失败。

        *   **DRT。灾难恢复测试** 。

    *   每隔 N 个月就会上演一场灾难。模拟组织各个层面的反应。

    *   如果灾难没有带走任何东西，公司将如何生存？必须学会适应。

    *   发现基础设施和物理安全存在巨大漏洞。

    *   想象一个数据中心有一条通往它的道路，路上有满载备用发电机燃料的卡车。路丢了会怎么样？最好有另一条道路和另一个柴油供应商。

    *   一定要有供应链冗余战略。

        *   **不同时间点不同位置不同软件栈中的冗余。**

     ***   **不要让刚刚的数据通过栈迁移** 。将数据保存在堆栈的不同层中一段特定的停留时间。所以如果你丢失了这个和这个，你就有重叠的数据。时间、地点和软件。

    *   考虑一下 GMail 宕机的例子。如果复制被破坏，数据如何不会丢失？这是一个来自观众的问题，他不想给出细节。数据不断被备份。假设我们有截至晚上 9 点的数据。假设腐败从晚上 8 点开始，但还没有被录到磁带上。腐败被制止了。软件被回滚到工作版本。在堆栈的某个点上，所有的数据都还在。带子上有东西。有些东西正在被复制。前端有东西。日志里有东西。所有这些来源都有重叠，因此有可能重建所有数据。对于这些情况，策略是在将数据放入另一个堆栈 N 小时后，才从一个堆栈中取出数据。** ***   **删除问题** 。

    *   我想删除这个。不会为了删除数据而重写磁带。只是规模太大了。

    *   一种方法是用加密密钥做一些聪明的事情。他没有告诉我们谷歌是做什么的。也许密钥丢失了，这实际上删除了数据？

        *   **当你信任你的同事并分担责任时，一个庞大的组织才能运转。**

    ***   **白名单和黑名单**。

    *   确保数据在有保证的位置，并保证不在某个位置，这与位置多样性和位置独立性的其他理念背道而驰。

    *   原本不是栈的一个特性。不得不添加以支持政府要求。

    *   在堆栈中尽可能低的责任。填写正确的个人资料，它会神奇地发生。****************** 

 ****## 相关文章******