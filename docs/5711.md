# 超越互动:网飞笔记本创新|网飞科技博客|网飞科技博客

> 原文：<https://medium.com/netflix-techblog/notebook-innovation-591ee3221233?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

# 超越互动:网飞的笔记本创新

由[米歇尔·乌福德](http://linkedin.com/in/mufford)、[米帕瑟](https://twitter.com/mdpacer)、[马修·西尔](https://www.linkedin.com/in/matthew-seal-70a07932/)和[凯尔·凯利](https://twitter.com/rgbkrk)

笔记本电脑在数据科学家中迅速普及，成为快速原型开发和探索性分析的事实标准。在网飞，我们将界限推得更远，重新想象笔记本可以是什么，谁可以使用它，以及他们可以用它做什么。我们正在进行大量投资，以帮助实现这一愿景。

在本帖中，我们将分享我们的动机，以及为什么我们觉得 Jupyter 笔记本如此吸引人。我们还将介绍我们笔记本电脑基础设施的组件，并探索我们在网飞使用笔记本电脑的一些新方式。

如果时间不够，我们建议跳到用例部分。

# 动机

数据驱动网飞。它渗透在我们的思想中，通知我们的[决定](https://medium.com/netflix-techblog/its-all-a-bout-testing-the-netflix-experimentation-platform-4e1ca458c15)，挑战我们的[假设](https://medium.com/netflix-techblog/selecting-the-best-artwork-for-videos-through-a-b-testing-f6155c4595f6)。它推动了[的实验](https://medium.com/netflix-techblog/a-b-testing-and-beyond-improving-the-netflix-streaming-experience-with-experimentation-and-data-5b0ae9295bdf)和[的创新](https://medium.com/netflix-techblog/growth-engineering-at-netflix-accelerating-innovation-90eb8e70ce59)达到前所未有的规模。数据帮助我们发现[精彩的内容](https://medium.com/netflix-techblog/studio-production-data-science-646ee2cc21a1)并为全球 1.3 亿会员提供[个性化体验](https://medium.com/netflix-techblog/artwork-personalization-c589f074ad76)。

使这成为可能是一个不小的壮举；它需要大量的工程和基础设施支持。每天有超过 1 万亿个事件被写入流接收管道，这些事件被处理并写入 100PB 的云原生数据仓库。每天，我们的用户针对这些数据运行超过 150，000 个作业，涵盖从报告和分析到机器学习和推荐算法的所有内容。为了支持如此大规模的用例，我们构建了一个灵活、强大且复杂(必然)的行业领先的数据平台。我们还建立了一个丰富的互补工具和服务的生态系统，如联合作业执行服务 [Genie](https://medium.com/netflix-techblog/evolving-the-netflix-data-platform-with-genie-3-598021604dda) 和联合 metastore[Metacat](https://medium.com/netflix-techblog/metacat-making-big-data-discoverable-and-meaningful-at-netflix-56fb36a53520)。这些工具简化了复杂性，使支持整个公司更广泛的用户成为可能。



用户多样性令人兴奋，但这是有代价的:网飞数据平台及其工具和服务生态系统必须扩展以支持更多的用例、语言、访问模式等。为了更好地理解这个问题，考虑 3 个常见的角色:分析工程师、数据工程师和数据科学家。



Example of how tooling & language preferences may vary across roles



通常，每个角色依赖于不同的工具和语言。例如，数据工程师可能会使用 IntelliJ 中的 Scala 创建一个包含数万亿个流事件的数据集的新聚合。一名分析工程师可能会在一份关于全球流媒体质量的新报告中使用该聚合数据——使用 SQL 和 Tableau。该报告可能会引导数据科学家使用 R 和 RStudio 构建一个新的流压缩模型。从表面上看，这些工作流看起来是完全不同的，尽管是互补的。但是如果我们深入研究，我们会发现每个工作流都有多个重叠的任务:

**数据探索—** 发生在项目的早期；可能包括查看样本数据、运行统计分析和探索性分析查询以及可视化数据

**数据准备** —迭代任务；可能包括清理、标准化、转换、反标准化和汇总数据；通常是项目中最耗时的任务

**数据验证** —周期性任务；可能包括查看样本数据、运行统计分析和聚集分析的查询以及可视化数据；通常出现在数据探索、数据准备、开发、部署前和部署后阶段

**生产化** —发生在项目的后期；可能包括将代码部署到生产环境、回填数据集、培训模型、验证数据和安排工作流

为了帮助我们的用户扩展，我们希望尽可能轻松地完成这些任务。为了帮助我们的平台扩展，我们希望最大限度地减少需要支持的工具数量。但是怎么做呢？没有一种工具可以完成所有这些任务；更重要的是，一项任务往往需要多种工具。然而，当我们添加另一个抽象层时，一个跨工具和语言的通用模式出现了:运行代码、探索数据、呈现结果。

碰巧的是，一个开源项目正是为了做这件事而设计的: [Project Jupyter](http://jupyter.org/) 。

# jupyter 笔记本



Jupyter notebook rendered in nteract desktop featuring [Vega](https://vega.github.io/) and [Altair](https://altair-viz.github.io/)



Jupyter 项目始于 2014 年，目标是为科学研究、可重复工作流、计算叙事和数据分析创建一套一致的开源工具。这些工具很好地应用于工业，今天 Jupyter 笔记本已经成为数据科学家工具包的重要组成部分。为了让你感受一下它的影响，Jupyter 被授予了 [2017 年 ACM 软件系统奖](https://blog.jupyter.org/jupyter-receives-the-acm-software-system-award-d433b0dfe3a2) —这是一项与 Java、Unix 和 Web 共享的声望很高的荣誉。

要理解 Jupyter 笔记本电脑为何如此吸引我们，请考虑它提供的核心功能:

*   一种用于自省和执行语言不可知的代码的消息协议
*   一种可编辑的文件格式，用于描述和捕获代码、代码输出和标记注释
*   基于 web 的 UI，用于交互式编写和运行代码以及可视化输出

Jupyter 协议提供了一个标准的消息传递 API 来与充当计算引擎的内核进行通信。该协议支持一个可组合的架构，该架构将内容写入的位置(UI)和代码执行的位置(内核)分开。通过将运行时与界面隔离，笔记本可以跨越多种语言，同时保持配置执行环境的灵活性。如果一种语言的内核知道如何使用 Jupyter 协议进行通信，笔记本可以通过与内核来回发送消息来运行代码。

支持这一切的是一种同时存储代码和结果的文件格式。这意味着以后无需重新运行代码就可以访问结果。此外，笔记本存储了丰富的散文，为笔记本中发生的事情提供了背景。这使得它成为交流业务环境、记录假设、注释代码、描述结论等的理想格式。

# 用例

在我们众多的使用案例中，今天我们使用笔记本最常见的方式是:数据访问、笔记本模板和计划笔记本。

## **数据访问**

网飞首次推出笔记本电脑是为了支持数据科学工作流程。随着数据科学家越来越多地采用它们，我们看到了扩展我们工具工作的机会。我们意识到，我们可以利用 Jupyter 笔记本电脑的多功能性和架构，并将其扩展到一般数据访问。2017 年第三季度，我们开始认真开展这项工作，将笔记本电脑从一个小众工具提升为网飞数据平台的一等公民。

从我们用户的角度来看，笔记本电脑为迭代运行代码、探索输出和可视化数据提供了一个方便的界面，所有这些都来自一个基于云的开发环境。我们还维护了一个 Python 库，它整合了对平台 API 的访问。这意味着用户可以从一台笔记本电脑中以编程方式访问几乎整个平台。由于多功能性、强大功能和易用性的结合，我们看到了整个平台上所有用户类型的快速有机采用。

如今，笔记本是网飞最流行的数据处理工具。

## **笔记本模板**

随着我们扩展对笔记本电脑的平台支持，我们开始引入新的功能来满足新的使用案例。从这项工作中出现了参数化笔记本。参数化笔记本就像它听起来的那样:允许您在代码中指定参数并在运行时接受输入值的笔记本。这为用户将笔记本定义为可重用模板提供了一个极好的机制。

我们的用户已经发现了这些模板惊人的用途。一些最常见的是:

*   **数据科学家:**用不同的系数进行实验，总结结果
*   **数据工程师:**执行一系列数据质量审计，作为部署流程的一部分
*   **数据分析师:**分享准备好的查询和可视化，使利益相关者能够进行比 Tableau 允许的更深入的探索
*   软件工程师:每次出现故障时，通过电子邮件发送故障诊断脚本的结果

## **日程安排笔记本**

我们利用笔记本电脑的一个更新颖的方式是作为一个统一层来安排工作流。

由于每个笔记本都可以在任意内核上运行，我们可以支持用户定义的任何执行环境。因为笔记本描述了一个线性的执行流程，被细胞分解，我们可以将失败映射到特定的细胞。这允许用户描述执行和可视化的简短叙述，我们可以在稍后运行时准确地报告。

这种模式意味着我们可以使用笔记本电脑进行交互式工作，并顺利地将工作安排为循环运行。对于用户来说，这是非常方便的。许多用户在笔记本中构建了一个完整的工作流，但当他们准备好部署它时，却不得不将它复制/粘贴到单独的文件中进行调度。通过将笔记本视为一个逻辑工作流，我们可以像安排任何其他工作流一样轻松地安排它。

我们也可以通过笔记本安排其他类型的工作。当 Spark 或 Presto 作业从调度器执行时，源代码被注入到新创建的笔记本中并被执行。然后，这个笔记本就变成了一个不可变的历史记录，包含所有相关的工件——包括源代码、参数、运行时配置、执行日志、错误消息等等。排除故障时，这为调查提供了一个快速的切入点，因为所有相关信息都集中在一起，并且可以启动笔记本进行交互式调试。

# 笔记本电脑基础设施

支持网飞规模的这些用例需要大量的支持基础设施。让我们简单介绍一下我们将要谈论的一些项目。

[**interact**](https://github.com/nteract)是新一代基于 React 的 Jupyter 笔记本用户界面。它提供了一个简单、直观的界面，并对经典的 Jupyter UI 进行了一些改进，比如内嵌的单元格工具栏、可拖放的单元格和内置的数据浏览器。

[**Papermill**](https://github.com/nteract/papermill) 是一个用于参数化、执行和分析 Jupyter 笔记本的库。使用它，您可以生成多个具有不同参数集的笔记本，并并发执行它们。Papermill 还可以帮助从一系列笔记本中收集和汇总指标。

[**通勤**](https://github.com/nteract/nteract/blob/master/applications/commuter/README.md) 是一个轻量级、可垂直扩展的服务，用于查看和共享笔记本。它提供了一个 Jupyter 兼容版本的 contents API，使得读取存储在本地或亚马逊 S3 上的笔记本变得很简单。它还提供了一个目录浏览器，用于查找和共享笔记本。

[**Titus**](https://netflix.github.io/titus/) 是一个容器管理平台，提供可扩展和可靠的容器执行以及与亚马逊 AWS 的云原生集成。Titus 由网飞公司内部制造，用于制作网飞流媒体、推荐和内容系统。

我们将在后续的博客文章[中探索这种架构，在网飞](https://medium.com/@NetflixTechBlog/scheduling-notebooks-348e6c14cfd6)安排笔记本。出于本文的目的，我们将只介绍它的三个基本组件:存储、计算和接口。



Notebook Infrastructure at Netflix



## **存储**

网飞数据平台依赖亚马逊 S3 和 EFS 的云存储，笔记本电脑将其视为虚拟文件系统。这意味着每个用户在 EFS 上都有一个主目录，其中包含笔记本的个人工作空间。此工作区是我们存储用户创建或上传的任何笔记本的地方。当用户以交互方式启动笔记本时，这也是所有读写活动发生的地方。我们依靠`[workspace + filename]`的组合来形成笔记本的*命名空间*，例如`/efs/users/kylek/notebooks/MySparkJob.ipynb`。我们使用这个名称空间来查看、共享和安排笔记本。这种约定可以防止冲突，并且可以轻松识别用户和笔记本在 EFS 卷中的位置。

我们可以依靠工作空间路径从用户那里抽象出基于云的存储的复杂性。例如，目录列表中只显示笔记本的文件名，例如`MySparkJob.ipynb`。这个相同的文件可以在`~/notebooks/MySparkJob.ipynb`从终端访问。



Notebook storage vs. notebook access



当用户计划一个笔记本时，计划程序将用户的笔记本从 EFS 复制到 S3 的一个公共目录中。S3 的笔记本成为调度者的真实来源，或*来源笔记本*。每次调度程序运行一个笔记本时，它都会从源笔记本实例化一个新的笔记本。这个新的笔记本是实际执行的东西，并成为该执行的不可变记录，包含来自每个单元的代码、输出和日志。我们称之为*输出笔记本*。

协作是我们在网飞工作的基础。当用户开始共享笔记本网址时，这并不奇怪。随着这种做法的发展，我们经常会遇到由于多人同时访问同一个笔记本而导致的意外覆盖问题。我们的用户希望能够以只读状态共享他们的活动笔记本。这导致了 [**通勤**](https://github.com/nteract/nteract/tree/master/applications/commuter) 的产生。在幕后，Commuter 为`/files`和`/api/contents`提供 Jupyter APIs 来列出目录、查看文件内容和访问文件元数据。这意味着用户可以安全地查看笔记本电脑，而不会影响生产作业或实时运行的笔记本电脑。

## **计算**

管理计算资源是数据处理中最具挑战性的部分之一。在网飞尤其如此，我们在 AWS 上采用了高度可扩展的容器化架构。数据平台上的所有作业都在容器上运行，包括查询、管道和笔记本。自然地，我们希望尽可能多地抽象出这种复杂性。

当用户启动笔记本电脑服务器时，会提供一个容器。我们为容器资源提供了合理的默认值，这适用于大约 87.3%的执行模式。当这还不够时，用户可以使用一个简单的界面请求更多的资源。



Users can select as much or as little compute + memory as they need



我们还提供了一个带有准备好的容器映像的统一执行环境。该映像具有公共库和一组预安装的默认内核。并不是映像中的所有东西都是静态的——我们的内核为我们的平台提取最新版本的 Spark 和最新的集群配置。这减少了新笔记本的摩擦和设置时间，并且通常使我们保持单一的执行环境。

在引擎盖下，我们通过 Docker 容器管理服务 [Titus](https://medium.com/netflix-techblog/titus-the-netflix-container-management-platform-is-now-open-source-f868c9fb5436) 管理流程和环境。我们通过管理用户的特定服务器配置和映像来进一步包装该服务。该映像还包括用户安全组和角色，以及包含的库中身份的公共环境变量。这意味着我们的用户可以在基础架构上花费更少的时间，在数据上花费更多的时间。

## **界面**

前面我们描述了我们对笔记本成为处理数据的首选工具的愿景。但是这提出了一个有趣的挑战:一个界面如何支持所有用户？我们还不完全知道答案，但我们有一些想法。

我们知道我们想要变得简单。这意味着一个具有极简美学的直观用户界面，它还需要一个有思想的 UX，使困难的事情变得容易。这一理念与 Jupyter 笔记本基于 React 的前端[**interact**](https://github.com/nteract/nteract)的目标非常一致。它强调简单性和[可组合性](https://components.nteract.io/)作为核心设计原则，这使得它成为我们想要做的工作的理想构建模块。

我们从用户那里听到的最常见的抱怨之一是缺乏跨语言边界的本地数据可视化，特别是非 Python 语言。nteract 的[数据浏览器](https://blog.nteract.io/designing-the-nteract-data-explorer-f4476d53f897)是一个很好的例子，说明我们如何通过提供一种语言无关的方式来快速浏览数据，从而使困难的事情变得简单。

您可以在 MyBinder 上的这个[示例笔记本](https://mybinder.org/v2/gh/nteract/examples/master?urlpath=%2Fnteract%2Fedit%2Fpython%2Fhappiness.ipynb)中看到 Data Explorer 的运行。*(请注意:加载可能需要一分钟)*



Visualizing the World Happiness Report dataset with nteract’s Data Explorer



我们还引入了对参数化的本机支持，这使得安排笔记本和创建可重复使用的模板变得更加容易。



Native support for parameterized notebooks in nteract



虽然笔记本电脑在网飞已经提供了很多价值，但我们才刚刚开始。我们知道我们需要[在前端和后端进行投资](https://jobs.netflix.com/search?q=notebooks),以改善笔记本电脑的整体体验。我们未来 12 个月的工作重点是提高可靠性、可见性和协作。上下文对用户来说至关重要，这也是我们增加集群状态、内核状态、作业历史等可见性的原因。我们还致力于自动版本控制、原生应用内调度、对可视化 Spark 数据帧的更好支持，以及我们的 Scala 内核的更大稳定性。我们将在以后的博客文章中更详细地介绍这项工作。

# 开源项目

网飞长期以来一直是开源的支持者。我们重视从开源合作中产生的能量、开放标准和思想交流。我们为网飞数据平台开发的许多应用程序已经通过[网飞操作系统](https://netflix.github.io/)开源。我们也有意不创造一次性解决方案或屈从于“不在这里发明”的心态。只要有可能，我们就利用和贡献现有的开源项目，如 [Spark](https://github.com/apache/spark) 、 [Jupyter](https://github.com/jupyter) 和 [pandas](https://github.com/pandas-dev/pandas) 。

我们描述的基础设施在很大程度上依赖于 Project Jupyter 生态系统，但在一些地方我们有分歧。最值得注意的是，我们选择了[**interact**](https://github.com/nteract)作为网飞的笔记本 UI。我们做出这个决定有很多原因，包括与我们的技术堆栈和设计理念保持一致。当我们挑战笔记本电脑的极限时，我们可能会创造新的工具、库和服务。这些项目也将作为 nteract 生态系统的一部分开源。

我们认识到，对网飞有意义的东西不一定对每个人都有意义。我们在设计这些项目时考虑到了模块化。这使得只挑选对您的环境有意义的组件成为可能，例如 Papermill，而不需要对整个生态系统做出承诺。

# 下一步是什么

作为一个平台团队，我们的责任是让 Netflixers 能够用数据做令人惊叹的事情。笔记本电脑已经在网飞产生了巨大的影响。随着我们在这一领域的重大投资，我们很高兴看到这一影响的增长。如果你想成为其中的一员，请查看我们的职位空缺。

唷！感谢你坚持阅读这篇长文。我们只是触及了笔记本电脑的皮毛。这篇文章是我们将在未来几周发布的网飞笔记本系列文章的第一部分。你可以在 Medium 上关注我们，了解更多来自网飞的信息，并查看以下最新发布的文章:

