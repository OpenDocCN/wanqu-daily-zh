# 在 SoundCloud | SoundCloud Backstage 博客上进行本地反应

> 原文:[https://developers . soundcloud . com/blog/react-native-at-soundcloud？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://developers.soundcloud.com/blog/react-native-at-soundcloud?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

大约一年前，我们在 SoundCloud 面临一个有趣的问题:我们能否用 React Native 构建 SoundCloud Pulse——我们面向创作者的应用程序？一项五个月大的技术是否足够成熟，可以成为 SoundCloud 技术堆栈的一部分？

在提出这个问题的几个月前，我们开始为 Android 和 iOS 设计第二套原生应用。我们首先关注 iOS，因为那里是大多数创造者所在的地方。事实证明，找到 iOS 工程师比我们想象的要难，这种情况你可能很熟悉。对于 Android，我们与 Novoda 合作。我们不希望在 iOS 和 Android 发布之间有很多个月的时间。与此同时，独立地，设计团队正在运行基于 React 本地原型的用户测试会议，我们也有来自非常热心的 web 工程师的能力。

## 预热

一开始我们有两个主要目标。包括所有对此项目有价值的团队，并说服我们自己使用 React Native。我们的 iOS 团队拥有多年的移动应用开发经验，他们的意见非常有价值，令人放心。与此同时，我们能够向他们解释为什么我们要研究 React Native。在公司中公开谈论项目并让人们参与决策过程，这对我们了解 React Native 能做什么和不能做什么有很大帮助:

*   哪些元素可以并且应该以原生方式编写？
*   哪些元素可以并且应该用 JavaScript 编写？
*   它能否以一种用户不会注意到它“与众不同”的方式与原生应用竞争？
*   React Native 支持原生共享对话吗？
*   它支持深度链接吗？
*   它支持安全存储访问令牌吗？
*   它支持脸书和谷歌的登录 SDK 吗？

我们还对它与我们现有的本地库的集成程度有疑问:

*   我们可以用现有的 iOS 工具运行验收测试吗？
*   如何才能实现国际化？
*   我们能把它集成到我们的持续集成管道中吗？
*   对于长列表，性能看起来如何？总的来说？
*   对续航有负面影响吗？

在为期两周的[高峰](https://en.wikipedia.org/wiki/Spike_(software_development))中，我们构建了一个 SoundCloud Pulse 应用的原型，以便在实践中更好地理解 React Native。第一周之后，我们已经充实了应用程序的大部分屏幕，并对我们的进展速度感到惊讶。在第二周，我们想把重点放在未回答的问题上，并编写一些本机代码。很容易将我们现有的 iOS 库与我们的 React 原生原型连接起来。我们在 iOS 工程师的支持下完成了原型，并得出结论，我们对 React Native 有足够的信心来全职推进这个项目。

## 旅程

我们开始与两名 JavaScript 工程师和一名 iOS 工程师一起开发这个应用程序。iOS 应用程序还没有设计，但我们知道我们需要达到与 Android 应用程序同等的功能，所以我们使用 Android 应用程序作为 iOS 版本的蓝图。

事实证明，让 iOS 开发人员与 JavaScript 开发人员并肩工作是一个好主意。在最初的几周，有很多知识分享，我们能够保持快速冲刺的速度。我们在一天内完成了整个屏幕，甚至在应用程序中内置了比我们在 Android 上开始时更多的功能(例如 1 密码集成)。

与 spike sprint 相比，我们更关注实现高测试覆盖率。我们来自一个主要是 web 的背景，我们习惯于在出现运行时错误的情况下，在几分钟内部署补丁。在手机上这是不可能的，所以我们必须在发布新版本的应用程序之前进行更彻底的测试。我们考虑过使用像 [CodePush](https://microsoft.github.io/code-push/) 这样的服务，它允许你推送应用的更新版本，而不需要等待应用商店的审核过程。然而，所有这些服务在开始时都不够稳定，我们决定不使用它们来减少错误源的数量。

该应用的开发始于 2015 年 10 月中旬，我们在 2 月中旬发布了第一个版本。我们花了四个月的时间和三个开发人员一起编写这个应用程序。从峰值代码库到经过单元测试、组件测试和集成测试的应用程序需要四个月。我们估计完成这个应用需要六个月的时间，但是我们低估了 React Native 允许我们的速度。

## 我们一路走来学到的东西

### 本地图书馆

对于许多流行的原生库/API/SDK，有人可能已经编写了一个桥来反应原生。当然，[脸书 SDK](https://github.com/facebook/react-native-fbsdk) 是其中之一，[谷歌登录](https://github.com/devfd/react-native-google-signin)也是其中之一，还有像 [Appboy](https://github.com/Appboy/appboy-react-sdk) ，访问 [iOS 钥匙链](https://github.com/oblador/react-native-keychain)等等。

如果您对加入 React Native 潮流的最大恐惧是您已经积累了许多您不想失去的伟大的 Objective-C 库，不要担心，使用它们非常容易。React Native 的[原生模块](http://facebook.github.io/react-native/docs/native-modules-ios.html)能够很好地连接 JavaScript 访问的任何东西，并且实现起来非常快。在你的团队中有一个具有 Objective-C 知识的人或者一个可以帮忙的人会有所帮助，但是这个 API 即使对于非 iOS 开发者来说也是非常容易理解的。

我们的事件日志库就是一个很好的例子。它在我们的 listener 应用程序中经过了实战测试，它支持批量发送事件，因此它的网络流量更小，并且可以处理离线/糟糕的连接。我们能够毫不费力地从监听器应用程序中提取它。剩下的工作很简单，只需在 JavaScript 中引入一些方法，如`initialize`、`pageView`和`click`。\o/

### 本地基础设施

在构建和测试我们的应用程序时，我们也不需要重新发明轮子。因为 React 原生应用程序的构建与任何其他 iOS 应用程序非常相似(当然不包括编译 JavaScript 的额外步骤；))我们的 iOS 和测试团队能够在几天内建立一个与当前结构非常相似的 CI 环境。验收测试的编写风格与我们的 iOS 开发人员相同，他们从自己的经验中受益匪浅，这使得设置更加容易。

另一个很大的帮助是关于如何将应用程序分发到 app store 的知识以及围绕它的流程。由于我们大部分是 web 开发人员，对这个过程没有任何经验，所以在 CI 上设置它为我们节省了大量手动运行构建并将它们上传到 app store 的时间。

### 网络图书馆

我们可以重用大量的内部 web 模块，几乎不需要修改。一个很好的例子是我们处理国际化的方式。我们使用的库与我们在所有基于 web 的应用程序中使用的库相同，所以我们只需要稍微修改一下我们的字符串解析。

另一个例子是以集中方式定义 API 端点的库。通过将 React Native 的`fetch`函数作为传输层，我们可以直接使用它，不需要任何修改。这只是两个例子，但是还有更多小的工具/助手，我们可以直接加入。

### 反应原生问题

当然，没有技术是完美的，所以 React Native 有它自己的一套小问题。对我们来说，它们都不是交易破坏者，但是在开始 React 原生项目之前，您仍然应该了解它们。

到目前为止，最大的一个问题是，React Native 发展非常快，这当然很好，但它确实会产生成本。每两周就会有一个新版本(以及下一个版本的发布候选版本)，并且“重大变更”部分通常非常广泛。如果你定期更新，你基本上不会有问题；更大的潜在问题来自你使用的第三方库。举个例子，现在你从`react`导入`React`，而不是从`react-native`导入，如果第三方库没有被更新来做同样的事情，这就是一个问题。最重要的是，比起安全更新，脸书肯定更重视向前推进，这在巴别塔 6 的一次更新中表现得最为明显，那次[破坏了许多库](https://github.com/facebook/react-native/issues/4062)，每个人花了几周时间才赶上。所有这些基本上意味着您需要比使用更成熟的框架多花一点时间来保持更新。

另一个小问题是文档。它不像我们希望的那样广泛，仍然有一些完全没有记录的功能/组件，但这正在变得越来越好，你可以看到在这一领域正在发生[大投资](https://twitter.com/reactjs/status/743937815705059330)。

## 为什么 React Native 对我们很有效

SoundCloud 使用 React Native 的主要原因是缺乏足够的移动工程师来开发新的移动应用程序。如果你处于 web 工程师比移动工程师多的类似位置，这可能是 React Native 的主要论点之一。虽然这种情况在某种程度上仍然适用，但我们开始欣赏 React Native 的原因不仅仅是因为它的 JavaScript 根源。

很明显，在创建 React Native 时，更好的开发者体验是脸书的首要任务，这一点也很明显。当你的代码发生变化时，自动实时重新加载你的应用程序大大缩短了反馈循环，使用 Chrome 调试你的应用程序对任何 web 开发人员来说都是如鱼得水。如果你碰巧也使用 Redux 和一个日志中间件，了解你的应用程序在任何时候发生了什么是非常简单的。这是一种非常令人欣慰的感觉，当你需要它们的时候，工具就在那里，它对开发人员的快乐、开发速度和信心的影响是不可低估的。如果你需要一个理由去尝试，这就是了。快乐的开发人员和更快的周转是难以超越的。产品经理、决策者&设计师们听好了，我在这里跟你们说话:)

但是还有更多:开源社区提供了许多现成的库和组件，并且对 Native 的变化、问题和改进建议反应非常迅速。成为这个积极社区的一部分感觉很好。

我们最近才开始探索的另一个巨大优势是 React Native 的跨平台特性。脸书提到，在他们的 iOS 和 Android 实现的 Ads Manager 之间，大约有 85%的代码重用，如果有合适的应用程序结构，这个数字是非常现实的。这意味着，一旦你有了架构，在两个平台上为你的应用程序构建一个新功能只会有 10-20%的额外成本，而不是 100%。那是巨大的。

如前所述，动态更新应用程序的能力还允许立即修复错误、进行 a/b 测试，以及随时推送更新的温暖舒适的感觉:在移动开发领域梦想成真(只要谷歌和苹果允许，这总是有点难以预测)。

## 下一步是什么

基于我们对 React Native 的良好体验，我们计划在 SoundCloud 的更多地方使用它。现在有一个设计团队正在开发一个用 React Native 编写的原型/用户测试应用程序的替代品。我们的设计人员发现，在基于 React 的应用上工作比在本地应用上简单得多，并且能够自己构建应用，而无需频繁的开发人员输入。他们还致力于将该应用程序引入 Android，以增加我们可以测试的用户数量，并测试 Android 特有的功能。

说到 Android，我们已经花了一些时间来准备在 Android 上运行的应用程序，并在几个[黑客时间](https://developers.soundcloud.com/blog/stop-hacker-time)会话中获得了该应用程序的精简版本。我们目前正在研究这方面的进一步措施，例如用 React 原生版本替换当前的 Android Pulse 应用程序。我们正在研究的另一个领域是将 React 本地视图集成到我们的本地应用程序中。我们期待着这些实验，希望它们能像这次一样顺利。

与我们联系

简·蒙施克[@迪夫顿](https://twitter.com/thedeftone)
彼得·米纳尔里克[@皮耶托皮奇](https://twitter.com/pietropizzi)