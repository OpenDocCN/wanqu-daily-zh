# 缓慢而稳定的重构

> 原文：<http://robnapier.net/refactoring?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

今天我一直在和闲散的人们谈论重构，我想我应该把我的一些想法放在这里。也许没有我想要的那么完美，但是我想把它们从我的脑海中抹去，写在“纸上”

*对话以引用乔尔的经典作品开始，[你不该做的事，第一部分](https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/)。引发我的思考:*

刚刚完成了一些主要的重构工作，将 ObjC 转移到 Swift 并完全重新设计了它的状态机。我绝对支持我重写的部分(这些部分是微妙的竞争条件和错误的持续来源，每次修复都会导致两个新问题)。我绝对支持我延迟重写的部分(这些部分乱七八糟，难以安全地修改，但是在一些小的调整之后足够稳定，可以不去管)。

我是“激进重构”的忠实粉丝我已经重构了几个代码库，直到几乎没有原始代码了。但这是稳步进行的，只是在煞费苦心地将它们从代码的其余部分中分离出来之后，才进行主要的重写(通常是在几个版本的过程中)。最后，总有一些“泥球”部分有点疯狂，但只是工作，不需要经常被触摸，所以我们让它去吧。

我甚至将一个 C 程序重构为一个 Go 程序，把它变成两个通过套接字通信的独立进程，并将位从 API 的一端移动到另一端。

(所以即使“我们需要完全转换语言/平台”也不会阻止你朝着一个目标进化。)

但是有一个例外，乔尔没有提到(但我认为马丁·福勒提到了):如果你有令人难以置信的错误代码，也就是说，如果你的 T2 没有工作代码，那么是时候考虑重写了。不是丑陋的代码。设计不错，使用代码也不可怕。但是实际上并不工作的代码，以及使它工作的几次尝试都失败了。这时重写(至少那些部分)可能是合适的。

然后讨论转向了单元测试，特别是被遗忘的重构。

在没有可靠的单元测试覆盖的情况下，对代码进行了一些非常成功的彻底重构，我认为值得讨论一下如何做到这一点。

首先，单元测试覆盖绝对是最好的第一步。也就是说，有时候这是不可能的。当你的系统中所有最可能和最常见的错误都是竞争条件和涉及程序之外的事情(非平凡的网络、蓝牙、特定版本的操作系统交互、复杂的动画等)时，我发现单元测试很快变成了模拟测试，而不是系统测试。我们可以讨论重新设计你的系统是否可行或有利可图，使其更具可测试性。我甚至会承认它是，并把关于 TDD 的争论留待以后讨论(我实际上是 TDD 的粉丝)。但是为可测试性重新设计将*本身*需要大量没有单元测试的重构(因为你不能单元测试直到你使它可测试)。即使你有很多测试，重构通常意味着显著地改变测试(这意味着你并没有真正测试同样的东西)。所以在*某个*点，你会发现自己需要在没有完美(甚至勉强足够)单元测试的情况下进行重构。你是怎么做到的？

慢点。

我怎么强调这一点都不为过。慢点。下去。预计您的重构将需要多次发布。做一个小的重构，运行一个完整的 QA 周期(不管这对你意味着什么)，然后发布。一遍又一遍地做。我的“convert a C project to Go”项目包含了一个版本，我们只是将 Go 代码与 C 代码一起发布，甚至没有调用 Go 代码，只是为了证明它可以安装并且不会破坏任何东西。然后，我们在 Go 代码中构建了一个微小的新功能。它是如此之小，影响的用户如此之少，如果它不工作，我们准备宣布它不受支持。在“真正”切入 Go 代码之前，我们已经在 Go 代码上下了将近两年的功夫(当时绝大多数代码仍然是 C 语言)。但是在前进的每一步中，系统都变得更好、更理智、更可靠。在这一过程中的每一步，它都运了出去，得到了真正的实地锻炼。我们为它建立了许多测试，我们仍然发现了一些我们无法建立自动化测试的错误。“无法在 Mac 上确定先前加入 AD 域但随后被删除的域，仅在 10.8 之前的 OS X 上”或“如果用户名包含空格，SMB 无法连接到 Window 2000 服务器”或“如果在 Cisco VPN 上，无法在具有区分大小写的文件系统的 Mac 上确定正确的 IP 地址”诸如此类的东西。

随之而来的第二点是保持重构步骤的可控性。我有太多的实验性重构分支，我都扔掉了，因为它们失去了控制，并以非平凡的方式触及了系统的太多部分。不要害怕放弃几次重构的尝试，直到你能让你的改变足够集中，风险得到控制。有时这意味着创建“防火带”，一个包装你正在重构的东西的对象，并为你还不想接触的代码提供旧的 API。创建防火墙通常只是一个传递，除了调用原始防火墙的方法之外什么也不做。乏味，但往往是无价的。它们使得一点一点地移植到你的新 API 成为可能，而不是一口气接触半个系统。

我强烈建议保持你的提交非常集中。“将 FooAdapter 重命名为 Foo”应该是它自己的提交。不要把它和 API 的变化混在一起。“将 X 重命名为 Y”提交确实很容易进行代码审查，即使它们涉及数百个文件。但是如果你也改变了逻辑，那么它就是一个怪物。类似地，任何容易取胜且风险很小的事情(比如合理地命名事物，或者将一些重复的代码移动到一个函数中)，首先做这些，然后将它们放入主代码库。这样，当你发现你雄心勃勃的新设计失去控制，不得不重新开始时，你不会失去你轻松的胜利。

测试是伟大的。测试至关重要。测试是必要的。但是单元测试是不够的。当有数百个测试用例需要重写时，它们可能会成为重构的障碍(T2)。根据我的经验，更重要的规则是慢慢来，稳扎稳打，继续出货。

是的。编写你的单元测试。我们是专业人士。