# 错误的抽象——桑迪·梅茨

> 原文：<http://www.sandimetz.com/blog/2016/1/20/the-wrong-abstraction?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

_ 我最初为我的 [Chainline 简讯](http://www.sandimetz.com/subscribe)写了以下内容，但我不断收到关于这个想法的推文，所以我在我的博客上重新发布了这篇文章。这个版本稍加编辑。_

* * *

我一直在思考“错误抽象”的后果我的 RailsConf 2014 " [所有的小事情](https://youtu.be/8bZh5LMaSmE)谈话包括一段[我断言](https://youtu.be/8bZh5LMaSmE?t=893):

> 复制比错误的抽象要便宜得多

在总结中，[我继续建议](https://youtu.be/8bZh5LMaSmE?t=2142):

> 宁愿重复也不要错误的抽象

这一小部分更大的谈话引起了惊人的强烈反应。一些人认为我疯了，但更多的人表达了这样的观点:

这种强烈的反应让我意识到“错误的抽象”问题是多么的普遍和棘手。我开始提问，发现了以下模式:

1.  程序员 A 看到了重复。

2.  程序员 A 提取复制并给它一个名字。

    这创造了一个新的抽象概念。它可能是一个新的方法，甚至可能是一个新的类。

3.  程序员 A 用新的抽象替换了复制。

    啊，代码很完美。程序员快乐地小跑而去。

4.  时光流逝。

5.  一个新的需求出现了，当前的抽象对于它来说几乎是完美的。

6.  程序员 B 的任务是实现这个需求。

    程序员 B 觉得保留现有的抽象是义不容辞的，但是由于并不是每种情况下都完全相同，他们修改代码以接受一个参数，然后添加逻辑以根据该参数的值有条件地做正确的事情。

    曾经是通用的抽象概念现在在不同的情况下表现不同。

7.  另一个新的要求来了。
    *程序员 X.
    另一个附加参数。
    又一个新的条件句。
    循环直到代码变得不可理解。*

8.  你出现在这个故事中，你的生活发生了戏剧性的变化。

现有的代码会产生强大的影响。它的存在表明它是正确和必要的。我们知道代码代表了付出的努力，我们非常积极地维护这种努力的价值。不幸的是，令人难过的事实是，代码越复杂、越难以理解，也就是说，创建代码的投入越多，我们就越感到保留代码的压力(“[沉没成本谬误](https://en.wikipedia.org/wiki/Sunk_costs#Loss_aversion_and_the_sunk_cost_fallacy)”)。就好像我们的潜意识告诉我们“天哪，这太令人困惑了，一定花了*很久*才弄对。这肯定非常非常重要。让所有这些努力付诸东流是一种罪过。”

当你出现在上面第 8 步的故事中时，这种压力可能会迫使你继续前进，也就是说，通过改变现有的代码来实现新的需求。然而，试图这样做是残酷的。代码不再代表一个单一的、共同的抽象，而是变成了一个充满条件的过程，它将许多模糊关联的想法交织在一起。很难理解，也很容易打破。

如果你发现自己处于这种情况，抵制沉没成本的驱使。当处理错误的抽象时，*最快的前进方式是后退*。请执行以下操作:

1.  通过将抽象的代码内联回每个调用者来重新引入重复。
2.  在每个调用程序中，使用传递的参数来确定该特定调用程序执行的内联代码的子集。
3.  删除这个特定呼叫者不需要的位。

这既去除了抽象*又去除了条件*，并且将每个调用者减少到只有它需要的代码。当您以这种方式回顾决策时，通常会发现，尽管每个调用者表面上都调用了一个共享的抽象，但他们运行的代码是相当独特的。一旦你完全去除了旧的抽象，你就可以重新开始，重新隔离重复，重新提取抽象。

我看到过这样的问题，人们勇敢地试图用错误的抽象向前推进，但是收效甚微。添加新特性非常困难，每一次成功都使代码更加复杂，这使得添加下一个特性更加困难。当他们将他们的观点从“我必须保护我们在这个代码上的投资”改变为“这个代码在一段时间内是有意义的，但是也许我们已经从它身上学到了我们能学到的一切”，并且允许他们自己根据当前的需求重新思考他们的抽象时，一切都变得容易了。一旦他们内联了代码，前进的道路就变得显而易见，添加新特性变得更快更容易。

这个故事的寓意是什么？不要被沉没成本谬论所困。如果您发现自己通过共享代码传递参数和添加条件路径，那么抽象就是不正确的。一开始可能是对的，但那一天已经过去了。一旦抽象被证明是错误的，最好的策略就是重新引入复制，让它告诉你什么是正确的。虽然偶尔积累一些条件来洞察正在发生的事情是有意义的，但是如果你尽早放弃错误的抽象，你会少受些痛苦。

当抽象错误时，最快的前进方式是后退。这不是后退，而是朝着更好的方向前进。动手吧。你会改善你自己的生活，以及所有人的生活。

### 新闻:99 瓶用 JS、PHP 和 Ruby 编写的 OOP！

第二版 [99 瓶 OOP](https://sandimetz.com/99bottles) 已经发售！

第二版包含 3 个新章节，比第一版长了约 50%。此外，因为《99 瓶 OOP》一般是关于面向对象的设计，而不是任何特定的语言，这一次我们创建了技术上完全相同的独立书籍，但是使用不同的编程语言作为例子。

99 瓶 OOP 目前有 Ruby、JavaScript 和 PHP 版本，还有啤酒和牛奶饮料。它以 epub、kepub、mobi 和 pdf 格式发布。这导致六本不同的书和(3x2x4) 24 个可能的下载；都是独一无二的，但仍然是相同的。一次购买可以让您下载任意或全部内容。