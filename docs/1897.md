# Fastmail |如何阻止 DDoS 攻击

> 原文:[https://blog . fast mail . com/2015/12/08/how-to-stop-a-DDOS-attack/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.fastmail.com/2015/12/08/how-to-stop-a-ddos-attack/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)



这是 [FastMail 2015 降临节日历](https://fastmail.blog/2015/12/01/fastmail-advent-2015/)中的第八篇帖子。请继续关注明天的另一篇文章。

* * *

上个月[我们遭到了 DDoS 攻击](https://fastmail.blog/2015/11/11/ddos-attack-may-lead-to-potential-service-disruption-this-week/)。在那一周的时间里，我们学到了很多关于这种攻击方式以及如何防范的知识。这篇文章记录了我们学到的一些东西，以及当面对针对自己服务的 DDoS 攻击时，你可以做些什么。我们热衷于谈论它，因为事实上很难在短时间内将所有这些信息收集在一起，尤其是当你已经受到攻击的时候。如果一些人因为这篇文章做了更好的准备，我们会很高兴的！

## 什么是 DDoS？

“DDoS”的扩展是“分布式拒绝服务”，但如果不谈论什么是[拒绝服务攻击](https://en.wikipedia.org/wiki/Denial-of-service_attack)，即使这样也没有多大意义，所以让我们从这里开始。

从根本上说，所有的互联网服务都接受来自网络的请求，执行一些工作，然后发回结果。为此，服务将提交一定量的资源来满足每个请求，其中资源可能包括网络容量、CPU 周期、内存、IO 等等。

DoS 攻击的目的是使其难以或不可能实际服务于传入的请求。通常的做法是从外部寻找一些方法来耗尽可用的资源，这样就不会为合法的请求留下任何资源。

有很多方法可以做到这一点，但对攻击者来说，最容易实现的方法之一是破坏服务接收请求的网络连接。正是“分布式”部分使这变得容易——全世界的计算机(通过恶意软件和病毒)可以被指示同时向网络服务发出大量请求，堵塞网络连接并阻止合法请求通过。我们上个月用来描述它的比喻是“这就像无法到达你的邮箱，因为一大群人已经围在了邮局的前门。”

### 分布式攻击

DDoS 背后的想法是让攻击者产生比接收站点能够处理的更多的流量。一台计算机不太可能有足够的网络资源来压倒一台服务器，服务器可能位于高容量互联网连接的末端。但是，如果你能让世界各地不同网络上的计算机同时发出请求，你就能使所有这些加起来超过服务器的处理能力。

实现这一点的主要方式是通过“[僵尸网络](https://en.wikipedia.org/wiki/Botnet)”。僵尸网络由许多(通常是数百或数千台)安装了恶意软件的普通家庭或工作计算机组成。该软件有多种来源——电子邮件(垃圾邮件/病毒)、软件安装程序中的附件(广告软件/恶意软件)等等。一旦安装，该软件将“呼叫总部”到控制服务器，并等待命令。攻击者将向被入侵的机器发出命令，指示它们开始向被攻击的站点发送大量网络请求。

执行 DDoS 的另一种方法称为“放大攻击”。某些类型的互联网服务(特别是 DNS 和 NTP)经常配置错误，以至于有可能通过一个小请求，欺骗服务将一个大响应发送到其他地方。如果几个僵尸网络机器都发出这种请求，就会导致大量流量攻击目标。

人们越来越容易进入僵尸网络。现在有一些网站，你可以在僵尸网络上租用时间，用信用卡或比特币支付，并通过简单的网络表单选择目标。

### 为什么会发生攻击？

有几个原因，但据我所知，它们主要分为三类:

*   勒索——攻击者威胁要进行攻击(可能会进行示威)，并索要钱财以避免攻击。这就是我们上个月面对的那种。
*   报复——攻击者是对你做了或说了什么，或只是不喜欢你的事情作出反应。
*   误导-攻击的目的是转移你对其他地方的其他事件(攻击)的注意力。

如果你非常不幸，你可能永远不知道为什么。不过，这并没有实质性地改变你对 DDoS 的计划和反应。

## 为 DDoS 做准备

理想情况下，您会在 DDoS 开始之前考虑如何防御它。在受到主动攻击时试图建立防御是非常痛苦的。在我们的情况下，我们在周日收到了一封要求付款的信，威胁在接下来的周三进行大规模袭击。我们很高兴给了我们时间(假设攻击者是可信的)，但这仍然是非常紧张的几天，我不认为我们中的许多人在那几天睡得很好。然而，我确实记得周三的那个时刻，我们决定尽我们所能做好准备。那一刻，担心消失了，因为这完全不在我们的掌控之中。当事情变得糟糕透顶时，提前做好准备会让你睡得更好。

### 应对勒索企图

你应该*永远不要*回应勒索企图。在大多数司法管辖区这被认为是犯罪。虽然付费可能会使攻击消失，但它也向攻击者表明你愿意付费，使你成为进一步攻击的目标，并且它给攻击者提供资金来支付更多的僵尸网络时间。

我们上次说过，但对于任何潜在的攻击者，这里再次重申: **FastMail 不回应勒索企图，我们在任何情况下都不会向罪犯付款。**

### 最低服务水平

了解全面的 DDoS 攻击极难防御是很重要的。即使是“成功的”防守也可能导致发球失误。你需要知道你的服务和你的用户的期望，并且清楚地知道最低可接受的服务水平是什么，并且相应地计划你的响应。

在我们的案例中，我们确定 DNS 和数据中心间的 VPN 链接绝对重要。DNS 是至关重要的，因为即使我们离线，正常工作的 DNS 也能让发送网站将电子邮件排队，直到我们回来，而失去 DNS 会导致退回。另一方面，我们数据中心之间的 VPN 链接允许我们的内部基础设施保持正常运行，即使外部网络出现故障，这意味着在我们需要专注于攻击的时候，我们不会有一大堆内部服务(如跨数据中心复制)出现故障。

### 网络防御

防止大量流量涌入您的网络的最佳方法很简单，就是让它远离您的网络。DDoS 攻击试图将来自世界各地的流量传输到您的单一网络连接。如果您可以将流量发送到其他地方，那么您的网络连接就可以自由地响应合法请求。

#### Web 和 DNS 缓解

对于典型的 web 应用程序，最简单的方法是在您的服务前面放置某种全球分布式 web/DNS 代理(也称为 CDN)。这些工具使用 [Anycast](https://blog.cloudflare.com/a-brief-anycast-primer/) 来迫使你的网站的流量首先通过一个地理上靠近发出请求的机器的代理。他们还实现了各种 DDoS 保护和过滤，所以只有合法的东西才能传递给你。

当然，如果攻击者不知道如何直接联系到您，这只能阻止您的实际服务受到攻击。如果你曾经在 DNS 中发布过你自己的网络范围，那么每个人都知道你在哪里，即使你在前面放了一个代理服务。在这种情况下，您需要获得一些您从未发布过的新的公共 IP 地址，并且只将它们提供给代理提供商，这样攻击者就更难找到您的网络。

对于 FastMail，web 代理是不够的，因为我们有大量关键的非 web 服务(IMAP、SMTP 等)。正如我之前所说，DNS 对我们来说至关重要，因此我们现在使用 [CloudFlare 虚拟 DNS](https://www.cloudflare.com/virtual-dns/) 来服务我们的公共 DNS。我们传统的 DNS 名称服务器`ns1.messagingengine.com`和`ns2.messagingengine.com`现在由 CloudFlare 遍布世界各地的服务器提供服务，这些服务器通过新的、未发布的 IP 地址连接回我们，以实际提供记录。如果我们停播，他们会一直提供缓存的答案，直到我们回来。

如果你使用云提供商的服务，先和他们谈谈，了解他们有什么样的 DDoS 保护服务(他们都有一些)。当攻击发生时(或者如果你受到威胁)，联系他们的安全团队让他们知道。他们掌握的信息和警告越多，他们就能做得越好。

#### 与您的数据中心提供商合作

我们不在云基础设施上运行我们的服务。相反，我们有自己的服务器，安装在不同位置的托管数据中心。多年来，我们的主要工作地点一直在 NYI 的纽约工厂。他们为我们提供了与互联网的连接，因此很自然地，他们是我们谈论如何保护我们网络的第一批人。

如果像我们这样，您的数据中心提供商将直接链接到“[主干网](https://en.wikipedia.org/wiki/Internet_backbone)”，这是一个高容量网络，将不同的 ISP、网络提供商和大型组织连接在一起，形成“互联网”。这是减轻 DDoS 攻击的最佳位置，因为在这里可以看到和处理大量的流量。在我们的案例中，NYI 安排他们的一个网络合作伙伴向全世界宣传我们的网络范围，将它定向到他们的 DDoS 缓解服务，该服务过滤掉垃圾并将合法数据包传递到我们的网络。

我只是粗略地了解这实际上是如何完成的(使用 [BGP](https://en.wikipedia.org/wiki/Border_Gateway_Protocol) 来广告网络和 [GRE 隧道](https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation)来将过滤后的流量传递回我们的网络)，但这就是要点——这是我们的数据中心提供商提供的服务之一，我很高兴让他们来处理这件事(如果你想从有经验的人那里获得惊人的服务，你应该和 NYI 谈谈)。

NYI 帮忙的另一件事是给我们弄到了一小部分未公开的 IP 地址。如前所述，我们在这里为 CloudFlare 添加了一个 DNS 服务器来代理我们的 DNS 流量，并且我们通过该范围路由我们的数据中心间 VPN 链接。理论上，如果我们的主网络被淹没，这个辅助网络应该仍然可用，因此 DNS 和数据中心间的流量可以不受阻碍地继续。

显然，有些攻击是我们永远无法防范的，比如直接针对我们的数据中心提供商的攻击，但对于攻击者来说，使用“商品”僵尸网络要难得多。像网络安全中的所有事情一样，对于资源丰富且意志坚定的攻击者，您几乎没有什么防御措施，但是对于偶然的攻击，您可以做很多事情。这就是我们在这里的目标。

#### 了解您的流量

您的应用程序可能只对一两种类型的流量感兴趣，例如端口 443 上的 TLS 流量。你自己的网络设备或主机防火墙可能已经丢弃了你不关心的东西。问题是，这种流量已经在您的网络上，与您的合法流量争夺带宽。

如果你知道你的流量，那么你可以和你的上游网络提供商谈谈，让他们屏蔽你不关心的内容。如果它从不攻击你的网络，你就永远不必处理它。

在我们的例子中，第一次“警告射击”攻击由 NTP 请求和端口 80 上的随机 UDP 数据包组成。我们对这两者都不感兴趣，它们早就被我们的主机防火墙屏蔽了。在攻击期间，90%的传入数据包都是这种类型的，而只有 10%是合法的用户流量。我们封锁了它，其余的照常服务，但是当只有 10%的数据包通过时，你的 TCP 连接会变得很不愉快。因此，我们要求 NYI 在这种流量接近我们的网络之前阻止它，随着我们了解的更多，我们要求他们也阻止其他事情。

这样做意味着潜在的攻击者必须生成看起来很像合法流量的流量。这通常不难实现，但至少排除了某些常见的攻击方式。你能做的任何让潜在攻击者的生活稍微变得更困难的事情，都会让防御变得更容易。

### 应用程序防御

正如我在开始时所说的，拒绝服务攻击就是耗尽服务合法网络请求所需的资源。在 DDoS 中，网络是目标资源，但考虑其他类型的攻击也很重要。在我们的案例中，我们不知道攻击者的能力或真实动机，我们想知道一旦他们攻击我们网络的努力失败后，如果他们转向另一种攻击会发生什么。因此，我们开始寻找在应用程序级别增加保护措施来抵御[复杂性攻击](https://en.wikipedia.org/wiki/Algorithmic_complexity_attack)。

这类攻击的主要特点是它们都会攻击到您的服务器，因此您可以使用应用程序所知道的一切来帮助抵御攻击。在我们的例子中，我们现在正在构建一个随时间变化的“好的”和“坏的”请求的概要。当我们受到攻击时，我们可以运行一个命令，使“坏”请求在到达我们的应用程序代码之前被防火墙丢弃。我将“好的”和“坏的”放在引号中，因为“坏的”请求不一定是我们不想服务的请求，而是太多的请求同时出现(也就是说，在受到攻击的情况下)会严重影响我们服务“好的”请求的能力。构成“好”和“坏”的因素在很大程度上取决于应用程序，所以我在这里不能给出更多的一般性建议。

我故意不去探究我们如何分析“好的”和“坏的”请求的细节，因为我不想告诉潜在的攻击者如何在攻击前“准备好”我们的系统。随着时间的推移，这也是我们将继续改变的事情。

### 与您的用户交流

技术防御很好，但是你不可能阻止一切，这意味着你的用户会注意到。所以，在事情发生之前让他们知道发生了什么。

在我们的案例中，当早期的“警告射击”攻击正在进行时，我们通过我们的[状态页面](http://www.fastmailstatus.com/)和我们的[推特账户](https://twitter.com/FastMail)与我们的用户沟通。我们明确地提到了“DDoS ”,因为我们的许多用户在技术上非常精通，足以理解这意味着什么并做出适当的响应。我们非常小心，不要透露太多的细节，直到我们的防御准备就绪，因为我们不想向攻击者发出信号，直到我们准备好了。最糟糕的情况是，攻击者在我们准备好之前发现我们不会付款，并提前攻击，测试我们的决心(并不是说这会有所不同)。只有当我们准备好了，我们[才向这个博客](https://fastmail.blog/2015/11/11/ddos-attack-may-lead-to-potential-service-disruption-this-week/)发帖。

给我们的用户尽可能多的警告意味着他们有时间做自己的准备。他们的回应非常积极——我们收到了数百条祝福我们的消息，许多新注册用户只是因为我们愿意表明立场，包括一个很棒的人，他并没有打算实际使用我们的服务，但购买了订阅服务，只是因为他们想给我们一些切实的支持。

虽然听起来很老套，但你的客户是你最大的资产。照顾他们，尊重他们的智慧，当事情变得艰难时，他们会支持你。

## 死后的

恭喜你，你已经从另一边出来了！

毫无疑问，你会有一些整理和修理工作要做；没有多少互联网服务能够很好地应对长时间无法访问互联网的情况。在这个阶段，你还需要考虑一些其他的事情。

### 注意后续行动

全世界现在都知道这已经发生了。也许只是世界的一小部分，这取决于你的服务的规模，但是这个世界是存在的，因为你与你的用户进行了所有的交流。所以要注意后续的攻击。最初的攻击者可能会放弃，但模仿者很常见，尤其是当他们怀疑你可能放松了警惕。

### 收集关于攻击者的数据

尽可能多地收集关于袭击的信息。源 IP 地址是主要的，数量也是有用的。如果你能把它与应用程序中的其他数据相匹配，那就非常方便了。如果你正在使用某种类型的缓解服务，也向他们询问这些信息。你可以用它来建立黑名单，为下次做准备，但这也很重要，所以你可以...

### 与计算机安全组织交流

许多司法管辖区都有某种专门应对计算机和基于互联网的威胁的组织，并且通常对这类攻击感兴趣。在澳大利亚，这是澳大利亚证书。美国，[US-CERT](https://www.us-cert.gov/)；在你的国家可能也有类似的东西。他们可以使用攻击的源 IP 和其他信息，并将其与来自其他事件的类似信息相关联，这有助于找到责任方。

### 检查您的安全措施

无论如何，你都应该定期这样做，但是现在是时候了。如果已知您在某个领域有足够的防御，那么一个坚定的攻击者将尝试不同的东西，您需要做好准备。你可能有办法利用你所学到的知识来提高其他领域的安全性。

## 收尾工作

DDoS 真的很可怕。我不想再经历一次，我也希望你永远不必经历，但至少现在我们更好地知道了会发生什么，以及如果它再次出现时该如何应对。

