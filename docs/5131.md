# Seva Zaikov -单页应用程序不是银弹

> 原文:[http://blog . bloomca . me/2018/02/04/spa-is-not-silver-bullet . html？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://blog.bloomca.me/2018/02/04/spa-is-not-silver-bullet.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

单页应用无处不在。即使是博客，简单的 html 页面(最初类似于[https://danluu.com/](https://danluu.com/))，也变成了巨大的怪物——例如， [jlongster 的博客](https://github.com/jlongster/blog)在写作时有 1206 颗星，而不是因为内容(人们通常订阅博客，而不是标记源代码):唯一的原因是，一旦他[使用 React & Redux](https://jlongster.com/The-Seasonal-Blog-Redux) 实现了它。但是，问题是什么呢？他想，他做到了，这里没有问题。问题是，让阅读博客变得如此臃肿被认为是正常的——当然，有一些人抱怨，但总体反应是绝对积极的。但是谁会关心博客呢——问题是，现在的问题往往不是“去 SPA 还是不去 SPA ”,而是“我们应该为我们的 SPA 使用哪个客户端框架”。

我是一名前端开发人员，他的整个职业生涯都在参与创建非常复杂的单页面应用程序(比如 [Lebara Play](https://play.lebara.com) ，或者[app.contentful.com](https://app.contentful.com/)——不过，你必须有一个帐户才能看到实际的应用程序)——很长一段时间以来，“应该是一个单页面应用程序”这个问题对我来说并不存在:当然应该是！但是一段时间前，在我之前的工作中，我的经理找到我，要求调查我们的应用程序大小——大约两年前，我们从 WordPress 迁移到 React/Redux/Immutable.js 堆栈(我想这是一个非常常见的选择),结果是平均加载时间增加了两倍！好吧，也许这只是我们的问题，我们并没有那么好——所以我花了几周时间研究这个问题，在研究之后，我重新思考了很多前端开发方面的问题。

## 技术发展水平

如今，许多初创公司、酷公司和个人网站都是使用单页应用程序创建的——这很常见，当人们点击应用程序中的链接后看不到真实加载时，没有人会感到特别惊讶。

让我们总结一下经验，从**优点**开始:

*   点击链接后没有页面重新加载
*   实现缓存后，后续页面会打开得更快，因为很多信息已经可以下载了(比如用户信息、电影细节等)
*   精细的动作非常快——比如添加到收藏夹，订阅新闻；当然，它不是火箭科学，所以你可以到处撒点 jQuery，但是维护起来要复杂得多
*   前端与后端分离，使得复杂功能的开发更加容易(特别是当我们需要在屏幕之间交互时)
*   有可能创造出近乎“本土”的体验(尽管我认为没人曾经感受过)，如果没有互联网，还会有倒退

**缺点**:

*   损坏的“后退”按钮(有时它可以正常工作，但一般情况下人们不信任它)
*   不良的“在新标签页中打开”行为——人们喜欢在`onClick`处理程序中处理链接，而浏览器不能将其识别为链接(即使大多数链接是有效的，你迟早会遇到非链接的“链接”)
*   有时“刷新”按钮坏了——刷新后，你会进入一个不同的用户界面(通常有点小，但还是不同)
*   增加了 TTI(互动时间)，稍后将详细介绍
*   低端设备性能差(我怀疑电池消耗更高，但无法证明这一点)

## 为什么慢？

回到开头，我说过我们发现 WordPress 实际上比我们新的 shiny stack 更快。我们的应用程序不是最简单的，但是有一些交互的部分——它是一个金融网站，在那里你可以申请贷款，进入你的个人账户，重组你的贷款，并更改一些个人信息。因为它是金融和完全在线的，我们必须收集大量数据，它是带有实时验证、即时验证和一些内在流程的几种形式，所以它是前端的完美案例。然而，有一个问题——它很慢；正如我提到的，加载时间增加了两倍。因此，我研究了它如此之大的原因，结果是，大小基本上是由我们的 react 生态系统决定的——我们需要的所有库都创建了这一大块 js(大约 350KB gzipped)。另一大块是我们实际的应用程序代码——又是 350kb，总共我们得到了大约 2.6MB 的非 gzip 数据，这当然是疯狂的。这意味着，无论我们的代码如何优化，为了启动应用程序，浏览器必须做几件事:

1.  下载这个 650KB 的文件
2.  解开它
3.  解析它(这个任务对于手机来说非常昂贵)
4.  执行它(这样我们就有了 React 运行时，我们的组件就变成交互式的了)

你可以在 Addy 的 Osmani 文章中读到更多关于这个过程的内容。

最后，我的发现是，我们把这一次的增长归功于大的包大小。正如我提到的，虽然我们的供应商块是一半的大小，所以这意味着基本功能(我们有非常“丰富”的主页)将需要一个大的块，只能解决部分问题。

我不得不说我们足够现代，为了帮助 SEO 和移动客户端，我们使用 Node.js + Express 实现了[服务器端渲染](http://blog.bloomca.me/2017/06/11/server-side-rendering-with-prefetch.html)，在那里我们为客户端获取所有需要的数据。这真的很有帮助——用户能够看到标记(尽管它在旧的移动设备上不工作),但问题是在 javascript 被下载、解析和执行之前，所以 React 可以添加事件侦听器，并且你的页面最终是交互式的，实际上要花很多时间。

## 有多慢？

让我们看看应用程序的实际大小。通常我会注销，并启用广告拦截器。

光明工程团队，很多关于迁移的文章反应过来。让我们看看它是如何进行的，在个别地方的典型页面上:

![](../Images/f33cd1271d1a290e9bde97fe17f7f62a.png) *一大堆文件。微服务在行动...*

有大量的文件，总共压缩了 1.3 兆字节。同样，1.3MB 向您展示一个地方-图片和描述。当然，有很多用户交互，但在一天结束时，作为一个用户，我想看看这个地方——我也可以被注销。它对用户友好吗？我不知道，但是我很乐意用静态内容来探索什么是需求，阅读描述等等。我很确定，激进的代码分割允许他们更快地发布特性，但是这里的代价是用户的舒适度和速度。

![](../Images/9b1540f05941261ccaeb35bc6cf376d1.png)

只有 3 个初始文件，1 个后来(我猜是懒惰加载):

*   init file, 161KB
*   通用文件，249KB
*   主页文件(分页！)，65KB
*   “原生捆绑”，44.5KB(不确定是什么，但后来加载了)

对于一些惰性加载文件，总共 475KB + 44.5KB。比 AirBnB 好多了，但还是有很多东西，只是为了给你看 feed。还有一款[移动版](https://mobile.twitter.com)，感觉轻了很多，但尺寸其实差不多。

Medium 是博客的一个很酷的平台。所以，本质上，它是一个高级的文本空间，就像你现在正在阅读的一样。让我们打开一篇我之前提到的关于 JS 成本的文章:

![](../Images/9836b211883e9c1ddfa3dae84006bba0.png)

还有 3 个文件:

*   主捆绑包，337KB
*   普通捆绑包，183KB
*   注释，22.6(也许这个惊人的功能突出了逗号)

总共 542KB，只是为了看一篇文章。顺便说一下，没有 JS 你也可以阅读它，所以这意味着它对主任务来说不是那么重要。

## 能做些什么？

我提到的所有这些网站都可以在我最新的 15 英寸 MBP 上下载 2-3 秒钟，并在 2 秒钟后完全可用，这在当今还不算太糟糕。问题是*在过去十年中变得多么正常*——[slack 在点击和切换到频道之间有 0.5 秒的延迟](https://twitter.com/freetonik/status/932965318816911361)，我们甚至不再注意到它。

不要把这种咆哮当成对水疗中心本身的攻击——我喜欢它们(在一天结束时，我为我的日常工作写一个！)，它们允许创建非常强大的用户体验，可以在所有平台上工作。然而，我在做 SPA 时做的很多事情，事实上不应该是一个。例如，前一段时间我给我妻子做了一个[作品集网站](https://jess.gallery/)，当然我是用[酷酷的 SPA stack](https://github.com/JessArt/website) 做的——但事实上，它只是一个有很多图片和一些小工具的博客；所以我比许多人更为这种趋势感到内疚。

此外，请随意浏览 CERN 的第一个网站。只要比较一下你在这个网站上时的导航速度，以及当你把它留给某个外部的现代网站时的响应速度。