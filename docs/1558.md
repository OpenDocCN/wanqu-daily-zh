# 为什么持续部署只是不停地给-内部对讲机

> 原文:[https://blog . intercom . io/why-continuous-deployment-just-keep-on-giving/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.intercom.io/why-continuous-deployment-just-keeps-on-giving/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

![](../Images/a9999a4017c2f3ae01d9d2a51a0b24ee.png)

快速和自动地部署新代码是我们如何在 Intercom 构建产品的基础。

我们从公司早期就开始这样做了。在 Intercom 最近的活动中，关于产品的*，我做了一个关于持续部署的意想不到的好处的演讲——以下是它的编辑版本。*

* * *

我们 Intercom 的核心价值观之一是，我们从大处着眼，从小处着手。这意味着我们接受大的、雄心勃勃的、有影响力的项目，并通过一系列小的、安全的步骤来解决它们。在构建新产品功能时，我们尽可能构建最简单的版本，并将其部署在功能标志后面，以便只有内部通信人员可以看到它。根据反馈，我们将在向一系列测试客户推出之前修复错误并做出改进。在又一轮的迭代、修复和改进之后，我们向所有人推出这个功能。

![null](../Images/a9999a4017c2f3ae01d9d2a51a0b24ee.png)

这种反馈循环是无价的，我们尝试并将其用于我们构建的一切。在这个过程的每一个阶段，我们都更多地了解人们如何使用这个特性，代码在产品中的表现如何，甚至这到底是不是一个好主意。对于大多数新功能，我们将在向所有客户发布之前部署几十次迭代。随着许多功能的同时开发，这意味着我们几乎每天都在不断地部署。

![](../Images/52a2073a36defca8999438a610397585.png)

从我们的内部部署仪表板中，我们可以看到在过去三年中我们每天部署 Intercom 的次数。从 2012 年年中开始，大约是每天 10 次，今天我们每天超过 80 次，我预测到 2015 年底，我们肯定会超过每天 100 次。

部署率大幅增长的主要驱动力是我们的团队在这段时间内显著增长。因此，当我们让这么多人一起开发一个每天变化 80 次的产品时，我们的部署过程需要平稳、可靠和快速。

当我们还是六个人的时候，我们开始为对讲机开发一个自动部署系统。

![](../Images/7e4d08e79a5f113e88d6ffb2b3a86bf6.png)

下面简单介绍一下它是如何工作的:
在 GitHub 上进行代码审查后，工程师们将他们的功能合并到主分支中。GitHub 向 Codeship 发送一个 webhook，code ship 为我们运行测试套件，以确保现有行为没有倒退。GitHub 还向我们构建的名为 Muster 的工具发送一个 webhook，该工具为发布准备最新版本的代码。

一旦测试成功运行，Codeship 会发送一个 webhook 给 must，然后代码会被推送到我们大约 200 个 EC2 实例的生产环境中。

整个过程首尾相连一般不到 10 分钟。这已经足够快了，工程师们永远不会被堵在等待部署的路上；如果我正在开发一个处于测试阶段的功能，并且在发布之前有十几个 bug 需要修复，我可以很容易地在一天之内将它们全部部署好——假设我能这么快地编写代码。

## 其他好处

在过去三年中，我们每天都这样做，我们注意到持续部署对我们的工作方式有一些其他有趣的好处。

### 帮助新工程师

![](../Images/9034ec0906b8b2dc47da1da838d30aec.png)

当一个新的工程师加入 Intercom 时，我们在他们的第一周给他们设定了两个初始目标:他们应该在第一天发布一些代码到产品中，在第一周发布一个特性。这让他们立刻感觉自己是团队中富有成效的一员。我们在周五有一个演示会议(如上图所示),向公司其他人展示我们在那一周做的东西；在你的第一周结束时，站起来向你的队友展示一个已经对客户开放的功能是一种令人难以置信的授权感。

但是对于一个新工程师来说，这些都是具有挑战性的目标。你需要做很多事情才能达到这个阶段。你需要设置你的笔记本电脑，会见你的团队，弄清楚你要做什么。您需要编写代码，并且您可能不熟悉您将在 Intercom 上使用的语言，所以您可能无法在一周内完成一个完整的功能有很多原因。

在 Intercom 中，不会让您慢下来的一件事是弄清楚如何部署您的更改。拥有一个完全自动化的部署系统消除了成功的一个重要障碍——新工程师可以在准备就绪后立即部署他们的更改。如果他们以后感到好奇，他们可以了解它是如何工作的，检查代码，甚至改进部署系统。但是在他们的第一周，不必学习关于部署的规则和流程真的很有帮助。

## 停止不良行为

另一个有趣的好处是，它减少了某些不良行为。当你在产品中有一个严重的 bug 时，尽你所能尽快修复这个问题是很诱人的。

如果您的部署系统很慢——如果从合并一个补丁到将它部署到生产环境需要 20 分钟——您可能会想尽一切办法绕过它来修复 bug。这听起来有点鲁莽，但可能是正确的选择。你不想坐在那里 20 分钟看着你的应用崩溃。诀窍是让您的部署系统足够快速和可靠，这样它总是比在生产中被破解更容易使用。

## 优化我们的部署率

![](../Images/07873c140aab81850c329b1974cf54d4.png)

这都需要相当多的工作。我们知道我们当前的部署过程需要八到九分钟，这还不错，但还可以更好。我的团队现在的大部分工作是优化部署，使其更快。理想情况下，我们将缩短到 3 或 4 分钟，这将为我们达到每天 100 次部署甚至更高的时候提供充足的空间。

如果你的公司成功了，随着时间的推移，很多东西都会成长。你将雇佣更多的人，你的团队将会成长，你将会编写更多的代码，你的代码库将会成长，你将会引入新的过程(那种适合 6 个人的过程不适合 100 个人)，希望你将会编写大量的自动化测试，并确保你在添加新的过程中不会破坏你所有的初始特性。所有这些加在一起会增加你的部署时间，这意味着减缓前面提到的反馈循环。

这也使得开发你的产品变得不那么有趣了。它不太有趣，因为你的效率会降低，每天学到的东西也会减少，这对工程师来说很沮丧，但对你的产品来说实际上更糟。你更有可能犯错误，构建错误的特性，或者投资于你不需要投资的东西。

因此，在 Intercom 的早期，我们认为部署时间是缩短反馈循环的一种非常好的方式，这意味着我们可以在尽可能短的时间内为我们的客户构建正确的功能。