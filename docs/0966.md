# 代码评审最佳实践

> 原文：<http://kevinlondon.com/2015/05/05/code-review-best-practices.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>



在我现在的公司，我们做了大量的代码审查。我来这里之前从来没有做过，所以这对我来说是一次新的经历。我认为这是一个好主意，当我进行代码评审时，我会明确一些我寻找的东西，并谈论我发现的接近它们的最好方法。

简而言之，代码评审是两个或更多开发人员之间关于解决问题的代码更改的讨论。许多文章谈到了代码评审的好处，包括知识共享、代码质量和开发人员成长。我发现很少有人谈论在评审中寻找什么以及如何讨论被评审的代码。

## 我在评估中寻找什么

### 建筑/设计

*   **[单一责任原则](https://en.wikipedia.org/wiki/Single_responsibility_principle) :** 一个类应该有且只有一个责任的思想。比人们想象的要难。我通常也将此应用于方法。如果我们必须使用“和”来完成描述一个方法能够做什么，它可能处于错误的抽象层次。

*   **[开/闭原理](https://en.wikipedia.org/wiki/Open/closed_principle) :** 如果语言是面向对象的，那么对象是不是对扩展开放，对修改封闭？如果我们需要再添加一个`x`会怎么样？

*   代码复制:我遵循[【三振出局】](http://c2.com/cgi/wiki?ThreeStrikesAndYouRefactor)规则。如果代码复制一次，虽然我不喜欢，但通常没问题。如果再复制一次，就应该重构，把通用功能拆分出来。

*   **[斜视测试罪](http://robertheaton.com/2014/06/20/code-review-without-your-eyes/) :** 如果我眯着眼睛看，这个代码的形状看起来和其他形状一样吗？在代码的结构中，有没有模式可以指出其他问题？

*   **代码处于比发现时更好的状态:**如果我要修改代码中混乱的部分，很容易添加几行代码然后离开。我建议更进一步，让代码比发现时更好。

*   潜在错误:是否存在一个接一个的错误？循环会以我们预期的方式终止吗？它们会终止吗？

*   **错误处理:**在必要的地方，错误是否得到了优雅而明确的处理？是否添加了自定义错误？如果有，它们有用吗？

*   **效率:**如果代码中有算法，它是否使用了高效的实现？例如，在字典中迭代一列键是一种查找所需值的低效方法。

### 风格

*   **方法名称:**命名事物是计算机科学中的难题之一。如果一个方法被命名为`get_message_queue_name`，而它实际上在做一些完全不同的事情，比如从输入中清除 HTML，那么这就是一个不准确的方法名。并且可能是一个误导的函数。

*   **变量名:** `foo`或`bar`对于数据结构来说可能不是有用的名字。与`exception`相比，`e`同样没用。根据需要尽量详细(取决于语言)。当我们以后必须重新访问代码时，表达性的变量名使理解代码变得更容易。

*   **函数长度:**我的经验是一个函数应该少于 20 行左右。如果我看到一个高于 50 的方法，我觉得最好把它切成更小的块。

*   课时长度:我认为课时总数应该在 300 行以下，最好少于 100 行。很可能大的类可以被分割成单独的对象，这样更容易理解类应该做什么。

*   文件长度:对于 Python 文件，我认为 1000 行左右的代码是我们在一个文件中应该拥有的最大长度。任何高于这个数字的文件都是一个好迹象，表明它应该被分割成更小、更集中的文件。随着文件大小的增加，可发现性下降。

*   对于复杂的方法或者那些有更长参数列表的方法，如果不明显，是否有一个文档字符串解释每个参数的作用？

*   **注释代码:**删除任何注释掉的行是个好主意。

*   **方法参数的数量:**对于方法和函数，它们的参数是 3 个还是更少？大于 3 可能是它可以以不同方式分组的标志。

*   **可读性:**代码是否容易理解？是不是复习的时候要经常停顿才能破译？

### 测试

*   测试覆盖:我喜欢看到新特性的测试。测试是否经过深思熟虑？它们包括故障条件吗？它们容易阅读吗？它们有多脆弱？测试有多大？他们慢吗？

*   在正确的水平上测试:当我回顾测试时，我也确保我们在正确的水平上测试它们。换句话说，我们是否达到了检查预期功能所需的低水平？Gary Bernhardt 建议 95%的单元测试，5%的集成测试。我发现，特别是对于 Django 项目，很容易意外地进行高水平的测试，并创建一个缓慢的测试套件，因此保持警惕是很重要的。

*   **嘲讽数量:**嘲讽很棒。嘲讽一切并不伟大。我使用一个经验法则，如果一个测试中有超过 3 个模拟，就应该重新测试。要么是测试范围太广，要么是函数太大。也许它不需要在单元测试级别进行测试，作为集成测试就足够了。不管怎样，这都是值得讨论的。

*   **满足需求:**通常作为评审结束的一部分，我会看一下工作所针对的故事、任务或 bug 的需求。如果它不符合其中一个标准，最好在它进入 QA 之前将其退回。

## 首先检查你自己的代码

在提交我的代码之前，我通常会对受影响的文件/目录做一个`git add`，然后运行一个`git diff --staged`来检查我还没有提交的更改。通常我会寻找这样的东西:

*   我是否留下了评论或待办事项？
*   那个变量名有意义吗？
*   …以及我在上面提到的任何其他内容。

我想确保在让其他人通过代码审查之前，我会先通过自己的代码审查。从自己那里得到的笔记也比从别人那里得到的少

## 如何处理代码评审

我发现代码审查中人的部分和审查代码一样具有挑战性。我也还在学习如何处理这部分。下面是一些在讨论代码时对我有用的方法:

*   **提问:**这种方法是如何工作的？如果这个需求改变了，还有什么需要改变的呢？我们如何使它更易于维护？

*   **称赞/强化好的实践:**代码评审最重要的部分之一是奖励开发人员的成长和努力。没有什么比得到同事的赞扬感觉更好的了。我试图提供尽可能多的正面评价。

*   **亲自讨论更详细的要点:**有时，推荐的架构更改可能会很大，亲自讨论比在评论中讨论更容易。类似地，如果我在讨论一个观点，而它来来回回，我通常会亲自拿起它并结束讨论。

*   解释理由:我发现最好是既问是否有更好的选择，又证明为什么我认为它值得修复。有时，在没有背景或解释的情况下，建议的改变似乎显得过于挑剔。

*   **关注代码:**亲自从代码评审中记笔记很容易，尤其是当我们为自己的工作感到自豪的时候。我发现，讨论代码比讨论开发人员更好。它降低了阻力，而且不管怎样，它与开发人员无关，它与提高代码质量有关。

*   建议修复的重要性:我倾向于提供许多建议，并不是所有的建议都需要执行。澄清一个项目在被认为已经完成之前是否需要修复，这对评审者和被评审者都是有用的。它使评审的结果清晰可操作。

## 论心态

作为开发人员，我们负责编写可工作和可维护的代码。由于交付工作代码的压力，很容易推迟第二部分。重构不会改变设计的功能，所以不要因为建议的改变而气馁。提高代码的可维护性与修复导致 bug 的代码行同样重要。

此外，请在代码审查期间保持开放的心态。这是我觉得每个人都在纠结的事情。我也可以在代码评审中为自己辩护，因为当有人说你写的代码可以做得更好时，我会觉得这是针对个人的。

如果评审者提出了一个建议，而我没有一个明确的答案来解释为什么这个建议不应该被实施，我通常会做出改变。如果评审者问的是关于一行代码的问题，这可能意味着它将来会让其他人感到困惑。此外，进行更改有助于揭示更大的架构问题或缺陷。

(感谢 Zach Schipono 建议添加此部分)

## 处理建议的更改

我们通常在每行的基础上留下评论，并在背后进行一些思考。通常，我会查看 Stash 中的评审笔记，同时将代码取出来进行建议的修改。我发现如果不马上处理，我会忘记应该处理哪些项目。

## 附加参考

有很多关于创建干净代码艺术的书。我读过的比我想要的要少(我正在努力改变这一点)。我的清单上有几本书:

**一些有用的相关演讲**我是演讲的忠实粉丝，所以这里有一些我在写这篇文章时想到的:

[关于黑客新闻的讨论](https://news.ycombinator.com/item?id=9517892)

