# HTTPS 实际上是如何工作的？罗伯特·希顿

> 原文：<http://robertheaton.com/2014/03/27/how-does-https-actually-work/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

HTTPS 只是你的标准 HTTP 协议，涂上了一层美味的 SSL/TLS 加密。除非出现可怕的错误(这是可能的)，否则它会阻止像[臭名昭著的 Eve](https://en.wikipedia.org/wiki/Alice_and_Bob#Cast_of_characters) 这样的人查看或修改构成你浏览体验的请求；它在你的计算机和你要发送这些数据的服务器之间的线路上保护你的密码、通信和信用卡信息的安全。虽然你地址栏中的绿色小挂锁和字母“https”并不意味着你和你正在浏览的网站没有足够的绳子把自己吊在别处，但它们至少可以帮助你在这样做的时候安全地交流。

### 1.什么是 HTTPS，它做什么？

HTTPS 采用了众所周知的 HTTP 协议，并在其上简单地放置了一个 SSL/TLS(以下简称为“SSL”)加密层。服务器和客户机之间仍然使用完全相同的 HTTP 协议，但是通过安全的 SSL 连接来加密和解密它们的请求和响应。SSL 层有两个主要目的:

*   验证您是否正在与您认为正在与之对话的服务器直接对话
*   确保只有服务器可以读取您发送给它的内容，只有您可以读取它发回的内容

真正聪明的是，任何人都可以拦截你与服务器交换的每一条消息，包括你同意使用的密钥和加密策略，但仍然无法读取你发送的任何实际数据。

### 2.如何建立 SSL 连接

客户端和服务器之间的 SSL 连接是通过握手建立的，其目的是:

*   以使客户端确信它正在与正确的服务器对话(或者反之亦然)
*   双方同意“密码套件”，其中包括他们将使用哪种加密算法来交换数据
*   对于已经就该算法的任何必要密钥达成一致的各方

一旦建立了连接，双方就可以使用商定的算法和密钥安全地相互发送消息。我们将把握手分成三个主要阶段——你好、证书交换和密钥交换。

1.  *Hello* -握手从客户端发送 ClientHello 消息开始。这包含服务器通过 SSL 连接到客户机所需的所有信息，包括各种密码套件和它支持的最大 SSL 版本。服务器响应一个 ServerHello，它包含客户端所需的类似信息，包括根据客户端的偏好决定将使用哪个密码套件和 SSL 版本。

2.  *证书交换*——既然联系已经建立，服务器必须向客户端证明其身份。这是通过它的 SSL 证书实现的，这有点像它的护照。SSL 证书包含各种数据，包括所有者的姓名、它所附加的属性(例如域)、证书的公钥、数字签名和关于证书有效日期的信息。客户端检查它是否隐式信任该证书，或者它是否被它也隐式信任的几个证书颁发机构(ca)之一验证和信任。很快会有更多的介绍。请注意，服务器也可以要求证书来证明客户端的身份，但这通常只发生在非常敏感的应用程序中。

3.  *密钥交换* -客户端和服务器交换的实际消息数据的加密将使用对称算法来完成，其确切性质已经在 Hello 阶段商定。对称算法使用一个密钥进行加密和解密，而非对称算法则需要一个公钥/私钥对。双方需要就这个单一的对称密钥达成一致，这个过程是使用非对称加密和服务器的公钥/私钥安全完成的。

客户端生成一个随机密钥，用于主对称算法。它使用在 Hello 阶段商定的算法和服务器的公钥(在其 SSL 证书中找到)对其进行加密。它将这个加密的密钥发送到服务器，在服务器上使用服务器的私钥对它进行解密，握手的有趣部分就完成了。双方都非常高兴，因为他们正在与正确的人交谈，并且已经秘密地商定了一个密钥来对称地加密他们将要发送给彼此的数据。HTTP 请求和响应现在可以通过形成明文消息，然后加密并发送它来发送。另一方是唯一知道如何解密该消息的人，因此中间人攻击者无法读取或修改他们可能截获的任何请求。

### 3.证书

### 3.1 信任

在最基本的层面上，SSL 证书只是一个文本文件，任何拥有文本编辑器的人都可以创建一个。事实上，你可以简单地创建一个证书，声称你是谷歌公司，你控制着 gmail.com 域名。如果这是全部的故事，那么 SSL 将是一个笑话；身份验证本质上是客户端问服务器“你是谷歌吗？”，服务器回复“呃，是的，完全正确，这里有一张写着‘我是谷歌’的纸”，客户端说“好的，这是我所有的数据。”防止这一闹剧的魔力在于数字签名，它允许一方验证另一方的文件确实是合法的。

您可能信任证书有两个合理的原因:

*   如果它在您绝对信任的证书列表中
*   如果它能够证明它受到上面列表中某个证书的控制器的信任

第一个标准很容易检查。您的浏览器预装了来自证书颁发机构(ca)的可信 SSL 证书列表，您可以从中查看、添加和删除证书。这些证书由一组(理论上和实际上)极其安全、可靠和值得信赖的组织集中控制，如 Symantec、Comodo 和 GoDaddy。如果服务器提供了该列表中的证书，那么您知道可以信任它们。

第二个标准要难得多。服务器很容易说“呃，是的，我叫呃，微软，你信任赛门铁克，呃，他们完全信任我，所以一切都很好。”稍微聪明一点的客户可能会去问赛门铁克“我这里有一个微软，他说你信任他们，这是真的吗？”但是即使赛门铁克说“是的，我们知道他们，微软是合法的”，你仍然不知道声称是微软的服务器实际上是微软还是更糟糕的东西。这就是数字签名的用武之地。

### 3.2 数字签名

如前所述，SSL 证书有一个相关的公钥/私钥对。公钥是作为证书的一部分分发的，而私钥被保护得非常安全。这对非对称密钥在 SSL 握手中用于交换另一个密钥，以便双方对称地加密和解密数据。客户端使用服务器的公钥加密对称密钥，并将其安全地发送到服务器，服务器使用其私钥解密对称密钥。任何人都可以使用公钥加密，但是只有服务器可以使用私钥解密。

对于数字签名来说，情况正好相反。证书可以由另一个权威机构“签名”，由此该权威机构有效地记录为说“我们已经核实该证书的控制者也控制证书上列出的财产(域)”。在这种情况下，授权机构使用他们的私钥(广义地说)来加密证书的内容，并且该密文作为其数字签名附在证书上。任何人都可以使用授权机构的公钥解密该签名，并验证它会产生预期的解密值。但是只有授权机构可以使用私钥加密内容，因此只有授权机构可以首先创建有效的签名。

因此，如果一台服务器声称拥有由赛门铁克(或其他 CA)签署的 Microsoft.com 证书，您的浏览器不必相信它的话。如果它是合法的，赛门铁克将使用他们的(超机密)私钥来生成服务器的 SSL 证书的数字签名，因此您的浏览器用户可以使用他们的(超公开)公钥来检查该签名是否有效。赛门铁克将采取措施，确保他们签约的组织确实拥有 Microsoft，因此，鉴于您的客户信任赛门铁克，可以肯定的是，它确实在与微软公司对话。

### 3.3 自签名

请注意，所有根 CA 证书都是“自签名”的，这意味着数字签名是使用证书自己的私钥生成的。根 CA 的证书本质上并没有什么特别之处——如果您愿意，您可以生成自己的自签名证书，并使用它来签署其他证书。但是由于您的随机证书没有作为 CA 预先加载到任何地方的任何浏览器中，所以没有人会信任您签署您自己的或其他的证书。你实际上是在说“呃，是的，我完全是微软，这是我自己签发的官方身份证明”，所有正常运行的浏览器都会抛出一个非常可怕的错误消息来回应你的可疑凭证。

这给所有浏览器和操作系统发行商带来了巨大的负担，他们只能信任非常干净的根 ca，因为他们的用户最终会信任这些组织来审查网站并保护证书的安全。这不是一件容易的事情。

### 3.4 你信任什么？

有趣的是，从技术上来说，您的客户端并不试图验证它是否应该信任向它发送证书的一方，而是验证它是否应该信任证书中包含的公钥。SSL 证书是完全开放和公开的，因此任何攻击者都可以获得微软的证书，拦截客户端对 Microsoft.com 的请求，并向其提供合法的证书。客户会接受这一点，并愉快地开始握手。然而，当客户端对将用于实际数据加密的密钥进行加密时，它将使用来自该真实证书的真实微软公钥来进行加密。由于攻击者没有微软的私钥来解密，他们现在被卡住了。即使握手完成，他们仍然不能解密密钥，因此也不能解密客户端发送给他们的任何数据。只要攻击者没有控制可信证书的私钥，就可以维持秩序。如果客户端不知何故被骗去信任一个证书和公钥，而这个证书和公钥的私钥被攻击者控制，麻烦就开始了。

### 4.非常非常有趣的事实

### 4.1 咖啡店可以监控我的 HTTPS 网络流量吗？

没有。公钥加密的神奇之处在于，攻击者可以看到您的客户机和服务器之间交换的每一个字节的数据，但除了大概交换了多少数据之外，他们仍然不知道您在和对方说些什么。然而，在不安全的 wi-fi 网络上，您的正常 HTTP 流量仍然非常容易受到攻击，脆弱的网站可能会成为任何数量的变通办法的受害者，这些变通办法以某种方式欺骗您通过普通 HTTP 发送 HTTPS 流量，或者只是发送到完全错误的地方。例如，即使登录表单通过 HTTPS 提交用户名/密码组合，如果表单本身通过 HTTP 不安全地加载，那么攻击者可以在表单到达您的机器的途中拦截表单的 HTML，并修改它以将登录详细信息发送到他们自己的端点。

### 4.2 我的公司可以通过他们的网络监控我的 HTTPS 流量吗？

如果你也使用由你的公司控制的机器，那么是的。请记住，在每个信任链的根部都有一个隐式信任的 CA，这些机构的列表存储在您的浏览器中。您的公司可以使用他们对您的计算机的访问权限，将他们自己的自签名证书添加到此 ca 列表中。然后，他们可以拦截您所有的 HTTPS 请求，提交声称代表适当网站的证书，由他们的假 CA 签名，因此毫无疑问地受到您的浏览器的信任。由于您将使用他们不可靠的证书的公钥来加密您的所有 HTTPS 请求，他们可以使用相应的私钥来解密和检查(甚至修改)您的请求，然后将它发送到它的预定位置。他们可能不会。但是他们可以。

顺便提一下，这也是你如何使用代理来检查和修改由 iPhone 应用程序发出的无法访问的 HTTPS 请求。

### 4.3 那么拉瓦比特和联邦调查局之间发生了什么？

在 2013 年美国国家安全局泄密事件中，拉瓦比特是爱德华·斯诺登的超级安全电子邮件提供商。正如我们所见，再多的标准黑客技术也无法让 FBI 看到 Lavabit 和其客户之间的任何数据。没有 Lavabit SSL 证书的私钥，这个机构就完蛋了。然而，一位乐于助人的美国法官告诉 Lavabit 的创始人 Ladar Levison，他必须交出这把钥匙，这实际上让 FBI 可以随心所欲地窥探流量。莱维森勇敢地试图拖延时间，他交出了 11 页 4 点字体的硬拷贝中的 2560 个字符的密钥，但被勒令以有用的格式交出密钥，否则将面临每天 5000 美元的罚款，直到他交出为止。

一旦他照办了，GoDaddy，即 Lavabit CA，在(正确地)认为证书已经泄露的情况下，撤销了证书。这将 Lavabit 证书添加到证书撤销列表(CRL)中，这是一个不可信的证书列表，客户端不应再信任它来提供安全连接。受损的、自签名的或不可信的证书会导致浏览器显示一个红色的大错误消息，并阻止或完全禁止用户的进一步操作。不幸的是，浏览器将继续信任一个损坏的证书，直到他们将最新的更新拉到 CRL，这个过程在实践中显然是不完美的。

### 5.结论

HTTPS 并非牢不可破，随着针对它的新攻击被发现和压制，SSL 协议必须不断发展。但它仍然是一种令人印象深刻的传输秘密数据的强大方式，而不用担心谁会看到你的信息。当然，还有许多实现细节在这里没有提到，例如握手消息的确切格式和顺序、无需重新协商密钥和密码组就可以获得最近会话的简化握手，以及每个阶段可用的许多不同的加密选项。要记住的关键一点是，虽然 HTTPS 将数据安全地传输到目的地，但它并不能保护您(作为用户或开发人员)免受 XSS 或数据库泄漏或其他任何突发事件的影响。很高兴它支持你，但要保持警惕。用威尔·史密斯不朽的话来说，“在阴影中行走，在沉默中行动，警惕外星暴力。”

*如果你喜欢这篇文章，你可能也会喜欢[我的文章，这篇文章解释了 2015 年 SSL](https://robertheaton.com/2015/04/06/the-ssl-freak-vulnerability/) 中反常漏洞的细节。*