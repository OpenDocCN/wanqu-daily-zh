# 《糖果日本》有多少行代码？

> 原文:[https://www . candy Japan . com/幕后/多少行代码是 candy-japan？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://www.candyjapan.com/behind-the-scenes/how-many-lines-of-code-is-candy-japan?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

在日本，有许多独特的糖果在其他国家没有销售，所以我创建了一个名为 Candy Japan 的网站，每月两次向国外发送这些糖果。

当我开始的时候，还没有好的平台来启动这样的服务，因为“订阅盒”还不存在。所以我不得不自己编写代码。这篇文章是关于有多少工作被证明是。

如果你想听我讲话，这也是一个 14 分钟的 YouTube 版本。如果你想额外看看我在舞台上不自在的样子，还有一个[视频，是我在一个黑客新闻聚会上做演示时拍的。](https://www.youtube.com/watch?v=nPVK4PhioFU)

## 堆

早在 2011 年，还没有现成的订阅盒平台可供使用。甚至“订阅箱”这个术语也没有被广泛使用。为了写这个网站，我在谷歌应用引擎上使用了 Python。该网站与 PayPal 和 Recurly(信用卡中间件)集成。没有其他主要依赖，只有 MixPanel 和谷歌分析。

## 表面

[登陆页面](https://www.candyjapan.com)有 **104** 行代码支持。你觉得 Candy Japan 的整个代码库有多少行 Python 代码？把你的猜测写在某个地方，这样你就可以看到你最后有多接近了。不要在你的猜测中包括 HTML & CSS 模板，只包括 Python 代码。

除了登陆页面，还有其他用户可以看到的页面，比如 FAQ，之前发送的糖果列表和它们的缩略图生成。图片在应用引擎博客中。这些总共增加了 **337** 行代码。

## 在表面之下

如果登录页面和其他面向客户的页面只是冰山一角，那么下面是什么呢？

## PayPal 集成

![PayPal integration](../Images/dee2a1892558bef73720c13808853728.png)

有一些代码来与贝宝交谈。当我最初做这个集成时，我可以使用的 API 是一个叫做 PayPal 支付标准 NVP API 的 API。缩写词 NVP 代表名称-值对，这是一种从 PayPal 传回响应的方式，比 JSON 更痛苦。这种集成增加了 712 行代码。

## 递归积分

![Recurly integration](../Images/1772cb9cc51c7f0cd80bf47bce739c57.png)

Recurly 是介于你和信用卡支付网关之间的中间件。它被设计成易于集成，所以最终只增加了 **222** 行代码。

## 礼物卡

我觉得如果人们可以互相买礼品卡就好了。这些是预付卡，你可以购买并作为特殊链接发送给朋友。购买礼物的人甚至不需要知道接收者的送货地址。

这被证明是危险的，目前还没有启用。接下来我会告诉你为什么。无论如何，我已经为它写了 **420** 行代码。

## 欺诈检测

网上有坏人。有时会有信用卡泄露，一些零售商的数据库被黑，结果一堆有效的数字被释放到野外。坏人会利用偷来的卡号在网上商店购物。

![Fraud detection](../Images/1271ba069d921636578b69ac0054f3d4.png)

礼品卡是具有双重吸引力的欺诈目标，因为犯罪分子不仅可以检查他们的卡号是否有效，还可以获得可能具有转售价值的卡。欺诈者可能会在易贝出售这些卡，给我留下退款和一个可悲的局面，易贝的客户以为他们买的是合法的卡。

目前礼品卡被禁用，但在年终假期之前，我想重新启用它们，可能只使用贝宝，因为它更防欺诈。

为了区分坏人和好人，我有 **587** 行欺诈检测代码。

## 购物车

在经历了欺诈问题之后，我不得不停止使用 Recurly 购物车小部件，因为它不够防欺诈。

相反，我不得不实现我自己的购物车流来收集所有可能的信号，这可以帮助更准确地检测欺诈。这增加了 **510** 行代码。

![Shopping cart](../Images/2a8f05885a237b091d8c5d754efd4c1f.png)

## 船舶

在我接到订单后，我也必须实际发货。如果只有几个订阅者，手动处理它们会很容易。当你的数据库中有数百名用户和数千个过去的账户时，你需要某种系统来帮助你。

![Shipping](../Images/e2040e7f3805669e436e30ed79c0e18d.png)

我写了一些代码来检查所有的账户，并试图找出我实际上应该给谁发送糖果。这并不总是那么简单，因为也有一些边缘情况。例如，可以暂停帐户，可以对其进行手动调整。在某些情况下，如果我有充分的理由相信付款很快就会到账，我可能会想把东西发给人们，即使他们的付款还没有到账。

当你一个月制作一千个运输标签时，你最终会在实体标签上花很多钱。我又写了一些代码，试图制作一个紧凑的 PDF 文件，可以在少量的贴纸上一次性打印出来。与一次打印一个相比，这既经济又快速。

装运相关代码增加了 **1165** 行。

## 返回

有时邮局会把包裹退回给我们。地址可能是错误的，或者客户可能已经搬家或不在家接受包裹。

这是额外的工作，手动找出哪些帐户返回框，给客户发电子邮件，并调整他们的帐户。为了减少这种劳动，我在箱子上印上条形码，这样当它们被退回来的时候我们就可以扫描它们了。现在，处理一个退回的包裹只需 10 秒钟，相比之下，在数据库中搜索和手动写电子邮件需要 10 - 15 分钟。

这确实给代码库添加了 **505** 行。

![Returns](../Images/1a4c042bc6ff486ce29e8683b89220e9.png)

## 管理工具

还有各种各样的管理工具。虽然您可以直接查看数据库，但拥有查看帐户信息的工具要方便得多。您还希望能够根据姓名、地址或订阅 ID 号来搜索帐户。

此外，还需要生成报告，例如出于税收原因。这些管理工具添加了 634 行代码。

## 营销代码

如果你把一个网站放到网上，人们不会神奇地找到你。刚开始的时候，吸引访客比较容易，因为你可以在产品搜索这样的地方发布一个新的网站。一些博客也可能会覆盖你的网站，因为它是新的。

当你存在的时间长了，你的网站就不再是新闻了，人们不会听说它，除非你继续推广它。这既费钱又费力。你最终会编写代码来衡量和改进你的营销。

首先，为了知道我的目标受众是谁，我在订阅流程中增加了一个问卷步骤。

你还需要知道你能在广告上花多少钱，所以你最终要计算诸如留存率之类的东西。有一些方法可以让更多的访问者转化，例如 A/B 测试和向放弃购物车的人发送提醒。

另一种营销方式是向博客发送免费样品盒，但手动将这些订单添加到数据库中会令人厌烦。我每周都会收到十几个这样的请求。为了缩短处理这些问题的时间，还有一个专门针对博客作者的注册流程。对于这个流程，没有付款步骤，而是我会看看每个申请，拒绝或接受它。

所有这些营销的东西增加了 1219 行代码。

## 交易电子邮件

当有人加入时，您希望向他们发送一封自动欢迎电子邮件。当一个审阅者被接受时，你想发送一封电子邮件告诉他们。这也是一个提醒，这样当盒子到达时，他们就不会忘记写评论。

我确实有时只是为了好玩而手动联系人们，但也有自动发出的电子邮件。

这些增加了 **253** 行代码。

## 总数

**总** **8341 行**

你做得怎么样？如果您的猜测在 5000 - 15000 行之间，我会将您的猜测评为“优秀”。3000 - 30000 的话“还不错”。“咩”如果 1000 - 50000。如果你认为我用不到 1000 行就能完成，那我真是受宠若惊。5 万多？这不是汇编程序。

## 学习

我花了几个月的时间积极开发代码库，用了大约 5 年的时间逐渐添加内容。

如果你现在开始做一个盒子，我肯定会选择像 [Subbly](http://www.subbly.co) 或者 [CrateJoy](http://cratejoy.com) 这样的平台。

将我的网站分成一个 CMS(也许是 WordPress)并把订阅部分分开是有意义的。网站上的所有可见内容(常见问题、糖果图片、登录页面、博客)都可以通过 CMS 进行管理。这将减少一些试图成为 CMS 的代码，但在增加不必要的复杂性的同时做得很差。

app engine NoSQL 数据存储不适合运行报告。你最终会写出用 SQL 更好表达的 Python 代码。否则我很乐意选择 App Engine。

我不知道我怎么能预料到，但不知何故从一开始我就应该为欺诈做好准备。你至少要留意任何可疑的活动，如果你开始收到很多退款，要迅速做出反应。

## 谢谢你

如果你想让我给你寄些糖果，请务必[注册](https://www.candyjapan.com)。你可以在 [Candy Japan 博客](https://www.candyjapan.com/blog)或[我的个人博客](http://www.bemmu.com)上读到更多我的文章。我还写了一本[关于启动订阅盒](https://www.candyjapan.com/book)的书。

感谢 [Artem Olegovich](https://www.upwork.com/freelancers/~017e241d50759eba20) 的插图。