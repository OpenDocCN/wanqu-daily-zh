# 将纽约时报游戏平台转移到谷歌应用引擎| JP Robinson | NYT 公开赛

> 原文：<https://open.nytimes.com/moving-the-new-york-times-games-platform-to-google-app-engine-e9337f2c9444?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

# **将纽约时报游戏平台转移到谷歌应用引擎**



Illustration by Kevin Zweerink for The New York Times



《纽约时报》的纵横字谜自 1942 年出版以来，已经成为许多人日常生活中不可或缺的一部分。当时报在 1996 年建立第一个网站时，数字版的纵横字谜作为一个独立的数字产品紧随其后。虽然它最初是作为一个基于网络的 Java 小程序而建立的，但这个纵横字谜已经发展成为一套移动应用程序和一个完全交互式的网站，拥有超过 30 万付费订户。为了向如此多的用户提供谜题数据，并处理高级功能，如在多个设备上同步游戏进度，我们的后端系统运行在亚马逊网络服务上，具有类似于[灯的架构](https://en.wikipedia.org/wiki/LAMP_(software_bundle))。2014 年 8 月推出的[免费每日迷你](https://www.nytimes.com/crosswords/game/mini)填字游戏带来了更大的每日受众，这给我们的架构带来了很大压力。

随着填字游戏越来越受欢迎，我们的架构开始触及其处理游戏流量的规模限制。由于我们遗留系统的非弹性架构，我们需要扩大系统规模，以处理每日难题发布时晚上 10 点的高峰流量。传统堆栈依赖于需要一定程度的人工交互的技术，并且可能需要数小时来扩大和缩小规模。我们需要在几分钟内扩展。该系统通常每天只有几分钟处于高峰流量，因此这种设置对于纽约时报游戏团队来说成本非常高。幸运的是，我们《纽约时报》最近决定将所有产品开发转移到谷歌云平台，那里有各种各样的工具等待着帮助我们更快地前进并节省资金。

在购买了谷歌产品套件之后，我们决定使用 [Go](https://golang.org/) 、[谷歌应用引擎](https://cloud.google.com/appengine/)、[数据存储](https://cloud.google.com/datastore/)、 [BigQuery](https://cloud.google.com/bigquery/) 、 [PubSub](https://cloud.google.com/pubsub/) 和[容器引擎](https://cloud.google.com/container-engine/)来重建我们的系统。我将在以后的文章中更详细地讨论这个架构，但是现在，我将集中讨论应用引擎，它是我们系统的核心。

该平台自 2008 年以来一直作为平台即服务(PaaS)提供，它抽象出了 web 服务器的大部分内部工作方式，允许开发人员专注于编写代码来解决他们的业务问题。以下是游戏团队利用的一些值得强调的功能:

*   **本地开发**:谷歌提供了一个 SDK，使用户能够通过一个命令运行一套服务以及管理界面、数据库和缓存层。
*   **结合访问和应用程序日志**:使用提供的日志库，开发人员可以编写应用程序日志，平台将这些日志绑定到谷歌云日志接口中的服务器访问日志。这极大地简化了系统调试，因为我们可以确切地看到任何给定请求中发生了什么。



Screenshot shows application logs generated by a crossword board update.



*   **监控/警报**:为了可靠地启动任何系统，开发人员需要深入了解他们系统的性能。无需任何额外的配置，该平台可以跟踪响应延迟、错误率、网络使用、内存、CPU 使用等等。一切都通过 Stackdriver 仪表板显示，该仪表板提供了基于指标数据设置警报的选项。
*   **用户认证**:通过向服务配置添加一行代码，开发者可以强制用户使用他们的 Google 凭证进行认证。谷歌还可以处理授权，因此这项服务只对特定的受众开放。
*   **HTTPS/DNS** :当一个服务被部署到 app engine 时，它立即在互联网上可用，并且在类似“https://{ service-name }-dot-{ project-name } . appspot . com”的域中启用 HTTPS。这使得开发者可以在几分钟内从概念到共享原型。
*   **PubSub 推送式订阅** : Google 的 PubSub 服务[可以配置为每当有新消息发送到订阅时，就向 HTTP 端点](https://cloud.google.com/pubsub/docs/push)发送。传统上，这需要开发人员添加额外的安全层，但 App Engine 可以为您管理。使用这个概念，我们可以轻松地将大型工作负载分散到一组服务器上，以完成离线任务，如个人统计计算和将[大量数据加载到 BigQuery 中。](https://youtu.be/3NwWiSEr4NE)

虽然我们对 App Engine 的大部分平台移植有时看起来几乎是不可思议的，但一些开箱即用的功能并不能满足我们的需求。虽然这些问题都不是阻碍因素，但我们的解决方案可能对考虑该平台的其他团队有用。

*   **部署工具**:谷歌确实提供了一些优秀的工具，用于版本控制和将代码部署到应用引擎，但我们当时使用的是[无人机 CI](http://readme.drone.io/) ，没有现有的插件，所以我们开发了一个可以与无人机和应用引擎很好地配合的插件，最近[开源了它](/continuous-deployment-to-google-cloud-platform-with-drone-7078fe0c2eaf)。
*   **API 安全性**:虽然用户认证在 App Engine 上运行良好，但是认证其他服务就有点困难了。Google 的云端点产品还不能用于 App Engine 和 Go，因此我们在服务中添加了逻辑，将 IP 地址列入白名单，以限制对非生产环境的访问。对于从一个应用引擎服务到另一个应用引擎服务的内部请求，我们依赖于[一个不可伪造的 HTTP 头](https://cloud.google.com/appengine/docs/standard/go/appidentity/#asserting_identity_to_other_app_engine_apps)。未来，我们希望在 App Engine 中依靠 Google 的 OAuth 工具。
*   **自动缩放**:自动缩放是 App Engine 的优势之一，但它确实在我们晚上 10 点的流量高峰时出现了一些问题，这可以在下面的图表中看到。



A chart displaying the Games API traffic over 7 days time. Notice the large/short spikes in the weekday evenings.



因为我们的流量峰值是可预测的，所以我们最终通过添加一个 [cron](https://cloud.google.com/appengine/docs/standard/go/config/cron) 来解决这个问题，在峰值前不久访问我们服务上的一个特殊端点，以扩大系统规模，然后再缩小到正常水平。这个特殊的端点使用 App Engine 的管理 API 来快速添加或减少额外的空闲实例，以处理流量的短暂增加。

虽然我们在大约 7 个月前迁移到 GCP，但所有游戏 API 流量都通过 App Engine 流动，90%的流量完全由 App Engine 服务和 GCP 数据库提供。

如果没有 Google 和 App Engine 提供的工具和抽象，我们的三人工程师团队不可能取得这样的成就。除了能够快速迁移到更可靠的平台，我们还设法在这段时间内将基础设施成本削减了一半。随着《纽约时报》的游戏业务继续增长，我相信我们做出了正确的选择，让我们能够轻松地快速实验、迭代和扩展。