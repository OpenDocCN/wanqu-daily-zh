# 从编写 300，000 多行基础设施代码中吸取的 5 个教训

> 原文：<https://blog.gruntwork.io/5-lessons-learned-from-writing-over-300-000-lines-of-infrastructure-code-36ba7fadeac1?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

# 5 从编写 300，000 多行基础设施代码中获得的经验

## 关于如何编写基础设施代码的简明大师班



今年 10 月，我在 HashiConf 2018 上做了一个演讲，分享了我们在 Gruntwork 创建和维护超过 300，000 行基础设施代码的[库时学到的 5 个关键经验，这些代码被数百家公司用于生产。在这篇博文中，我将与你分享演讲的视频和幻灯片，以及 5 个关键课程的浓缩书面版本。](https://gruntwork.io/infrastructure-as-code-library/)

# 视频和幻灯片





# 简介:DevOps 在石器时代

虽然这个行业充满了前沿的流行词汇——Kubernetes、微服务、服务网格、不可变的基础设施、大数据、数据湖等等——但现实是，当你在构建基础设施时，它并不*感觉*前沿。

对我来说，DevOps 的感觉更像这样:



#thisisdevops





#thisisdevops





#thisisdevops





(your company’s CI/CD pipeline) #thisisdevops



构建生产级基础设施非常困难。压力很大。而且耗时。非常耗时。

根据我们与数百家不同公司合作时收集的经验数据，以下是您预计下一个基础设施项目大概需要多长时间:



# 第 1 课:生产级基础架构清单

DevOps 项目*总是*比你预期的要长。*总*。这是为什么呢？

嗯，第一个原因是[牦牛毛](https://seths.blog/2005/03/dont_shave_that/)，在这个来自*马尔科姆(中间:*的片段中可以很好地说明这一点



第二个原因是，建设生产级基础设施(你可以把公司押在这种基础设施上)涉及上千个细节。绝大多数开发人员不知道这些细节是什么，所以当你评估一个项目时，你通常会忘记一些关键的——也是耗时的——细节。

为了避免这一问题，每次您着手处理一个新的基础设施时，请仔细检查以下清单:



不是每一个基础设施都需要列表中的每一项，但是您应该有意识地、明确地记录您已经实现了哪些项目，决定跳过哪些项目，以及为什么。

# 第 2 课:工具集

截至 2018 年，我们在 Gruntwork 使用以下主要工具来构建和管理基础设施:



1.  [**Terraform**](https://terraform.io) :我们使用 Terraform 来提供所有的基础设施，包括网络、负载平衡器、数据库、用户、权限和我们所有的服务器。
2.  [**Packer**](https://packer.io) :我们使用 Packer 来定义和构建我们在服务器上运行的虚拟机映像。
3.  [**Docker**](http://docker.com) :我们的一些服务器形成集群，我们在其中作为 Docker 容器运行应用。我们使用的主要 Docker 集群工具是 [Kubernetes](https://kubernetes.io/) 、 [ECS](https://aws.amazon.com/ecs/) 和 [Fargate](https://aws.amazon.com/fargate/) 。

现在，所有这些工具都很有用，但这不是真正的教训。真正的教训是，工具本身是不够的。你还需要改变你的团队的行为。

特别是，如果你的团队不愿意使用这些工具，或者如果你的团队没有足够的时间来学习使用这些工具，那么世界上最好的工具也不会对你的团队有任何帮助。因此，关键的一点是，将基础设施用作代码是一项投资(T0 )( T1 ):启动基础设施需要前期成本，但如果你投资明智，从长远来看，你将获得丰厚的回报。

# 第 3 课:被认为有害的大型模块

基础设施作为代码新手通常在一个文件或作为一个单元部署的一组文件中为他们的环境(开发、阶段、生产等)的*所有*的基础设施定义*所有*。这是个坏主意。

以下是一些不利因素:

1.  **慢**:如果你所有的基础设施都是在一个地方定义的，那么运行任何命令都需要很长时间。我们见过一些公司的`terraform plan`运行时间只需 5-6 分钟！
2.  **不安全**:如果你的所有基础设施都集中管理，那么要改变*的任何东西*，你需要访问*的任何东西*。这意味着几乎每个用户都必须是管理员，这是另一个坏主意。
3.  风险:如果你把所有的鸡蛋都放在一个篮子里，那么任何地方*的一个错误*都可能毁掉*的一切*。您可能对 dev 中的前端应用程序做了一个小的更改，但是由于输入错误或运行了错误的命令，您删除了生产数据库。
4.  **难以理解**:一个地方的代码越多，任何一个人就越难完全理解。但是如果它们都捆绑在一起，你不理解的部分*可能会*伤害你。
5.  **难测试**:测试基础架构代码很难；测试大量的基础设施代码几乎是不可能的。我们稍后将回到这一点。
6.  **难以回顾**:像`terraform plan`这样的命令输出变得毫无用处，因为没有人会费心去查看数千行的计划输出。此外，代码审查变得毫无用处:



简而言之，你应该用小的、独立的、可重用的、可组合的模块来构建你的代码。这不是一个新的或有争议的见解。你以前已经听过一千遍了，尽管是在稍微不同的领域:

> *“做一件事并把它做好”*——[*Unix 哲学*](https://en.wikipedia.org/wiki/Unix_philosophy#Do_One_Thing_and_Do_It_Well)
> 
> 函数的第一条规则是它们应该很小。函数的第二个规则是它们应该比那个小。”—干净代码

# 第 4 课:没有自动化测试的基础设施代码被破坏了

如果你的基础设施代码没有自动化测试，那么它就是坏的。你只是还不知道而已。也就是说，测试基础设施代码很难。您没有真正的“本地主机”(例如，您不能在您的笔记本电脑上部署 AWS VPC)，也没有真正的“单元测试”(例如，您不能将您的 Terraform 代码与“外部”世界隔离，因为所有 Terraform 都是与外部世界对话)。

因此，为了正确地测试您的基础设施代码，您通常必须将其部署到真实的环境中，运行真实的基础设施，验证它是否能做它应该做的事情，然后将其全部拆除(对于这种类型的测试，请参见 [Terratest](/open-sourcing-terratest-a-swiss-army-knife-for-testing-infrastructure-code-5d883336fcd5) ，这是一个开源库，包括用于测试 Terraform、Packer 和 Docker 代码的工具，使用 AWS、GCP 和 Kubernetes APIs，通过 SSH 在本地和远程服务器上执行 shell 命令，等等)。这意味着，对于基础设施测试，您必须稍微重新定义术语:



*   **单元测试**部署并测试一种类型的基础设施中的一个或少量密切相关的模块(例如，测试单个数据库的模块)。
*   **集成测试**部署和测试来自不同类型基础设施的多个模块，以验证它们能够正确地协同工作(例如，用来自 web 服务的模块测试数据库的模块)。
*   **端到端(e2e)测试**部署并测试您的整个架构。

请注意，该图是一个金字塔，其中有大量的单元测试、少量的集成测试和非常少量的 e2e 测试。为什么？因为每种测试需要多长时间:



基础设施测试的周期时间很慢，尤其是当你在金字塔的顶端时，所以你会想尽可能多地捕捉金字塔底层的 bug。这意味着您应该:

1.  构建小型、简单、独立的模块(还记得第 3 课吗？)并为它们编写大量的单元测试来建立您对它们正常工作的信心。
2.  将这些小的、简单的、经过实战测试的构建块结合起来，创建更复杂的基础设施，您可以用更少的集成和 e2e 测试来测试这些基础设施。

# 第 5 课:发布过程

现在让我们把这次谈话中的所有内容放在一起。从现在开始，您将如何构建和管理基础架构:

1.  仔细查看[生产级基础设施清单](#f769)以确保您正在构建正确的东西。
2.  使用 Terraform、Packer 和 Docker 等工具将基础设施定义为代码。确保您的团队有时间掌握这些工具(参见 [DevOps 资源](https://gruntwork.io/devops-resources/))。
3.  用小的、独立的、可组合的模块构建您的代码(或者使用[基础设施中现成的模块作为代码库](https://gruntwork.io/infrastructure-as-code-library/))。
4.  使用 [Terratest](https://github.com/gruntwork-io/terratest) 为你的模块编写自动化测试。
5.  提交一个拉请求，让你的代码得到审查。
6.  发布新版本的代码。
7.  从一个环境到另一个环境升级新版本代码。



*在* [*获得 DevOps 超能力。*](https://gruntwork.io/?ref=blog-lessons-learned-300k)





















