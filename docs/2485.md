# 在 Instagram 上持续部署|由 Instagram 工程| Instagram 工程

> 原文：<https://engineering.instagram.com/continuous-deployment-at-instagram-1e18548f01d1?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website#.zgdqcf151>

# 在 Instagram 上持续部署

在 Instagram，我们一天要部署 30 到 50 次后端代码……每当工程师向 master 提交更改时……大多数情况下没有人工参与。这听起来可能很疯狂，尤其是在我们的规模下，但它确实很有效。这篇文章讲述了我们是如何实现这个系统并让它顺利工作的。

# 为什么这么做？

持续部署对我们来说有很多优势:

1.  它让我们的工程师行动非常迅速。他们不局限于每天在固定时间进行几次部署；相反，他们可以随时部署代码。这意味着他们浪费的时间更少，可以非常快速地迭代变更。
2.  这使得识别不良提交变得容易得多。不再需要挖掘数十或数百个提交来寻找新错误的原因，而是将池缩小到一个，或者最多两三个。当您稍后发现问题并返回调试时，这也非常有用。指示问题的度量或数据可以用于确定准确的开始时间，并且从那里我们可以找到在那个时间部署了哪些提交。
3.  错误的提交会很快被检测到并得到处理，这意味着我们不会在 master 中以不可部署的混乱结束，也不会对其他不相关的更改造成明显的延迟。我们总是处于这样一种状态，我们可以快速地得到重要的修复。

# 履行

这种实现的成功很大程度上归功于其构造的迭代方法。我们没有在边上构建这个系统并突然切换，而是发展了当前的机制，直到它们成为连续部署。

## **在**之前它是如何工作的

在持续部署之前，工程师会临时部署变更。他们会进行更改，如果他们希望尽快部署，他们会进行首次展示。否则，他们会等待另一个工程师的到来。工程师应该事先知道如何进行小规模测试:他们将针对一台机器进行首次展示，登录该机器并检查日志，然后针对整个车队进行第二次展示。这都是作为一个结构脚本实现的，我们有一个非常基本的数据库和 UI，名为“Sauron ”,它存储了一个部署日志。

## **金丝雀和测试**

第一步是添加 canarying，它最初只是简单地编写工程师已经被期望做的事情。脚本没有针对一台机器运行单独的部署，而是部署到 canary 机器上，跟踪用户的日志，并询问它是否应该继续完全部署。接下来是对 canary 机器的一些基本分析:一个脚本为每个请求收集 HTTP 状态代码，对它们进行分类，并应用硬编码的百分比阈值(例如，小于 0.5% 5xx，至少 90% 2xx)。然而，这只会在阈值失败时警告用户。

我们已经有了一个测试套件，但是它只由工程师在他们的开发机器上运行。代码评审员不得不相信作者所说的测试通过了，我们不知道 master 中结果提交的测试状态。所以我们设置 Jenkins 在 master 中运行新提交的测试，并将结果报告给 Sauron。索伦会跟踪已经通过测试的最近一次提交，当进行首次展示时，会建议使用该提交，而不是最近一次提交。

脸书使用 Phabricator(http://phabricator.org/)进行代码审查，并有一个名为 Sandcastle 的持续集成系统，可以与 Phabricator 很好地集成。我们让 Sandcastle 在创建或更新 diff 时运行测试，并向 diff 报告结果。

## **自动化**

为了实现自动化，我们首先必须打下一些基础。我们向卷展栏添加了状态(运行、完成、错误)，并使脚本在先前的卷展栏不处于“完成”状态时发出警告。我们在 UI 中添加了一个中止按钮，将状态更改为“中止”，并让脚本偶尔检查状态并做出反应。我们还添加了完整的提交跟踪；索伦不再只知道最近一次通过测试的提交，它现在在 master 中有一个每次提交的记录，并且知道每个特定提交的测试状态。



然后，我们将人类需要做出的剩余决策自动化。第一个决定是推出哪个承诺。最初的算法是总是选择一个通过测试的提交，并选择尽可能少的提交——永远不超过三个。如果每个提交都通过了测试，那么每次都会选择一个新的提交，最多可以有两个连续的提交没有通过测试。第二个决定是首次展示是否成功。如果超过 1%的主机部署失败，将被视为失败。

在这一点上，当一切正常时，进行首次展示只需要回答几次“是”(接受建议的提交，启动金丝雀，并继续完全部署)。所以我们允许自动回答这些问题，并让 Jenkins 运行部署脚本。起初，实现这一功能的工程师只在 Jenkins 在办公桌前进行监督时才启用它，直到他们不再需要监督它。

# 问题

虽然我们在这个阶段进行了持续部署，但还不完全顺利。有几个问题需要解决。

## **测试失败**

工程师经常会遇到破坏测试的差异，这将导致所有后续的主提交也无法通过测试，从而阻止任何东西被部署。oncall 需要注意到这一点，恢复有问题的提交，等待测试通过恢复，然后在自动化可以继续之前手动推出整个 backlog。这破坏了连续部署的一个主要优势，即每次部署部署非常少的提交。这里的问题是测试既慢又不可靠。我们进行了各种优化，使测试在 5 分钟内运行，而不是 12-15 分钟，并修复了导致测试不可靠的测试基础设施问题。

## **积压**

尽管有这些改进，我们仍然经常有需要部署的变更积压。最常见的原因是金丝雀故障(假阳性和真阳性)，但偶尔也会有其他故障。当原因解决后，自动化将一次获得并部署一个提交，因此需要一段时间来清除积压，并导致新到达的差异的显著延迟。oncall 通常会介入并一次部署整个 backlog，这破坏了连续部署的主要优势之一。

为了改进这一点，我们在提交选择逻辑中实现了积压处理，这使得自动化在出现积压时部署多个提交。该算法基于设置部署每次提交的时间目标(30 分钟)。对于队列中的每个提交，它会计算达到目标的剩余时间、在这段时间内可以完成的部署数量(使用硬编码值)，以及每次部署必须部署的提交数量。它采用最大提交/首次展示值，但上限为三。这允许我们尽可能多地进行部署，同时在合理的时间内完成每次提交。

积压的一个具体原因是，随着基础架构规模的增加，部署变得越来越慢。我们到达了这样一个点，ssh-agent 绑定了一个完整的核心来认证 ssh 连接，fab master 进程也绑定了一个管理所有任务的核心。这里的解决方案是切换到脸书的分布式 SSH 系统。

# 指导原则

那么，为了实现类似于我们所做的事情，你需要什么呢？有几个关键原则使我们的系统运行良好，您可以将它们应用到您自己的系统中。

1.  测试:测试套件需要快速。它需要有像样的覆盖面，但不一定要完美。测试需要经常运行:在代码审查期间，在登陆之前(理想情况下，在失败时阻止登陆)，以及在登陆之后。
2.  金丝雀:你需要一只自动化的金丝雀来防止真正糟糕的行为被部署到整个舰队。然而，它不需要尽善尽美——甚至一组非常简单的统计数据和阈值就足够了。
3.  **自动化正常情况:**你不必自动化每一种情况；只是将已知的正常情况自动化。如果有任何异常，让自动化停止，让人类介入。
4.  让人们感到舒适:我认为这种自动化的一大障碍是当人们感到脱节和失控时。为了解决这个问题，系统需要对它已经做了什么、正在做什么以及(最好)将要做什么提供良好的可见性。它还需要良好的停止机制。
5.  **预期坏的部署:**坏的变化会出现，但没关系。您只需要快速检测到这一点，并能够快速回滚。

这是很多其他公司都可以实现的。持续部署系统不需要复杂。从关注上述原则的简单事物开始，并在此基础上进行提炼。

# 下一步是什么

这个系统目前对我们来说运行良好，但我们将面临更多的挑战，我们希望做出改进。

*   Instagram 增长迅速，因此提交率将继续上升。我们需要保持快速推出，以便每次推出都保持很少的提交。一种可能性是将首次展示分成多个阶段，并实现流水线操作。
*   随着提交率的增加，金丝雀的失败和积压将会影响越来越多的开发者。我们希望阻止更多的错误提交进入 master 并阻止部署，所以我们将 canarying 作为 Landcastle 的一部分来实现。测试通过后，Landcastle 将测试生产流量的变化，如果没有通过金丝雀阈值，land 将失败。
*   **更多数据:**我们希望提高金丝雀的检测能力，所以我们计划收集和检查更多的统计数据，如每视图功能响应代码。我们还尝试从一组控制机器收集统计数据，并将其与 canary 统计数据进行比较，而不是当前的静态阈值。
*   **改进检测:**减少不良提交的影响而不被金丝雀发现将是一件好事。我们可以在中间添加更多阶段(一个集群或一个区域)，在继续之前检查该级别的指标，而不是在一台机器上进行测试，然后部署到整个机群。

