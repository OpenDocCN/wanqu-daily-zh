# 高可用性提示。安迪·格洛弗和卡塔琳娜·普罗布斯特|网飞科技博客| Medium

> 原文:[https://medium . com/@ NetflixTechBlog/tips-for-high-avail ability-be 0472 f 2599 c？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://medium.com/@NetflixTechBlog/tips-for-high-availability-be0472f2599c?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

# 高可用性提示

安迪·格洛弗和 T2【卡塔琳娜·普罗布斯特

在过去的四年里，网飞的用户从不到 5000 万增加到了 1 . 25 亿。虽然这种增长给我们带来了大量的扩展挑战，但我们实际上在这段时间内提高了服务的整体可用性。一路走来，我们学到了很多，现在对如何使我们的系统更高可用性有了更好的理解。但是消息并不都是好的。事实是，我们通过艰难的方式吸取了许多教训:通过英雄主义，通过出问题时的疯狂争夺，有时不幸的是通过面对客户的事件。尽管我们还没有弄清楚所有的事情，仍然有很多机会来改进我们的系统，但我们希望分享一些我们已经获得的经验以及我们得出的技巧或最佳实践。希望你们中的一些人会带走一些东西，这样就可以在凌晨 3 点钟为面对客户的事件而叫醒你。

在网飞，我们已经建立并使用 [Spinnaker](http://spinnaker.io) 作为持续集成和交付的平台。这里讨论的许多最佳实践已经被编码到 Spinnaker 中，因此很容易理解。虽然在本文中，我们展示了如何在 Spinnaker 中对最佳实践进行内部编码，但是这些技巧和最佳实践更加通用，可以帮助任何人使他们的系统高度可用。

## 相比全球部署，更倾向于区域性部署

我们的目标是尽可能提供最佳的客户体验。因此，我们的目标是限制任何系统变更的影响范围，验证变更，然后向更广泛的客户推广。更具体地说，我们一次向一个 AWS 区域部署。这为我们的生产部署提供了额外的安全保障。它还让我们能够快速[将流量](https://medium.com/netflix-techblog/project-nimble-region-evacuation-reimagined-d0d0568254d4)从受影响的客户那里转移出去，这是我们最重要的补救工具之一。

我们还建议在每个区域部署之间验证应用程序功能，并避免在目标区域的高峰时段发布。

在 Spinnaker 中，指定部署的目标区域非常简单。



## 使用红/黑部署策略进行生产部署

在红/黑(也称为蓝/绿)部署中，新版本的应用程序(红色)将在通过健康检查后立即开始接收流量。一旦红色版本正常运行，之前的(黑色)版本将被禁用，不会接收任何流量。如果需要回滚，进行更改就像启用以前的版本一样简单。对于我们的服务来说，这是一个允许我们快速行动并在出现问题时返回到已知良好状态的模型。

为了使用 Spinnaker 完成红/黑部署，我们的工程师只需在他们的管道中指定策略(并可选地设置策略的参数)，Spinnaker 将负责部署。



## 使用部署窗口

每当您部署新版本的应用程序时，有两件事需要记住:首先，您(和/或您的同事)是否能够观察到部署的影响，并在需要时进行补救？第二，*如果*你的首次展示出现问题，你会将爆炸半径限制到尽可能少的客户吗？

这两个原因都表明，在部署新软件或新版本时要小心。在我们的例子中，我们的流媒体流量遵循一个相对可预测的模式，大多数人在晚上流媒体，无论他们住在哪里。我们建议在工作时间和非高峰时间为选定区域选择部署窗口。

Spinnaker 通过其管道 UI 提供了一个接口。这使您可以轻松地指定管道可以运行的日期和时间。



## 确保自动触发的部署不会在非工作时间或周末执行

部署窗口也适用于自动触发的事件。Spinnaker 允许 cron 表达式作为管道触发器。这有助于减少用户必须做的手握操作，并减少精神负担。但这也可能是一个有风险的策略:很容易形成一个激进的 cron 表达式，在下班时间或周末执行管道，这可能不是我们所期望的。无论您使用哪种自动化，都要确保任何自动触发的管道(例如，由 cron 触发的)都可以在无人值守的情况下运行。



## 启用混沌猴

[混沌猴](https://medium.com/netflix-techblog/netflix-chaos-monkey-upgraded-1d679429be5d)由网飞构建并开源，是我们混沌工程工具套件的一部分。混沌猴不可预测地自动终止生产中的实例。这作为一种强制功能，以对单实例故障有弹性的方式设计服务。如果不是这样，Chaos Monkey 将会暴露这个漏洞，以便服务所有者可以在它变成大范围的面向客户的事件之前修复它。在网飞，我们的最佳实践是，生产中的所有服务都应该启用混沌猴，这些服务的所有者应该不会发现混沌猴终止应用程序实例的问题。



## 在代码投入生产之前，使用(单元、集成、冒烟)测试和金丝雀分析来验证代码

快速移动的关键是在部署之前自动验证软件的新版本。理想情况下，运行所有必要的测试套件都可以在没有任何人工干预的情况下完成。



此外，我们建议使用金丝雀分析。金丝雀分析是根据服务的新变化来验证实时流量的有效方法。我们在网飞内部开发了一个工具，叫做 [Kayenta](https://medium.com/netflix-techblog/automated-canary-analysis-at-netflix-with-kayenta-3260bc7acc69) ，最近我们已经将它开源了。Kayenta 很容易集成到 Spinnaker 中；结合人工判断，Kayenta 是全面投产前的最后一道关卡。



## 使用您对人工干预的判断

尽可能自动化，但在适当的时候使用手动干预。例如，在将新版本投入生产之前，检查金丝雀运行的结果可能是合适的。



## 在可能的情况下，将您测试的内容准确地部署到生产环境中

既然您已经对新版本进行了大量的测试和验证，我们强烈建议您将测试过的内容部署到生产环境中。在我们的例子中，这意味着我们更喜欢从测试环境中复制一个经过验证的映像，而不是在生产环境中烘焙*一个新的映像*。

## 定期检查分页设置

有时候，你能为应用程序的可用性做的最好的事情很简单，但并不明显。当你的应用程序出了问题，而且很有可能在某个时候出问题，通知能修好它的人是很重要的。因此，请定期检查您的分页设置。这将有助于确保在发生事故时，能够迅速呼叫到合适的人员。



在内部，Spinnaker 有一个方便的“页面所有者”按钮，因此这一信息是最新的尤为重要，这样我们就不会有一种错误的安全感，即能够联系到应用程序所有者，但在我们最需要的时候发现配置已经过时了。

## 知道如何快速回滚部署

你们中的许多人会同意，即使有可靠的测试、金丝雀和其他验证，有时一些东西会被部署到生产中，从而导致问题。也许这是一个由竞争条件暴露的罕见错误，只有在大规模情况下才会被触发。无论是哪种情况，重要的是您知道如何在需要时快速回滚到已知的良好状态。

在 Spinnaker 中，如果新版本的应用出现生产问题，[可以通过服务器组操作下的回滚选项](https://www.youtube.com/watch?v=1JM-fjGZZH8)进行回滚。回滚将启用您选择的 ASG(通常是以前的)并禁用有故障的 ASG。Spinnaker 还支持创建回滚管道，可以在管道失败时执行，甚至可以手动触发。



## 当实例运行不正常时，部署失败

多年来，当部署成功时，我们有几次陷入糟糕的状态，并且出现了实例，但是它们不健康，并且事实上无法适当地处理流量。“成功的”部署给了我们一种虚假的安全感，当关键服务实际上不健康时，这种安全感很快消失，请求很快堆积起来并失败，有时会导致重试风暴和各种破坏。从这些经验中，我们了解到当实例出现但不健康时，部署失败是多么重要。

Spinnaker 有一种灵活的方法来关联实例健康。当一个实例不正常时，Spinnaker 会相应地记录下来；更重要的是，不健康的实例不会收到流量。如果 ASG 中的所有实例都不正常，Spinnaker 将会导致部署失败。为了方便操作员，Spinnaker 还用不同的颜色清楚地将实例状态标记为正在进行、正在启动、等待发现、不正常和正常，如下所示。



## 对于自动化部署，通知团队即将进行和已完成的部署

还建议让人们知道一个部署已经成功地投入生产。这对我们的成功运营至关重要。我们的最佳实践是在部署变更时始终监视您的系统。当出现问题时，重要的是要知道什么发生了变化，什么时候发生了变化。对于自动化部署来说，通知团队以便他们知道要关注服务的健康状况是特别重要的。我们在内部使用松弛信道进行通知。在 Spinnaker 中，管道可以在完成时通知操作员想要通知的任何通道。



## 自动化非典型部署情况，而不是做一次性手动工作

每个工程师都为非典型情况编写过一次性脚本。许多人遇到过这种“一次性”情况再次发生的情况，现在团队的其他人不知道这个工程师在他们的脚本中做了什么，这个脚本本来打算运行一次就被扔掉！

管道是自动化任何一系列步骤的有效手段，即使这些步骤不是日常执行的。一个例子是为紧急推送形成管道，其中提供参数来控制条件执行，例如跳过部署窗口。

不要忘记在非关键情况下定期测试您的非典型(和典型)部署管道！

## 使用前提条件来验证预期状态

我们都生活在一个系统频繁变化的世界里。在网飞，我们的数百种微服务在不断变化。做出假设，比如对其他系统的状态做出假设，可能是危险的。从我们自己的错误中学习，我们现在使用先决条件来确保当我们部署新代码或进行其他更改时假设仍然有效。这对于长时间执行的管道尤其重要(可能是由于人工判断和/或部署窗口的延迟)。使用前提条件阶段可以在潜在的破坏性操作之前验证预期状态。

## 结论

这篇文章总结了我们在网飞多年积累的各种技巧和最佳实践，通常是从我们自己的错误中学习。我们的方法是尽可能围绕这些最佳实践构建工具，因为我们已经发现，当容易“落入成功的陷阱”时，最佳实践通常会被遵循——当脆弱且令人不快的手工劳动被保持在最低限度时。

我们的目标是不断提高我们服务的可用性。对我们来说，这意味着当真正需要人工判断时，要让人类参与进来，否则就不行。通过这样做，我们将工程师的时间集中在提高可用性的任务上，同时也让他们在不需要他们参与的时候专注于其他事情。























