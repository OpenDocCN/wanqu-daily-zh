# 认真对待 PHP 松弛工程

> 原文:[https://slack . engineering/taking-PHP-serious-cf7a 60065329？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://slack.engineering/taking-php-seriously-cf7a60065329?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

Slack 的大部分服务器端应用逻辑都使用 PHP，这在当今是一个不寻常的选择。为什么我们选择用这种语言来构建一个新的项目？你应该吗？

大多数只是偶尔使用 PHP 的程序员都知道两件事:一是它是一种糟糕的语言，如果有选择的话，他们永远不会使用它；历史上一些非常成功的项目使用了它。这不太矛盾，但应该让我们好奇。脸书、维基百科、WordPress、Etsy、百度、Box 以及最近的 Slack 都成功了吗？用 Ruby 来表达他们的应用程序会更好吗？二郎？哈斯克尔。

也许不是。PHP-the-language 有许多缺陷，这无疑减缓了这些努力，但是 PHP-the-environment 的优点远远超过了这些缺陷。改进 PHP 语言层面缺陷的[选项](http://hhvm.com)是[非常令人印象深刻的](http://hacklang.org/)。总的来说，PHP 为构建、更改和操作一个成功的项目提供了比竞争环境更好的支持。我今天会用 PHP 启动一个新项目，有一两个保留意见，但没有道歉。

## 背景

现代语言中独一无二的是， **PHP 诞生于网络服务器**。它的优势与面向请求的服务器端执行环境紧密相关。

PHP 最初代表“[个人主页](http://php.net/manual/en/history.php.php)”它由拉斯马斯·勒德尔夫于 1995 年首次发布，旨在支持小型、简单的动态 web 应用程序，如 web 早期流行的留言簿和点击计数器。

从 PHP 诞生之日起，它就被用于比它的创建者预期的复杂得多的项目。它已经经历了几次大的修改，每次都带来了新的机制来处理这些更复杂的应用程序。2016 年的今天，它是混合范式开发者生产力语言( *MPDPL* )家族**[**[**1**](#9956)**】**中功能丰富的一员，该家族包括 JavaScript、Python、Ruby 和 Lua。如果您最近一次接触 PHP 是在早期，那么当代的 PHP 代码库可能会以[特性](http://php.net/manual/en/language.oop5.traits.php)、[闭包](http://php.net/manual/en/functions.anonymous.php)和[生成器](http://php.net/manual/en/language.generators.overview.php)让您大吃一惊。

## PHP 的优点

PHP 有几个非常深刻和独特的地方。

首先，**状态**。每个 web 请求都是从一张完全空白的白板开始的。它的命名空间和全局变量是未初始化的，除了提供基本功能和生命支持的标准全局变量、函数和类。通过从已知状态开始每个请求，我们得到了一种有机的故障隔离；如果请求 *t* 遇到软件缺陷并失败，这个 bug 并不直接干扰后续请求 *t+1* 的执行。当然，状态确实存在于程序堆之外的地方，而且有状态地搞乱数据库、memcache 或文件系统是可能的。但是 PHP 与所有可以想象的允许持久性的环境都有这个弱点。将请求堆相互隔离可以降低大多数程序缺陷的成本。

二、**并发**。单个 web 请求在单个 PHP 线程中运行。乍一看，这似乎是一个愚蠢的限制。但是由于您的程序是在 web 服务器的上下文中执行的，所以我们有一个自然的并发资源:web 请求。异步卷曲到本地主机(或者甚至另一个 web 服务器)提供了一种利用并行性的无共享、复制入/复制出的方式。实际上，这比大多数其他通用语言提供的锁和共享状态方法更安全，对错误更有弹性。

最后，PHP 程序在请求级别运行的事实意味着**程序员工作流**快速高效，并且随着应用程序的变化而保持快速。许多开发人员生产力语言都声称这一点，但是如果它们不为每个请求重置状态，并且主事件循环与请求共享程序级状态，它们几乎总是有一些启动时间。例如，对于一个典型的 Python 应用服务器，调试周期将类似于“思考；编辑；重新启动服务器；发送一些测试请求。”即使“重启服务器”只需要几秒钟的挂钟时间，那也要占掉[15-30 秒](http://www.simplypsychology.org/short-term-memory.html)的很大一部分，我们有限的人脑必须保持最微妙的状态。

我声称 PHP 更简单的“思考；编辑；重新加载页面”的循环使开发人员更有效率。在一个漫长而复杂的软件项目的生命周期中，这些生产率的提高是复合的。

## 反对 PHP 的案例

如果以上都是真的，为什么[都是恨](https://eev.ee/blog/2012/04/09/php-a-fractal-of-bad-design/)？当你抛开丰富多彩的夸张，关于 PHP 最常见的抱怨集中在这些根本原因上:

1.  **惊喜类型转换**。现在几乎所有的语言都允许程序员用> =运算符来比较，例如整数和浮点数；见鬼，连 C 都允许这样。目的非常清楚。不太清楚用==比较字符串和整数是什么意思，不同的语言做出了不同的选择。PHP 在这方面的选择尤其反常，导致意外和未被发现的错误。例如，123 == "123foo "的计算结果为 true(看看它在做什么？)，但是 0123 == "0123foo "是假的(嗯)。
2.  **围绕引用、值语义的不一致**。PHP 3 有一个清晰的语义，即赋值、参数传递和返回都是按值进行的，创建了所讨论数据的逻辑副本。程序员可以用一个&注释**[**[**2**](#2e75)**选择引用语义。然而，这与 PHP 4 和 PHP 5 中面向对象编程工具的引入发生了冲突。PHP 的许多 OO 符号都是从 Java 借鉴来的，Java 的语义是对象通过引用来处理，而基本类型通过值来处理。因此，PHP 语义的当前状态是对象通过引用传递(选择 Java 而不是 C++)，原始类型通过值传递(Java、C++和 PHP 都同意这一点)，但旧的引用语义和&符号仍然存在，有时会以奇怪的方式与新的世界交互。**
***   [**失败——浑然不觉**](http://people.csail.mit.edu/rinard/paper/osdi04.pdf) **哲学**。PHP 非常非常努力地保持请求运行，即使它做了一些非常奇怪的事情。例如，被零除不会抛出异常，或者返回 INF，或者致命地终止请求。默认情况下，它会发出警告并评估为 false 值。因为 false 在数字上下文中被默认为 0，所以许多应用程序在部署和运行时都被未诊断的零除。这个特殊的问题在 [PHP 7](http://php.net/manual/en/migration70.incompatible.php) 中被改变了，但是继续前进的设计冲动，超越了它可能有意义的时候，也弥漫在图书馆中。*   **标准库中的不一致性**。当 PHP 还年轻的时候，它的读者最熟悉 C，许多 API 使用 C 标准库的设计语言:六个字符的小写名称，成功和失败以整数返回值返回，而“真实”值以被调用者提供的“输出”参数返回，等等。随着 PHP 的成熟，以 _ 作为前缀的 C 风格命名空间变得更加普遍:mysql_…、json_…，等等。最近，camelCase 类上的 CamelCase 方法的 Java 风格已经成为引入新功能的最常见方式。因此，有时我们会看到将 new directory operator($ path)这样的表达式与 if(！($f = fopen($p，' w+')) …以一种不和谐的方式。**

 **以免我看起来像一个轻率的 PHP 辩护者:**这些都是严重的问题，使得缺陷更有可能**。它们是非受迫性错误。PHP 的优点和这些问题之间没有内在的平衡。应该有可能构建一个 PHP 来限制这些缺点，同时保留好的部分。

## HHVM 和哈克

PHP 的后继系统叫做[Hack](http://hacklang.org)**[**3**](#8f9f)**。****

 ****Hack 就是编程语言人们所说的 PHP 的'[渐进打字系统](http://wphomes.soic.indiana.edu/jsiek/what-is-gradual-typing/)。“类型系统”意味着它允许程序员表达关于流经代码的数据的可自动验证的不变量:这个函数接受一个字符串和一个整数，并返回一个 Fribbles 列表，就像在 Java 或 C++或 Haskell 或任何你喜欢的静态类型语言中一样。“渐进”意味着你的代码库的一些部分可以静态类型化，而其他部分仍然是杂乱无章的动态 PHP。混合它们的能力使得大型代码库能够逐步迁移。

与其在这里浪费大量的笔墨描述 Hack 的类型系统和它是如何工作的，[还不如去玩玩它](http://hacklang.org/tutorial.html)。你回来时我会在这里。

这是一个简洁的系统，在它允许你表达的内容上相当雄心勃勃。PHP 生态系统的一个独特优势是，如果项目变得超出了您最初的预期，您可以选择逐步将项目迁移到 Hack。Hack 的类型检查保留了“思考”;编辑；重新加载页面的工作流，因为类型检查器在后台运行，当它看到对文件系统的修改时，增量地更新它的代码库模型。Hack 项目提供了与所有流行的编辑器和 ide 的集成，这样当您完成键入时，关于类型错误的反馈就会出现，就像在 web 演示中一样。

让我们根据 Hack 来评估 PHP 带来的一系列实际风险:

1.  **意外类型转换**成为 Hack 文件中的错误。整类问题都消失了。
2.  通过简单的[在 Hack 中禁止旧式引用](https://docs.hhvm.com/hack/unsupported/references)来清理引用和值语义，因为它们在新的代码库中是不必要的。这留下了与 Java 或 C#相同的“引用对象”和“其他一切”的语义..
3.  PHP 的 [**失败-遗忘**](http://people.csail.mit.edu/rinard/paper/osdi04.pdf) 更多的是运行时和库的属性，像 Hack 这样的语义检查器更难直接进入这些系统。然而，在实践中，大多数形式的遗忘失败都需要惊人的类型转换才能走得很远。例如，传播从被零除返回的“假”所引起的问题最终会跨越类型检查边界**[**[**4**](#0514)**]**，这在数字上处理布尔型时会失败。这些界限在黑客代码库中更常见。通过使编写这些类型变得更容易，Hack 在实践中减少了许多错误执行的“滑行距离”。
4.  最后，标准库中的**不一致性持续存在。黑客们最希望做的就是减少用更安全的抽象来包装它们的痛苦。**

Hack 提供了一个 MPDPL 家族中其他受欢迎的成员所没有的选项:在初始开发之后引入类型系统的能力，并且只在系统中价值超过成本的部分引入。

## 嗯，嗯

Hack 最初是作为 HipHop 虚拟机(HHVM)的一部分开发的，这是一个 PHP 的开源 JIT 环境。HHVM 为成功的项目提供了另一个重要的选择:更快更经济地运行你的网站的能力。脸书[报告说](https://research.facebook.com/publications/the-hiphop-virtual-machine/)的 CPU 效率比 PHP 解释器提高了 11.6 倍，[维基百科](http://hhvm.com/blog/7205/wikipedia-on-hhvm)报告说提高了 6 倍。

Slack 最近将其 web 环境迁移到了 HHVM，所有端点的延迟都显著下降，但在撰写本文时，我们缺乏对 CPU 效率的点对点测量。我们也正在将部分代码库转移到 Hack 中，并将在此报告我们的体验。

## 展望未来

我们从一个明显的悖论开始，PHP 是一种在许多成功项目中使用的非常糟糕的语言。我们发现，孤立地看，它作为一种拙劣语言的名声是实至名归的。使用它的项目的成功更多的是与 PHP *环境*的属性以及它所支持的高节奏工作流有关，而不是与 PHP 语言有关。以及该环境的优势(通过故障隔离降低了 bug 的成本；安全并发；和高开发人员吞吐量)比该语言的缺陷所带来的问题更有价值。

此外，在 MPDPLs 中，有一个明确的迁移路径，以 Hack 和 HHVM 的形式迁移到更高性能、更安全和更易维护的介质。Slack 正处于向 HHVM 转型的后期阶段，以及向 Hack 转型的早期阶段，我们乐观地认为，他们会让我们更快地生产出更好的软件。

Slack 技术公司正在寻找优秀的技术人员加入我们。[立即申请](https://slack.com/jobs/dept/engineering)

### **注释**

1.  我创造了“MPDPL”这个术语。虽然它们之间几乎没有直接的亲缘关系，但这些语言相互之间影响很大。回顾过去的语法，它们的相似之处多于不同之处。在包括 MIPS 汇编、Haskell、C++、Forth 和 Erlang 的编程语言世界中，很难否认 MPDPLs 在语言设计领域形成了一个紧密的集群。【 [**回文**](#5a7b)
2.  不幸的是&被标记在被调用者中，而不是调用者中。所以程序员声明希望通过引用接收参数，但实际上通过引用传递参数是没有标记的。这使得在阅读代码时很难理解什么可能会改变，并使 PHP 的有效实现变得非常复杂。参见图 2 中的[http://dl.acm.org/citation.cfm?id=2660199](http://dl.acm.org/citation.cfm?id=2660199)[T3】回文 T5】](#c7a2)
3.  是的，Hack 是一个几乎不可搜索的编程语言名称。“Hacklang”有时用于可能产生歧义的情况。如果谷歌自己能说出一种更难被谷歌搜索的流行语言，为什么不呢？【 [**回文**](#eafa)
4.  默认情况下，Hack 程序中的类型检查也是在运行时强制执行的，因为它们附带了 PHP 的“类型提示”功能。这增加了 Hack 和经典 PHP 混合代码库的安全性。【 [**回文**](#ffa3)******