# 堆栈交换网络状态—停机后—2016 年 7 月 20 日

> 原文:[http://stack status . net/post/147710624694/outage-postmortem-July-20-2016？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://stackstatus.net/post/147710624694/outage-postmortem-july-20-2016?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

# 概观

2016 年 7 月 20 日，我们经历了从世界协调时 14:44 开始的 34 分钟断电。找出原因花了 10 分钟，编写修复代码花了 14 分钟，修复工作又花了 10 分钟，直到堆栈溢出再次可用。

直接原因是一个错误的帖子，导致我们的一个正则表达式消耗了我们 web 服务器上的大量 CPU。文章在主页列表中，这导致昂贵的正则表达式在每个主页视图上被调用。这导致主页停止响应不够快。因为主页是我们的负载平衡器用于运行状况检查的地方，所以整个站点变得不可用，因为负载平衡器停止了服务器的轮换。

# 后续行动

*   审核我们的正则表达式和验证后工作流中的任何类似问题
*   向我们的负载平衡器添加控件以禁用运行状况检查——因为我们相信，如果没有运行状况检查，除了主页之外的所有内容都可以访问
*   因为我们的 StackStatus Twitter 通知比我们希望的要晚，所以创建一个“停机期间做什么”清单(以及我们希望在其他一些停机工作流项目上更加一致)。

# 技术细节

正则表达式是:`^[\s\u200c]+|[\s\u200c]+$`,用于从一行的开始和结束处修剪 unicode 空格。暴露了相同问题的正则表达式的简化版本是`\s+$`，它对人来说看起来很容易(“字符串末尾的所有空格”)，但这意味着对于简单的回溯正则表达式引擎来说要做相当多的工作。这个畸形的帖子在以`-- play happy sound for player to enjoy`开头的评论行中包含了大约 20，000 个连续的空格字符。对我们来说，声音并不快乐。

如果要匹配的字符串在一行中包含 20，000 个空格字符，但不是在末尾，那么 Regex 引擎将从第一个空格开始，检查它是否属于\s 字符类，移到第二个空格，进行同样的检查，等等。在第 20，000 个空格之后，有一个不同的字符，但 Regex 引擎需要一个空格或字符串的结尾。意识到它不能像这样匹配，它回溯，并尝试从第二个空格开始匹配`\s+$`，检查 19，999 个字符。匹配再次失败，返回到第三个空格开始，依此类推。

所以 Regex 引擎必须执行“字符属于某个字符类”检查(加上一些附加的东西)20，000+19，999+19，998+…+3+2+1 = 199，990，000 次，这需要一段时间。这不是经典的灾难性回溯([谈回溯](https://href.li/?https://vimeo.com/112065252))(性能是 O(n)，长度不是指数级的)，但这已经足够了。此正则表达式已被替换为子字符串函数。