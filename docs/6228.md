# iOS 和 Android 之间共享代码的隐藏成本——Dropbox

> 原文：<https://blogs.dropbox.com/tech/2019/08/the-not-so-hidden-cost-of-sharing-code-between-ios-and-android/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

直到最近，Dropbox 还有一个通过 C++在 iOS 和 Android 之间共享代码的移动技术策略。这一策略背后的想法很简单——用 C++编写一次代码，而不是用 Java 和 Objective C 编写两次。我们在 2013 年采用了这一 C++策略，当时我们的移动工程团队相对较小，需要支持快速增长的移动路线图。我们需要找到一种方法来利用这个小团队在 Android 和 iOS 上快速发布大量代码。

我们现在已经完全放弃了这个策略，转而使用每个平台的本地语言(主要是 Swift 和 Kotlin，在我们开始的时候还不存在)。这一决定是由于与代码共享相关的(并非如此)隐性成本。以下是我们作为一家公司学到的一些关于有效共享代码的成本的东西。它们都源于同一个基本问题:

通过以非标准的方式编写代码，我们承担了额外的开销，如果我们继续使用广泛使用的平台默认值，我们就不必担心这些开销。这种开销最终比只写两次代码更昂贵。

在分解我们遇到的所有不同类型的开销之前，我想澄清一下，我们实际上从来没有达到用 C++开发大部分代码库的地步。采用 C++的开销实际上阻止了我们完全朝着这个方向前进。

同样值得注意的是，像谷歌和脸书这样的大公司已经开发可扩展的代码共享解决方案好几年了。迄今为止，这些解决方案仅获得有限采用。虽然您可以通过利用 React Native 或 Flutter 等第三方代码共享解决方案来避免下面描述的一些开销，但一些开销仍然适用(至少在这些技术中的一种获得牵引力并成熟之前)。例如， [A](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a) [irbnb sunset 他们使用](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a)[R](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a)[eact](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a)[N](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a)[ative](https://medium.com/airbnb-engineering/sunsetting-react-native-1868ba28e30a)的原因和这篇文章中描述的一样。

我们可以将面临的不同类型的开销分为四个主要类别:

## 定制框架和库的开销

使用 C++最容易预测的开销是构建框架和库的需要。这大致分为两个子类别:

*   允许我们与主机环境交互的框架，以构建一个成熟的移动应用程序。例如:
    *   [D](https://github.com/dropbox/djinni) [金妮](https://github.com/dropbox/djinni)，一个生成跨语言类型声明和接口绑定的工具
    *   一个在后台和主线程中运行任务的框架(一个用平台本地语言执行的琐碎任务)。

*   这些库将取代我们在平台本地语言中使用的默认语言/开源标准。例如:
    *   [json11](https://github.com/dropbox/json11) 用于 json(反)序列化
    *   [nn](https://github.com/dropbox/nn) ，C++的不可空指针。

如果我们坚持使用平台原生语言，这些代码都是不必要的，如果他们使用平台原生语言，我们对开源项目的贡献可能会使更多的开发人员受益。我们可能在利用开源 C++库方面做得更好，但是 C++开发社区中的开源文化曾经是(现在仍然是？)不像在移动开发社区中那样强大(尤其是在几乎不存在的 C++移动社区中)。

请注意，这些成本在 C++中特别高(相对于其他可能的非本地语言，如 Python 或 C#)，因为它缺乏一个单一的、全功能的标准库。也就是说，C/C++是唯一一种编译器同时被谷歌和苹果支持的语言，所以使用不同的语言会产生一大堆其他问题需要处理。

## 自定义开发环境的开销

移动生态系统有许多工具可用来提高开发效率。移动 ide 非常丰富，谷歌和苹果投入了大量资源，让它们成为相应平台上开发者的最佳开发体验。通过摆脱平台的默认设置，我们放弃了一些好处。最值得注意的是，使用平台的本机语言进行调试的体验通常优于通过平台的默认 IDE 使用 C++代码进行调试。

一个特别令人难忘的例子是一个错误，它导致我们的后台线程框架死锁，导致应用程序随机崩溃。即使你在一个简单的、标准的栈上工作，这些类型的错误也很难确定。因为这个问题涉及调试在 C++和 Java 之间来回运行的多线程代码，所以花了几个星期才确定下来！

除了失去工具，我们还必须投入时间来构建支持 C++代码共享的工具。最重要的是，我们需要一个定制的构建系统来创建包含 C++代码以及 Java 和 Objective-C 包装器的库，并且可以生成 Xcodebuild 和 Gradle 都能理解的目标。这个系统对我们的资源是一个很大的拖累，因为它需要不断更新以支持两个构建系统中的变化。

## 解决平台间差异的开销

尽管 iOS 和 Android 应用程序都是“移动应用程序”，通常提供相同的特性和功能，但平台本身也有一些影响实现的差异。例如，应用程序在每个平台上执行后台任务的方式是不同的。甚至当我们采用这种跨平台策略时开始相当相似的事情随着时间的推移也有了很大的不同(例如，与相机卷的交互)。

结果，你甚至不能真正地写一次代码，让它在不同的平台上运行。您必须花费大量时间将代码集成到不同的平台中，并编写特定于平台的代码(有时这些代码最终会出现在 C++层中！).

这使得只编写一次代码的理论上的好处无法兑现，从而大大降低了这种方法的好处。

## 培训、雇佣和留住开发人员的开销

最后，但绝对不是最不重要的，是培训和/或雇佣开发人员来开发我们非常定制的堆栈的成本。当 Dropbox 开始这个移动战略时，我们有一个经验丰富的 C++开发人员核心团队。这个小组启动了 C++项目，并培训了 Dropbox 的其他移动开发人员如何为代码库做出贡献。

随着时间的推移，这些开发人员转到了其他团队和公司。留下来的工程师没有足够的经验来填补出现的技术领导空缺，并且越来越难以雇用具有相关 C++经验并对移动开发感兴趣的高级工程师来替代。

结果，我们最终真正缺乏维护 C++代码库的关键专业知识。恢复这种专业技能的唯一方法是大量投资于两个选项之一:

1.  寻找并聘用具备这一特定技能的候选人(我们尝试招聘这一职位已有一年多，但没有成功)
2.  用缺少的技能在内部培训移动(或 C++)工程师，当你不再有具备所需技能的人来执行培训时，这实际上是不可能的。即使在核心小组继续前进之前，移动工程师通常对学习 C++不感兴趣，所以找到可以培训的人也是一个大问题

除了招聘问题之外，开发我们自己的技术还会产生一个留住人才的问题——移动开发人员根本不想从事 C++项目。这导致许多有才华的移动工程师离开了这个项目，而不是在一个维护得不是很好的定制堆栈中苦干。总的来说，移动开发社区是非常动态的——新的技术和模式频繁出现，并被迅速采用。最好的开发人员喜欢保持他们的技能是最新的。

在拥有标准堆栈的成熟产品环境中，跟上最新最好的产品是一项挑战。为了稳定，你牺牲了采用速度。当你将自己锁定在一个定制的堆栈中，并置身于更广泛的移动生态系统之外时，这一挑战会被极大地放大。

尽管编写代码一度听起来很划算，但相关的开销使得这种方法的成本超过了收益(结果比预期的要小)。最终，我们不再通过 C++(或任何其他非标准方式)共享移动代码，而是用平台本地语言编写代码。

此外，我们希望我们的工程师有一个愉快的体验，并能够为社区做出贡献。这就是我们决定让我们的实践符合行业标准的原因。

我们在招人！如果你是一名 Android 或 iOS 工程师，对构建令人惊叹的产品并为移动生态系统做出贡献感到兴奋，那么来[加入团队](https://www.dropbox.com/jobs/search-results?utm_source=tech&utm_medium=tech_blog&utm_campaign=mobile#q=mobile&sort=relevancy)！