# Instagram 顺利迁移到 Python 3——新的堆栈

> 原文:[https://thenewstack . io/insta gram-makes-smooth-move-python-3/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://thenewstack.io/instagram-makes-smooth-move-python-3/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

每天，超过 9500 万张照片和视频在 Instagram 上被分享。这个势不可挡的以照片为中心的社交媒体平台拥有超过 6 亿注册用户，其中 4 亿人每天都很活跃。说到规模化经营:Instagram 在大多数公司做梦都想不到的水平上扼杀了它。

然而，更令人印象深刻的是，Instagram 通过在引擎盖下运行 [Python](https://www.python.org/) (在 [Django](https://www.djangoproject.com/) 的帮助下)，可靠而稳定地服务于如此惊人的流量。是的，Python——简单易学、万能的通用编程语言。业内每个人都不屑一顾地说，“是的，Python 在很多方面都很棒，可惜它没有真正的可伸缩性。”

咳咳。四个。一百。百万。用户。Per。日。Instagram 不仅已经成为世界上最大的 Python 用户，而且该公司最近转移到了零用户体验中断的 [Python 3](https://www.python.org/download/releases/3.0/) 。Instagram 工程师[丁辉](https://www.linkedin.com/in/hui-ding-76825911/)和[郭美孜](https://www.linkedin.com/in/lisa-guo-5b56972/)与新堆栈对话，分享对 Python 的热爱，描述 Python 3 迁移体验。

Instagram 最初是如何从 Python 开始的？

**丁辉**:我加入 Instagram，成为收购后第一个被聘用的工程师【Instagram 成立于 2010 年，2012 年被脸书收购】。从那时起，我们的工程师从 6 名增加到 300 名。一开始我不在那里，但在早期我们还是一个非常小的团队时，我与[Instagram 联合创始人] [迈克·克里格](https://www.linkedin.com/in/mikekrieger/)密切合作，所以我对我们为什么选择 Python 的历史有很多了解。

原因与 Instagram 的工程格言“首先做简单的事情”一致:Python 对工程师来说是用户友好的——很容易达到速度并推出产品，使团队能够专注于面向用户的功能。Python 简单干净，偏向实用主义。这是一项成熟的技术。最后，它是一种非常流行的语言，这使得发展工程团队更加容易。

哪些问题促使 Instagram 考虑新的堆栈？

丁:随着我们的成长，很明显 Python 无论如何都不是最快的语言。AWS 使得在我们需要增长时投入更多的机器变得更加容易，但是存在收益递减点——在某一点上，比用户增长更多的资源被用于性能回归。从现在起的三到五年内，我们预计将有十亿用户加入我们的社区，所以是时候考虑其他选择了。我们的第一个问题是，是否有足够高的回报来证明？

![](../Images/6153b3b0ea14d76acef61b1fd00ce50f.png)

Instagram 用户增长稳步上升——但没有服务器增长快。

**郭美孜**:我们面临着服务器上网络 I/O 活动增加的特殊挑战。因此，我们需要一种更加并行的方式来处理用户请求。实际上，PHP 和 Python 是脸书最受支持的生态系统，使用任何其他平台都需要学习曲线和对我们的工程师进行大量新的培训。

所以我们用 PHP 做了一个门户类型比较，PHP 被脸书的 web 服务器使用。

丁(音译):如果我们看到性能提高了几个数量级，我们可能会改变，但最终还是没有。

所以这些数字并不令人信服，而且我们已经在 Python 上有了很多工具和投资。我们已经能够通过 Python/Django 栈获得几亿用户，所以我们决定继续下去。同样重要的是，我们的工程师真的很喜欢 Python。这实际上是人们想来为我们工作的一个原因。

这是团队决定转向 Python 3 的原因吗？

丁(音译):当时的决定是，我们是投资一个已经成熟但还没有发展的语言版本，还是投资一个下一个版本的、拥有强大且不断增长的社区支持的语言？如果我们打算在未来十年继续使用 Python，我们应该投资于该语言的最新版本，这是有道理的。然后在我们决定推 Python 3 后不久，就宣布 2020 年后不再支持 v2.7。

> 性能速度不再是主要的担忧。上市速度是。—丁辉

郭:推动 Python 3 的背后有三个主要的动机。首先，Python 传统上不是一种类型化语言，所以当我们开始编写新的代码时，会有很多开发冲突。所以对我们来说，一个很大的动力是 Python v3.5 版将开始支持打字的声明——我们的开发人员对这个消息非常兴奋。

其次，网络越来越成为我们的瓶颈。

第三，Python 并不快，但是每一个更新的版本都在继续获得更快的运行时间——v 2.7，没有人努力让它更快。随着最新版本的发布，我们有了社区正在开发的版本，并且我们也开始做出贡献。

那么推送过程是什么样的呢？

郭:总共花了大概十个月的时间，分不同的阶段。

首先，团队进行了大规模的代码修改。这需要两到三个月的时间，包括用支持 Python 3 的包替换不兼容的第三方包——工作规则是，“没有 Python 3，就没有新包”——还包括删除未使用的包。

然后是单元测试，用了两个月。然后，我们在四个多月的时间里进行了缓慢但稳定的推广。到 2017 年 2 月初，我们已经完全运行 Python 3 了。

![](../Images/a67d8c1cd2bd41280db4d7888b89fa1f.png)

Instagram 的基础设施工程团队总共花了 10 个月的时间完成了向 Python 3 的迁移。

根据所有报道，事情进行得非常顺利——这个团队是如何做到天衣无缝的呢？

郭:一个重要的因素是，如果你看看我们是如何迁移的，我们会不断地将小的变化签入主分支，所以我们从不合并大的差异。修复最多的错误，让更少的用户一步一步地迭代:这是保持稳定并快速前进的关键方法。

丁:考虑到这两个版本的不兼容性，并不是没有缺陷。关键是要提前花时间，针对你的问题，全面审视你的解决方案。所以我们从剖析开始，清楚地了解潜在的好处和权衡。很好地确定问题的范围，然后做最有意义的事情。也就是说，先做简单的事情并不意味着我们行动缓慢或者我们不冒险。

![](../Images/be21adf2559a40d59718ec2bf4bfb06f.png)

移交:Python 2 和 Python 3 之间的无缝转换，不会中断用户体验。

**从那以后 Python 3 的表现如何？**

**丁**:我们并没有对 Python 3 的开箱性能有所期望。所以看到 12%的 CPU 节省(在 [uswgi](https://uwsgi-docs.readthedocs.io/en/latest/) /Django 上)和 30%的内存节省(在芹菜上)是一个惊喜。自推出以来才过了四个月，我们不期望看到持续 10%的性能改进，但这是一个非常有希望的开始。

我们使用的一个非常常见的机甲是用 Python 编写的 Thrift，我们的团队正在脸书工作以使序列化更快。

对考虑迁移到 Python 3 的工程师有什么建议吗？

**郭**:我得到的最多的问题是，“我如何说服我的经理我们应该使用 Python？”鉴于 Python 速度慢的名声，这可能很难卖出去。但是效率工作是我的专长，Python 的效率对我有很大的吸引力，所以效率是消除对速度担忧的一个地方。

**丁**:性能速度不再是首要担心的。上市速度是。

郭:所以我的建议是，从小模块开始，展示它的好处——这会让更多的人对改变感兴趣。

丁:业内人士和其他仍在艰难应对迁移的公司找到我，问我我们是如何做到这一点的。

正如 Lisa 所说:我们采用“小步前进”的方法来推动迁移，正是这种方法让迁移进行得如此顺利。这也是让 Instagram 成为世界头号视觉社交平台的方法。

<svg xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 68 31" version="1.1"><title>Group</title> <desc>Created with Sketch.</desc></svg>