# 建立账户体系。特洛伊·亨特最近发表了一篇博客… |作者:迈克·赫恩|迈克的博客

> 原文：<https://blog.plan99.net/building-account-systems-f790bf5fdbe0?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>



# 建立帐户系统

[Troy Hunt](https://www.troyhunt.com/) 最近发表了一篇名为“[现代认证指南](https://www.troyhunt.com/passwords-evolved-authentication-guidance-for-the-modern-era/)”的博客文章。它有一大堆关于你的网站应该使用什么样的密码规则的可靠建议，参考了正式的政府建议——对说服同事或老板总是有用的。

我在谷歌工作期间参与的一个项目是他们的统一账户系统([具体来说就是反劫持](https://googleblog.blogspot.ch/2013/02/an-update-on-our-war-against-account.html))。登录系统是大多数网站的一部分，所以读了 Troy 的文章后，我想到了一些关于建立登录系统的建议。

# 1.理想情况下，不要

无论您的业务是什么，用户身份验证都不是您的核心竞争力。现代登录系统被期望做很多事情。密码只是开始。如果你成功了，你最终也会想要:

*   忘记密码恢复
*   电子邮件地址验证
*   注销，这比看起来要难(见下文)
*   密码暴力强制保护
*   通过短信、手机应用程序和硬件密钥进行双重身份认证
*   帐户劫持保护(当攻击者已经知道正确的密码，而用户没有 2FA 时)
*   地区/语言/姓名/个人资料照片首选项
*   支持移动/桌面登录
*   异常活动通知
*   仅限电话登录

随着大公司提高用户期望，攻击者变得更好，努力跟上变得不切实际。幸运的是，您可以将您的身份验证外包给那些使用 OAuth 的公司。

通常，web 开发人员认为添加一个“[用脸书](https://developers.facebook.com/docs/facebook-login)登录”或“[用谷歌](https://developers.google.com/identity/sign-in/web/sign-in)登录”按钮是一种可选的好东西，只有在建立了自己的帐户系统之后才会出现。如果你读这篇文章是因为你要从头开始创建一个新网站，我认为“登录…”应该是你提供的唯一选择。如今建立自己的账户系统就像建立自己的数据中心，而不是使用 AWS。这是一种昂贵的分心。

有时人们担心，如果他们只提供“用……登录”，大的 ID 提供商可能有一天会试图偷走他们的客户。有人担心这一点的通常迹象是，你用 ID 提供商登录，然后被要求设置密码。不要担心这个——在这种不太可能发生的情况下，您可以随时将您的客户群迁移到您自己的新系统，只需通过电子邮件向他们发送一个链接。

# 2.使用电子邮件/电话号码来识别用户

不要让用户选择用户名，即使你想要像在聊天论坛上那样的用户名导向的体验。您总是通过电子邮件地址、电话号码或两者来识别用户，如果您想要不同的名称来进行用户对用户的识别(显示名称)，应该单独选择。为什么？

*   无论如何，你都要询问电子邮件地址。
*   如果用户名在你的服务中成为一种自我表达的形式，用户会希望不时地改变它。
*   用户会忘记用户名，但不会忘记他们的电子邮件/电话号码。
*   选择用户名是令人沮丧的。每次用户选择一个已经被使用的名字，一些人就会放弃，你的客户获取渠道就变窄了。
*   将用户名和显示名称分开将减少对用户显示方式施加任意限制的诱惑，比如禁止空格。

# 3.根本不要使用密码



如果你不准备 100%依赖第三方 ID 提供商，至少帮大家一个忙，不要让用户选择密码。

这并不像听起来那么愚蠢。您已经在向用户询问他们的电子邮件地址。上线后，您将在登录系统中添加的第一个功能是忘记密码恢复，它将通过电子邮件向用户发送一个可点击的链接。因此，任何可以阅读你的用户的电子邮件的人都可以以他们的身份登录，你自己的网站密码不会增加额外的安全性。

相反，跳过第一步，直接进入第二步——您的登录系统可以非常简单，只需向用户发送一个链接，单击该链接时会设置一个登录 cookie。Medium.com 就是这样做的一个例子。

只要用户可能登录到您的服务的每个设备都有电子邮件客户端，这种方法就有效。台式机、笔记本电脑、手机、平板电脑都是如此。对于游戏机或电视来说，情况并非如此，但你可能还没有把它们作为目标。如果你是，最好使用蓝牙方式的配对过程，因为这些设备没有方便的键盘。

过去有人提出，用户可能会因为缺少密码输入框而感到困惑。但是现代的谷歌登录体验是从只要求用户输入电子邮件地址开始的，所以用户不太可能再对此感到困惑了…而且好处是巨大的。

这种方法有一个额外的好处:一些用户有电话号码，但没有电子邮件地址。这在发展中国家尤其如此，所以如果这是你的网站的一个可能的目标市场，你可能最终想要支持那些只能通过手机接收代码才能登录的用户。这样的帐户根本没有密码，所以如果你假设所有用户都有密码，那就需要你回去给安全敏感的代码路径添加许多特例(这很容易导致致命的错误)。

# 4.不要使用秘密问题

如果你必须使用密码——也许你不想向你的老板解释为什么你做事情不一样——至少不要让用户使用秘密问题和答案恢复。

*   秘密问题的答案通常都是猜测出来的。用户发现很难想出只有他们自己能回答而其他人不能回答的问题。
*   预先提供的问题使猜测问题变得更糟。
*   预先提供的问题通常带有文化偏见，这使得它们对许多用户来说毫无用处(例如，“你高中的吉祥物是什么？”)
*   一些精明的用户意识到他们想不出一个难以猜测的答案，所以就把它作为第二个密码字段，这意味着当他们忘记时就无法恢复。
*   有一个很长的名单高调名人和贵宾黑客滥用密码恢复流程。你不希望这是你。

谷歌在秘密问题上存在严重问题。我的几个老同事发表了关于 it 的研究,值得阅读或观看(视频如下)



A talk on secret questions/answers at Google



一些有问题的问答示例:

*   问:最喜欢的食物。甲:比萨饼。答案永远是披萨。使用这个答案，你只需猜一次，就可以打入大约 20%的英语账户。只需猜 10 次，你就可以打入超过三分之一的有这个问题的英语账户。对于韩国账户，你可以在 10 次猜测内进入 43%的账户。
*   问:我是哪一天结婚的？ **星期四。**一个定制的问题，但有致命的缺陷——攻击者只需要猜 5 次，很少被检测为暴力破解尝试。
*   问:我出生在哪个城市？ **答:首尔。在一些国家，几乎每个人都住在少数几个大城市。观察 ID 验证 UI 所使用的语言可以大大缩小可能的城市列表。对于韩国账户，你只需要猜 10 次就能破解 40%的账户。**
*   问:我的启蒙老师叫什么名字？史密斯先生，史密斯，约翰，约翰·史密斯，约翰·史密斯，约翰·史密斯。所有这些答案都是正确的，但无法通过简单的实施来匹配。我为这类问题添加了模糊匹配，因为用户经常“几乎”答对。匹配逻辑通常需要了解问题的某些方面(Levenshtein 距离本身对于街道地址之类的东西是不够的)。祝你在你的产品支持的所有语言中好运！

毫不奇怪，专业帐户系统不仅仅使用秘密 Q/A 的知识来允许用户恢复帐户。这只是众多信号中的一个。我给你不到 2%的机会写出足够复杂的东西来解决这个问题。这就是谷歌逐步淘汰秘密问答，转而支持短信恢复的原因。基于短信的恢复有它自己的问题，但它仍然比秘密问题好得多。

# 5.避免验证码

验证码是许多登录表单的常见特征。这也是我在谷歌做的一些工作。不幸的是，现在验证码的价值非常低，而且经常执行的很糟糕。



All these CAPTCHAs are uselessly weak



关于验证码需要理解的是，它们只在对自动攻击施加非常基本的限制时有用。他们不会保护您的帐户系统免受批量注册。除了账户安全，我还花了几年时间研究谷歌注册滥用。我们经常看到垃圾邮件发送者破解数千万个最难的验证码。像 [DeathByCaptcha](http://www.deathbycaptcha.com/user/login) 这样的专业验证码解决公司混合使用 OCR 和人工解决方案。普通验证码阻止盲人注册，这可能是一个问题，但基于语音识别的验证码要么由计算机轻松解决，要么由人类解决。

验证码对于阻止密码暴力破解最有用。暴力破解可能需要对一个帐户进行数十万或数百万次尝试才能找到正确的密码。如果用户最近有一些失败的登录尝试，一个简单的方法来阻止他们而不打扰用户，就是开始抛出验证码。即使是简单的验证码也足以在机器人循环中造成一点延迟。

验证码对于停止批量帐户注册来说用处不大。建立检测和阻止系统完全是另一回事；一个我玩了几年的游戏。为了感受这有多难，去 buyaccs.com 观察地下账户卖家收取的巨大价格差异。更高的价格是由更好的防御系统造成的。除非你是五大巨头之一，否则你将无法击败我们在帐户注册安全方面所做的工作——这只是将登录外包给主要玩家的又一个理由。

如果你*仍然*想要使用验证码，使用 [reCAPTCHA](https://www.google.com/recaptcha/intro/) 并确保你的验证码被适当绑定以避免重放攻击。不要尝试自己卷或者使用在 GitHub 上找到的工具包。这种验证码总是由现代 OCR 解决，除了降低客户注册的成功率之外，什么也做不了。

# 6.外包双因素身份认证



如今，双因素认证是一个非常常见的特性。同样，做好这一点是困难的，昂贵的，你不想自己实现它。

*   短信不靠谱，尤其是在一些国家。恢复代码偶尔不会出现。最终，您会希望使用语音合成来实现电话通话，因为电话通话更加可靠，但现在您需要多语言语音合成引擎。
*   做大量的短信或电话是非常昂贵的，即使你可以协商好批量折扣。
*   人们总是会忘记自己的电话号码。如果你依赖于电子邮件地址，你的密码恢复流程会非常容易，但是一旦引入了 solid 2FA，你的密码恢复就会成为系统中最薄弱的环节。如果你不升级它，攻击者会简单地绕过它。如果你阻止它，那么你会发现…
*   攻击者可以滥用 2FA，将它添加到他们钓鱼或攻击的帐户中。这是为了防止真正的用户在恶意活动进行的同时偷回帐户。
*   电话号码容易受到移植攻击，因此趋势是要求用户设置移动应用程序或安全密钥。实现这些甚至是更多的工作，当然这两者也可能会丢失，所以您最终仍然需要一些客户支持流程来帮助他们恢复。
*   正如您所发现的，2FA 增加了许多手动客户支持工作，因为您不能再只是将用户推向电子邮件或基于秘密问答的恢复。那很贵。

其中一些问题是根本性的，但是大部分问题已经被大玩家解决了，他们将免费为你支付电话账单和客户支持人员！

尽管如此，如果你不想使用它们，有创业公司会为你解决 2FA 难题的一小部分。

# 7.不要强制更改密码

Troy 已经很好地涵盖了这一点，所以我不会在这里重复它，除了说这真的很重要。不要仅仅因为过了一段时间就要求用户更改密码。

*   一些用户不能通过这个过程，你会让用户流血。
*   有些用户会比你聪明，他们会使用诸如更改密码(一次、两次、三次)之类的技巧，然后立即将其改回旧密码，这意味着你最终会希望存储最近密码的历史以防止这种行为。但是我打赌你的第一个实现不会这样做。
*   反正也提高不了安全性。

# 8.不要使会话过期

另一个不是这样的最佳实践。将您的会话 cookies 设置为过期是很诱人的。有时候，人们认为这样可以提高安全性，原因和他们认为让人们的密码过期可以提高安全性是一样的。

*   攻击者倾向于立即执行恶意活动，因此过期没有多大帮助。
*   会话到期训练用户随机意外密码提示是正常的，这使他们难以置信地容易钓鱼。
*   随机过期的会话会产生大量错误，开发人员会在这些错误上浪费大量时间。你的网站的大部分内容都不会被编写成能够处理会话中途终止的情况，所以你必须返回并修复它们，假设你甚至注意到了所有的问题。随着用户报告难以追踪的随机剥落，过期往往会浮出水面。

# 9.记得注销

在不成熟的账户系统中，签出错误非常普遍。这听起来表面上很容易，但最明显的方法有缺陷。

*   简单地删除会话 cookie 对用户来说很方便，但是这意味着您不能从 XSS 恢复。一旦发现 XSS，您可能希望使可能被盗的会话 cookie 无效，但是如果注销只是“要求浏览器删除 cookie”，那么您就不能这样做。
*   将时间戳添加到会话 cookies 中，然后设置“最后一次退出时间”，这需要每一个操作都要检查帐户数据库，以发现用户的会话是否太旧。这可能会减慢速度，意味着开发人员会试图优化它(毕竟这样做似乎并不危险)。但是如果他们取消了对攻击者感兴趣的端点的检查，您仍然会遇到第一步中的问题。此外，这意味着退出一个浏览器或设备意味着用户退出所有浏览器或设备，这不是预期的行为。

正确的做法是用内存缓存保存一个无效会话 cookies 的列表。但对于大多数公司来说，有一种成本更低的方法已经足够好了:让用户的注销链接只是清除会话 cookie 的一种方式，仅此而已，然后让会话 cookie 过期，但每隔 5 分钟左右自动悄悄替换一次。替换过期的会话 cookie 的行为咨询数据库，以查看管理员是否已经强制注销。如果用户提供的是过期的 cookie，则要求他们再次登录。这表明，在 cookies 被盗后进行清理的情况相对较少。

# 10.将帐户电子邮件与营销邮件分开



发送密码恢复链接、注册验证等的最明显的方法就是从你公司的主电子邮件服务器发送。不幸的是，贵公司的一些人试图通过向用户发送他们不想要的商业邮件来与他们建立“关系”。

即使用户同意在注册帐户时收到这些邮件，他们中的许多人也不再需要它们，有些人会通过报告它们为垃圾邮件来解决这个问题。对于那些已经注意到只需点击几次“报告垃圾邮件”就能让邮件消失的精明用户来说，这是一个权宜之计，而无需花费任何精力去寻找微小的浅灰色白底 6pt 字体的退订链接，或者……编写邮件过滤器。

不幸的是，这种完全正常的行为会降低你的邮件域名的声誉。来自您帐户系统的邮件可能会开始进入用户的垃圾邮件文件夹。我们都见过注册或密码恢复流程上的警告，告诉我们检查我们的垃圾邮件文件夹——这就是为什么。

解决这个问题的一个方法是购买一个单独的顶级域名来发送你的帐户邮件，并确保配置 DKIM。但是有些用户会注意到这种不匹配，并报告你的邮件是网络钓鱼。最佳解决方案是从不同的 DKIM 域发送营销电子邮件，但这可能会涉及到与您的产品人员发生冲突。尽管如此……当你选择推出自己的产品时，你就接受了这种痛苦，记得吗？

# 11.保护好你的密码数据库

如果您有密码，您就有了攻击者想要的(并且经常得到的)数据库。他们并不直接关心你的公司，他们只是想要密码，这样他们就可以在更高价值的目标上使用它们。然而，数据泄露令人尴尬，即使对客户的直接影响很小，也可能导致巨额罚款。OAuth 令牌的数据库对攻击者来说没有多大价值，因此您被攻击的可能性也小得多。

# 结论

关于会计系统，我可以写得更多。捍卫你的网站免受恶意帐户黑客攻击/注册本身就是一整本书。我写不出那本书，但是如果你感兴趣的话，你可以看看我在 2012 年做的一个演讲的视频。

但是公平地说，这个任务看起来很大。这就是为什么我一直建议你咬紧牙关，把你的账户管理外包给大公司。摆弄验证码不是你的核心业务。为“注销”写设计文档不是你的核心业务。诊断忘记密码的用户流失的原因并不是你的核心业务。诊断为什么向秘鲁发送短信不可靠不是你的核心业务。你在这些事情上花的每一块钱，都是你的竞争对手在核心业务上花的每一块钱。

所以扔掉你的密码数据库，不要回头。







