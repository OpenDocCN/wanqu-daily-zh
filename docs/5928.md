# 与米开朗基罗一起在优步缩放机器学习|优步博客

> 原文:[https://eng.uber.com/scaling-michelangelo/?UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://eng.uber.com/scaling-michelangelo/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

【2017 年 9 月，我们发表了一篇文章，将 [米开朗基罗，优步的机器学习平台](https://eng.uber.com/michelangelo/) ，介绍给更广泛的技术社区。 那时，我们已经在平台 的第一个版本上有了一年多的生产经验，并且正在与我们的一些团队一起构建、部署和操作他们的机器学习(ML)系统。

随着我们平台的成熟和优步服务的增长，我们已经看到整个公司的 ML 部署呈爆炸式增长。在任何给定的时间，代表数千个模型的数百个用例被部署在平台上的生产中。每秒钟有数百万次预测，整个公司有数百名数据科学家、工程师、产品经理和研究人员致力于 ML 解决方案。

在这篇文章中，我们从平台的角度思考了过去三年中优步 ML 的发展。我们回顾了这段旅程，回顾了米开朗基罗在优步发展大联盟的历程，深入探讨了优步目前发展大联盟平台的方法和未来目标，并提供了一些经验教训。除了平台的技术方面，我们还关注对我们在优步的 ML 成功至关重要的重要组织和流程设计考虑因素。

### 三年内从零到 100

2015 年，ML 在优步并未得到广泛应用，但随着我们公司规模的扩大和服务变得更加复杂，ML 显然有机会产生变革性影响，在整个公司普遍部署 ML 的想法迅速成为战略重点。

虽然米开朗基罗的目标从一开始就是让优步的 ML 民主化，但我们从小处着手，然后逐步建立这个系统。米开朗基罗最初的重点是实现大规模批量训练和批量预测工作的生产。随着时间的推移，我们添加了集中式功能存储、模型性能报告、低延迟实时预测服务、深度学习工作流、笔记本集成、分区模型以及许多其他组件和集成。

在短短的三年里，优步从没有集中的 ML 工作和几个定制的 ML 系统发展到拥有先进的 ML 工具和基础设施，以及数百个生产 ML 用例。

#### 优步的 ML 用例

优步将 ML 用于各种各样的应用。优步并没有将 ML 应用于几个关键领域(如广告优化或内容相关性)，而是将 ML 解决方案更加均衡地推广开来。在本节中，我们将讨论过去三年中米开朗基罗精选的几个用例，强调优步 ML 的多样性和影响力:

##### 妖孽吃 [![](../Images/b2216fb1409461ef940a51c0d3bf7d38.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image4-34.png)

Uber Eats 使用许多建立在米开朗基罗基础上的机器学习模型进行数百次预测，每次打开应用程序时都会优化食客的体验。

ML-powered [排名模型基于历史数据和来自用户在应用程序中的当前会话的信息(例如，他们的搜索查询)来建议餐馆和菜单项](https://eng.uber.com/uber-eats-recommending-marketplace/) 。

使用米开朗基罗，Uber Eats 还可以根据预测的 eta、历史数据和各种实时信号来估计餐点和餐厅的到达时间。

##### 市场预测

[![](../Images/9f3baa94996e6e0ec0b1da1a7e7366dd.png)](https://eng.uber.com/wp-content/uploads/2018/11/image10.gif) 优步的市场团队利用各种 [ 时空预测模型 ](https://eng.uber.com/forecasting-introduction/) ，这些模型能够预测未来不同地点和时间的骑手需求和司机合作伙伴可用性。根据预测的供需不平衡，优步系统可以提前鼓励司机伙伴去最有机会乘车的地方。

##### 客户支持

[![](../Images/3b4bf74785b0ae1d9072823937b68be7.png)](https://eng.uber.com/wp-content/uploads/2018/11/image3.png) 优步每天大约有 1500 万次出行。人们经常将钱包或手机留在车里，或者遇到其他问题，导致每天通过我们的帮助系统收到数千张支持票。这些票据被发送给客户服务代表。 [ 米开朗基罗 ](https://eng.uber.com/cota-v2/) 内置的机器学习模型被大量用于自动化或加速响应和解决这些问题的过程的大部分。这些模型的第一个版本基于提升的树，在类似或更好的客户满意度下，将票务处理时间加快了 10%。第二个版本基于深度学习模型，实现了 6%的额外加速。

##### 行驶检查

[![](../Images/1fd33d1bae87c50d4413a8449f8294f5.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image5-12.gif) 自从 2010 年第一次优步骑行以来，GPS 数据就被用于将每一次旅行都标在地图上，这样我们就能知道你何时何地在骑行，谁在开车。但我们可以做得更多:通过利用司机智能手机中的 GPS 和其他传感器的力量，我们的技术可以检测到可能的碰撞。这项技术还可以标记除撞车以外的行程异常，在一些罕见的情况下，这些异常可能表明 [ 增加的安全风险 ](https://eng.uber.com/peloton/) 。例如，如果旅途中出现长时间的意外停车，骑手和驾驶员都会通过我们的骑行检查功能收到通知，该功能可在发生事故时提供帮助。

##### 预计到达时间

[![](../Images/8c1b95fb0bacb887c90237b939b1a9b8.png)准确的 eta 对于积极的用户体验至关重要，这些指标被输入到无数其他内部系统中，以帮助确定定价和路线。然而，众所周知，eta 很难做对。](https://eng.uber.com/wp-content/uploads/2018/11/image1.png)

优步的地图服务团队开发了一个复杂的分段路由系统，用于计算基本 ETA 值。这些基本 eta 具有一致的错误模式。地图服务团队发现，他们可以使用机器学习模型来预测这些错误，然后使用预测的错误进行纠正。随着这种模式在一个城市一个城市地推广(然后在过去几年里推广到全球)，我们看到 ETA 的准确性显著提高，在某些情况下，平均 ETA 误差减少了 50%以上。

 **##### 一键聊天 [![](../Images/e9f48076fce2c00044308c6a1efd8842.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image2-10.gif)

[一键式聊天功能](https://eng.uber.com/one-click-chat/) 通过使用自然语言处理(NLP)模型来预测和显示应用内聊天消息的最可能回复，简化了骑手和驾驶员伙伴之间的沟通。让司机伙伴只需按一下按钮就能回复骑手的聊天信息，减少了分心。

##### 无人驾驶汽车

优步的自动驾驶汽车系统使用深度学习模型来实现多种功能，包括物体检测和运动规划。建模者使用米开朗基罗的 [Horovod](https://eng.uber.com/horovod/) 在大量 GPU 机器上对大型模型进行高效的分布式训练。

[![](../Images/a444b1d92d63cc4bfd5354310bcb29ca.png)T2】](https://blogapi.uber.com/wp-content/uploads/2022/08/image11-19.png)

### 我们如何在优步扩展 ML

作为一个平台团队，我们的使命是释放 ML 的价值，并加速其在公司各个角落的应用。我们通过民主化工具和支持我们的技术团队需要来做到这一点，即优化开发速度、端到端所有权、软件工程严谨性和系统灵活性。

对于数据科学家来说，我们的工具简化了构建和部署 ML 系统的生产和操作方面，使他们能够端到端地拥有自己的工作。对于工程师来说，优步的 ML 工具简化了数据科学(特征工程、建模、评估等)。)在这些系统背后，使他们可以轻松地训练足够高质量的模型，而不需要数据科学家。最后，对于构建专业 ML 系统的经验丰富的工程团队，我们提供米开朗基罗的 ML 基础设施组件，用于可定制的配置和工作流程。

在像优步这样的公司成功扩展 ML 需要的不仅仅是正确的技术，还有重要的组织和流程设计。在这一节中，我们着眼于三大支柱的关键成功因素:组织、流程和技术。

[![](../Images/a6eb236a5c46029f17198f544bdcc991.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image7-1-13.png)

Figure 1: The core strategy pillars of the Michelangelo Machine Learning Platform.



#### 组织

对于机器学习来说，对 ML 问题的广泛变化的需求和有限的专家资源使得组织设计变得尤其重要和具有挑战性。虽然优步的一些 ML 项目由拥有多名 ML 工程师和数据科学家的团队所有，但其他项目则由很少或没有技术专业知识的团队所有。类似地，一些问题可以由新手使用普遍可用的现成算法来解决，而其他问题则需要专家使用高级技术进行调查(并且通常没有已知的解决方案)。

让合适的人处理合适的问题，对于构建高质量的解决方案并在生产中持续成功地部署这些解决方案至关重要。挑战在于分配稀缺的专家资源，并放大他们对许多不同的 ML 问题的影响。例如，如果一个新项目需要计算机视觉技术，什么样的组织结构将允许优步以与公司优先事项相一致的方式有效地分配专家资源？

几经反复，优步目前的主要角色和职责如下:

[![](../Images/c9179d77ebf7ff1f21db472588f3dab3.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image8-1-e1541116655230.png)

Figure 2: Organizational interactions of different teams in Uber’s ML ecosystem.



让我们来看看一些关键团队，以及他们如何在生产中一起设计、构建和部署新的 ML 系统。

##### 产品团队

我们发现，如果产品工程团队拥有他们在生产中构建和部署的模型，效果会最好。例如，我们的地图服务团队拥有预测优步 eta 的模型。产品团队通常配备了使用优步的 ML 平台构建和部署模型所需的全套技能。当他们需要额外的专业知识时，他们可以从研究和/或专家团队获得帮助。

产品组织有时也会有专门的团队来帮助解决平台提供的东西和特定产品工程团队需要的东西之间的差距。这些团队将集中式平台工具用于他们的用例，并使用定制的工具和工作流来填补功能空白。例如，优步市场组织中的许多团队在培训、评估和部署每个城市和产品的模型方面有类似的工作流程。一个市场团队在米开朗基罗的基础上创建了专门的工具，使得管理这些市场 ML 项目变得更加容易。

##### 专家团队

当产品工程团队遇到超出其能力或资源的 ML 问题时，他们可以向内部专家团队寻求帮助。优步的专家在不同领域拥有深厚的专业知识，如自然语言处理、计算机视觉、推荐系统、预测，并与产品工程团队合作，构建量身定制的解决方案。例如，我们的[【COTA】](https://eng.uber.com/cota/)项目就是将专家团队与产品团队结合起来，为我们的业务和客户创造巨大影响。

通常，这些项目会持续几周到几个季度。随着一个项目的风险降低，并且更接近于投入生产，产品团队通常会添加相关的全职专家来填补专业知识缺口，确保他们能够独立维护系统，并释放专家资源。

##### 研究团队

专家和产品工程团队经常与优步的人工智能研究小组 [人工智能实验室](http://uber.ai/) 接触，就问题进行合作，并帮助指导未来的研究方向。研究团队通常不拥有产品代码，但他们经常与不同的团队在应用问题上密切合作。当研究人员开发相关的新技术和工具时，平台工程团队会将它们集成到公司范围的平台中，从而使新技术能够在整个公司范围内轻松使用。

##### ML 平台团队

米开朗基罗平台团队构建并运行一个通用的 ML 工作流和工具集，产品工程团队直接使用它来构建、部署和运行机器学习解决方案。

随着我们的系统变得越来越复杂，我们解决的问题也越来越复杂，对额外的灵活性、可扩展性和特定领域的 ML 开发体验的需求也在增长。我们正在开发许多其他的、更特定于领域的平台，以解决米开朗基罗工作流工具不能很好服务的特殊用例。这些新的平台团队重用了大量现有的米开朗基罗平台，并向产品团队提供专门的 ML 开发工作流。例如，正在构建的 NLP 和计算机视觉专用平台包含特殊的可视化工具、预训练模型、元数据跟踪和其他不太适合通用平台的组件。

#### 过程

随着优步 ML 运营的成熟，许多流程已被证明对我们团队的生产力和有效性非常有用。分享 ML 最佳实践(例如，数据组织方法、实验和部署管理)和建立更结构化的过程(例如，发布评审)是指导团队和避免重复他人错误的有价值的方法。专注于内部的社区建设工作和透明的规划流程使 ML 团队在共同的目标下参与并保持一致。

##### 发布模型

设计可靠的流程以避免常见的开发陷阱并验证预期的模型行为对于在组织中安全地扩展 ML 是至关重要的。ML 系统特别容易受到意外行为、棘手的边缘案例和复杂的法律/道德/隐私问题的影响。然而，在实践中，不同用例的风险状况差异很大，需要定制的批准和启动流程。例如，启动使用匿名数据的 ETA 预测模型的自动更新比启动新的定价模型需要更少的隐私审查。

由于这些原因，产品组织(如 Uber Eats 或 Marketplace 团队)拥有其 ML 模型的发布流程。这些团队从集中的发布剧本中调整流程以适应他们的产品领域，该剧本围绕 ML 模型的试验和发布遍历一般的产品、隐私、法律和伦理主题。产品团队本身最了解不同模型行为的产品含义，并且最适合咨询相关专家来评估和消除风险。

##### 跨 ML 团队的协调计划

当需求超过了平台团队的路线图时，产品工程团队可能会产生一种渴望，即分支并构建自己的系统来满足他们的需求。需要注意的是，要确保团队有能力解决他们自己的问题，但公司也要做出良好的工程权衡，以避免分裂和技术债务。在优步，我们组建了一个由高级领导组成的内部小组，负责监督整个公司 ML 工具的发展，以确保我们做出明智的取舍，并保持长期的架构一致性。这对解决这些棘手且有时敏感的情况非常有价值。

##### 社区

在整个公司范围内推广高质量的 ML 需要一个相互联系和协作的组织。

为了建立一个内部社区，我们每年都会举办一次名为 UberML 的内部 ML 会议。我们最近接待了大约 500 名员工和 50 多个小组，他们就自己的工作发表了演讲或海报。像这样的活动使从业者能够交换想法，庆祝成就，并为未来的合作建立重要的联系。优步的团队还为优步的 ML 爱好者组织社区建设活动，包括 ML 阅读小组、谈话系列和定期的午餐，以便从建立项目的个人那里了解我们内部的一些 ML 项目。

我们对社区的关注超越了我们自身。我们的团队还通过会议、发表论文、参与开源项目以及与其他公司和学术界合作进行 ML 项目和研究，与外部 ML 社区密切合作。多年来，这个社区已经发展成为一个全球性的组织，致力于分享最佳实践，在前沿项目上进行合作，并普遍改善该领域的状况。

##### 教育

对于 ML 团队来说，不断学习是很重要的。他们需要掌握 ML 理论的最新发展，跟踪和学习内部 ML 项目，并掌握 ML 工具的使用。有效分享信息并就 ML 相关主题开展教育的适当渠道至关重要。

优步 ML 教育始于员工的第一周，在此期间，我们为所有技术人员举办 ML 和米开朗基罗训练营的特别会议。当米开朗基罗推出主要的新功能时，我们会为经常使用它们的员工举办特殊的培训课程。关键工具和用户工作流程的记录也有助于鼓励知识共享和我们平台工具的大规模采用。

公司内不同的 ML 小组也在办公时间提供支持，以应对出现的问题。这也有助于在优步从事 ML 项目的个人倾向于天生的好奇和求知欲。上面提到的许多由社区领导的计划是团队成员跟上内部和外部发展的好方法。

### 技术

任何 ML 系统的技术层面都有无数的细节需要处理。在优步，我们发现以下高级领域尤为重要:

#### 端到端工作流

早期，我们认识到在像优步这样的大公司中成功的 ML 需要的不仅仅是训练好的模型——你需要对整个工作流程的强大的、可扩展的支持。我们发现相同的工作流程适用于广泛的场景，包括传统的 ML 和深度学习；监督、非监督和半监督学习；在线学习；批量、在线和移动部署；和时间序列预测。一个工具提供一切并不重要(尽管我们就是这样做的)，但拥有一套能够处理工作流所有步骤的集成工具是很重要的。

##### 管理数据

这通常是 ML 过程中最复杂的部分，包括数据访问、特征发现、选择和转换，这些都发生在模型训练和部署模型时这些特征的管道生产过程中。在优步，我们建立了一个功能商店，允许团队共享高质量的功能，并在模型训练和部署时轻松管理这些功能的离线和在线管道，确保在线和离线版本之间的一致性。

##### 列车型号

在米开朗基罗，用户可以使用我们的 [数据科学工作台](https://eng.uber.com/dsw/) (DSW)从我们的 web UI 或 Python 训练模型。在 DSW，我们支持在 GPU 集群上进行深度学习模型的大规模分布式训练，在 CPU 集群上进行树和线性模型的训练，以及使用无数可用的 Python 工具包对各种模型进行较低规模的训练。除了训练简单的模型之外，用户还可以构建更复杂的转换管道、集合和堆叠模型。米开朗基罗还提供可扩展的网格和随机超参数搜索，以及更高效的贝叶斯黑盒超参数搜索。

##### 管理和评估模型

找到数据、算法和超参数的正确组合是一个实验性的迭代过程。快速有效地完成这一过程需要所有实验和结果的自动化。它还受益于良好的可视化工具，用于了解每个模型的性能，并能够将许多模型相互比较，以查看提高模型性能的配置和功能数据的模式。米开朗基罗管理的模型是严格管理的，版本控制的，完全可复制的，并具有丰富的模型准确性和可解释性的可视化。

[![](../Images/f8dd2bb8010553abfc46ba459eaeef77.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image9-19.png)

Figure 3: Michelangelo’s model comparison page showing a comparison of two models’ behavior across different segments and features.



##### 部署模型并进行预测

一旦训练了一个有效的模型，模型开发人员能够将模型部署到一个阶段或生产环境中是很重要的。在 Michelangelo 中，用户可以通过我们的 web UI 方便地部署模型，或者通过我们的 API 与外部自动化工具集成。在部署时，模型和相关资源被打包，然后通过 Thrift 推送到离线作业进行预定的批量预测，或者推送到在线容器进行实时请求-响应预测。对于在线和离线模型，系统会自动为来自特征存储的数据设置管道。

##### 监控数据和预测

根据历史数据对模型进行训练和初步评估。这意味着用户可以知道一个模型在过去会工作得很好。但是一旦你部署了模型并使用它对新数据进行预测，通常很难确保它仍然正确工作。模型会随着时间退化，因为世界总是在变化。此外，生产模型的数据源或数据管道中可能会有破损或错误。在这两种情况下，对生产中的模型所做的预测进行监控(并发出警报)至关重要。我们有两种方法来监控生产中的模型。最准确的方法是记录生产中做出的预测，然后将这些预测与我们的数据管道收集的结果结合起来；通过将预测与实际进行比较，我们可以计算出精确的准确性指标。如果结果不容易收集，或者我们不容易将预测与结果联系起来，第二种选择是监控特征和预测的分布，并随着时间的推移对它们进行比较。这是一种不太精确的方法，但仍然可以经常检测到特征和相应预测中有问题的变化。

#### 软件工程硕士

米开朗基罗团队的方法的一个重要原则就是把 *机器学习看成软件工程* **。** 在生产中开发和运行 ML 应该像软件工程一样迭代、严谨、经过测试、有方法论。我们发现在 ML 和软件开发之间进行类比，并且将相应的和成熟的软件开发工具和方法学的见解应用到 ML 中是非常有价值的。

例如，一旦我们认识到一个模型就像一个编译过的软件库，很明显我们想要在一个严格的、版本控制的系统中跟踪模型的训练配置，就像你对库的源代码进行版本控制一样。重要的是跟踪用于创建模型的资产和配置，以便它可以在以后被复制(和/或改进)。在深度学习模型中的迁移学习的情况下，我们跟踪整个谱系，以便在需要时可以重新训练每个模型。如果没有良好的控制和工具，我们会看到这样的情况:模型被构建和部署，但是由于数据和/或训练配置丢失而无法重现。

此外，为了确保软件正常工作，在部署软件之前进行全面的测试是很重要的；同样，我们总是在部署之前根据维持集评估模型。同样，对软件系统进行良好的监控以确保它们在生产中正确工作也很重要；这同样适用于机器学习，其中您希望在生产中监控模型，因为它们的行为可能与离线评估中的行为不同。

#### 模型开发者速度

构建有影响力的 ML 系统是一门科学，需要多次迭代才能做好。迭代速度既影响 ML 如何在组织中扩展，也影响团队在任何给定问题上的生产力。米开朗基罗团队的首要任务是让数据科学团队走得更快。我们走得越快，我们可以进行的实验越多，我们可以测试的假设越多，我们可以得到更好的结果。

下图显示了我们如何看待标准 ML 开发流程以及其中不同的反馈循环。我们一直在思考这个过程，并收紧这些循环，以便更容易、更快地进行迭代和敏捷的数据科学。

[![](../Images/19dbc2ed9b6dd1f5d71dc1101e8275a2.png)](https://blogapi.uber.com/wp-content/uploads/2022/08/image6-32.png)

Figure 4: The workflow of a machine learning project. Defining a problem, prototyping a solution, productionizing the solution and measuring the impact of the solution is the core workflow. The loops throughout the workflow represent the many iterations of feedback gathering needed to perfect the solution and complete the project.



米开朗基罗的“零对一速度**或**时间价值速度**对于 ML 如何在优步蔓延至关重要。对于新的用例，我们专注于通过微调不同能力的人的入门工作流来降低入门门槛，并通过精简的流程来建立一个基本模型并使用良好的默认设置运行。******

 ******对于现有的项目，我们关注迭代速度 **，** ，这决定了数据科学家能够以多快的速度迭代，并从离线测试或在线实验中获得对他们新模型或功能的反馈。

一些原则已经被证明对团队快速发展非常有用:

1.  解决数据问题，这样数据科学家就不需要这么做了。
    *   处理数据访问、集成、特性管理和管道经常会浪费数据科学家大量的时间。米开朗基罗的要素存储和要素管道对于解决许多数据科学家头疼的问题至关重要。
2.  自动化或提供强大的工具来加速常见流程。
3.  让部署过程变得快速而神奇。
    *   米开朗基罗将部署和监控生产中的模型和数据管道的细节隐藏在用户界面的一次点击之后。
4.  让用户用最少的代价使用他们喜欢的工具——“走向客户”。
    *   米开朗基罗允许在 Python、笔记本、CLIs 中进行交互式开发，并包括用于管理生产系统和记录的用户界面。
5.  支持协作和重用。
    *   再次强调，米开朗基罗的特征库对于团队重用其他团队已经识别和构建的重要预测特征至关重要。
6.  引导用户通过结构化的工作流程。

##### 走向客户:笔记本和 Python

当米开朗基罗开始时，最紧迫和影响最大的用例是一些规模非常大的问题，这促使我们围绕 Apache Spark(用于大规模数据处理和模型训练)和 Java(用于低延迟、高吞吐量在线服务)进行构建。这种结构对于生产培训和许多模型的部署工作得很好，但是在开销、灵活性和易用性方面还有很多需要改进的地方，尤其是在早期的原型和实验阶段。

为了提供更大的灵活性、易用性和迭代速度，我们正在将主要的模型构建工作流程转移到优步的 DSW。DSW 在一个自然的笔记本电脑界面中提供了对优步数据基础架构和计算资源的灵活、便捷的访问。它与我们的云和本地 GPU 集群的集成允许在笔记本电脑环境中快速原型化米开朗基罗就绪的 ML 模型，并在米开朗基罗中轻松保存这些模型以进行部署和扩展服务。我们正在过渡到使用 DSW 作为米开朗基罗的主要模型探索和原型界面。

为了在笔记本环境中支持我们一直通过 UI 提供的可扩展建模，我们发布了(目前在内部，但我们希望很快开源)一组扩展 Spark 的库，以提供一组自定义的 *估计器* 、 *变压器* 和 *管道* 组件，这些组件公开了用于批处理、流式处理和基于请求/响应的评分的接口这些组件可以使用 PySpark 组装，然后上传到米开朗基罗，以便使用我们的纯 Java 服务系统进行部署和服务。这将 Python 的易用性与 Spark 和 Java 的规模结合在一起。

普通 Python 建模有利于简化和访问更丰富的 ML 和数据工具包生态系统。为了解决这个问题，我们最近将米开朗基罗扩展为 [，为任何来源的任何种类的 Python 模型](https://eng.uber.com/michelangelo-pyml/) 提供更灵活的建模支持。用户在 DSW 笔记本(或其他首选的 Python 环境)中构建他们的模型，然后使用米开朗基罗 PyML SDK 将模型和依赖项打包并上传到米开朗基罗进行存储、部署和服务(批处理和在线)。

##### 深度学习的速度

深度学习模型的开发工作流程通常与其他 ML 开发工作流程有不同的要求。开发人员通常会编写更多详细的培训代码，并需要专门的计算资源(GPU)。在过去的一年里，我们一直致力于使这一过程平稳快速。

米开朗基罗现在拥有强大的工具，可以在优步自己的数据中心和各种公共云中的不同 GPU 机器上提供和运行培训工作。生产 TensorFlow 模型在我们现有的高规模米开朗基罗模型服务基础设施(现在与 [TensorFlow 服务](https://www.tensorflow.org/serving/) )或我们的 [PyML 系统](https://eng.uber.com/michelangelo-pyml/) 中提供。我们有专门的工具来帮助建模者跟踪他们的实验和开发，但是一旦一个模型被保存在米开朗基罗中，它就像系统中的任何其他模型一样被对待。

##### 通过自动调优加快模型开发

AutoTune 是优步的一款新型通用优化即服务工具。它已被集成到米开朗基罗，使建模者能够轻松使用最先进的黑盒贝叶斯优化算法，更有效地搜索一组最佳的超参数。到目前为止，它是米开朗基罗提供的不太复杂的搜索算法的一个新的推荐替代方案。这意味着在相同的训练时间或更少的训练时间内得到更精确的模型，从而得到高质量的模型。

#### 模块化和分层产品

在开发米开朗基罗的过程中，我们发现了一个矛盾，即在为最常见的 ML 工作流提供端到端支持的同时，还要灵活地支持不太常见的工作流。

最初，我们的平台和基础设施组件被合并到一个系统中。随着我们的系统变得越来越复杂，我们正在解决的问题变得越来越多样和复杂，对额外的灵活性、可扩展性和特定领域开发体验的需求增长了，这超出了单一平台所能提供的范围。

如上所述，我们通过桥梁团队解决了其中一些问题。但是一些团队希望将米开朗基罗的部分作品与他们自己的组件混合搭配到新的工作流程中。其他团队需要专门的开发工具来开发他们的用例，但是从头开始构建这些工具是没有意义的。我们对米开朗基罗的架构做了一些重大改变，以尽可能地利用我们现有的系统，同时随着 ML 在整个公司的成熟，随着需求的增长而发展:

我们还发现，对于一些问题领域，专门的开发经验是有用的。这可以像应用和评估预测模型的预构建工作流一样简单，也可以是更加定制化的东西，例如为特定计算机视觉应用构建的交互式学习和标记工具。我们希望通过允许平台开发者利用米开朗基罗的底层基础设施来支持所有这些用例。

为了解决这些问题，我们正在将米开朗基罗的基础设施分解为一个明确的基础设施层，并让团队可以利用该基础设施来构建更专业的平台，例如 NLP 或 Vision。一旦完成，我们将有两个客户群:使用米开朗基罗平台构建和部署模型的模型构建者，以及使用米开朗基罗基础设施组件构建定制解决方案或更专业平台的 ML 系统构建者。

### 吸取的主要经验教训

在过去的三年里，我们建造了米开朗基罗，并帮助在优步推广机器学习，我们从成功和失败中学到了很多。在某些情况下，我们第一次就把事情做对了，但更常见的是，需要几次迭代才能发现什么最适合我们。

*   让开发人员使用他们想要的工具。 这是一个我们花了几年时间反复思考才找到正确方法的领域。当我们开始米开朗基罗，我们首先关注最高规模的用例，因为这是我们可以产生最大影响的地方。虽然早期对 Scala、config 和基于 UI 的工作流的关注使我们能够支持大规模用例，但它使我们远离了模型开发人员已经精通的成熟的、记录良好的编程接口。因为建模工作是非常迭代的，所以关注开发速度(因此快速迭代周期)和高可伸缩性是非常重要的。我们找到了一种混合解决方案，其中我们提供了一个较难使用的高规模选项和一个非常容易使用的低规模系统。
*   数据是 ML 中最难的部分，也是最重要的部分。 建模者在培训时花费大部分时间选择和转换特性，然后构建管道将这些特性交付给生产模型。损坏的数据是生产 ML 系统中出现问题的最常见原因。在优步，我们的功能库通过允许建模者轻松共享高质量的功能，自动部署这些功能的生产管道，并随着时间的推移监控它们，解决了许多这样的问题。定义功能后，我们还可以利用优步的数据质量监控工具来确保功能数据始终正确。
*   要让开源和商业组件大规模运行可能需要付出巨大的努力。 Apache Spark 和 Cassandra 都是流行且成熟的开源项目；然而，在每一种情况下，都需要一年多的持续努力，才能使它们在优步的规模下可靠地工作。我们在商业工具包中遇到了类似的挑战，我们在早期尝试过，但最终放弃了。
*   基于用户的反馈，以长远的眼光进行迭代开发。 在我们打造米开朗基罗的过程中，我们几乎总是与客户团队密切合作开发新功能。我们将首先为一个团队很好地解决问题，一旦它在生产中成功运行，我们将为公司的其余部分推广。这个过程确保了我们构建的解决方案被实际使用。这也有助于保持团队的参与和领导的支持，因为他们看到了稳定的影响。同时，为用户可能看不到的长期赌注预留一些时间也很重要。例如，在真正有需求之前，我们就开始研究深度学习工具；如果我们等了，我们就会太迟了。
*   实时 ML 很难做好。 现有的大多数数据工具都是为离线 ETL 或在线流而构建的。目前还没有伟大的工具！–解决实时 ML 系统所需的混合在线/离线功能(批处理、流和 RPC)。作为我们特色商店的一部分，这仍然是我们优步的一大关注领域。

旅程才刚刚开始，还有很多事情要做。这是一个不断发展的空间，将会有更多的课程需要学习。如果你有兴趣解决机器学习挑战，推动规模的极限，考虑申请我们团队的 [a 角色](https://www.uber.com/careers/list/?city=all&country=all&keywords=michelangelo&subteam=all&team=all) ！

Jeremy Hermann 和 Mike Del Balso 是优步机器学习平台团队的工程和产品经理。T3】********