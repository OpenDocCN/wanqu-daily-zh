# Instagram 的性能和使用。在 Instagram，我们将性能视为…| Instagram 工程| insta gram 工程

> 原文：<https://engineering.instagram.com/performance-usage-at-instagram-d2ba0347e442?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website#.lixkea3ps>

# Instagram 的性能和使用

在 Instagram，我们将性能视为一项功能，在我们打造产品时，我们不断思考如何让事情变得更快、更高效。我们发现，提高性能实际上可以推动使用，通过做一些小的改变，我们也可以改善用户对服务的体验。在这里，我们探索了一个案例研究，在这个案例研究中，识别和修复容易实现的结果减少了网络使用，提高了客户端可靠性，减少了服务器端延迟，反过来，我们看到了应用程序范围内用户体验的改善。

## 背景

在移动客户端从我们的 cdn 下载实际媒体(即照片或视频)之前，它必须首先从我们的 Django webserver 端点获取 JSON 元数据(“媒体包”)。根据端点的不同，压缩后的响应通常为 10–60kb。每个包都包含媒体 id、关于作者的元数据、赞数、标题和最近的评论(称为“预览”或“摘要”评论)等信息。

```
{
  “status”:”ok”,
  “items”: [{
    "id": "###",
    “author”: {
      “id”: “###”,
      “profile_pic_url”: …
    },
    "like_count": 500,
    “caption”: “tbt”,
    "comments": [{
      "id": "###",
      "text": "Great pic!”,
      “user”: {
        “id”: “###”,
        “profile_pic_url”: …
      },
      {(another comment)},…
    ],
  },
  {(another media bundle)},…
   ] }
}
Simplified illustrative example of a media bundle JSON
```

当你打开 Instagram 到主 feed 时，你会注意到你在每张照片下面最多只能看到三条预览评论(除了标题)。在网格视图中(例如，在搜索浏览选项卡或用户简档中)，根本看不到预览注释。



在订阅源中每个项目有 3 个预览评论，在网格视图中没有预览评论。

然而，我们已经向客户发送了每个捆绑包多达 20 条评论。最初，这是为了优化“查看所有评论”屏幕的加载速度。但从整体来看，这似乎是一个糟糕的权衡，原因如下:

*媒体比他们的评论更常被浏览，我们应该针对常见情况进行优化。

*评论包特别重:

*   它们包含评论文本本身及其 id、时间戳和作者元数据(包括个人资料图片 URL)。
*   每个评论的作者和内容通常都是唯一的，因此压缩性能很差。

*生成个人资料图片 URL 是一项 CPU 效率低下的操作，因为我们必须动态计算正确的 CDN URL。我们加载的评论越多，我们需要生成的个人资料图片 URL 就越多。

*当用户点击“查看所有#评论”时，我们会向服务器请求新的评论！

出于这些原因，减少每个媒体包中的最大摘要评论数量似乎是一件显而易见的事情。但目前还不清楚它会对用户产生多大的影响。毕竟，这只会使每个有效载荷产生几十千字节的差异，这种差异是由照片或视频文件的大小决定的。我们假设对网络延迟的影响可以忽略不计——如果用户使用的连接足够慢，下载几千字节很重要，那么几乎任何互联网服务都可能很难使用。但是，考虑到可能的带宽和 CPU 节省，我们决定做一个实验，看看实际上是否有任何面向用户的效果。

## 实验

我们运行了一个 A/B 实验，将每个包中的总结评论的最大数量从 20 减少到 5。这将主要新闻订阅端点的中值响应大小从 15 KB 降至 10KB，而“Explore Posts”端点的中值响应大小从 46 KB 降至 23 KB。当考虑更高百分位的响应大小时，这种下降更加明显:在第 95 个百分位，主要提要端点的中值响应大小从 32 KB 下降到 16 KB。



## 结果

正如预期的那样，将有效负载的大小减少几千字节对网络延迟没有明显的影响。但它对内存使用产生了令人惊讶的影响:减少每个提要屏幕的平均内存使用量最终显著提高了整个应用程序的稳定性。Android 内存不足(OOM)错误下降了 30%！我们假设平台之间的差异源于 Android 市场:一些 Android 手机的 RAM 容量非常低，相应的内存压力也很大。

我们最受欢迎的端点(如主 feed 端点)的 CPU 使用率中值下降了 20%！这意味着服务器端墙时间平均节省了 30 毫秒(从而减少了端到端延迟)，在第 95 个百分点，我们节省了 70 毫秒的服务器端墙时间。这很重要！

## 基础设施改进

当我们在所有用户中推出这一功能时，整个 Django 车队的 CPU 下降了约 8 %, egress 下降了约 25%。出口是对站点健康状况的一种度量，这样的下降通常是令人担忧的。但在这种情况下，这是一个好迹象，表明我们正在减少基础架构的负载！

## 结果

在 A/B 测试期间，我们看到所有移动平台的应用范围印象增加了 0.7%，喜欢增加了 0.4%。这是由所有表面上的印象增加所驱动的——例如，“探索照片”印象增加了 3%以上，用户个人资料滚动增加了 2.7%。这些趋势持续了一段时间，证实了良好的性能会重新吸引用户。



*3 个月内用户档案的百分比增长滚动*

## 外卖食品

*   质疑固有的假设。在这种情况下，我们问，“为什么我们每个媒体捆绑包要发送 20 条评论？”有时候，质疑固有的假设可以让你找到唾手可得的果实。
*   **测量。**优化前，花点时间了解潜在影响。当我们检查有效负载时，我们看到了大量的注释，而概要分析让我们意识到我们可以节省 CPU。
*   **针对最常见的情况进行优化。**优化的基本原则。在这里，我们有意识地选择优化媒体负载，而不是评论负载。
*   做简单的事情。“先做简单的事”是 Instagram 的教条。在确定了潜在的问题后，我们选择了最简单和最明显的行动方案。尽管它很简单，却产生了巨大的成果。
*   **感同身受。**这是脸书经常重复的。我们在强大的网络上使用强大的手机，所以这种变化个人是察觉不到的。然而，它仍然影响了许多人。同样，值得注意的是，Android 上观察到的改进超过了 iOS。这是有道理的——安卓手机往往更便宜，功能更弱。
*   跟着你的鼻子走。在纽约 Instagram，我们主要负责对媒体进行排名(例如，我们对“探索照片”的媒体进行个性化和排名)。所以像这样的性能优化与我们的工作没有直接关系。但我们的直觉告诉我们，这将是值得追求的，在 Instagram 工作的最大好处之一是，加入一个特定的团队不会限制我们可以接触代码库的哪些部分。在合理的范围内，我们有追求任何我们认为有价值的事情的自由。

感谢郭美孜、陈皓、泰勒·基夫特、吉米·张、张康和刘沙。





