# Digg 的 v4 发布:一种源于必要性的乐观。非理性繁荣

> 原文:[https://lethain.com//digg-v4/?utm_source=wanqu.co&UTM _ campaign = Wanqu+Daily&UTM _ medium =网站](https://lethain.com//digg-v4/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

Digg 经历了艰难的一年。我们的 CEO 在我加入的前一天离开了。高级工程师鬼鬼祟祟地离开了，降低了生产率，拉走了他们剩下的朋友。欺诈性投票环绕过我们的算法，出售我们的首页访问权，并威胁我们的生命修改，以防止他们的滥用。我们为开发人员环境提供的工具坏了，没有人知道如何修复它们，所以我们重新分配新员工最近离职的同事的僵尸虚拟机。

但今天与这些无关。今天是为了扭转困扰 Digg 两年的最大问题。我们启动了对 Digg 的完全重写。我们承诺今天发布。我们一致反对进一步推迟发射。我们非常确定新版本，第四版，还没有准备好。

这一天开始了。我们太天真了。我们的教育被搁置了。

如果你有幸被邀请到我们由一间办公室改造而成的巨大仓库里，感受到这里的喧嚣，你可能会猜测这是一场庆祝活动。从 Digg v3.5 到 Digg v4 的重写已经杂乱地前进了近两年，并承诺将我们从一个单一的社区驱动的新闻聚合器转变为一个无限个性化的聚合器，通过混合你的社交图、顶级影响者和全球新闻的时代精神来驱动。

如果我们的产品需求持续到前一周，那么通往 Digg v4 的道路显然在几年前就已经建立了，当时 Digg 已经被 Google 的 Panda 算法更新所摧毁。由于搜索更新花了一个月的时间才慢慢生效，我们的运气逆转了，就像我们唾弃上帝一样:我们从第一个——也是唯一一个——盈利的月份开始下滑，一直下滑，直到我们的月流量减半。一个月，一家公司实现了为期五年的盈利，下一个月，一家公司陷入自由落体状态，即将从弱势地位融资。

发布 v4 是我们重返互联网巨头中应有位置的机会，被员工们称为“谋杀教堂”的巨大办公室被亲切地重新布置了一天。在房间的中央，一张巨大的木制桌子被放置作为“作战室”它被一圈长沙发框住，其他人会袖手旁观协助。身着黑色领带的侍者端着一盘盘寿司、精致的小点心和冰镇香槟在房间里走来走去。一个酒吧已经建成，提供各种各样的饮料。人们溜上楼去看几场乒乓球比赛。

问题是慢慢开始的。

有一次，一个热情的工程师宣称整个重写可以在两个服务器上运行，相反，我们的极简 QA 环境要大得多，我们非常接近最准确的估计是在两个服务器上启动。在发布的前一周，容量规划项目被转移到 Rich 和我身上。我们上演了一场安装 JMeter 的勇敢闹剧，并针对组成重写的复杂、密集和快速移动的沙子生成了尽可能多的性能数据。这不是我对自己的工作最不自信的时候，我记得在去学校的公交车上写了一篇读书报告，是关于我四年级时从未读过的一本书，但有可能我们是在没有太多意识到这是否会奏效的情况下开始的。

我们怀疑这不会有多大影响，因为在发布之前，我们无法在我们的数据中心订购和安装新硬件。容量就足够了，因为这是我们所拥有的一切。

上午 10:00 左右，有人问我们什么时候开始切换，Mike 很有帮助地插话说，“我们已经开始重新配置 v3 服务器了。”我们的容量如此之小，以至于我们决定重新映像所有现有的服务器，然后在新的软件堆栈中重新配置它们。从降低成本的角度来看，这是聪明的，但它所带来的乐观情绪带有疯狂的色彩。

随着重生的火焰吞噬了之前的基础设施，奇怪的事情发生了，或者也许没有发生。新网站并没有真正出现。运营团队匆匆完成了一个维护页面，我们聚集在漂亮的木桌、昂贵的椅子和令人痛苦的恐惧感周围。这是*不*进展顺利。我们没有回滚计划。与会工程师的随机自我选择决定了我们唯一可能的选择是继续前进，我们做到了。一个小时后，旧的基础设施完全消失了，取而代之的是 Digg 第四版。

服务器重新配置，维护页面哄骗访客，办公室呈现出“罗马末日”的气氛。香槟和开放的酒吧川流不息，乒乓球桌被占满，公司的其他人在一旁看着，不知道如何帮助，并接受了 Digg 最后的万福玛利亚被摸索的事实。大厅里装裱好的《福布斯》封面肯定是一个遗产，而不是一个预兆。

这一天慢慢过去，人们开始离开，但对于挤在中间桌子上的工程师来说，还有很多事情要做。我们已经成功地提供了新的网站，但它仍然负荷惊人，大多数页面无法加载。主要的瓶颈是我们的 Cassandra 集群。Rich 和我去了一个会议室，扩展了我们对 memcache 的使用，将其作为屏蔽 Cassandra 的直写缓存；几个小时后，网站的大部分内容开始为注销用户加载。

然而，登录的用户在访问网站时仍然会看到错误页面。罪魁祸首是重写的皇冠上的宝石，称为 MyNews，它提供了你的朋友与每篇文章互动的社会背景，并将所有这些活动合并到一个个性化的新闻提要中。嗯，这是应该发生的，无论如何，在这一点上，它实际做的是抛出有品味的“启动蓝”错误页面。

当天结束时，我们将用户的默认页面从 MyNews 更改为 TopNews，这是一个仍在加载的全局视图，使用户可以登录并使用该网站。我的新闻页面仍然会出错，但这足以让我们带着醉意和挫败感回家，成为我们重新开业庆典的幸存者。

第二天一早，人们陆陆续续来到办公室，我们重新分组。我的新闻彻底瘫痪了，网站每四个小时就像时钟一样失灵，在这些核心问题的背后，还有几十个更小的问题出现了。我们了解到，我们可以通过重启每个进程来修复周期性的中断，我们无法隔离出哪些是问题的根源，所以我们决定首先关注我的新闻。

我和 Rich 又一次躲在会议室里，这次的目标是从头开始重写我们的 MyNews 实现。当前版本写入了 Cassandra，其负载正在粉碎集群，破坏社交功能，并降低周围所有其他功能。我们决定重写以在 Redis 中存储数据，但是有太多的数据要存储在任何服务器中，所以我们需要推出新的实现、新的分片策略以及管理该工具的工具。

我们做到了！

在接下来的两天里，我们实现了一个分片的 Redis 集群，并成功迁移到该集群。它有一些错误——在 Digg 的剩余生命中，我会秘密地从 MyNews 集群中删除大量数据，因为我们无法正确地调整它的大小以存储必要的数据，并且我们无法就如何处理它达成一致，所以每次我都秘密地删除多余的数据以保持网站的运行——但它奏效了，我们珍贵的重写从起跑线飞出，开始一瘸一拐地沿着轨道前进。

不过这真的很难，需要每四个小时手动重启一次。追踪这个 bug 花了一个月的时间，到最后只剩下三个人在尝试。我变得如此专注于理解问题，与运营团队的 Jorge 和 Mike 一起工作，以至于我甚至不知道接下来的一个月是否还有其他人来过办公室。不理解这种破损成了一种冒犯，当大多数人离开时——大概是因为他们有一点理智而开始申请工作——我被修理它的困扰所占据。

我们做到了！

我们的 API 服务器是一个 Python Tornado 服务，它对我们的 Python 后端层(称为 Bobtail)进行 API 调用(前端是 Bobcat)，其中一个最常访问的端点用于通过名称或 id 检索用户。因为它支持通过名称或 id 进行检索，所以它将两个参数的默认值都设置为空列表。这是一件超级合理的事情！然而，Python 只在第一次计算函数时初始化默认参数，这意味着对函数的每次调用都使用相同的列表。因此，如果您改变了这些值，这些改变会跨越多个调用。

在这种情况下，每次调用它时，用户 id 和名称都会附加到默认列表中。几个小时后，这些列表开始根据每个请求检索成千上万的用户，甚至淹没了 memcache 集群。这花了很长时间，因为我们将值作为字典返回，字典总是包含必要的值，只是碰巧也包含了成千上万的无关值，所以它从来没有以明显的方式失败过。这个 bug 的影响被放大了，因为我们假设用户不会传入重复的 id，并且会愉快地为一个请求重复检索同一个 id。

我们推出了最后的关键修复，Digg V4 也全面推出。一周后，我们最后的首席执行官会加入。一个月后，我们将进行第三轮裁员。一年后，我们会卖掉公司。但在那一刻，我们赢了。

我即将迎来我的六个月纪念日。

* * *

Digg V4 有时被认为是灾难性发布的一个例子，暗示我们不应该发布它。在某一点上，我曾经同意，但这些天来，我认为我们做出了正确的决定。我们的流量显著下降，我们每个月都在损失大量资金，我们最近筹集了资金，知道我们不能轻易筹集更多。如果我们可以在推出伟大的东西和糟糕的东西之间做出选择，我们会更喜欢推出伟大的东西，但相反，我们可以选择做最后一搏，或者安静地交出球棒。

我很高兴我们做了最后一击；很自豪我们在艰难的发射中幸存下来。

另一方面，我仍然对我们在发布会上如此鲁莽感到震惊。我记得在那次会议上，我们决定继续发布，迈克强烈抗议。就我的记忆所及，我保持沉默。我希望我能从这次经历中成长，因为即使现在我也不确定这样一个有才华的组合是如何上演那场乱搞的。

<time class="f6 mv4 dib tracked" datetime="2018-07-02T06:00:00-07:00">发表于 2018 年 7 月 2 日。</time>