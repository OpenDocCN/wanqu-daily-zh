# 阿萨纳 9 月 8 日停电

> 原文:[https://blog.asana.com/2016/09/yesterdays-outage/?UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.asana.com/2016/09/yesterdays-outage/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

昨天早上，Asana 从太平洋时间早上 7:25 到 8:48，大约有 83 分钟没有活动。这是我们在过去两年中经历的最长的一次停机，就客户影响而言，也是我们经历过的最严重的一次停机。为此，我们非常抱歉。我们知道体式是我们用户工作流程的基石，这次中断浪费了你的时间。我们想告诉您我们对停电的理解，以及我们为避免将来发生类似事件所采取的措施。

中断的直接原因是我们在周三晚上部署的新代码。我们通常一天部署两次新代码，但这是一次比平常晚得多的部署，因为当天早些时候发生了一些恢复。除此之外，新的代码包括日志记录，旨在帮助提高 Asana 的安全性。然而，代码有一个 bug，导致日志记录被触发的频率大大超过了我们的预期。在部署代码的时候，这导致了我们的 web 服务器的 CPU 利用率的增加。我们有足够的上升空间，CPU 的增加不会导致任何问题，使得这个问题在周三晚上没有被注意到。

周四早上 7 点 15 分，我们第一次意识到一个问题。更高的 CPU 利用率，加上早上的流量(我们的峰值负载)，导致请求延迟增加，这导致 web 服务器保持数据库连接的时间比平时更长。我们的一些安全措施检测到连接的增加，并导致我们的非关键工作队列后退。这导致我们的搜索索引器落后了，它呼叫了我们的待命工程师。此时，Asana 还没睡。

最初，待命工程师并不了解问题的严重性，因为应用程序已启动，而且事件的影响似乎仅限于非关键工作队列。我们的调查最初以数据库为中心，因为这是问题的常见原因。在初始页面之后，我们收到了一个关于 API 关闭的附加页面。让事情变得更加混乱的是，我们的工程师都在使用 Asana 的 dogfooding 版本，它运行在与生产版本不同的 AWS-EC2 实例上。只有 Asana 的员工使用这个版本，这些机器不会超载。上午 7 点 35 分，我们的客户支持人员通知值班工程师，用户无法使用该应用程序。

上午 7:40，随叫随到的工程师确定数据库实际上是欠载。

上午 7 点 47 分，一名工程师注意到网络服务器上的日志记录在增加，但放弃了这条调查线索，因为它与正在探索的假设不匹配。

上午 7 时 57 分，问题再次升级到更广泛的工程师群体。

上午 8:02，一名随叫随到的工程师注意到网络服务器的 CPU 已经达到极限，并迅速将其与前一天晚上发布的代码联系起来。

在上午 08:08 和 08:29 之间，我们试图找到一个可以恢复的安全版本的代码。我们在前一天有一组最近的回复，所以如果我们只是选择以前的版本，我们会以糟糕的代码结束。

上午 8 点 29 分，一名值班工程师明确指出了问题。在这一点上，我们致力于追踪不包括错误变更的最后已知修订。恢复在上午 8 点 37 分执行。鉴于故障的性质，在这些情况下，web 客户端不会提示重新加载。有必要在上午 8:42 将不良修改列入黑名单。

从这一点上应用程序开始逐渐恢复。上午 8 点 48 分，应用程序完全恢复正常。

事件解决后，我们跑了一个 [5 个为什么](https://blog.asana.com/2015/06/workstyle-ask-5-whys-to-get-to-the-root-of-any-problem/) 。我们认为，我们在这次事件中的失败是我们的反应。因此，我们正在实施额外的工具和安全措施，以确保我们能够更好地应对未来的此类问题。我们确定了可以在三个主要方面改进的系统和程序:在问题变成用户面对的问题之前检测到问题，减少随叫随到的工程师对事件进行分类所需的时间，以及减少在发现问题后修复问题所需的时间。

我们意识到你依靠体式来完成工作，而昨天，体式并不可靠。对于我们未能提供稳定的服务，我们真的很抱歉——我们对自己的要求比这更高。我们希望通过努力确保类似的事情不再发生，再次赢得您的信任。