# 使用机器学习自动调整您的| AWS 机器学习博客

> 原文:[https://AWS . Amazon . com/blogs/ai/tuning-your-DBMS-automatically-with-machine-learning/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://aws.amazon.com/blogs/ai/tuning-your-dbms-automatically-with-machine-learning/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)



这是卡内基梅隆大学的达纳·范·阿肯、安迪·帕夫洛和杰夫·戈登的客座博文。 *该项目展示了学术研究人员如何利用我们的* [*AWS 云研究项目信用*](https://aws.amazon.com/research-credits/) *来支持他们的科学突破。*

数据库管理系统(DBMSs)是任何数据密集型应用程序中最重要的组件。他们可以处理大量数据和复杂的工作负载。但是它们很难管理，因为它们有数百个配置“旋钮”,这些旋钮控制着诸如用于缓存的内存量以及向存储设备写入数据的频率等因素。组织经常雇佣专家来帮助进行调优活动，但是专家的费用对许多人来说是非常昂贵的。

OtterTune 是由卡内基梅隆数据库组的学生和研究人员开发的一种新工具，它可以自动为 DBMS 的配置旋钮找到好的设置。目标是让任何人都更容易部署 DBMS，甚至是那些没有任何数据库管理专业知识的人。

OtterTune 不同于其他 DBMS 配置工具，因为它利用从调优以前的 DBMS 部署中获得的知识来调优新的 DBMS 部署。这大大减少了调整新的 DBMS 部署所需的时间和资源。为此，OtterTune 维护了一个从以前的调优会话中收集的调优数据的存储库。它使用这些数据来建立机器学习(ML)模型，以捕捉 DBMS 如何响应不同的配置。OtterTune 使用这些模型来指导新应用程序的实验，推荐可以改进目标的设置(例如，减少延迟或提高吞吐量)。

在本文中，我们将讨论 OtterTune 的 ML 管道中的每个组件，并展示它们如何相互作用来调整 DBMS 的配置。然后，我们通过将其最佳配置的性能与数据库管理员(DBA)和其他自动调优工具选择的配置进行比较，来评估 OtterTune 在 MySQL 和 Postgres 上的调优效率。

OtterTune 是由卡内基梅隆数据库研究小组的学生和研究人员开发的开源工具。所有代码都可以在 [GitHub](https://github.com/cmu-db/ottertune) 上获得，并在 Apache License 2.0 下获得许可。

# 【OtterTune 如何工作

下图显示了 OtterTune 组件和工作流。

![](../Images/44625ca3a541114872c1a2335aa486a0.png)

在新的调优会话开始时，用户告诉 OtterTune 要优化哪个目标(例如，延迟或吞吐量)。客户端控制器连接到目标 DBMS，并收集其 Amazon EC2 实例类型和当前配置。

然后，控制器开始其第一个观察周期，在此期间，它观察 DBMS 并记录目标对象。当观察期结束时，控制器从 DBMS 收集内部指标，如 MySQL 的从磁盘读取的页面和写入磁盘的页面的计数器。控制器将目标和内部指标返回给调优管理器。

当 OtterTune 的调优管理器收到这些指标时，它会将它们存储在其存储库中。OtterTune 使用结果来计算控制器应该在目标 DBMS 上安装的下一个配置。优化管理器将这个配置返回给控制器，并估计运行它的预期改进。用户可以决定是继续还是终止优化会话。

**注释**

OtterTune 为它支持的每个 DBMS 版本维护一个旋钮黑名单。黑名单包括没有意义的调整旋钮(例如，DBMS 存储文件的路径名)，或者那些可能产生严重或隐藏后果的旋钮(例如，可能导致 DBMS 丢失数据)。在每个调优会话开始时，OtterTune 会向用户提供黑名单，以便用户可以添加任何其他他们希望 OtterTune 避免调优的旋钮。

OtterTune 做了一些假设，这些假设可能会限制它对某些用户的有用性。例如，它假设用户具有允许控制器修改 DBMS 配置的管理权限。如果用户没有，那么他或她可以在其他硬件上部署数据库的第二个副本，用于 OtterTune 的调优实验。这要求用户要么重放工作负载跟踪，要么从生产 DBMS 转发查询。关于假设和限制的完整讨论，请参见我们的论文。

# **机器学习流水线**

下图显示了数据在通过 OtterTune 的 ML 管道时是如何处理的。所有的观察结果都保存在 OtterTune 的知识库中。

OtterTune 首先将观察结果传递给工作负载特征组件。该组件确定了一个较小的 DBMS 度量集，该度量集最能捕捉不同工作负载的性能可变性和区别特征。

接下来，旋钮识别组件生成对 DBMS 性能影响最大的旋钮的排序列表。然后，OtterTune 将所有这些信息反馈给自动调谐器。该组件将目标 DBMS 的工作负载映射到其数据存储库中最相似的工作负载，并重用该工作负载数据来生成更好的配置。

![](../Images/5ec7c6bc72afcde47e390833b812ef22.png)

让我们深入研究 ML 管道中的每个组件。

**工作负载表征:** OtterTune 使用 DBMS 的内部运行时指标来表征工作负载的行为。这些指标提供了工作负载的准确表示，因为它们捕获了工作负载运行时行为的许多方面。然而，许多指标是多余的:有些是以不同单位记录的相同测量值，而有些则代表 DBMS 的独立组件，其值高度相关。重要的是删除冗余的度量，因为这降低了使用它们的 ML 模型的复杂性。为此，我们根据相关模式对 DBMS 的指标进行聚类。然后，我们从每个集群中选择一个有代表性的指标，特别是最接近集群中心的指标。ML 管道中的后续组件使用这些指标。

**旋钮识别:**DBMS 可以有数百个旋钮，但是只有一个子集影响 DBMS 的性能。OtterTune 使用一种流行的特征选择技术，称为*套索*，来确定哪些旋钮强烈影响系统的整体性能。通过将这种技术应用于数据库中的数据，OtterTune 确定了 DBMS 旋钮的重要性顺序。

然后，在提出配置建议时，OtterTune 必须决定使用多少旋钮。使用太多会显著增加 OtterTune 的优化时间。使用太少可能会阻止 OtterTune 找到最佳配置。为了使这个过程自动化，OtterTune 使用了一种增量方法。它会逐渐增加调音过程中使用的旋钮数量。这种方法允许 OtterTune 在扩展范围考虑其他方面之前，探索和优化一小组最重要的旋钮的配置。

**自动调优器:**自动调优组件通过在每个观察周期后执行两步分析来确定 OtterTune 应该推荐哪个配置。

首先，系统使用工作负载特征组件中标识的度量的性能数据来标识最能代表目标 DBMS 工作负载的来自先前调优会话的工作负载。它将会话的指标与以前工作负载的指标进行比较，以查看哪些指标对不同的旋钮设置有相似的反应。

然后，OtterTune 选择另一种旋钮配置进行尝试。它将统计模型与收集的数据以及存储库中最相似工作负载的数据相匹配。这个模型让 OtterTune 预测 DBMS 在每种可能的配置下的性能。OtterTune 优化下一个配置，在探索(收集信息以改进模型)和利用(贪婪地试图在目标指标上做得更好)之间进行权衡。

# **实施**

OtterTune 是用 Python 写的。

对于工作负载表征和旋钮识别组件，运行时性能不是关键问题，因此我们使用 [scikit-learn](http://scikit-learn.org/) 实现了相应的 ML 算法。这些算法在后台进程中运行，当新数据在 OtterTune 的存储库中可用时，它们会合并这些数据。

对于自动调谐器，ML 算法位于关键路径上。它们在每个观察期后运行，合并新数据，以便 OtterTune 可以选择下一个旋钮配置进行尝试。因为性能是一个考虑因素，我们使用 [TensorFlow](https://www.tensorflow.org/) 实现了这些算法。

为了收集有关 DBMS 硬件、旋钮配置和运行时性能指标的数据，我们将 OtterTune 的控制器与 [OLTP-Bench](https://github.com/oltpbenchmark/oltpbench) 基准测试框架集成在一起。

### 试验设计

为了进行评估，我们使用 OtterTune 选择的最佳配置对 MySQL 和 Postgres 的性能进行了比较，如下所示:

*   默认值:DBMS 提供的配置
*   优化脚本:由开源优化顾问工具生成的配置
*   DBA:由人类 DBA 选择的配置
*   RDS:为 DBMS 定制的配置，由 Amazon RD 管理，部署在相同的 EC2 实例类型上

我们在亚马逊 EC2 点实例上进行了所有的实验。我们在两个实例上运行每个实验:一个用于 OtterTune 的控制器，一个用于目标 DBMS 部署。我们分别使用了 m4.large 和 m3.xlarge 实例类型。我们在一个拥有 20 个内核和 128 GB 内存的本地服务器上部署了 OtterTune 的调优管理器和数据存储库。

我们使用了 [TPC-C](http://www.tpc.org/tpcc/) 工作负载，这是评估在线事务处理(OLTP)系统性能的行业标准。

### 估价

对于我们在实验中使用的每个数据库，MySQL 和 Postgres，我们测量了延迟和吞吐量。下图显示了结果。第一张图显示了第 99 个<sup>百分位数的延迟量，这代表了完成一个事务所需的“最坏情况”时间长度。第二张图显示了吞吐量的结果，以每秒完成的平均事务数来衡量。</sup>

## MySQL 结果

![](../Images/22b4bb0a085b3570c2304880252c2945.png)

将 OtterTune 生成的最佳配置与调优脚本和 RDS 生成的配置进行比较，MySQL 在 OtterTune 配置下实现了大约 60%的延迟减少和 22%到 35%的吞吐量提升。OtterTune 还生成了一个几乎与 DBA 选择的配置一样好的配置。

对于 TPC-C 工作负载来说，MySQL 的几个旋钮会显著影响其性能。OtterTune 和 DBA 生成的配置为每个旋钮提供了良好的设置。RDS 的性能稍差，因为它为一个旋钮提供了次优设置。调优脚本的配置性能最差，因为它只修改了一个旋钮。

## Postgres 结果

![](../Images/aaedb426db34552a84aeb658440e5e3c.png)

对于延迟，OtterTune、调优工具、DBA 和 RDS 生成的配置都比 Postgres 的默认设置实现了类似的改进。我们可能将这归因于 OLTP-Bench 客户机和 DBMS 之间通过网络往返所需的开销。就吞吐量而言，使用 OtterTune 建议的配置，Postgres 的性能比 DBA 和调优脚本选择的配置高 12%,比 RDS 高 32%。

与 MySQL 类似，只有几个旋钮显著影响 Postgres 的性能。OtterTune、DBA、调优脚本和 RDS 生成的配置都修改了这些旋钮，并且大多数都提供了相当好的设置。

# 结论

OtterTune 自动执行为 DBMS 的配置旋钮寻找良好设置的过程。为了调优新的 DBMS 部署，它重用从以前的调优会话中收集的训练数据。因为 OtterTune 不需要生成初始数据集来训练它的 ML 模型，所以调优时间大大减少了。

下一步是什么？为了适应日益流行的 DBaaS 部署，远程访问 DBMS 主机是不可用的，OtterTune 将很快能够自动检测目标 DBMS 的硬件能力，而不需要远程访问。

关于 OtterTune 的更多细节，请参见我们的[论文](http://db.cs.cmu.edu/papers/2017/tuning-sigmod2017.pdf)或 GitHub 上的[代码。请关注这个](https://github.com/cmu-db/ottertune)[网站](http://ottertune.cs.cmu.edu/)，在这里我们将很快提供在线调谐服务。

* * *

### 关于作者

**![](../Images/3a6c73826815c2d0be6bdc10262985d0.png) [达纳·范·阿肯](http://www.cs.cmu.edu/~dvanaken/)** 是安德鲁·帕夫洛博士指导下的卡耐基·梅隆大学计算机科学博士生。她广泛的研究兴趣是数据库管理系统。她目前的工作重点是开发使用机器学习来调优数据库管理系统的自动化技术。

安迪·帕夫洛博士是卡耐基·梅隆大学计算机科学系数据库学的助理教授。在 CMU，他是数据库小组和并行数据实验室的成员。他的工作还与英特尔大数据科学技术中心合作。

**![](../Images/56a2263aeca33c11023712f52f93a503.png) [杰夫·戈登](http://www.cs.cmu.edu/~ggordon/)** 博士是卡耐基·梅隆大学机器学习系的副教授和副系主任。他的研究兴趣包括人工智能、统计机器学习、教育数据、博弈论、多机器人系统以及概率、对抗和总和领域的规划。

