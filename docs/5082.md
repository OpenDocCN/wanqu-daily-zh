# 实践中的金丝雀

> 原文：<http://dreynaud.fail/canaries-in-practice/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

在分布式系统的环境中，金丝雀被用来限制软件发布的爆炸半径。根据谷歌 SRE 图书:

> 为了进行金丝雀测试，服务器的子集被升级到新的版本或配置，然后留在潜伏期。如果没有意外的变化发生，发布会继续，其余的服务器以渐进的方式升级。如果出现任何问题，修改后的服务器可以快速恢复到已知的良好状态。

例如，假设您有一个服务，其中 100 台服务器都运行相同的版本 N，部署在一个负载平衡器后面的云中，所有服务器都接收用户流量。服务的版本 N+1 已经准备好了，但是仅仅在版本 N+1 下创建一个具有 100 台服务器的新集群并将流量切换到新集群可能会导致服务中断。所以要运行金丝雀，你可以这样做(见[martinfowler.com](https://martinfowler.com/bliki/CanaryRelease.html)的图表):

1.  在版本 N+1 上创建一个有 1 台服务器的 canary 集群，并将其放在与 prod 集群相同的负载平衡器之后。
2.  等一段时间，比如说 1h
3.  在培育期之后，以某种方式比较 canary 和 prod 集群之间的指标(稍后将详细介绍)。
4.  如果指标看起来不错，那么继续下一步:将版本 N+1 滚动到 X%的流量(例如，将 canary 集群的大小增加到 X 个服务器，并禁用旧集群中的 X 个服务器)。这可以重复任意次，直到 X 为 100%，以使卷展或多或少是渐进的。

这个过程看起来相对简单，但是在实践中有一些重要的细节需要考虑:

*   产品中的测试:最好不要认为金丝雀是测试，但是你仍然把活生生的客户放在新软件面前，你没有 100%的信心。金丝雀会失败，真正的客户会出错。这听起来是显而易见的，但它必须被接受和理解。还有潜在的伦理影响，比如粘金丝雀。

*   粘性金丝雀(sticky canaries):一些错误可能需要与新版本多次往返才能显现，特别是如果与金丝雀的交互改变了客户端上的一些状态，比如 cookies。如果每个请求被独立地随机分配给一个 prod 或 canary 实例，那么客户不太可能连续多次点击 canary(从而暴露问题)。为了解决这个问题，有可能实现粘性金丝雀，不仅分配一定比例的流量，而且分配一定比例的*用户*给金丝雀。这里潜在的伦理难题是，你可能已经完全破坏了你的可怜的豚鼠用户群的用户体验，这些用户被分配到金丝雀“测试细胞”中，不管你的潜伏期有多长。因此，请记住这一点，理想情况下，让用户足够快地进出金丝雀单元，以便他们不会经历令人讨厌的中断。

*   **客户端错误处于盲点**:上述方法只查看服务器指标，不查看客户端指标。金丝雀可能会成功通过，但当它完全展开时，客户端错误将使回滚成为必要。对此没有简单的解决方法，试图将客户端错误与金丝雀联系起来是很棘手的。

*   **小心小型服务**:如果主生产集群只有 3 台服务器，而不是上面示例中的 100 台，并且负载均衡器只是随机循环所有可用实例，那么 canary 实例将占用 25%的用户流量，而不是 1%。以这种方式运行 canaries 现在是一个主要的事故风险—理想情况下，您的负载平衡器/服务发现机制将允许您控制发送到 canary 集群的流量的百分比，而不仅仅是基于 prod 实例数量的流量的一部分。

*   **看什么指标**:这个例子掩盖了可以说是最重要的方面，即如何给金丝雀评分。应该查看哪些指标，应该如何比较它们？在光谱的一端，您将只查看潜伏期[【1】](#footnote1)`(num_http_4XX + num_http_5XX)/num_requests`内的 HTTP 错误率(这将防止灾难性的部署，例如，一个服务总是返回 500，但可能会错过与业务逻辑相关的更微妙的问题)。另一方面，您会查看*服务公开的所有*指标(CPU、延迟、内存使用、GC 暂停、业务逻辑错误、下游依赖性、缓存命中和未命中、超时、连接错误……)。这种方法的问题是，您现在可能正在处理嘈杂的信号。

*   **处理噪声信号**:与性能相关的指标(CPU、内存、延迟、GC)存在自然差异，这可能会导致误报，例如金丝雀因 CPU 或延迟峰值而失败。包含这些的理由是，我们不希望小的性能退化随着时间的推移而累积。虽然这肯定会发生，并且持续的性能监控是必要的，但我不认为金丝雀是检查性能退化的正确地方。你真的想因为 2%的 CPU 增加或内存使用而推迟发布吗？还有一些其他的缺点:
    *   如果*任何*指标的偏差都可能导致金丝雀失败，那么金丝雀很可能会左右失败，开发人员将会让**对糟糕的金丝雀结果变得不敏感**(有时会因为尽管金丝雀结果不佳却决定推送而导致事故)
    *   包含不止一个 canary 实例来消除噪声指标中的尖峰可能很有吸引力。如果你是一个简单的负载均衡器，请再次注意小服务，这将使问题变得更糟。
    *   除非存在导致性能随时间下降的资源泄漏问题，否则 prod 集群中的 warm 实例可能比新的 canary 实例具有更好的性能指标。对此的一个解决方法是**在版本 N 中引入一个专用的基线集群**,它是与 canary 集群同时创建的。然后将金丝雀与新的基线集群进行比较，而不是与生产集群进行比较。但是，还是要小心小服务。
    *   为了测试您的指标是否过于嘈杂，可以考虑运行一个 **A/A canary** ，其中 canary 集群运行与 prod 集群相同的版本。如果你得到不好的金丝雀结果，你知道你有问题。
*   **弱信号**:金丝雀可能看起来很好，但在完全展示后会引起事故，即使症状指标是在金丝雀中分析的。例如，你可能有一个让 0.1%的客户非常不爽的错误:很难抓住一只金丝雀，但结果可能是成千上万个愤怒的电话。还有另一种情况，您可能需要明确地从分析中排除弱信号:例如，想象一下基线经历了 0 个错误，金丝雀经历了 N 个>错误的情况:这是与基线的无限百分比偏差，但也不是很强的信号。

*   **不一致的配置**:包含太多的度量标准会导致金丝雀配置在团队和服务之间不一致，因此您最终会得到一个众所周知的古怪服务，金丝雀总是失败，但您仍然可以(大部分)推送；以及一个看似健壮的服务，金丝雀总是看起来很棒，但实际上并没有捕捉到问题。如果可能的话，在服务间寻找一个最小的(因此是一致的)金丝雀配置，以减少与它们相关的认知负荷。作为一个推论，您应该考虑在每次事件之后，抵制添加越来越多指标的冲动(例如，当有人问“为什么这没有被金丝雀抓住？”).

*   **推送延迟**:即使自动化程度很高，如果变更需要 4 小时或更长时间才能完成，那么您很可能一天最多只能推送一次。需要注意开发速度和风险之间的权衡。

*   **小心被遗忘的特征标志**:有可能通过一只禁用特征标志的金丝雀偷偷获得特征。很明显，当你打开它时，它会在 prod 中爆炸(从好的方面来说，只有特性需要恢复，而不是整个部署)。作为一种解决方法，可以考虑默认启用功能标志，并要求显式更改配置才能禁用。

*   毒丸:如果你在整个潜伏期都不去管它，即使是一个金丝雀实例也能造成重大损失(200 RPS 的错误持续 1 小时是很大的错误)。考虑让自动化在适当的位置尽早杀死真正糟糕的金丝雀，不需要抛出超过几分钟的错误。

*   **区域/DC**:如果您部署到多个云区域(或数据中心、云供应商……)，您可能应该在每个区域运行金丝雀，因为指标表明代码版本 N+1 在*特定环境*和*特定运行时配置*下的健康状况。AWS / us-east-1 中一个好的金丝雀结果不会告诉您版本 N+1 适合于任何地方，它会告诉您 N+1 在那个时间点在 AWS / us-east-1 中是很好的，具有当时活动的运行时配置(包括启用的特性标志的特定集合)。这意味着我们将不得不处理不一致的金丝雀结果，这些结果在一个地区可能很好，但在另一个地区却是灾难性的。[【2】](#footnote2)
    *   此外，你不能在一个已经被疏散的地区准确地金丝雀(见[混沌孔](https://medium.com/netflix-techblog/chaos-engineering-upgraded-878d341f15fa))，所以你的自动化必须知道不要推出到一个疏散的地区，否则当交通恢复时你可能会大吃一惊
*   **与 alerts 的关系**:有很好的金丝雀结果，进行到一个 rollout，然后因为 rollout 而被分页，感觉不对。T2 感觉金丝雀和警报之间应该有更紧密的整合，但我不知道具体会是什么样子。如果有，请[跟我说话](https://twitter.com/FakeRyanGosling)。

要了解这一点的不同风味，请看[脸书如何推动变革](https://code.facebook.com/posts/270314900139291/rapid-release-at-massive-scale/)。

[讨论 HN](https://news.ycombinator.com/item?id=16199499)

[在推特上讨论](https://twitter.com/FakeRyanGosling/status/948710942082154496)

:你可能还需要检查信号的大小是否符合预期，否则你可能会认为金丝雀看起来很棒(0%误差！)如果它没有接收任何客户流量，而只是为健康检查请求返回 200。这个绝对发生在一个朋友身上。

:例如，您可能在 eu-west-1 中有一个错误配置的安全组，导致该区域的 prod 中有一个不可访问的关键依赖项。也发生在一个朋友身上。