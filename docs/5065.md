# Etsy 工程|选择云提供商

> 原文:[https://code ascraft . com/2018/01/04/select-a-cloud-provider/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://codeascraft.com/2018/01/04/selecting-a-cloud-provider/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

自 2005 年第一个 Etsy 站点启动以来，Etsy.com 和我们的大多数相关服务一直托管在自我管理的数据中心。今年早些时候，我们决定评估将一切迁移到云托管解决方案。在数据中心运行我们自己的硬件的决定在当时是正确的，但基础设施即服务(IaaS)和平台即服务(PaaS)产品在这几年发生了巨大的变化。是时候重新评估我们的决定了。我们[最近宣布](https://investors.etsy.com/news-and-events/press-releases/2017/12-14-2017-130416690)我们已经选择谷歌云平台(GCP)作为我们的云提供商，我们对这一决定感到非常兴奋。这标志着 Etsy 从基础设施自力更生转变为一流的服务提供商。这种转变使我们可以花更少的时间维护我们自己的基础设施，将更多的时间放在战略功能和服务上，使 Etsy 市场变得更好。

尽管我们在提到云提供商时使用了“供应商”一词，但我们认为这不仅仅是一个简单的供应商选择过程。我们正在建立合作伙伴关系和长期关系。我们选择的提供商将是我们成功的初始迁移的主要部分，也是我们网站和服务的长期可扩展性和可用性的合作伙伴。这不是我们在没有仔细考虑和深思熟虑分析的情况下想要作出的决定。本文将带您了解我们审查并最终选择合作伙伴的过程。我们不打算解释为什么我们选择迁移到云托管提供商，也不打算解释我们已经建立的衡量项目成功的业务目标。

## 从一个，许多

虽然迁移到云托管提供商可以被认为是一个单一的项目，但它确实是一个非常大的项目，由许多较小的项目组成。为了准确地评估每个云提供商，我们需要确定所有的子项目，确定每个子项目的具体要求，然后使用这些要求来评估各个提供商。此外，为了确定整个项目的范围，我们需要确定每个子项目的顺序、工作量、依赖性、优先级和时间安排。

我们首先确定了八个主要项目，包括网站的生产渲染路径、网站的搜索服务、生产支持系统(如日志记录)以及第一层业务系统(如吉拉)。然后，我们将这些项目进一步划分为它们的组件项目——例如，MySQL 和 Memcached 作为产品渲染路径的一部分。在这项工作结束时，我们已经确定了 30 多个子项目。为了确定每个子项目的需求，我们需要从整个组织中收集专业知识。没有一个人或项目团队能够准确或及时地收集所有这些需求。例如，我们不仅需要知道 MySQL 数据库的延迟容忍度，还需要知道 API 创建和删除数据的数据仓库需求。为了帮助收集所有这些需求，我们使用了 RACI 模型来识别子项目所有权。

## 拉齐

RACI 模型用于确定每个子项目的负责人、问责人、咨询人和知情人。我们使用了以下定义:

*   **负责人**——这是最终负责完成项目或计划的人。
*   负责人(Accountable)-这是 R 要对其负责的人，他必须批准工作才能完成。
*   **咨询** -这些人可能有对完成项目有用的数据。
*   **通知** -这些人应该被告知或者被通知项目的进展，但是他们不需要批准任何步骤或者工件。

每个负责人负责收集需求，并为他们的子项目映射依赖关系。负责人确保负责人有完成项目所需的时间、资源和信息，并最终签字确认项目已经完成。

[![](../Images/142c9d3698396b47a7340ce49a844cef.png)T2】](http://i.etsystatic.com/inv/43f265/3444015316/inv_fullxfull.3444015316_hn60kqyy.jpg?version=0)

## 建筑评论

Etsy 长期以来一直使用架构审查流程，通过该流程，我们环境中的任何重大变化，无论是技术、架构还是设计，都要经过同行审查。由于这些需要高级工程师投入大量时间，因此准备工作并不轻松。整个组织的专家协作征求不同的观点，并经常为体系结构评审生成 30 多页的文档。

我们认为正确评估各种云提供商需要了解我们系统各个部分的期望最终状态。例如，我们当前的配置是在我们的主机托管中心使用自定义工具集自动构建裸机服务器和虚拟机(VM)来完成的。我们还使用在已配置的裸机服务器和虚拟机上应用的 [Chef](https://www.chef.io/chef/) 角色和配方。我们确定了在云中选择基础设施创建工具的几个关键目标，包括:更大的灵活性、责任性、安全性和集中访问控制。我们的供应团队根据这些目标评估了几种工具，讨论了它们，然后在架构审查中提出了新的工作流。该团队最后建议我们使用 [Terraform](https://www.terraform.io/) 结合 [Packer](https://www.packer.io/) 来构建基本操作系统映像。

最终，我们对系统和环境的主要组件进行了 25 次架构审查。我们还为我们认为需要更深入审查的某些组件举行了八次额外的研讨会。特别是，我们回顾了生成 etsy.com 页面(也称为生产渲染路径)所涉及的后端系统，重点关注延迟约束和故障模式。这些架构审查和研讨会产生了一组需求，我们可以使用这些需求来评估不同的云提供商。

## 它如何组合在一起

一旦我们对系统的主要组件有了一套确定的需求，我们就开始概述迁移的顺序。为了做到这一点，我们需要确定所有组件是如何相互关联的。这需要我们绘制依赖关系图，这需要工程师团队围着白板讨论系统和子系统如何交互。

[![](../Images/653327899c8701019b436bfe344cb281.png)T2】](http://i.etsystatic.com/inv/4d40b8/3444015422/inv_fullxfull.3444015422_29qn9xl0.jpg?version=0)

依赖关系绘图练习帮助我们识别和记录每个主要组件的所有支持部分，例如调度和监控工具、缓存池和流服务。这些会议最终产生项目工作和时间的高级评估，映射在甘特图风格的项目计划中。

[![](../Images/f029d19e16b2be6a3664cd10408533fb.png)T2】](http://i.etsystatic.com/inv/a2c33a/3491683477/inv_fullxfull.3491683477_58qcfwtg.jpg?version=0)

## 实验

今年早些时候，我们在一家云提供商的服务上运行了一些 Hadoop 工作，这让我们很好地了解了迁移所需的工作以及我们在大规模迁移时将面临的挑战。然而，在这个最初的实验中，我们没有使用 GCP，所以我们对最终选择的云提供商没有相同程度的了解。

因此，我们进行了一项实验，利用 Dataproc 和 Dataflow 在 GCP 上运行批处理作业。我们从这次实践中学到了很多经验，包括一些 GCP 服务仍处于 alpha 版本，不适合我们要求的工作负载和 SLA。这是我们需要做出的许多类似决定中的第一个:使用云服务还是构建我们自己的工具。在这种情况下，我们选择在 GCP 虚拟机上实施[气流](https://airflow.incubator.apache.org/)。为了帮助我们做出这些决定，我们评估了各种标准的优先级，例如服务的供应商支持、供应商独立性以及这个决定对其他团队的影响。

这些问题没有正确的答案。我们认为，每个团队都需要确定这些问题和标准，以便考虑它们并做出可能的最佳决策。我们也不反对在将来当我们有更多的信息或 [alpha 和 beta](https://cloud.google.com/terms/launch-stages) 项目进入正式发布(GA)时重新审视这些决策。

## 会议

在五个月的时间里，我们多次与谷歌团队会面。这些会议中的每一个都有明确定义的目标，从团队成员的简短介绍到全天深入探讨各种主题，比如在云中使用容器服务。除了提供关键信息，这些会议还加强了 Etsy 和 Google 之间的共享工程文化。

我们还会见了参考客户，讨论他们在迁移到云的过程中学到了什么，以及在我们的过程中需要注意什么。与这些公司一起度过的时间是非常值得的，并展示了纽约科技公司中普遍存在的令人惊叹的开放文化。

我们还会见了 Etsy 内部的主要利益相关方，让他们了解我们的进展，并邀请他们就关键方向决策发表意见，例如如何平衡财务风险的缓解与成本承诺的时间贴现值。这样做为决策者提供了一个共同的熟悉和舒适的过程，并消除了在最终决策点的可能性。

## 决定

到目前为止，我们已经从利益相关者、供应商和工程团队那里获得了数千个数据点。我们利用了一个叫做[决策矩阵](https://en.wikipedia.org/wiki/Decision_matrix)的工具，用于评估多标准决策问题。该工具有助于将这些数据组织起来并按优先顺序排列，以便用来公正地评估每个供应商的产品和提案。我们的决策矩阵包含 200 多个因素，按 1，400 个权重排序，并评估了 400 多个分数。

这个过程从确定总体功能需求开始。我们将关系、成本、易用性、增值服务、安全性、位置和连接性确定为七个顶级功能需求领域。然后，我们列出了 200 多个客户需求中的每一个(客户指的是工程团队和利益相关者)，并根据每个需求对整体功能需求的支持程度对它们进行加权。我们用 0、1、3、9 的标度来表示 [![](../Images/83e21a24a9b93fc9d82c18849e5dfc6e.png)](http://i.etsystatic.com/inv/214af4/3491683565/inv_fullxfull.3491683565_bu9f45ug.jpg?version=0) 的支持程度。例如，客户对“自动扩展支持”的要求在成本方面的权重为 9(因为这将有助于通过动态扩展我们的计算集群来降低成本)，在易用性方面的权重为 9(因为这将使我们不必手动启动和关闭虚拟机)，在增值服务方面的权重为 3(因为这是除基本计算和存储之外提供的附加服务，但并不复杂)，在支持其他功能要求方面的权重为 0。多个工程团队对这些因素进行了深入评估和权衡。作为非线性加权量表的结果，明确的优先顺序开始出现，这迫使过于保守的评分者在真正重要的问题上做出艰难的决定。

[![](../Images/d0ad935d003897529a60f4181330b84d.png)T2】](http://i.etsystatic.com/inv/baf433/3444015698/inv_fullxfull.3444015698_muoo30i5.jpg?version=0)

然后，我们使用这些加权要求对每个供应商的产品进行排名。我们再次使用 0、1、3、9 的等级来衡量每个云供应商满足要求的程度。继续我们的“自动扩展支持”示例，我们给每个云供应商打了 9 分，因为我们评估的所有供应商都将自动扩展计算资源作为本机功能提供了支持。每个供应商的总得分超过 50，000 分，其中 GCP 超过其他供应商 10%以上。

[![](../Images/81daf6a8fd2ab4922b5d4b2970820d6d.png)T2】](http://i.etsystatic.com/inv/5ee04e/3491683733/inv_fullxfull.3491683733_5pyvsxqj.jpg?version=0)

从上下文中可以明显看出，应该注意 Etsy &39;的决策矩阵(由 Etsy 的工程师用 Etsy 的权重对 Etsy 的需求进行排序)仅适用于 Etsy。我们并不认为这一决策对您或您的组织是正确的，而是试图让您了解我们如何做出对我们来说具有战略意义和重要意义的决策。

## 仅仅是开始

现在，娱乐和工作开始了。这个过程花了我们五个月的大部分时间，我们有一名全职的技术项目经理、几十名工程师和工程经理，以及几名律师、财务人员和采购专家负责这个部分，在某些情况下是全职的。不用说，这不是一个无足轻重的努力，但实际上只是一个迁移到 GCP 的多年项目的开始。我们有一个雄心勃勃的时间表，要在大约两年内完成我们的迁移。我们将在继续关注创新产品功能的同时做到这一点，并将过渡期的风险降至最低。我们期待着搬到 GCP 为我们提供的机会，并对这一转变感到特别兴奋，这使我们能够通过与一流的服务提供商合作，更加专注于 Etsy 市场的核心战略服务。