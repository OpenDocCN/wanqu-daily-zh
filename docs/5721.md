# Chick-fil-A 的边缘计算。Brian Chambers，Caleb Hurd，Sean… |福乐鸡快餐店科技博客| Medium

> 原文:[https://medium . com/@ cfatechblog/edge-computing-at-chick-fil-a-7d 67242675 e 2？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://medium.com/@cfatechblog/edge-computing-at-chick-fil-a-7d67242675e2?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

# 福乐鸡快餐店大学的边缘计算

作者:布莱恩·钱伯斯、凯勒·赫德、肖恩·德鲁克、亚历克斯·克莱恩、摩根·麦克整个、杰米·罗伯特和劳拉·乔奇(福乐鸡快餐店·IOT/Edge 团队)

在最近的[帖子](/@cfatechblog/bare-metal-k8s-clustering-at-chick-fil-a-scale-7b0607bd3541)中，我们分享了我们如何在餐厅边缘为 Kubernetes 实时进行裸机集群。我们收到的最常见(也是最好)的问题之一是“但是为什么？”。在文章中，我们将回答这个问题。如果你对更多感兴趣或者更喜欢视频而不是文本，你也可以在 [QConNY 2018](https://www.infoq.com/presentations/chick-fil-a-k8-clusters) 上查看[布莱恩](https://www.linkedin.com/in/brian-chambers/)和[凯勒](https://www.linkedin.com/in/calebrhurd/)的演示。



(Including Kubernetes. Look for our new container orchestration tool, Kowbernetes, coming soon)



# 为什么 k8 会在餐厅里？

为什么像福乐鸡快餐店这样的餐饮公司想要在边缘部署 Kubernetes？目标是什么？这个，我们可以回答。

*   能够可靠运行我们业务的低延迟、独立于互联网的应用
*   这些应用程序的高可用性
*   支持快速创新并允许尽快向生产交付业务功能的平台
*   横向扩展—基础架构和应用程序开发团队

# 产能压力

福乐鸡快餐店是一家非常成功的公司，这在很大程度上是因为我们美味的食物和[客户服务](http://fortune.com/2018/07/05/best-fast-food-restaurant-2018/)——这两者都是在我们餐厅工作的优秀员工的成果。他们在业内无人能及。结果是**非常**繁忙的餐馆。如果你去过福乐鸡快餐店餐馆，这对你来说并不陌生。如果你还没有去过[，那么是时候去](https://www.chick-fil-a.com/Locations)了！



A busy Chick-fil-A in Manhattan w/ lines out the door. Photo credit [Wall Street Journal](http://(credit:%20WSJ%20https://www.wsj.com/articles/behind-blur-of-motion-at-chick-fil-a-years-of-planning-1444180466))



虽然我们非常感谢我们的成功，但作为一家企业，它们也给我们带来了许多容量挑战。客观地说，我们一周六天(T0)的销售额比我们的竞争对手一周七天(T3)的销售额还要多(我们周日不营业)。我们的许多餐厅比最初设计的**大了三倍**。这些都是很大的问题，但它们带来了一些与规模相关的极其困难的挑战。

在福乐鸡快餐店，我们相信许多产能问题的解决方案是技术解决方案。

# 新一代工作负载

我们解决这些问题的方法之一是投资一家更智能的餐厅。

我们的目标是:简化业主/经营者及其团队的餐厅体验，优化美味可口的食物，快速提供个性化服务，同时增加我们现有餐厅的容量。

我们的假设是:通过制造更智能的厨房设备，我们可以收集更多的数据。通过将数据应用到我们的餐厅，我们可以建立更智能的系统。通过构建更智能的系统，我们可以更好地扩展我们的业务。

举个简单的例子，想象一个预测模型，它试图预测一天中每分钟应该做多少华夫饼(或者用你最喜欢的福乐鸡快餐店产品代替)。该预测是由运行在云中的分析流程创建的，该流程使用来自许多餐馆的交易级销售数据。只要稍加努力，这一预测肯定是可以实现的。不幸的是，它还不够准确，不足以真正推动粮食生产。福乐鸡快餐店餐厅的销售容易受到许多交通高峰的影响，并受到当地事件(交通、体育、天气等)的显著影响。).

然而，如果我们从我们的销售点系统的击键中实时收集数据，以了解当前的需求，添加来自油炸锅的关于在制品库存的数据，然后对餐厅的初始预测进行微调，我们将能够更准确地了解在任何给定时刻我们应该烹饪什么。然后，这些数据可以用于为负责烹饪薯条的餐厅团队成员提供更加智能的显示(例如)，或者在未来推动烹饪自动化。

诸如此类的目标促使我们为餐厅开发了一个物联网(IOT)平台。为了成功扩展我们的业务，我们需要能够 1)收集数据，2)利用数据推动餐厅的自动化。

我们希望拥有一个**开放的生态系统**,而不是选择许多不同的供应商解决方案，这些解决方案各自为政、互不关联，因此难以集成。这种方法使我们能够允许内部开发人员和/或外部合作伙伴开发面向边缘的互联“事物”或应用，并利用我们的平台满足安全性、身份和连接性等共同需求。

换句话说，IOT/Edge 团队拥有部署在边缘上的整个应用程序库的一个小子集，并且实际上是餐厅内计算平台的运行时平台团队。

# 架构概述

下面是我们为实现这些目标而开发(并在今天使用)的架构。



Simple view of our current architecture, w/ K8s changes highlighted



## 云控制平面

今天，我们在云中运行我们的高阶控制平面和核心物联网服务。这包括以下服务:

*   授权服务器—设备身份管理
*   数据接收/路由—收集数据并将其发送到需要的地方
*   操作时间序列数据—日志、监控、警报、跟踪
*   部署管理——使用 [GitOps](https://www.weave.works/blog/gitops-operations-by-pull-request) 为我们的应用团队进行自助式部署(感谢我们在 Weaveworks 的朋友分享这个术语)。我们计划很快分享我们的工作和代码。

这些服务也在 Kubernetes 中运行，因此我们在团队的所有部署中都有一个通用的范例。

## 边缘

“边缘计算”是指*将计算资源放在靠近活动的地方，以获得更高的可用性和/或更低的延迟。*

我们认为我们的边缘计算环境是一个“微型私有云”。我们的意思是，我们为开发人员提供了一系列有用的服务和一个在我们的基础设施上部署他们的应用程序的地方。

这是否使我们成为世界上最大的“云提供商”？你可以自己判断。



严肃地说，这种方法给了我们一种独特的尺度。与几个拥有几万到几十万个容器的大型 K8s 集群不同，在全规模下，我们将拥有超过 2000 个集群，每个集群拥有*几十个容器*。随着我们每年开设许多新餐厅，这个数字还在显著增长。

我们的边缘工作负载包括:

*   平台服务，如认证令牌服务、发布/订阅消息(MQTT)、日志收集/过滤( [FluentBit](https://fluentbit.io/) )、监控( [Prometheus](https://prometheus.io/) )等。
*   与餐厅中的“事物”进行交互的应用程序
*   服务于 HTTP 请求的简单微服务
*   机器学习模型，将云开发的预测与 MQTT 的实时事件相结合，在边缘做出决策并推动自动化

我们的物理边缘环境从多个餐厅内交换机(和两个路由器)获得连接，因此我们在一个高度可用的 LAN 上运行。

如今，几乎所有在边缘收集的数据都是短暂的，在被渗透到云中之前只需要存在很短的时间。这在未来可能会改变，但它使我们的早期部署非常简单，并使它们更容易管理。

由于我们有一个高度可用的 Kubernetes 集群，数据在所有节点上复制，我们可以确保我们可以保留收集的任何数据，直到互联网再次可用于数据过滤。我们还可以根据业务需求在边缘动态聚合、压缩或丢弃数据。

尽管如此，我们仍然尽可能使用**云** **第一**为我们服务。当高可用性、低延迟、餐厅内应用程序必不可少时，Edge 是备用部署目标。

## 追随巨人的脚步

我们在商用硬件上运行我们的边缘基础设施，成本大约为[](https://english.stackexchange.com/questions/28310/origin-of-ballpark-estimate-to-mean-a-very-rough-estimate)**【1000 美元/家餐厅。我们希望保持硬件投资的低成本和水平可伸缩性。我们还没有找到一种方法让它变得动态/有弹性，但也许有一天(在亚马逊上订购，也许 30 秒免费送货？).**

**借助我们的架构，我们可以通过添加额外的设备来按需增加额外的计算能力。我们可能会在未来扩大我们的硬件占用空间，但我们现有的硬件对我们今天的工作负载是有意义的。谷歌也开始在[商用硬件](https://www.pcworld.com/article/112891/article.html)上扩展工作负载(写于 2003 年，时间都到哪里去了？)…所以我们在一个好公司里！**

**我们希望我们的边缘基础设施方法能够鼓励任何使用稀缺资源(物理空间、预算或其他)的人进行创造性思维。我想那是*大家*。**

## **其他一切**

**最后，我们有我们的连接层和 IOT 的东西。我们的许多设备都是全功率的(没有电池)，但仍然受到芯片组/处理能力的限制。Wi-Fi 是默认的连接方式。我们尚未承诺低功耗协议，但对 [LoRa](https://www.lora-alliance.org/about-lorawan) 和 [WiFi Halo (802.11ah)](https://en.wikipedia.org/wiki/IEEE_802.11ah) 项目感兴趣。**

**对于事物/物理设备，我们的团队还为开发人员提供了一个 SDK，用于执行 on-boarding 流程(全部基于 OAuth)和访问 MQTT 等边缘环境中的服务。Brian 在 [QConNY 2017](https://www.infoq.com/presentations/chickfila-iot) 上更广泛地谈到了这一点(注意我们当时用的是 Docker Swarm vs. Kubernetes)。**

# **边缘的容器**

**为什么要在边缘运行容器？出于同样的原因，您可以在云中(或其他任何地方)运行它们。**

**依赖性管理变得更加容易。测试更容易。开发者体验更轻松更好。团队可以更快、更自主地前进，尤其是当应用了合理的抽象点(比如 k8s 名称空间)和资源限制(CPU/RAM)时。**

**另一个关键设计目标是我们关键应用的可靠性，这意味着架构中没有单点故障。有许多方法可以实现这种类型的目标，但我们认为在边缘部署 1 台以上的物理主机和基于容器的流程编排层是适合我们的工作负载类型和团队技能组合的最佳方法。**

**我们最初将我们的策略称为“冗余餐厅计算”，这实际上说明了我们方法背后的目标。后来，我们过渡到称之为“边缘计算”。**

**Kubernetes 能够有效地编排服务，并快速一致地保存所需数量的副本，这吸引了我们。**

# **为什么是 Kubernetes？**

**起初，我们计划使用 Docker Swarm 进行容器编排，但在 2018 年初转向 Kubernetes，因为我们相信它的核心能力和周围的生态系统是(迄今为止)最强的。我们很高兴能够利用 Kubernetes 的一些发展，如 [Istio](https://istio.io/) 和 [OpenFaaS](https://github.com/openfaas/faas) 。**

**最重要的是，我们坚信…**

**想法本身没有价值。**

**代码本身没有价值。**

**唯一有价值的是在生产中运行的代码*。只有这样，你才能为用户创造价值，才有机会影响你的业务。***



**因此，在福乐鸡快餐店，我们希望优化，将伟大的想法转化为代码，并让代码尽快投入生产。**

**研究表明，使用最新最好的技术(比如 Kubernetes)与一个团队或组织的成功没有关系。没有。将想法转化为代码并将代码快速投入生产的能力确实如此。**

**如果您可以实现这一目标，并通过 VMWare、单台机器、一些其他集群工具或流程编排层或仅使用云来满足您的要求，我们不会尝试并说服您转向 Kubernetes 并跟随我们的领导。最简单的可能解决方案通常是最好的解决方案。**

**在福乐鸡快餐店，我们相信对我们来说，实现这些目标的最好方式是接受集装箱化，并通过 Kubernetes 来这样做。在一天结束时，这一切都是为了帮助你“吃更多的鸡肉”。**

# **然后**

**我们的下一步是什么？**

**在接下来的 18-24 个月中，我们希望将餐厅中的智能/联网设备数量增加到 100，000 台以上，并完成 Kubernetes to the Edge 的全链推广。从边缘控制餐厅的“大脑应用程序”的用例数量持续增长，我们期待为它们提供服务，并与社区分享更多我们所学到的东西。**

**我们还将密切关注刚刚宣布的谷歌 GKE 本地服务，因为它可能会使我们在未来不必构建和管理集群。到目前为止，我们所做的是沉没成本，如果我们能够将资源重新集中在差异化上，而不是基础设施上，你可以肯定我们会这样做。**

**如果我们没有回答你关于我们正在做什么的问题，请不要犹豫，联系 LinkedIn。如果我们可以帮助您应对 Kubernetes 在边缘方面的任何挑战，请告诉我们。在福乐鸡快餐店，我们总是乐于分享，并且(为此向 Caleb 致敬)“我们很高兴为您服务”。**



