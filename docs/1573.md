# 让一千朵鲜花盛开。然后把 999 个连根拔起。

> 原文:[http://www.gigamonkeys.com/flowers/?utm_source=wanqu.co&UTM _ campaign = Wanqu+Daily&UTM _ medium =网站](http://www.gigamonkeys.com/flowers/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

# 让一千朵鲜花盛开。然后把 999 个连根拔起。

2015 年 9 月 28 日

在过去的 11 个月里，我一直是 Twitter 工程效率小组的技术主管。工程效率是我们对其他地方可能称为开发工具、开发生产力、工程基础设施或开发效率的名称。我们提供工具和流程，让其他 Twitter 工程师做他们的工作，专注于大多数 Twitter 工程师使用的东西，而不是超级 Twitter 特有的东西:构建工具、持续集成系统、源代码控制等等。

最近，我在脸书的@Scale 会议上做了一个关于像 Engineering Effectiveness 这样的团队如何扩展我们的工作的演讲。这篇文章是那次演讲的扩展舞蹈混音。TL；然而，灾难恢复是一样的:作为一个行业，我们大多不知道如何做，因此在使我们的工程组织实际有效方面投资严重不足。

* * *

每个软件公司都是从第一个开发人员写的一行代码开始发展的。推特做到了。脸书做到了。你的公司有。但是之后会发生什么呢？

作为一个行业，我们在很大程度上知道如何扩展我们的软件。我们知道如何构建抽象和模块化我们的代码，以便我们可以管理大型代码库，以及如何部署我们的软件，以便它可以处理数百万甚至数十亿用户的需求。我们还知道如何扩大我们的组织，建立必要的管理结构，让成千上万的人或多或少地一起工作。

另一方面，我认为我们真的还没有很好地处理如何扩展存在于工程和人类组织交叉点的领域——像工程有效性这样的团体工作的地方。更糟糕的是，当我们从第一行代码发展到成千上万的工程师处理数百万行代码时，我们甚至不理解扩展的重要性。无论如何，这是一点 Twitter 的历史会建议。

## 扩展我们的软件:百花齐放

Twitter 的第一句话是由我们现在的临时首席执行官[杰克·多西](https://twitter.com/jack)在 2006 年写的。他后来[在一条推文中](https://twitter.com/jack/status/47090747706580992)声称他原本想用 Python、C 和 OCaml 来写，但是因为他很快雇佣了一个 Rails 核心贡献者，他们就用 Ruby on Rails 了。最初是一个简单的 Rails 应用程序，后来发展成为可能是这个星球上最大的整体式 Rails 应用程序，被称为 Monorail。

然而，Twitter 并没有完全成为 Ruby。2008 年，Twitter 收购了一家五人搜索公司，该公司的技术是基于 Java 的。当时，Twitter 有大约 9 名工程师和一些运营人员，所以增加 5 名拥有自己的代码库和工作方式的新工程师，立即增加了 Twitter 内部工程风格和实践的多样性。让百花齐放。

2008 年也是 Twitter 编写第一个 Scala 的一年。所以现在我们有了主要产品，twitter.com，作为一个 Rails 应用程序，使用 Java 进行搜索，人们在尝试 Scala。让百花齐放。

2009 年，有人发起了一项名为“科学”的回购计划。当时，为一个新项目创建一个新的回购协议只是一个人的做法，没什么大不了的。然而，repo 逐渐成为 Java 代码的主要存储库，这些代码包括搜索代码、ads 团队的大部分代码以及需要对 ads 代码定义的数据结构进行操作的相关数据科学代码。当平台团队越来越倾向于 Scala 时，部分原因是 Scala 看起来更像 Ruby 而不是 Java，ads 团队却在走另一条路。Alex Roetter ，现在是我们的工程 SVP，当时是一名工程师，他亲自领导将 ads 团队已经编写的 Scala 代码转换成 Java。也是在那个时候，其他几个工程师开始尝试用我们自己的构建系统 Pants 将科学变成谷歌式的 monorepo。让百花齐放。

最后，我们来到了 2010 年，四年一度的足球世界杯。推特上对奖杯的兴奋程度很高。事实上，有点太高了。或多或少，每当有人进球，每秒钟的推文就会激增，淹没整个网站。GOOOOAAAAALLLL！失败的鲸鱼。GOOOOAAAAALLLL！失败的鲸鱼。

因此，在世界杯之后，我们决定我们真的需要离开单轨铁路，转向基于 JVM 的面向服务的架构。大约在同一时间，现在是首席工程师的 Marius Eriksen 和其他一些人正在开发一个新的 Scala RPC 库 Finagle，它很快成为编写新服务的标准。“脱离单轨”的努力开始认真起来，我们开始教 Ruby 开发人员 Scala，这样他们就可以编写服务来取代单轨。在广告方面，一些数据科学家开始使用 Scala DSL 编写 Map Reduce，这一工作变得非常棘手。很快我们就有了三种在 Twitter 上编写的 Scala:希望它是 Ruby 的人编写的 Scala，希望它是 Java 的人编写的 Scala，以及希望它是 Haskell 的人编写的 Scala。让百花齐放。

然而，尽管存在这种多样性，也许正因为如此，我们在软件的可靠性和可伸缩性方面取得了真正的进步。再过四年就是下一届世界杯了，这是一个完全不同的故事。我们基本上没有问题地处理了大量的推文——在德国队以 7 比 1 惨败巴西队的半决赛中，有 3560 万条推文，在德国队第五个进球后不久，每分钟的峰值为 580，166 条。很明显，在这四年中发生了很多事情，我没有讨论，包括 2014 年世界杯前的许多非常具体的工作。但关键是我们确实知道如何扩展我们的软件。

* * *

## 花园被侵占了

大约在我们庆祝成功处理世界杯流量的同时，内部工具方面的事情也到了紧要关头。科学报道成长为 Twitter 的两个 monorepi 之一。另一个 monorepo 是由所有那些脱离单轨铁路的 Scala 服务组成的。它们最初是独立的回购协议，但最终被合并成一个单一的回购协议 Birdcage，以便欺诈开发者更容易升级他们的图书馆和所有客户。

你可能会问，当 Scala 开发人员决定他们需要一个 monorepo 时，为什么不把他们的代码移植到科学中；为什么要再做一个 monorepo？好问题。其中一些与工具问题有关:科学中的构建系统是裤子——由一位前谷歌工程师编写，灵感来自谷歌的 Blaze 构建系统。在制作鸟笼的时候，Pants 不知道如何构建 Scala，并且继承自 Google 的 Pants 视图(关于如何组织存储库)与使用 SBT(Scala 构建工具)构建的 Scala repos 的组织方式不一致。Java 粉丝和 Scala 粉丝之间可能也有一些书呆子的姿态。但真正的问题是，这不是任何人的工作:有一个名为 Developer Productivity 的团队在某种程度上参与其中，但它没有章程或人员来说，“嘿，我们应该真正做必要的工作，将所有这些 Scala 代码纳入科学，而不是制造另一个 monorepo，”也没有强迫 Java 和 Scala 支持者找到一些相处的方式。

不幸的是，Finagle 也真的起飞了，最终科学中的代码开始依赖于 Finagle。鸟笼中的代码依赖于科学中的库。一方的更新必须由另一方发布和使用，这是一个耗时的过程，只需一次跳跃，有些项目需要多次来回跳跃。因此，我们有两个 monorepi 和一个可以想象的情况，正如同名的 Twitter 账户 [@monorepi](https://twitter.com/monorepi) 所建议的:

在这个过程中，有人认为将 Birdcage 转换为使用 Pants 会更容易，Pants 已经学会了如何构建 Scala 和处理 maven 风格的布局。然而，在某个时候，prior Pants 在 throw it over the wall fashion 中被开源，并被其他公司的一些工程师采用，如 Square 和 Foursquare，并向前发展。与此同时，同样因为没有足够多的人负责这些事情，科学仍然处于最初的内部开发版本，事实上已经独立于开源版本而发展。然而，当我们想把鸟笼放到裤子上的时候，开源版本已经领先了，所以这是鸟笼人选择的版本。

更糟糕的是——还是因为投资不足——这两种裤子都不完全可靠。因此，不同的团队进化出了他们的货物养殖策略，以使其足够好地运转。对于一些团队来说，这包括运行一个脚本 wash-pants，它积极地清除运行之间缓存的所有 state Pants 以加速构建。

我们也开始使用 Thrift 作为我们的数据交换格式，但是在使用哪个 Thrift 编译器或者我们是否应该发布 Thrift IDL jars 或者已经编译的工件上没有达成一致。同样，肯定有人对所有这些问题都有自己的看法——毕竟我们是一群工程师——但没有人有能力提出这些问题，也没有人有时间去做这些工作来坚持这些问题。让百花齐放，真的。

所有这些都是说，这是一个烂摊子。2013 年 4 月，当我来到 Twitter 从事 A/B 实验系统的工作时，鸟笼到裤子的全面转换“迫在眉睫”。事实上，它直到一年半以后才完成。2013 年末，当时的工程学 SVP 克里斯·弗莱(Chris Fry)宣布，我们将把我们的代码转移到 monorepo 中，这基本上意味着将科学和鸟笼融合在一起。2014 年 5 月，他说我们肯定会在 2014 年 7 月 11 日之前加入 monorepo。声明发布几周后，他离开了 Twitter，但新的工程主管 Alex Roetter，最后一次看到他从 ads 代码库中删除 Scala 代码，重申了这个目标。但是日期来了又去，没有 monorepo。

在他成为工程主管几个月后，罗特决定适可而止，并聘请了一位新的副总裁，我的老板 [Nandini Ramani](https://twitter.com/eyeseewaters) 来领导一个新的组织工程效率，这将包含旧的开发人员生产力组和其他几个团队，以便扩大我们可以支持 Twitter 工程其余部分的工作范围。几个月前她把我招进了 EE？从那时起，重振旗鼓并重新命名的工程效率团队一直在完成 monorepo consolidation 等项目，但也在思考如何才能真正为 Twitter 工程师提供世界级的工具和支持。

发生了什么事？为什么 Twitter 可以很好地扩展我们的软件，而我们为自己构建的帮助我们工作的软件却有这么多问题？

## 如何看待工程有效性

我认为问题的很大一部分在于，作为一个行业，我们不太善于思考如何让工程师变得高效。对于我们的软件，尤其是后端软件，我们可以通过它每秒可以处理的查询数量、我们经历的事件数量以及我们必须购买来运行它的硬件数量来衡量它的好坏。这些东西很容易衡量，甚至很容易与业务的财务影响联系起来。

另一方面，工程师的效率很难衡量。我们甚至不知道是什么让人们变得高效；因此，我们谈论 10 倍的工程师，好像这是一件事，即使是导致 10 倍工程师概念的研究也更强烈地指向 10 倍办公室的概念。

但是我们都同意，我认为，这可能会影响工程师的生产力。至少有可能伤害它。

Twitter EE 的座右铭是:“质量、速度、快乐”。这是我们试图影响整个 Twitter 工程的三件事。不像其他著名的三重，快，便宜，好，我们相信你不必只选择两个。事实上，它们相互促进:把事情做好会让你走得更快。更快地构建会给你更多的时间去实验，找到正确的方法。每个人都喜欢制造好东西，而且是大量的好东西。

但是工程效率如何影响质量、速度和快乐呢？

从简单的节省时间开始。如果我们假设工程师每天花费一定的时间等待事情发生——这些时间没有被有效利用——我们可以通过消除一些停机时间来提高人们的效率。假设一个标准的 8 小时——或者 480 分钟——的工作日，我们每天只需要为每个人节省大约 5 分钟就可以获得 1%的速度提升。显然，为了每天节省每个人五分钟的时间，我们必须每天都做一些每个人都一直在使用的事情。很明显，这有多容易取决于您的工具和流程当前导致了多少停机时间。也可以通过去除那些周期性地消耗大量时间的东西来节省时间。由于令人困惑的错误消息或日志，每隔几周花在调试问题上的额外一小时相当于每天五分钟，也就是你一年总时间的 1%。

我们可以影响人们效率的另一个更戏剧性的方法是帮助他们保持心流状态。我想你已经听说过心流的心理状态，又名“进入状态”，当一切都在运转，你可以集中注意力，解决困难的问题，等等。一般认为，进入心流大约需要 15 分钟，如果你被打断，只需一瞬间就能失去。

现代开放式办公室不利于流动，但那是另一天的文章。我们现在关心的是，我们提供给工程师的工具是否有助于保持他们的流动，或者事实上，它们是打破流动的东西。即使使用我们刚刚经历的简单的时间节省分析，每天节省 15 分钟的一个方法是每天少打断一次他们的心流。但是有益于心流的工具可能比仅仅节省 15 分钟提供更多的推动，因为心流是如此强大的一种状态，失去心流代价如此之高。显然，当涉及到增加开发者的快乐时，流也是游戏的名字。

但是，就像中断流动一样糟糕，还有更糟糕的事情削弱我们工程师的效率。从《沙丘》中我们知道，恐惧是精神杀手。那么恐惧是如何在软件开发的环境中表现出来的呢？我会说是科技债务。科技债务是精神杀手。

科技债务是缺乏质量。它会让我们慢下来。这让我们很痛苦。它打断了我们的心流，削弱了我们生存的意志。就像金融债务一样，睁大眼睛看，少量的债务可能是一件好事。但也像金融债务一样，它会随着时间的推移而复利。当你是十个或一百个工程师时欠下的一点技术债，留在账本上，会在你是一千个工程师时杀死你。

工程效率团队通常与技术债务有着密切的关系，因为它经常堆积在工具中:直到你有了专门为它们工作的人，工具往往是一些拼凑得足够好的东西，以完成一些事情。好消息是，在你清除了工具中积累的技术债务之后，你的团队将会很好地帮助其他团队解决他们自己的技术债务，这将会带来巨大的效率收益。

我们还没有到那一步，但是我对 EE 在 Twitter 的一个梦想是建立一支常备军。这些人必须是经验丰富的资深人士，有能力钻研代码库的某个部分，使代码和从事代码工作的人都做得更好。

工程效率团队可以提供帮助的另一个领域是与工程师协调，推动做事的好方法，杜绝不好的方法，无论是我们如何进行代码审查、测试代码、编写设计文档，还是其他任何事情。然而，如果你希望你的 EE 团队参与到这些问题中，你最好确保你的团队中有强大的高级工程师，因为他们将做出会影响许多其他工程师的决定和建议。

最后，向工程师提供好的工具还有一个心理方面，我必须相信这对人们的整体效率有真正的影响。一方面，好的工具只是一种享受。仅仅在这个基础上，我们应该提供好的工具，原因和许多公司为他们的员工提供美味的食物一样:它只是让每天上班变得更加愉快。但是好的工具扮演着另一个重要的角色:因为我们使用的工具本身就是软件，我们整天都在编写软件，用坏的工具来编写软件会产生一种腐蚀性的心理影响，暗示我们可能实际上不知道如何编写好的软件。理智上，我们可能知道，除了产品的主要功能之外，还有不同的团队在开发内部工具，但如果你使用的工具妨碍了你的工作，或者设计得很糟糕，你很难不怀疑你公司的整体能力。

## 让我们建立一个模型

因此，让我们假设有*件事情我们可以做，这将提高我们的工程组织生产的软件的质量，它生产软件的速度，以及我们的工程师在他们的工作中体验到的快乐，并且以一种真正的方式增加这些事情将最终使公司受益。由于没有更好的术语，我们姑且称之为“有效性”。*

这是一个工程组织整体效率的简单模型:

*E* 是一个组织的总效率，其中 *eng* 是工程师总数， *ee* 是致力于工程效率风格团队的工程师数量， *b* 是第一个 ee 工程师对其余工程师效率的提升， *s* 代表每个额外的 EE 工程师如何提升总生产力。如果 *s* 是 1，那么每个 EE 工程师将增加一个 *b* 的助推力。如果少于一个，看起来很有可能，那么每一个新的 EE 工程师都比前一个工程师的影响小。

这显然是一个非常简单的模型，像所有模型一样，是错误的。但可能有用。假设你的工程师总数或多或少给定，这个模型的两个有趣的参数是比例因子， *s* 和助推， *b* 。坦率地说，对于如何设置*的*，我没有什么好主意。我很确定不到一个。如果它是 0.5，这将意味着总的提升将随着 EE 工程师数量的平方根而增长；也就是说，要使总的提升翻一番，你就必须让 EE 工程师的数量平方。这个降幅似乎有点太大了。所以假设 0.7 是一个合理的猜测。对于 *b* 来说，我们可以想一想刚才讨论的 EE 人员可以帮助提高其他工程师效率的所有方法。在简单的节省时间、帮助工程师保持流畅、消除技术债务、鼓励和支持良好实践以及通过提供优秀工具来增加快乐之间，全面提高 2%的效率似乎是合理的，甚至可能是保守的。

现在让我们看一些总效率的图表，取决于我们有多少工程师致力于效率工作，假设 *s* = 0.7 和 *b* = 0.02。如我所说，这些在我看来是相当保守的价值观。稍后你可以玩这个模型，并放入你自己的价值观。

在第一个图中，我们看到，对于一个 10 人的工程组织来说，将任何工程师投入到工具上实际上是不值得的，因为最大的效率——由箭头指出——是当你将零个工程师投入到工程效率上时你所得到的 10 个工程师。在这样一个小的工程组织中，单个工程师可能会将困扰他们的事情自动化，简单地权衡他们在自动化上花费的时间将多快得到自动化节省的时间，但不值得为此投入任何人。

然而，如果你仔细观察这个图表，你会发现虽然它看起来像一条直线，但它实际上是稍微弯曲的:当你把一个工程师投入到 ee 工作中时，你会失去他们的工作，但你会有所收获，因为那个工程师正在使其他九个更有效。问题是，只有其他 9 名工程师，其收益加起来不足以弥补 EE 工程师的工作损失。

在 100 名工程师时，有了这些参数，曲线开始更明显地弯曲，因为我们有足够的工程师来提高效率，以弥补几名 EE 工程师的成本。该模型建议我们应该将两名工程师投入到 EE 中，这将使总生产率达到 101 名工程师的水平，因此相当于一名免费工程师的工作量。

然而，一旦我们有了 1000 个工程师，每个工程师的小收益开始增加，即使每个额外的 EE 工程师增加的效率越来越少。如果这些参数是正确的，对于一个 1000 人的工程组织，我们应该将超过四分之一的工程师——255 人——用于工程效率，以 1000 美元的价格产生相当于 1465 名工程师的总效率。

如果我们假设随着我们的工程组织再增长一个数量级，达到 10，000 名工程师，该模型仍然有效，那么我们希望有超过三分之一的工程师从事 EE 风格的工作，10，000 名工程师中的 3，773 名工程师的总效率相当于 45，945 名没有 EE 的工程师。

我必须承认，我很难想象一个比整个 Twitter 还要大的 EE 组织，但我也很难想象一个 10，000 人的工程团队。但是请注意，即使在从 100 名工程师增加到 1000 名工程师的过程中，EE 工程师的最佳数量也比工程师的总数量增长得快得多，并且回报也不成比例地大。这就是为什么不投资不足来支持我们的工程师是如此重要。

## 给花园举行婚礼

然而，对于这一切有一个警告。为了让工程效率工程师能够提高整个工程的效率，事情需要标准化。正如我们刚刚看到的，只有当你为许多工程师工作时，在工程效率工作上的大投资才开始得到回报。你可能为一个 1000 人的工程组织工作，但是如果你正在使用的工具或流程只有 100 人使用，那么 100 是相关的数字，而不是 1000。

这就是把 999 朵花连根拔起的原因。一旦你的工程组织达到一定的规模，你可以通过投资让所有的工程师都更有效率而获得的好处开始淹没一个团队以他们自己的方式，稍微不同的方式做事可能获得的轻微收益。在“百花齐放”阶段，人们将种植各种各样的异国花卉，其中一些非常可爱，甚至很好地适应了当地的小气候；你需要能够决定哪些将是一流的，培育你的花园成员，哪些是杂草。

我明白这是一个微妙的平衡。只要你选择了他们当前喜欢的做事方式，每个人都会喜欢你做出一些关于如何做事的决定，并带来一些一致性。另一方面，当事情足够混乱的时候，很多人会很高兴有人进来，做一些关于如何做事情的决定，并实际上使这些决定生效。

因此，你需要具备良好技术判断力和技术能力的工程师，才能在混乱中走在前面，从你的工具中积累的技术债务中挖掘出来。但是好消息是，每次你在质量、速度和为你公司的工程师带来快乐方面做出一些真正的改进，你就会赢得更多的信任来做决定。

您的目标应该是选择您将支持的工具和过程集，并支持它们。投入比你可能认为需要的更多，并坚持不懈地专注于使你所支持的工具和过程变得令人敬畏。让高级工程师尽早参与进来，这样他们就能为你的工程组织做出好的选择，并让他们参与进来，让他们成为现实。如果你落后了，就像 Twitter 那样，你可能需要投入更多来恢复你的花园。当你落后了，而“官方”的方法没有真正发挥作用时，你会得到更多的鲜花盛开，因为人们和团队需要找到他们自己的方法来完成他们的工作。

但是一旦你达到你照料的所有花都很棒的程度，人们就会使用它们。如果他们不这样做，那是因为他们有真正的理由不这样做。当你没有被现有的工作淹没的时候，你应该有时间把一个走自己路的团队当作一个机会来学习你所提供的产品如何不能完全满足你的客户的需求。

换句话说，当你的花园整洁且管理良好时，如果一个漂亮的新志愿者出现，你不必惊慌失措，因为你担心它会占领花园。你可以看着它成长，如果它看起来对花园有价值，你可以开始像培育其他的花一样培育它。

我们正在推特上讨论这件事。工程效率，这个团队，只有一年的历史，我们仍然在某种程度上以 weed whacker 模式运作，有很多机会通过简单地改进我们现有的工具来显著提高 Twitter 工程师的效率。也许在一年左右的时间里，我会有一个更复杂的模型和一个理论，关于一旦你把一切都整理好了，你可以缩减你的 EE 风格的团队，因为打理一个维护良好的花园几乎不需要多少人，而只需要把一个花园打理得井井有条。但我不认为 Twitter 从一个开发者成长到几十个、几百个、几千个开发者所走的路与其他公司已经走的或未来将要走的路有什么不同，所以也许你们都可以从我们这里学到一些投资不够、不够快、不够支持你们的工程师的后果。

与此同时，我希望你的工作质量高、速度快、快乐，并在照料花园时过得愉快。

更正:这篇文章的早期版本说，裤子是由其他公司的前 Twitter 工程师发现的。事实上，成为裤子主要用户的公司中只有一家有前 Twitter 员工。我还把 2014 年世界杯德国对巴西的比赛误认为是决赛，而不是半决赛。