# 第 1 部分–我们迁移| Evernote | Evernote 博客的选择

> 原文:[https://blog . evernote . com/tech/2017/02/08/part-1-evernote-service-options-migrate-Google-cloud-platform-GCP/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.evernote.com/tech/2017/02/08/part-1-evernote-service-options-migrate-google-cloud-platform-gcp/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

自从 2008 年开始这项服务以来，Evernote 就拥有、配置和维护自己的服务器和网络。这种方法让我们能够以我们想要的方式构建我们想要的服务。但它也有局限性——难以扩展、升级缓慢且维护昂贵。虽然我们当时拥有的基础设施非常适合支持 Evernote，但它缺乏我们未来所需的速度和灵活性。

迁移到公共云的决定是一个简单的商业决定，对 Evernote 的所有人来说都是一个令人兴奋的决定。自从我们发布第一个公告以来，我们一直在后台工作，以完成从我们的物理数据中心到我们在谷歌云平台(GCP)上的新家的迁移。似乎在一些非常疲倦的眼睛眨了一下就结束了，我们在 70 天内完成了从原地开始的迁移！

如果您想了解我们是如何着手和执行迁移的，或者甚至正在考虑这样的迁移，我们想让您更深入地了解我们做了什么，以及我们是如何这么快完成的。这并不是一份完整的迁移操作手册，而是应该涵盖我们必须做出的关键决策以及我们如何实现这些决策。

我们最好从 Evernote 服务的概述开始。

### Evernote 服务

我们的服务由以下构件组成。

**碎片(NoteStore)**

 **这是 Evernote 能力/服务的核心单位。它是存储和服务用户笔记的构件。每个碎片可以支持超过 30 万 Evernote 用户。碎片包含:

*   Evernote 客户端连接的前端 web 服务层——这是基于 Tomcat 的。
*   数据存储层——包含用户笔记的 MySQL 数据库。
*   搜索索引——用户内容的服务器端 Lucene 搜索索引。

有 762 个这样的碎片，或笔记存储，总共管理 2 亿个用户帐户，存储大约 50 亿条用户笔记。

**用户商店**

一个基于 MySQL 的中央用户和首选项数据库，存储关于用户的所有集中信息并管理他们的身份验证。由于该数据库管理服务的所有用户状态和身份验证，因此它是服务中最关键和最复杂的部分，也是我们总是格外小心的部分。

**【用户附件存储(资源)】**

我们有一个单独的文件存储层，用于存储 50 亿个用户附件(我们称之为资源)。这包括 206 个独立的 WebDav 服务器。当你上传一个附件到 Evernote 时，你的 Shard 会把这个附件保存到本地的两个不同的 WebDavs 上。一份发送到位于我们远程灾难恢复数据中心的异地 WebDavs。

**前端负载均衡**

我们运行一个高可用性、负载平衡的集群，该集群加速和终止 TLS，并负责将用户的请求路由到他们的笔记数据所在的适当后端碎片。

**配套服务**

最后，我们还有大约 200 台 Linux 服务器，它们执行缓存和批处理功能，例如手写和文本识别。

### 我们的迁移选项

对于 Evernote 这种规模的服务，设计向云的迁移总是一项复杂的任务，需要做出多个相互依赖的决策。我们想要快速移动和迭代，所以我们采取了基于关键的战略决策来构建稻草人的方法。然后，在可能的情况下，我们测试看稻草人是否是一个可行的计划。这允许我们快速重复我们的计划。

我们从了解需要改变什么开始，并且知道有些组件不会简单地(或直接地)转化为我们新的云世界。我们首先将环境的组件分为两类:

*   这些系统在他们位于 GCP 的新家看起来大致相同。碎片、用户存储和大多数支持服务都在这个组中。它们在我们的物理数据中心基于 Linux，并将迁移到云中类似的 Linux 虚拟机。

*   **转型**–作为迁移的一部分，用户附件存储、我们的负载平衡层和识别服务(Reco)需要进行重大转型。云中没有对等的服务，或者云中存在更有效的方法。

### 迁移方法

然后，我们需要考虑我们的迁移选项。对于 Evernote，有两个显而易见的选择:

*   **大爆炸**–这是迁移项目中的一个单点，在这里您将 100%地从旧系统切换到新系统。在每个人都运行自己的数据中心，应用程序架构是整体式的，分布式程度较低的时候，这种方式更受欢迎(可能是因为这通常是唯一的选择)。这也被称为*‘交叉手指，闭上眼睛，按下按钮，希望一切都好计划！’*

*   **分阶段切换**–这是一种分而治之的方法，您可以分阶段或分批迁移服务，或者按服务或用户分组。此类模型通常还允许您在提交整个迁移之前“测试”或验证部分迁移。

当我们回顾我们的具体情况时，很明显“大爆炸”不是一个选项。即使有最好的计划，我们也要冒太大的风险去一步到位，并希望我们已经覆盖了所有的基地。我们也知道我们的应用程序没有被设计为在多个位置之间“分离”运行，尽管有迹象表明我们可能已经使“分离”环境工作了一段时间。

所以我们需要在这两个极端之间找到一个折中的办法。如果可能的话，我们希望为我们称之为“加速分阶段切换”的事情做计划。整个服务迁移将在不到 20 天的紧张时期内进行，在整个迁移窗口内有非常具体的阶段，以最大限度地降低每个步骤的风险。如果事情没有像预期的那样运行，这样的计划也将允许回滚点。

在第 2 部分中，我们将讨论如何在 GCP 保护客户数据。

如果您有任何后续问题，请加入我们的 Evernote 论坛。**