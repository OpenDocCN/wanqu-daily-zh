# 向前移动代码。作者 Myo Thein 和 Dan Lee |作者工程 Yammer | Yammer 工程| Medium

> 原文:[https://medium . com/@ yammereng/moving-code-forward-de7d 7852 a 58 f？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://medium.com/@yammereng/moving-code-forward-de7d7852a58f?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

每个人都喜欢好的重写。扔掉陈旧的代码库，用闪亮的新东西取而代之，感觉棒极了。不过重写也伴随着一些严重的权衡，在很多情况下，从头开始的决定根本就不是正确的决定。在 yammer.com 的前端代码库的七年历史中，我们从未抛弃整个东西并重新开始。为什么？好了，让我们来快速了解一下 Yammer 前端的特点…

*   它很大。我们有大约 120，000 行 JavaScript 代码。
*   它拥有众多遍布全球的贡献者。Yammer 前端团队有 25 名成员，分布在旧金山、雷蒙德和伦敦的办公室。
*   它经常被部署。我们每天部署前端代码，能够在大约 20 分钟内按需交付补丁。
*   它变化很快。在任何给定的时间，都有十几个项目团队在添加提交。

像这样的代码不太适合全局重写。但是！这并不意味着我们从不改进代码的整体健康状况。相反，Yammer 前端团队已经非常擅长于进行安全的迭代改进，而不会降低团队快速交付特性的能力。

## 介绍要求

今年，我们引入了 RequireJS 来帮助进行代码组织和动态加载。尽管这是对我们代码库的一个大的、根本性的改变，我们还是迭代地引入了它，现在我们所有的 JavaScript 模块都使用 RequireJS。如果您有兴趣了解这个项目的更多信息，请查看 Yammer 前端工程师 Dan Lee 和 Chris Chen 在今年的前端运营大会上的演讲:



Dan Lee & Chris Chen: Introducing RequireJS Into a Large Codebase. Delicately.



## 骨气。成分

Yammer 前端的第一次提交发生在 2007 年——远在流行的 JavaScript MVC 框架引入之前。像许多其他人一样，我们创建了自己的 MVC 框架来恰当地设计我们的代码。今天，在前端框架领域有许多成熟的选择，我们已经意识到使用成熟的开源解决方案的好处。我们决定从我们自己的 UI 组件抽象中迁移出来，开始使用[主干](http://backbonejs.org/)视图。在这个过程中，我们创造了一个我们称之为“主干”的薄包装。组件。骨气。组件提供了视图之间父/子关系的管理。我们开源了这个抽象，你可以在 Github 上查看:https://github.com/yammer/backbone-component。

骨干的引入。当我们将旧的、劣质的 UI 组件移植到这个新的 API 时，Component 在我们的前端工程师中掀起了一阵热潮。我们甚至有几个“黑客日”，每个人负责转换一个或多个组件。

下面是一个时间序列图，说明了我们的努力。



## FeedList 重构

Yammer 是一个消息传递系统，其核心是称为提要的线程列表。我们的 FeedList，即显示线程列表的 UI 组件，从一开始就已经存在，并且经受了无数的 A/B 测试和功能迭代。不用说，随着时间的推移，快速添加新功能变得越来越困难。因此，有了我们新的 UI 抽象，前端团队开始着手一个项目来复兴 FeedList。该项目的主要开发者之一 Sugendran Ganess 讲述了他在 Scotland JS 的经历。他的演讲视频可以在这里看到:



Sugendran Ganess: Refactoring Legacy Code



## 我们是怎么做到这一切的？

那么，我们如何在不牺牲产品质量或减缓发布节奏的情况下做出所有这些大的改变呢？实验。“实验”是 A/B 测试的 Yammer 术语。我们有能力在代码中引入一个分支，并且只向该分支暴露某些用户/网络。通常，这用于确定一个特性是否有助于产品度量，但是这个系统对于缓慢引入基础设施变更也非常有用。以上所有项目都是利用实验完成的。

总的流程是首先单独为我们的 QA 团队启用实验，随着代码的稳定，慢慢地将它推广到越来越多的用户。以一种允许代码隐藏在实验开关后面的方式来构造代码需要更多的前期工作，但是我们发现这种技术对于对我们快速移动的代码库进行大的改变是必不可少的。

## 我们如何确定这些项目的优先级？

在讨论这样的项目时，另一个问题是:你什么时候有时间做这些事情？随着代码的增长，添加新功能和清理现有问题区域之间的矛盾也在增加。在 Yammer，我们为“非功能性”工作创造了一些渠道。第一个是我们称之为“内部项目”的东西:除了包含我们的产品团队想要构建的所有很酷的东西的产品 Backlog 之外，每个工程团队都有一个额外的 Backlog，装满了改善代码库健康的项目。在任何给定的时间，我们的一小部分工程师被分配到内部项目积压工作中。事情并不总是这样。内部项目的概念是随着技术债务实际上开始减缓我们快速迭代特性的能力而自然产生的。

## 为什么要这么做？为什么不直接扔掉&重写呢？

大规模重写是提高公司技术的有效方法。但是如果你的代码看起来像我们的一样——庞大，不断部署，被几十个人接触过——大规模的重写几乎不可能不破坏我们每天都在变化的运输文化。

尽管如此，Yammer 前端团队已经开发了一些技术来保持我们的代码向前发展。我们会继续前进。

