# 网飞是如何运作的:每次点击 Play 时发生的(极度简化的)复杂事情|作者 Mayukh Nair | Refraction:tech+everything | Medium

> 原文：<https://medium.com/refraction-tech-everything/how-netflix-works-the-hugely-simplified-complex-stuff-that-happens-every-time-you-hit-play-3a40c9be254b?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

# 网飞是如何工作的:每次点击播放时都会发生的(极度简化的)复杂事情



Image: Shutterstock



不久前，*《纸牌屋》第五季回归，终于结束了全世界对美国政客无情登上总统宝座感兴趣的狂热观众的漫长等待。对他们来说，开始一场马拉松就像伸出你的设备或遥控器，打开网飞应用程序，点击播放一样简单。简单，快速，即刻满足。*

网飞的运营并不简单，这项服务每天向 190 个国家的约 9800 万付费用户提供约 2.5 亿小时的视频。在这种规模下，在几秒钟内为每个用户提供高质量的娱乐可不是闹着玩的。这意味着以前所未有的规模建设一流的基础设施，也意味着体验中的许多参与者必须与之协商并保持满意——从提供内容的制作公司到处理网飞带来的网络流量的互联网提供商。

简单地说，这就是网飞的工作方式。

T2】



Dave Hahn, a senior engineer from Netflix’s Performance and Reliability Department, shows off the entire architecture of Netflix in one flow diagram. (Amazon Web Services/YouTube)



# 数百个微服务，一个巨型服务

让我们试着用一个简单的例子来理解网飞在技术方面是如何构建的。

让我们假设你手机上的地图应用程序一直在跟踪你的位置，并将你去的所有地方的复杂信息保存在一个文件中， *locations.txt.* 最后你创建了一个名为 LocoList 的应用程序，如果你手机上有地图应用程序，它会查找这个 *locations.txt* 文件，并在一个简单的列表中显示该文件中记录的所有地方。它完美地工作。

现在，我们只能说，地图应用程序的开发人员意识到，将您的所有位置信息存储在其他地方比存储在那个 *locations.txt* 文件中更好，并更新了应用程序，以便它不再在您的手机上创建或存储该文件。现在，LocoList 似乎无法找到其所有数据所依赖的 *locations.txt* 文件，也没有其他方法可以从地图应用程序中提取这些信息。疯狂现在不再起作用了。你完蛋了。

你在 LocoList 上的所有工作都已被丢弃，因为对地图的更改破坏了你的应用程序。虽然这在这里看起来没什么大不了的，但在像网飞这样的大型服务上，整个应用程序因为其中一部分的更改而宕机不仅会破坏用户的体验，还意味着应用程序的所有其他部分都必须重写，以适应您对应用程序的一部分所做的微小更改。这样的结构就是我们所说的*整体架构*。

大约十年前，网飞通过重写运行整个服务的应用程序来适应*微服务架构——*，这意味着每个应用程序，或*微服务的*代码和资源都是自己的。本质上，它不会与任何其他应用程序共享任何内容。当两个应用程序确实需要相互对话时，它们使用一个*应用程序编程接口(API)——*一组两个程序都能处理的严格控制的规则。开发人员现在可以对每个应用程序进行许多或大或小的修改，只要他们确保它与 API 配合良好。由于一个程序完全了解另一个程序的 API，任何改变都不会中断信息的交换。

网飞估计，它使用大约 700 个微服务来控制组成整个网飞服务的许多部分:一个微服务存储你观看的所有节目，一个从你的信用卡中扣除每月费用，一个为你的设备提供可以播放的正确视频文件，一个查看你的观看历史并使用算法猜测你会喜欢的电影列表，一个将提供这些电影的名称和图像，以在主菜单上的列表中显示。这只是冰山一角。网飞的工程师可以对应用程序的任何部分进行更改，并可以快速引入新的更改，同时确保整个服务中没有任何其他问题发生。

总之，为什么微服务架构对网飞如此重要？嗯，这就是他们选择的结果:



Amazon Web Services/YouTube



T2】



A typical data center, this one in particular being located in Frankfurt, Germany. (Nils Juenemann/nilsjuenemann.de)



# 然而，他们在哪里运行所有这些微服务呢？

要运行所有这些，你需要有一个庞大的计算机服务器网络，网飞曾独自拥有这些服务器，但他们意识到，如果他们花时间构建能够支持他们的软件的计算机系统，并不断修复和修改它们以满足他们的需求，他们以极快的速度增长并需要继续这样做是很困难的。他们做出了一个勇敢的决定*不再维护他们自己的服务器*，并将他们所有的东西都转移到云上——也就是说，在负责维护硬件的其他人的服务器上运行所有东西，而网飞的工程师编写了数百个程序，并迅速部署在服务器上。他们为其基于云的基础设施选择的另一个人是亚马逊网络服务(AWS)。

等等。*亚马逊？那些碰巧也经营着主要视频设备的人？网飞怎么能把自己拥有的一切***托付给一个宿敌呢？**

*嗯，许多企业遵循一种君子协定，尽管在相同的类别中竞争，但他们仍为彼此工作——一个很好的例子是三星如何在手机领域与苹果竞争，同时 iPhone 的主要部件都是由韩国巨头制造的。在 Prime Video 出现之前，网飞是 AWS 的客户，但这并不意味着他们会相互敌视。*

*事实证明，网飞和亚马逊的合作对两家公司来说是一个巨大的双赢局面。网飞是 AWS 最先进的客户，将他们的所有能力发挥到了极致，并不断创新，如何使用 AWS 为各种目的提供的不同服务器，以发挥自己的优势，这些目的包括运行微服务、存储电影、处理互联网流量。反过来，AWS 改进了他们的系统，使网飞能够在其服务器上承担大量负载，并使他们更灵活地使用不同的 AWS 产品，并利用获得的专业知识来满足成千上万其他企业客户的需求。AWS 自豪地吹捧网飞是它的最大客户，网飞可以迅速改善他们的服务，但由于 AWS 保持稳定。即使网飞夺走了 Prime Video 的人气，反之亦然。*

*T2】*



*ScaleScale/scalescale.com*



# *从卷轴到屏幕——漫长的旅程*

*当然，如果没有电视节目/电影可看，电视/电影服务会有什么好处呢？对网飞来说，将它们从电影制片人手中拿到消费者手中是一个漫长而艰难的过程:*

*   *如果这部剧/电影不是网飞自己制作的，(即不是网飞原创)，他们必须与负责发行电影或电视剧的公司谈判转播权。这意味着支付一大笔钱来获得向世界各地的客户播放电影或电视节目的合法权利。通常情况下，发行公司(甚至网飞本身)可能已经与一些地区的其他视频服务或电视频道签署了独家协议，这意味着网飞可能无法向那里的客户提供一些节目，或者在更晚的日期提供——例如，这导致《纸牌屋》第五季在中东的首播被可怕地推迟到 6 月 30 日，比 5 月 30 日获得的 150 多个国家晚了整整一个月。他们甚至让安德伍德的幕僚长用一段幽默的(英文)视频来解释这一点:*



*Netflix Middle East and North Africa / twitter.com/netflixmena*



*   *将节目或电影的原始数字拷贝存储到他们的 AWS 服务器上。原版通常是高质量的电影标准，在任何人可以观看之前，网飞将不得不处理这些。*
*   *网飞在数千台设备上工作，每台设备都播放不同格式的视频和声音文件。另一组 AWS 服务器获取这个原始电影文件，并将其转换成数百个文件，每个文件都意味着在特定类型的设备上以特定的屏幕大小或视频质量播放整个节目或电影。一个文件只能在 iPad 上运行，一个在全高清 Android 手机上运行，一个在可以播放 4K 视频和杜比声音的索尼电视上运行，一个在 Windows 电脑上运行，等等。甚至更多的这些文件可以用不同的视频质量制作，这样它们在糟糕的网络连接上更容易加载。这是一个被称为*代码转换*的过程。一段特殊的代码也被添加到这些文件中，用所谓的*数字版权管理或 DRM 来锁定它们，DRM 是一种防止电影盗版的技术措施。**
*   *网飞的应用程序或网站会确定你正在使用哪种特定的设备来观看，并获取该节目的确切文件，以便专门在你的特定设备上播放，并根据你当时的互联网速度来提供特定的视频质量。*

*关于抓取的最后一部分对网飞来说是最重要的，因为毕竟，这是互联网将视频从网飞的 AWS 服务器传送到客户设备的地方。如果管理不善或被忽视，这意味着一个真正缓慢或不可用的网飞，几乎是公司的末日。互联网是连接网飞和客户的脐带，他们需要在尽可能短的时间内提供用户想要的内容。在一个非常拥挤的网络上，数以百万计的服务争夺空间。*

## *与缓冲时间赛跑*



*CDN in a nutshell (CDN Reviews/cdnreviews.com)*



*如果最终用户的互联网连接太差，无法处理视频质量，那么构建网飞生态系统的所有操作——软件、内容和技术——都将变得毫无用处。互联网上的一切基本上都是这样工作的:当你做一些需要网络接入的事情时，一个*请求*被发送到你的互联网服务提供商(ISP)。ISP 将其转发给处理网站的专用服务器，服务器提供一个*响应*，该响应被转发回你的计算机并形成结果。对于网飞和其他顶级网站，数百万小时的视频内容通过互联网在它们的服务器和所有用户之间传递，需要更大的服务器网络来维持性能。他们通过建立一个叫做内容交付网络(CDN)的东西来做到这一点。*

*cdn 基本上做的是，它们获取原始网站及其包含的媒体内容，并将其复制到遍布世界各地的数百台服务器上。因此，当你从布达佩斯登录，而不是连接到美国的主网飞服务器，它会从离布达佩斯最近的 CDN 服务器加载一份副本。这极大地减少了延迟——请求和响应之间的时间，并且所有东西都加载得非常快。cdn 是谷歌、脸书或 YouTube 等拥有大量用户的网站无论你身在何处或网速如何都能快速加载的原因。*



*Netflix’s Open Connect boxes, supplied to internet providers. (NDTV Gadgets360/gadgets.ndtv.com)*



*网飞早些时候使用各种 CDN 网络——由 Akamai、Level 3 和 limited Networks 等巨头运营，以提供他们的内容。但是不断增长的用户群意味着他们必须在更多的地方提供更多的内容，同时降低成本——这导致他们建立了自己的 CDN，称为 **Open Connect** 。*

*在这里，他们不依赖 AWS 服务器，而是在世界各地安装自己的服务器。但它只有一个目的——智能地存储内容并交付给用户。网飞与互联网服务提供商达成协议，免费向他们提供你在上面看到的红盒子。ISP 将这些与他们的服务器一起安装。这些开放的连接盒从美国的主服务器上下载他们所在地区的网飞图书馆——如果有多个连接盒，每个连接盒都会在一个地区存储更受网飞用户欢迎的内容，以优先考虑速度。因此，一部很少被观看的电影可能比一集*更奇怪的事情*需要更多的时间来加载。现在，当你连接到网飞时，离你最近的打开的连接盒将提供你需要的内容，因此视频加载速度比你的网飞应用程序试图从美国的主服务器加载更快。*

*你可以把它想象成世界各地存储视频的硬盘，它们离你越近，你就能越快地找到它们并加载视频。幕后还有更多的诡计:正如[这个采访](https://scaleyourcode.com/interviews/interview/11)所解释的，每当你在一个节目中点击播放，网飞将定位 10 个最近的打开的连接盒，这些连接盒加载了该节目。然后，你的网飞应用程序/网站将尝试检测哪一个离你最近或在你的互联网连接上运行最快，然后从那里加载视频。这就是为什么视频开始模糊，然后突然变得清晰——这是网飞切换服务器，直到它连接到一个将给你最高质量的视频。*

*T2】*



*Screenshot by author*



# *简而言之…*

*当你按下播放键时会发生这样的事情:*

*   *数百个微服务或微小的独立程序一起工作，形成一个大型的网飞服务。*
*   *合法获取或许可的内容被转换成适合您的屏幕的大小，并受到保护以防被复制。*
*   *世界各地的服务器都会复制并存储它，以便离您最近的服务器以最高的质量和速度提供它。*
*   *当你选择一个节目时，你的网飞应用程序会从这些服务器中挑选一个来加载视频。*
*   *你现在被 Frank Underwood 的令人不寒而栗的策略所吸引，被 BoJack rideman 过山车般的生活所压抑，被《无主之主》中的 Dev 逗乐，被《T2》黑镜中的故事弄得对科技的未来感到恐惧。随着你沉迷于电视，变成一个电视迷，你的寿命也会缩短。*

*以前看起来很简单吧？*

**【更新(2017 年 11 月 21 日):这篇文章中的一张图片被误认为是亚马逊网络服务数据中心的图片。我很感谢德国亚马逊网络服务的好心人亲自联系我并提醒我这个错误。]**