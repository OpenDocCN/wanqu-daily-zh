# 帮助 Medium 扩展到 2600 万阅读时间的堆栈- Medium 技术堆栈

> 原文：<http://stackshare.io/medium/the-stack-that-helped-medium-scale-to-2-6-millennia-of-reading-time?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

***编者按**:作者[丹尼尔·普皮乌斯](/dpup)[中](/medium)T7】工程负责人*

* * *

![medium](img/c5f4d96fe8a00dcde9df9a7d55f89a2d.png)

## 背景

媒介是一个网络。这是一个分享重要故事和想法的地方——这是你向前思考的地方，人们已经花了 14 亿分钟——或 2600 万年——在媒体上阅读。

我们每个月都有超过 2500 万的独立读者，每周都有成千上万的帖子发布。但是我们希望媒体成为一个成功的衡量标准不是观点，而是观点。在这里，想法的质量很重要，而不是作者的资格。一个对话推动思想前进，话语仍然重要的地方。

我领导工程团队。我之前是谷歌的一名软件工程师，在那里我负责 Google+和 Gmail，并参与创建了 Closure 项目。在过去的生活中，我玩过滑雪板，跳过飞机，还住在丛林里。

## 工程团队

我为这个团队感到无比自豪。这是一群很棒的有才华、好奇、有头脑的人，他们聚在一起做伟大的工作。

我们在跨职能、任务驱动的团队中运营，因此尽管有些人专攻，但每个人都应该感觉能够接触到堆栈的任何部分。我们相信接触不同的学科会让你成为一名更强的工程师。我在这里写了[我们的其他价值观](https://medium.com/medium-eng/engineering-values-7143c0db0bd6)。

团队在如何组织他们的工作方面有很大的灵活性，但作为一个公司，我们设定季度目标，并鼓励迭代冲刺。我们使用 [GitHub](/github) 进行代码审查和错误跟踪，使用 [Google Apps](/google-apps) 处理电子邮件、文档和电子表格。我们大量使用[Slack](/slack)——和 Slack 机器人——许多团队使用 [Trello](/trello) 。

## 初始堆栈

我们从一开始就部署到了 [EC2](/amazon-ec2) 。主要的应用服务器用 [Node.js](/nodejs) 编写，我们迁移到 [DynamoDB](/amazon-dynamodb) 进行公开发布。

有一个节点服务器，我们用于图像处理，委托给 [GraphicsMagick](/graphicsmagick) 进行实际的艰苦工作。另一台服务器充当后台任务的 [SQS](/amazon-sqs) 队列处理器。

我们用 [SES](/amazon-ses) 做电子邮件， [S3](/amazon-s3) 做静态资产， [CloudFront](/amazon-cloudfront) 做 CDN， [nginx](/nginx) 做反向代理。我们使用 [Datadog](/datadog) 进行监控，使用[page duty](/pagerduty)进行报警。

该网站使用 TinyMCE 作为编辑器的基础。在发布之前，我们已经在使用[闭包编译器](/closure-compiler)和[闭包库](/closure-library)的一些部分，但是[把手](/handlebars)用于模板。

## 当前堆栈

对于一个看似简单的中型网站来说，其背后的复杂性可能令人惊讶。只是个博客，对吧？您可能在几天内就可以使用 Rails 完成一些东西。:)

总之，够了。让我们从底层开始。

#### 生产环境

我们在亚马逊的虚拟私有云上。我们使用 [Ansible](/ansible) 进行系统管理，这允许我们将配置保持在源代码控制之下，并以可控的方式轻松推出变更。

我们有一个面向服务的架构，运行大约十几个生产服务(取决于你如何计算它们，有些比其他的更微观)。关于是否部署一个单独的服务的主要选择是它所执行的工作的特殊性、跨越服务边界进行相关更改的可能性以及资源利用特征。

我们的主要应用服务器仍然写在[节点](/nodejs)中，这允许我们在服务器和客户端之间共享代码，这是我们在编辑器和 post 转换中大量使用的。Node 对我们来说工作得很好，但是在我们阻塞事件循环的地方出现了性能问题。为了缓解这种情况，我们在每台机器上运行多个实例，并将昂贵的端点路由到特定的实例，从而隔离它们。我们还接入了 V8 运行时，以深入了解哪些滴答花了很长时间；通常这是由于 JSON 反序列化期间的对象具体化。

我们有几个用 [Go](/go) 写的辅助服务。我们发现 Go 非常容易构建、打包和部署。我们喜欢没有冗长的类型安全和 JVM 调优的 [Java](/java) 。就个人而言，我喜欢在团队环境中使用固执己见的语言；它提高了一致性，减少了模糊性，最终给你更少的上吊的绳子。

我们现在使用 [CloudFlare](/cloudflare) 为静态资产提供服务，尽管我们将 5%的流量快速发送到，将 5%发送到 [CloudFront](/amazon-cloudfront) ，以便在紧急情况下需要切换时保持缓存的热度。最近，我们也将 CloudFlare 用于应用流量，主要用于 DDOS 保护，但我们对性能提升感到满意。

我们结合使用 [Nginx](/nginx) 和 [HAProxy](/haproxy) 作为反向代理和负载平衡器，以满足我们需要的维恩图特性。

我们仍然使用 [Datadog](/datadog) 进行监控，使用[page duty](/pagerduty)进行警报，但是我们现在大量使用 ELK ( [Elasticsearch](/elasticsearch) 、 [Logstash](/logstash) 、 [Kibana](/kibana) )来调试生产问题。

#### 数据库

[DynamoDB](/amazon-dynamodb) 仍然是我们的主要数据存储，但它并没有完全一帆风顺。我们遇到的一个长期问题是在病毒式活动或百万粉丝用户粉丝活动期间的[热键问题](https://medium.com/medium-eng/how-medium-detects-hotspots-in-dynamodb-using-elasticsearch-logstash-and-kibana-aaa3d6632cfd)。我们在 Dynamo 前部署了一个 [Redis](/redis) 缓存集群，可以缓解这些读取问题。为开发人员的便利和产品的稳定性而进行的优化经常看起来不一致，但是我们正在努力缩小差距。

我们开始使用 [Amazon Aurora](/amazon-rds-for-aurora) 来处理一些更新的数据，这允许比 Dynamo 更灵活的查询和过滤。

我们使用 [Neo4J](/neo4j) 来存储代表介质网络的实体之间的关系，用两个副本运行一个主设备。人、帖子、标签和收藏是图中的节点。边是在创建实体时创建的，并且是在人们执行诸如关注、推荐和突出显示等操作时创建的。我们遍历图表来过滤和推荐帖子。

#### 数据平台

从一开始，我们就非常渴望数据，投资于我们的分析基础设施，以帮助我们做出业务和产品决策。最近，我们能够使用相同的数据管道反馈到生产系统，以支持数据驱动的功能，如 Explore *。*

我们使用 [Amazon Redshift](/amazon-redshift) 作为我们的数据仓库，为我们的其他工具提供可扩展的存储和处理系统。我们不断地将我们的核心数据集(如用户、帖子)从 Dynamo 导入 Redshift，并将事件日志(如帖子浏览、帖子滚动)从 S3 导入 Redshift。

作业由 Conduit 调度，这是一个管理调度、数据依赖和监控的内部工具。我们使用基于断言的调度模型，在这种模型中，只有满足了作业的依赖性，才会执行作业(例如，依赖于一整天事件日志的每日作业)。在生产中，这被证明是必不可少的——数据生产者从他们的消费者中分离出来，简化了配置，并且系统非常可预测和可调试。

虽然在红移中运行的 SQL 查询对我们来说很好，但我们需要将数据移入和移出红移。我们越来越多地转向 [Apache Spark](/spark) 进行 ETL，因为它的灵活性和随我们的增长而扩展的能力。随着时间的推移，Spark 可能会成为我们数据管道的首选工具。

我们使用[协议缓冲区](https://developers.google.com/protocol-buffers/)用于我们的模式(和模式演化规则)来保持分布式系统的所有层同步，包括移动应用程序、web 服务和数据仓库。使用定制选项，我们用配置细节(如表名和索引)和验证约束(如字符串的最大长度或数字的可接受范围)来注释模式。

人们也需要保持同步，以便移动和 web 应用程序开发人员能够以相同的方式记录日志，产品科学家能够以相同的方式解释字段。我们通过将模式视为规范，严格记录消息和字段，并发布从*生成的文档，来帮助我们的员工处理数据。原型*文件。

#### 形象

我们的图像服务器现在是用 [Go](/go) 编写的，使用瀑布策略来提供处理过的图像。服务器使用 [groupcache](https://github.com/golang/groupcache) ，它提供了 memcache 的替代方案，同时有助于减少整个机群的重复工作。内存中的缓存由持久的 S3 缓存支持；然后按需处理图像。这使我们的设计师能够灵活地改变图像呈现方式，并针对不同平台进行优化，而不必进行大量批处理工作来生成调整大小的图像。

虽然它现在主要用于调整大小和裁剪，但该网站的早期版本允许颜色清洗、模糊和其他图像效果。处理动画 gif 一直是一个巨大的痛苦，原因应该是另一个帖子。

#### 文本快照

有趣的 TextShots 功能由一个小型 Go 服务器提供支持，该服务器作为一个渲染器进程与 [PhantomJS](/phantomjs) 接口。

我总是想象切换渲染引擎来使用类似 Pango 的东西，但是在实践中，用 HTML 布局图像的能力更加灵活和方便。该特性的使用频率意味着我们可以非常轻松地处理吞吐量。

#### 自定义域

我们允许人们为他们的媒体出版物设置自定义域名。我们希望单点登录和 HTTPS 无处不在，所以开始工作并不简单。我们有一套专用的 HAProxy 服务器来管理证书，并将流量路由到主要的应用服务器群。设置域名时需要一些手动工作，但是我们已经通过与 [Namecheap](/namecheap) 的定制集成实现了大部分自动化。证书供应和发布链接由专用服务处理。

#### Web 前端

在网络上，我们倾向于想接近金属。我们有自己的单页应用程序框架，它使用[闭包](/closure-library)作为标准库。我们使用闭包模板在客户机和服务器上呈现，并且使用闭包编译器来缩减代码并将其分成模块。编辑器是我们的 web 应用程序中最复杂的部分，这一点[尼克](https://medium.com/medium-eng/why-contenteditable-is-terrible-122d8a40e480)已经写过了。

#### ios

我们的应用都是原生的，很少使用网络视图。

在 iOS 上，我们混合使用自主开发的框架和内置组件。在我们的网络层，我们使用 NSURLSession 发出请求，使用 Mantle 将 JSON 解析成模型。我们有一个建立在 NSKeyedArchiver 之上的缓存层。我们有一种通用的方式来呈现具有通用样式的列表中的项目，这允许我们快速构建具有不同类型内容的新列表。post 视图是用带有自定义布局的 UICollectionView 构建的。我们使用共享组件来呈现完整的帖子和帖子预览。

每一个提交都被构建并推送给中型员工，这样我们就可以尽快试用这个应用。我们发布 appstore 的节奏取决于审核周期，但我们会尽可能快地推进，即使只有最少的更新。

对于测试，我们使用 XCTest 和 OCMock。

#### 机器人

在 Android 上，我们保持 SDK 和支持库的最新版本。我们不使用任何全面的框架，而是喜欢为重复的问题建立一致的模式。我们用[番石榴](/guava)来代表 Java 中缺失的所有东西。但除此之外，我们倾向于使用旨在解决更小问题的第三方工具。我们使用协议缓冲区定义我们的 API 响应，然后生成我们在应用程序中使用的对象。

我们使用[莫克西托](http://mockito.org/)和[机器人](http://robolectric.org/)。我们编写高级测试来启动活动并四处探查——当我们第一次添加屏幕或准备重构时，我们创建这些测试的基本版本。当我们繁殖虫子以抵御退化时，它们就会生长。我们编写低级测试来测试单个类的细节——我们在构建新功能时创建这些测试，它们帮助我们推理我们的类如何交互。

每一次提交都被自动推送到 play store 作为 alpha 版本，并立即发送给中级员工。(这包括该应用程序的另一种风格，用于我们的内部版本 Medium-Hatch)。大多数周五，我们会向[我们的 beta 组](https://medium.com/@caramev/welcome-to-the-android-beta-4ca716ef65e4)推广最新的 alpha，让他们在周末玩一些东西。然后，在星期一，我们把它从测试版推广到生产版。因为最新的代码总是可以发布的，所以当我们发现一个坏的 bug 时，我们会立即将补丁发布到产品中。当我们担心一个新的特性时，我们让测试组玩久一点；当我们兴奋时，我们会更加频繁地释放。

#### A|B 测试和功能标志

我们所有的客户端都使用服务器提供的特性标志，称为[变体](https://github.com/Medium/variants)，用于测试和保护未完成的特性。

#### 混杂的

在产品的边缘还有很多我上面没有提到的东西: [Algolia](/algolia) 让我们可以快速迭代搜索相关的功能， [SendGrid](/sendgrid) 用于收发电子邮件， [Urban Airship](/urban-airship) 用于通知，还有 [SQS](/amazon-sqs) 用于队列处理，还有[bloom filters](https://github.com/armon/bloomd)，RSS 的 [PubSubHubbub](https://github.com/pubsubhubbub/PubSubHubbub) 和 [Superfeedr](https://superfeedr.com/) 等等。等等。

## 构建、测试、部署工作流

我们支持持续集成和交付，尽可能快地推动绿色发展。詹金斯管理所有这些流程。

历史上，我们使用 Make 来构建系统，但是对于新的项目，我们正在迁移到 [Pants](/pants) 。

我们有一个[单元测试](https://github.com/caolan/nodeunit)和 [HTTP 级功能测试](https://github.com/Medium/falkor)的组合。所有提交都必须通过测试才能被合并。我们与 Box 的团队合作，使用[集群运行器](https://github.com/box/ClusterRunner)来分发测试并使其快速完成。它与 GitHub 有很好的集成。

我们尽可能快地部署到试运行环境，目前大约需要 15 分钟，然后成功的构建将作为生产的候选。主应用服务器通常每天部署大约五次，但有时多达 10 次。

我们进行蓝/绿部署。对于生产，我们将流量发送到 canary 实例，发布流程在继续部署之前监控错误率。回滚是内部 DNS 翻转。

## 下一步是什么

我们开始为作者和出版商开发货币化功能。这是一个绿色领域的项目，我们正以开放的心态处理这个问题。我们认为未来需要新的内容融资机制，我们希望确保我们的功能能够激励优质内容和网络价值。

![medium](img/62ad2d997e45a7a75b5b7d02b5060b4e.png)

## 加入媒体工程

一般来说，我们总是有兴趣与有消费领域工作经验的任务驱动型工程师交谈。我们并不规定你懂什么语言，因为我们认为优秀的工程师可以很快学会新的学科，但你应该[好奇、有意识、果断、有同情心](https://medium.com/engineering-leadership/software-engineer-traits-fbf5dee9289c)。也就是说，使用 iOS、Android、Node 或 Go 的经验会给你一个好的开始。

我们正在壮大我们的[产品科学团队](https://medium.com/@tc/analytics-engineer-cefea925aecd)，因此我们正在寻找有构建数据管道和大型分析系统经验的人。

我正在寻找工程领导者来帮助扩展团队。他们应该对组织理论感兴趣，愿意弄脏自己的手，并且是仆人式领导的支持者。

你可以在这里了解更多关于[中型工程的信息。](http://medium.com/medium-eng)