# 服务器正在燃烧

> 原文:[https://logicmag.io/05-the-servers-are-burning/?UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://logicmag.io/05-the-servers-are-burning/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

在学会如何编写软件之后，我学到的第一件事就是如何为该软件编写测试。首先，您编写代码来执行某项任务——比如说，求一个数的平方根。然后你写了更多的代码来测试第一段代码是否如你所愿。该函数是否返回正确的值？二是四的平方根吗？

我认为这种测试是荒谬的。如果你写了有问题的软件，为什么你写的用来检查软件的软件会有更少的问题？这在我身上发生了很多:我花了 20 分钟试图找出为什么我的测试说我的程序坏了，却发现测试本身也坏了。

然而，我发现更麻烦的是，为了编写有效的测试，程序员必须知道一个软件可能失败的所有方式，以便为这些情况编写测试。如果她忘记了-1 的平方根是未定义的，她就不会为它写测试。但是，很明显，如果你知道你的 bug 在哪里，你就会修复它们。错误通常隐藏在我们忘记看的地方。

我的第一个雇主，在线约会网站 OkCupid，也没有反复强调测试。在某种程度上，这是因为我们的公司太小了。只有七名工程师和我一起维护运行在我们服务器上的所有代码——测试工作既耗时又容易出错。“我们不能为了技术债务而牺牲前进的动力，”时任首席执行官迈克·马克西姆告诉我，他指的是工程师构建幕后技术而不是面向用户的功能的成本。“用户不在乎。”他认为测试框架有点学术性，比实用性更崇高。

相反，我们防止网站崩溃的方法是向一小部分用户推送更新，然后观察会发生什么。有什么东西坠毁了吗？滞后增加了吗？用户是否报告了新的问题？这个想法是，发现错误的最好方法是将软件暴露给真实的站点流量，并在必要时用补丁或回滚来快速响应。

也许对于一个小型工程团队来说，这是一个明智的方法。但当我刚开始在 OkCupid 工作时，我发现它很可怕。大约四个月后，我被指派制作一个功能，突出会员在个人资料中列出的兴趣——比如“ *Infinite Jest* ”、“冥想”、“肮脏的投影仪”——供 OkCupid 的工作人员查看。因为这是用户无法访问的内部功能，所以风险很低。

尽管如此，我还是担心会破坏这个网站，并且一直在拖延。我的老板，当时的工程总监 David Koh 开始注意到这一点。“我知道这很吓人，”有一天下班时他告诉我，“但你必须扣动扳机，启动代码。很快你就会不假思索地做到这一点。”他告诉我第二天推我的更新，那时他不在办公室。

如果出了什么差错，没有大卫在那里拯救我，我很紧张要做出改变。但是，不可否认的是，我的更新非常少。第二天早上，为了掩人耳目，我请首席执行官迈克看一下我的代码，他也是 OkCupid 最好的工程师。“你只增加了一些功能，”他一边说，一边在他的显示器上读着我的台词。“看起来很好。”我觉得为如此无关紧要的事情占用他的时间很愚蠢。

所以我为一部分用户发布了我的新代码，并观察了统计数据。一切似乎都很好。我把我的修改推给了网站的其他人，然后去吃了点零食。当我回来时，一切肯定都不好。该网站已经慢如蜗牛，然后变得完全没有反应。在我们单层办公室的后角，运营主管喊道:“服务器着火了。到底是怎么回事？”

“一定是我干的，”迈克回敬道。Mike 和我几乎同时部署了代码，这是一个开发禁忌，因为当出现问题时(比如现在)，你不知道该怪谁。但是当 Mike 撤销他的更改却没有效果时，他被卡住了。过不了多久，OkCupid 服务器就会变得反应迟钝，我们甚至无法连接到它们来推送我们的修复程序。

#### #恐慌#疯狂

到午饭时，我们仍然没有拯救这个网站。OkCupid 用户开始在 Twitter 上注意到:

> “@okcupid 如果你的网站瘫痪了，我该如何面对每天的毁灭性拒绝和情感羞辱？？？?"

> “Okcupid 在午餐时间停止工作，纽约市想知道我们是否从现在开始对手机里的人负责，街上的恐慌”

> “@okcupid 如果不知道我在哪的女性无视我，我怎么可能继续被全世界的女性无视？！#恐慌#疯狂"

时间过得越久，我就越有信心，通过排除过程，我拿下了这个网站。我通读了我修改过的每一个文件——我写的代码行，甚至是我没有写的代码行。然后，终于，我发现了错误。它看起来像这样:

> 如果(数据库抛出错误){什么都不做}

这是一个错误，我甚至没有写它。我刚刚触发了它。但这是一个严重的错误，在正确的情况下——我不幸创造的情况——不仅会使 OkCupid 服务器崩溃，还会向我们的缓存和数据库中排放放射性垃圾，使恢复变得特别困难。我吓坏了。

如此微小的变化怎么会对网站产生如此巨大的影响？“同样的故事发生了很多次，”我以前的老板大卫告诉我。“有人发起了一个相对无害的小变化，做了它可能做的数百万件意想不到的事情中的一件，然后碰巧破坏了网站的某个部分，然后整个网站都瘫痪了——有时瘫痪到我们几个小时都无法恢复的地步。”在我破坏了网站的第二天早上，当我在办公室看到他时，他非常羞愧，他安慰我说网站中断只是依赖这样一个小工程团队的代价。

但是，即使是大公司也容易受到看似无害的行为所导致的崩溃的影响。2017 年 2 月，亚马逊的一名员工在尝试调试该公司的 S3 服务时，错误地输入了一条命令，导致互联网意外瘫痪。因为成千上万的公司使用 S3 来存储数据，这个错误关闭了数以吨计的网站，包括 Quora、Giphy 和 Slack。具有讽刺意味的是，亚马逊自己的 S3 状态指示器依赖于 S3，这就是为什么它错误地报告说服务在中断期间工作正常。

#### 缠结的网

然而，对大多数企业来说，软件崩溃并不是丧钟。如果你不是在制造自动驾驶汽车，存储敏感信息，或者支持互联网的数据主干，那么如果一个错误中断了你的服务，这可能并不重要。举例来说，如果一个免费的在线约会网站宕机一个小时或半天，这没什么。事实上，对于企业来说，用前进的动力来代替烦琐可能会更好——这是脸书的老口号“快速行动，打破常规”背后的精神

当你允许自己构建不完美的系统时，你开始以不同的方式工作——更快、更有雄心。你知道有时候你的系统会崩溃，你不得不去修复它，但是没关系。“修复事情很容易的事实意味着你最终会用这种方法，你会想，‘让我们尽可能快地得到一个坏的东西，它有点像我们想要的，然后我们就可以修复它了，’”大卫说。这不一定是件坏事，因为防止错误本来就很难。“即使你花了一大堆时间试图做出完美的东西，你也不一定会成功，”他解释道。

OkCupid 是一个复杂的网站。如果我们试图让它变得完美，它可能一开始就不存在了。

但是软件是建立在其他软件之上的。您不仅使用自己的代码，还使用来自同事和第三方软件库的代码。如果这些依赖关系有问题或复杂，或者表现得不直观，错误可能会渗透到依赖它们的软件中。

以 Equifax 数据泄露事件为例，该事件在 2017 年 9 月泄露了约 1.479 亿美国人的私人信息。Equifax 易受攻击不是因为它自己的工程师引入的一个错误，而是因为 Equifax 的软件建立在一个流行的开源框架 Apache Struts 之上的代码中的一个错误。

这个 bug 自 2008 年以来就存在于 Struts 中，但直到 2017 年 Apache 最终发布补丁时才被注意到。在安装补丁之前，数万家使用 Struts 的公司——包括银行和政府机构——都是可以被黑客攻击的。

然而 Equifax 直到 Apache 发布补丁的两个月后才安装补丁。为什么耽搁了？根据 Equifax 高管在众议院能源和商业委员会的证词，问题是双重的:首先，负责报告需要补丁的员工没有这样做。第二，软件脚本中的一个错误导致了 Equifax 软件堆栈中已知漏洞的检测失败。

然而，即使 Equifax *试图安装补丁，它也不会是一个容易的更新。据 *Ars Technica* 报道，该补丁很难安装，可能会破坏现有系统，并可能引入新的漏洞。这有助于解释为什么，根据软件供应商 Sonotype 的说法，即使在补丁发布后，仍有 46，557 家公司下载了 Struts 的易受攻击版本。*

也许 Equifax 的安全程序是草率的，其漏洞是完全可以避免的。然而，对我来说，很容易想象未来会有一个类似的灾难性后果，而不是那么容易归咎于无能。今天大多数复杂的软件是复合的，由许多不同的程序员甚至许多不同的组织编写的交织模块组成。这些代码塔建得越高，就越难理解它们的各个组成部分是如何相互作用的。

#### 理智的悲观主义

就是因为这个原因，我自己在 OkCupid 的 bug 才那么烂。我写了一个函数，要求数据库给我不存在的数据。它应该返回一个错误，停止程序。但是由于我的一个依赖项中的一个 bug——这个 bug 是我在崩溃当天通读代码时发现的——我的程序没有出错，而是继续突突前进，就好像什么都没发生一样。它不断消耗越来越多的内存，最终几乎吞噬了我们服务器上运行的每一个程序。这就是 OkCupid 网站变慢到无法使用的原因。

也许弄清楚我是如何让 OkCupid 崩溃的最糟糕的部分是，我还太嫩，不知道如何修复它。我所能做的就是坐在我的办公桌前，捻弄我的拇指以示团结，而我的同事们在重建被我摧毁的东西。我们在办公室一直呆到晚上 9 点。从那时起，我开始意识到一个系统中的裂缝可以延伸到多远。

“我听说你昨天过了令人兴奋的一天，”我的老板大卫第二天早上说。羞愧之余，我确信我会被解雇。但我没有，相反，我在接下来的三个月里焦虑地试图向我的同事证明我并不是完全不称职。我再也没有关闭这个网站，也许是因为我的代码启动感觉被 PTSD 引起的肾上腺素激增增强了。

也许我仍然心有余悸，或者只是普遍悲观，但总的来说，我倾向于认为所有足够大、足够复杂的软件都容易发生这种崩溃。几乎可以肯定的是，要防止所有的错误是不可能的，而且由于代码是复合的，所以更难推断这些错误的后果。如今，一个成功的开发人员需要像在代码爆炸时熄灭代码一样擅长编写代码。