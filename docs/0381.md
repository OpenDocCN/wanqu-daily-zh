# 生产中的故障注入- ACM 队列

> 原文:[http://queue.acm.org/detail.cfm?id=2353017&UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium =网站](http://queue.acm.org/detail.cfm?id=2353017&utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

<label>August 24, 2012
**[Volume 10, issue 8](issuedetail.cfm?issue=2346916)**</label>

[![Download PDF version of this article](../Images/d41c7b6eb6493a00953aa6dd3bd5eac4.png) PDF](https://dl.acm.org/ft_gateway.cfm?id=2353017&ftid=1278473&dwn=1)

# 生产中的故障注入

## 为弹性测试提供理由

### 埃西·约翰·奥斯鲍

当我们在 Etsy 建立网络基础设施时，我们的目标是使它们具有弹性。这意味着要仔细设计它们，以便它们在面临失败时能够维持其(越来越关键的)运作。令人欣慰的是，已经有几十年和大量的论文花在研究如何将容错和优雅降级引入计算机系统上。这有助于事业。

为了确保 Etsy 系统中内置的弹性是健全的，并且系统的行为符合预期，我们必须看到生产中的故障被容忍。

为什么生产？为什么不在 QA 或试运行环境中进行模拟呢？首先，这些环境中任何差异的存在都会给测试带来不确定性，其次，无法恢复的风险在测试期间没有任何后果，这可能会将隐藏的假设带入容错设计和恢复中。目标是减少不确定性，而不是增加不确定性。

强迫故障发生，或者甚至设计系统让它们自己发生故障，通常不容易说服管理层。工程师不习惯于接受他们应对紧急情况的能力；他们的目标是完全避免它们。仔细看看如何更好地应对失败，本质上是接受失败会发生，你可能会认为这与你在工程或商业中想要的相反。

举个例子，您通常会认为这是一个简单的案例:从零到生产配置服务器或云实例:

1.  裸机(或云计算实例)变得可用。
2.  基本操作系统通过 PXE(预启动执行环境)或机器映像安装。
3.  操作系统级别的配置已经到位(通过配置管理或机器映像)。
4.  应用程序级配置已到位(通过配置管理、应用程序部署或机器映像)。
5.  应用程序代码到位，底层服务正确启动(通过配置管理、应用程序部署或机器映像)。
6.  系统集成发生在网络中(负载平衡器、VLANs、路由、交换、DNS 等)。).

这可能过于简化，每一步或每一层都可能代表大量的 CPU 周期；磁盘、网络和/或内存操作；和各种数量的软件机制。所有这些共同将一个节点投入生产。

可操作性意味着您可以对该节点投入生产充满信心，可能会加入集群，并在每次发生时无缝地提供实时流量。此外，您希望并期望确信底层电源、配置、应用程序或计算资源(CPU、磁盘、内存、网络等)。)经历了一个故障，那么您可以通过一些方法在这样的故障中幸存下来:允许应用程序优雅地降级、重新构建自己、使自己退出生产，以及对故障的细节发出警报，等等。

这种信心通常是通过多种方式建立的:

*   **硬件老化测试。**您可以对节点中的各种硬件组件运行极限测试，以确认它们在负载开始时都不会出现故障。这在云计算实例中可能是不必要或不可行的。
*   **组件的单元测试。**每项服务都可以很容易地单独测试，并且可以对配置进行校验和检查，以确保它符合预期。
*   集成的功能测试。每个执行路径(通常基于一个应用程序特性)都可以用某种形式的自动化过程来探索，以确保预期的结果。

传统上，这些获得信任的明智措施是在系统或应用程序投入生产之前采取的。一旦投入生产，传统的方法是依靠监控和日志记录来确认一切工作正常。如果它的表现和预期的一样，那么你就没有问题。如果不是，并且需要人工干预(故障诊断、分类、解决等)。)，然后您需要对事件做出反应，并尽快让事情恢复正常。

这意味着一旦系统投入生产，“不要碰它！”—当然，除非它坏了，在这种情况下，在断电响应固有的时间压力下，您可以随意触摸它。

在许多层面上，这种方法并没有达到预期的效果。

在现场，你需要为不良情况做好准备。电力可能会突然中断。对应用程序或配置的更改可能会产生不可预见的行为，无论测试的覆盖面有多广。各种资源争用条件下的应用程序行为(想想新闻事件或类似消防水管的分布式拒绝服务攻击的流量高峰)可能会有令人惊讶的结果。这不是纯粹的学术好奇；这些类型的故障可能(并将 *)* 影响生产，因此，在 Etsy 的案例中，影响我们的销售人员和我们的业务。然而，这些类型的事件很难精确地建模和模拟，以激发面对这些问题时对系统行为的信心。

挑战在于 Web 系统(像许多“复杂”系统一样)很难处理，这意味着:

*   要全面描述，细节很多，不是很少。
*   变化率高；在完整的描述(以及理解)完成之前，系统会发生变化。
*   组件如何工作部分是未知的，因为它们在不同的条件下相互共振。
*   流程是异构的，可能是不规则的。

换句话说，尽管在生产环境之外进行测试是一种非常合适的方法，但它是不完整的，因为有些行为只能在生产环境中看到，无论可以制造出多么相同的试运行环境。

因此，另一个选项必须添加到增强信心的武器库中:故障注入练习，有时也称为游戏日。目标是让这些故障发生在*生产*中，以便预测未来的类似行为，了解故障对底层系统的影响，并最终洞察它们给业务带来的风险。

在复杂系统中引发故障并不是一个新概念。几十年来，消防部门等组织一直在进行全面的灾难演习。网络工程比这些类型的训练更有优势，因为系统工程师可以以极高的分辨率收集任何故障的大量细节，对复杂的故障机制进行大量控制，并学习如何快速恢复。

### 故障注入

在 Etsy 构建游戏日练习遵循以下模式:

1.  想象一下您的基础设施中可能发生的不幸事件。
2.  找出防止该事件影响您的业务所需的措施，并实施这些措施。
3.  使事件在生产中发生，最终证明事件的无效性并获得对其的信心。

比赛日演习的最大优势是弄清楚如何防止失败影响业务。很难夸大第一步和第二步的重要性。这个想法是让一组工程师聚在一起，集体讨论特定应用程序、服务或基础设施可能遇到的各种故障场景。这将有助于消除对整个系统安全性的自满情绪。自满是弹性的敌人。如果一个系统有一段时间很少或没有降级，它就有在多个层面上走向失败的真正风险，因为工程师可能会错误地认为该系统没有出现问题，因为它本质上是安全的。

想象失败的场景并问，“如果...?"可以帮助打击这种想法，并给组织带来持续的不安感。这种不安感是高可靠性组织的标志。可以把它想象成持续部署 BCP(业务连续性计划)。

### 商业理由

理论上，GameDay 练习的想法似乎很合理:你做出明确的努力来预测失败场景，准备优雅地处理它们，然后通过故意将这些失败注入到生产中来确认这种行为。在实践中，这种想法可能并不吸引人:它将风险带到了最前沿，没有背景，故意造成失败可能看起来很疯狂。出了问题怎么办？

生产失败的传统观点是不惜一切代价避免失败。假设失败是完全可以预防的，如果它真的发生了，那么找到负责的人(通常是那些最接近代码或系统的人)并解雇他们，相信除掉“害群之马”就是你给组织带来安全的方式。

这种观点当然是可笑的。故障注入和游戏日场景可以产生一个更加实用和现实的视图。

当我向 Etsy 的执行团队提出游戏日演习的想法时，我解释说，我们并不是出于某种看着基础设施崩溃的反常需求而想要导致失败；那就是我们知道系统的某些部分*将不可避免地失败，我们需要获得信心，相信系统有足够的弹性来优雅地处理失败。*

我向高管们解释说，这个概念是，建立有弹性的系统需要失败的经验，我们希望更多地预测和确认我们对失败的预期，而不是更少地预测和确认我们对失败的预期。回避失败的影响，错误地尝试降低风险，会导致糟糕的设计、陈旧的恢复技巧和错误的安全感。

换句话说，最好为生产中的失败做好准备，并在我们观察时让它们发生*，*，而不是依赖一种策略，希望系统在我们 *不观察*时会正确运行*。比赛日演习最糟糕的情况是在演习过程中会出问题。在这种情况下，一个完整的工程师团队已经准备好应对意外，系统将因此变得更加强大。*

没有比赛日练习的最糟糕的情况是，生产中的某些东西会失败，这是没有预料到或准备好的，并且它会在团队没有预料到或密切关注它时发生。

您如何确保将故障注入到一个实时生产系统中不会影响实际的流量、收入和最终用户体验？这可以通过将容错和适度降级机制视为*特性*来实现。这意味着带来所有其他建立信任的技术(单元和功能测试、试运行硬件环境等)。)直到你满意为止。就像应用程序的每个其他特性一样，直到您将它部署到生产环境并验证它工作正常，它才算完成。

### 案例:支付系统

今年早些时候，Etsy 推出了一个新的支付系统([http://www . Etsy . com/blog/news/2012/announcing-direct-check out/](https://www.etsy.com/blog/news/2012/announcing-direct-checkout/))，为网站上的买家和卖家提供更大的灵活性和可靠性。显然，弹性对项目的成功至关重要。与许多 Etsy 功能一样，新系统是以逐步升级的方式投入生产的。想要使用这种新支付方式的卖家可以选择加入，Etsy 一次为一组卖家打开该功能。

可以想象，支付系统并不是特别简单。它有欺诈检测组件、审计跟踪、安全机制、处理状态机和其他需要相互交互的组件。因此，Etsy 有一个复杂的关键任务系统，对弹性有很高的期望。

为了确认其承受故障的能力，Etsy 整理了一个合理的场景列表，以便在生产中进行准备、开发和测试，包括以下内容:

*   其中一个应用服务器死机(电源线被拔掉)。
*   所有的应用服务器都离开了负载平衡池。
*   其中一个应用服务器被擦除干净，需要从头开始完全重建。
*   数据库死亡(电源电缆被拔掉和/或进程被不恰当地终止)。
*   数据库完全损坏，需要从备份中完全恢复。
*   需要异地数据库副本来调查/恢复/重放单个事务。
*   与第三方网站的连接被完全切断。

然后，工程师们将这些场景在生产中发生时系统将如何运行的所有预期放在一起，以及他们如何通过日志、图表和警报来确认这些预期。一旦掌握了这些情景，他们就开始研究如何避免这些失败:

*   一点也不重要(透明地恢复并继续处理)，
*   仅暂时重要(适度降级而不丢失数据并向用户提供建设性反馈)，
*   或者只对最小的用户子集有影响(包括用于快速和可能自动地重建和恢复的审计日志)。

在开发中编写并测试了这些机制之后，就到了在生产中测试它们的时候了。Etsy 团队知道系统看到了多少活动；支持和产品团队随时准备帮助进行任何必要的沟通；团队成员经历了每个场景，收集了以下问题的答案:

*   他们是否通过冗余、复制、排队等方式成功实现了透明恢复？？
*   每个过程需要多长时间—在从头开始自动重建节点、恢复数据库等情况下。？
*   他们能确认在整个演习过程中没有数据丢失吗？
*   有什么惊喜吗？

团队能够确认大多数预期的行为，Etsy 社区(卖家和买家)能够继续在网站上体验，不受失败的影响。

然而，在此过程中也有一些意外，Etsy 团队在演习结束后将其作为补救项目。首先，在支付过程中，我们联系了第三方欺诈检测服务，获取交易信息。而 Etsy 使用许多外部 API(欺诈、设备信誉等。)，这个特定的服务在外部调用上没有指定的超时。当测试无法联系服务时，Etsy 团队使用防火墙规则来硬关闭连接并试图将其挂起。没有指定超时意味着他们依赖于默认值，60 秒太长了。预期的行为是 fail open，这意味着如果外部服务关闭，事务可以继续。这很有效，但只是在 60 秒的超时之后，这导致实时支付在练习中花费了不必要的时间。

这既令人惊讶又相对容易解决，但尽管如此，这仍然是一个影响测试期间生产的疏忽。

从数据库损坏中恢复也花费了比预期更长的时间。GameDay 练习是在主-主数据库对的一端进行的，当恢复发生在损坏的服务器上时，该对服务器中的其余服务器承担生产的所有读写操作。虽然没有生产数据丢失，但产能下降的时间比预期的要长，因此 Etsy 团队开始进行分析，然后尝试缩短恢复时间。

这种做法的文化效应是显而易见的。这大大降低了对支付系统升级的担忧；它暴露了代码和基础设施中一些需要改进的地方；它增加了对系统的整体信心。因此，自满不会对金融体系构成直接威胁。

### 限制

故障注入和游戏日练习的目标是增加对复杂或复杂系统保持弹性能力的信心，但它们有局限性。

首先，这些练习并不是为了发现工程团队如何在时间压力下处理不断升级、有时令人迷惑的场景。这需要来自实际事件的事后分析，而不是来自已经计划和设计好的故障处理。

故障和失效模式是*设计的*。它们反映了故障设计者的想象力，因此不能足够全面地保证系统的安全性。虽然对系统弹性的信心的任何增加都是积极的，但它仍然只是:增加，而不是完全的信心。任何复杂的系统都可能(并将)以令人惊讶的方式失败，无论您注入多少不同类型的故障并从中恢复。

一些人认为，与作为工程团队活动手动运行游戏日练习相比，自动连续引入故障是获得系统适应性信心的更有效方式。这两种方法都有这里提到的相同限制，即它们增加了信心，但不能用于实现足够的安全覆盖。

自动化故障注入会带来一个悖论。如果注入的错误(即使是随机的)以透明和优雅的方式处理，那么它们就不会被注意到。你可能会认为这就是目标:当失败发生时，无论如何都不要紧。然而，这种对失败的掩盖会导致自满情绪，而这种自满情绪是想要(至少应该想要)减少的。换句话说，当你已经成功地进行了随机生成和/或连续的故障注入和恢复时，必须小心地*提高*对这正在发生的细节的意识——何时、如何、在哪里等。否则，故障本身会成为另一个组件，增加系统的复杂性，同时仍然限制其功能(因为它们仍然是人为的，因此是不充分的)。

### 害怕

我提出的许多建议应该只是组织已经拥有的建立信任工具的延伸。自动化质量保证、容错、冗余和 A/B 测试都属于游戏日场景的同一类别，尽管可能没有那么戏剧化。

每样东西都应该有一个相关的游戏日练习吗？可能是，也可能不是，这取决于您对组件、交互的信任程度，以及您的应用程序和基础设施的复杂程度。即使你的企业不认为游戏日演习是正当的，但是，它们应该在你的工程工具包中占有一席之地。

### 安全疫苗

为什么要将错误引入一个运行良好的生产系统中呢？为什么会有用？

首先，这些导致失败的练习可以作为提高系统安全性的“疫苗”——注入少量失败来帮助系统*学习*恢复。它还在工程团队的文化中保持对失败的关注，并防止自满。

它将通常不会聚在一起的人聚集在一起，共同经历失败并建立容错能力。它还有助于将生产中可操作性的概念更贴近那些可能不习惯它的开发人员。

在高层次上，生产故障注入应该被认为是用来获得对系统的安全性和弹性的信心的许多方法之一。与单元测试、功能测试和代码审查一样，这种方法在防止哪些意外事件方面受到限制，但它也有好处，其中许多是文化上的。我们当然无法想象没有它的工作。

**爱它，恨它？让我们知道**

**[【邮件保护】](/cdn-cgi/l/email-protection#3254575756505351597243475747571c53515f1c5d4055)**

John Allspaw 是 Etsy 技术运营高级副总裁。他在生物技术、政府和在线媒体领域从事系统运营工作超过 14 年。他开始为美国政府调整运行车辆碰撞模拟的并行集群，然后在 1997 年转向互联网。他在 Salon、InfoWorld、Friendster 和 Flickr 建立了后台基础设施。他是《T2:能力规划的艺术》(T3)(奥赖利媒体，2008 年)、《T4》(T5)和《网络运营》(T7)(奥赖利，2010 年)的作者。

2012 年 ACM 1542-7730/12/0800 10.00 美元

![acmqueue](../Images/4f57fce9b685ad00824bd02663d98c4d.png)

*原载于《队列》第 10 卷第 8 期*——
见本条目于 [ACM 数字图书馆](https://portal.acm.org/citation.cfm?id=2353017)

* * *

更多相关文章:

Sanjay Sha - [**企业应用程序的可靠性**](detail.cfm?id=3374665)
企业可靠性是一门学科，它确保应用程序将以一致、可预测和经济高效的方式交付所需的业务功能，而不会损害可用性、性能和可维护性等核心方面。本文描述了一组核心原则和工程方法，企业可以应用这些原则和方法来帮助他们驾驭复杂的企业可靠性环境，并交付高度可靠且经济高效的应用程序。

随着 MongoDB 的特性越来越丰富和复杂，开发更复杂的方法来发现 bug 的需求也在增长。三年前，MongDB 在其工具包中添加了一个自主开发的 JavaScript fuzzer，现在它是我们最多产的 bug 查找工具，负责在两个发布周期中检测近 200 个 bug。这些错误跨越了从分片到存储引擎的一系列 MongoDB 组件，症状从死锁到数据不一致。fuzzer 作为 CI(持续集成)系统的一部分运行，它经常在新提交的代码中捕获 bug。

罗伯特·v·宾德，布鲁诺·勒加德，安妮·克莱默 - [**基于模型的测试:它站在哪里？**](detail.cfm?id=2723708)
你可能听说过 MBT(基于模型的测试)，但是像许多没有使用过 MBT 的软件工程专业人员一样，你可能会好奇其他人对这种测试设计方法的体验。从 2014 年 6 月中旬到 2014 年 8 月初，我们进行了一项调查，以了解 MBT 用户对其效率和效果的看法。2014 年 MBT 用户调查是 2012 年类似调查的后续，面向所有评估或使用过任何 MBT 方法的人。它的 32 个问题包括 2013 年高级自动化测试用户会议上分发的一份调查中的一些问题。一些问题侧重于 MBT 系统的效率和效果，提供了经理们最感兴趣的数据。

特里·科塔，迈克尔·多纳特，贾法尔·侯赛因 - [**电子艺界的自动化 QA 测试:由事件驱动**](detail.cfm?id=2627372)
对于数百万游戏极客来说，电子艺界的 QA(质量保证)测试员这个职位一定看起来像是一份梦寐以求的工作。但从公司的角度来看，与 QA 相关的开销看起来非常可怕，尤其是在一个大型多人游戏的时代。

* * *

* * *

[![](../Images/ad65ebb8b75e7581c1bc43a3736aed3c.png)](#) 
ACM 公司版权所有。