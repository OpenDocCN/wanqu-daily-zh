# 一个奇怪的减肥方法——莱克丝

> 原文：<https://blog.halide.cam/one-weird-trick-to-lose-size-c0a4013de331?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

流行的社交网络应用超过 400 兆。通过每周发布，一年内你可以下载 20g 的数据。

自从我们推出 [Halide](https://halide.cam/) 以来，我们听到的最意想不到的赞美是关于它的尺寸。以 11 兆字节的速度，我们一年推送的数据比一个社交网络一次更新推送的数据还少。

“所以你不用 Swift，”一个朋友问。毕竟，Swift 将其标准库捆绑到您的应用程序中，扩大了它的规模。卤化物几乎完全是迅捷的。

我们是怎么做到的？让我们从技术层面开始。很多内容都是对 QA1795 的回顾，但这很重要。

## 衡量，不要猜测

从 Xcode 导出构件。选择“存储以用于临时部署”假设你的应用程序支持[应用程序细化](https://developer.apple.com/videos/play/wwdc2015/404/)(目前确实应该支持)，选择“为特定设备导出”确保勾选了**“从位代码重建”**。

您不仅可以获得您的软件包大小的最终表示，还可以获得应用程序细化报告。检查你的应用程序包，找出最大的违规者。

## 使用资产目录

将您的资产保存在资产目录中。当你上传你的应用程序时，苹果会将它分成特定于设备的版本，因此具有 2 倍屏幕的设备不会获得 3 倍的资产，反之亦然。

## 运行 PNG-crush

在将您的资产放入目录之前，运行 [pngcrush](https://en.wikipedia.org/wiki/Pngcrush) 。根据 [QA1681](https://developer.apple.com/library/content/qa/qa1681/_index.html) ，Xcode 会自动粉碎资产目录外*的 png 资产。*

## 试试 JPEGs 格式的照片

将 UI 资源和类似的精细线条限制为 png。这可能构成了你的应用程序中的大部分资产，但是如果你有照片，尝试使用 JPEGs。一点压缩就能走很长一段路。

# 是时候进行一次艰难的对话了

在所有这些艰苦的工作之后，你只从一百兆的庞然大物上削掉了几兆。我不知道该怎么告诉你，但是你需要更少的代码。

## 选择正确的战斗

Halide 大约有 15000 行 Swift。这包括一个实时视频处理器，一系列自定义控件，以及我们控制 AVFoundation 的平台。有趣的是我没有写的代码。

我利用自动布局删除了数千行样板文件。很多开发者还是坚持手工布局。也许他们不了解自动布局，或者他们从朋友的朋友那里听到了自动布局有多慢的故事。(其实不是。)

我见过太多的开发者——尤其是在大公司——发明内部布局引擎。那简直是胡说八道。当苹果在操作系统中捆绑了一个精美的布局引擎时，不要用定制的框架来膨胀你的应用。

我们可以通过放弃界面构建器再削减 100k。用户手册和设置几乎完全是 IB，布局带有约束。摄像机 UI 的高级排列也以类似方式管理。但是我们认为短期内生产力是值得的。

## 避免库膨胀

检查许多大型应用程序的包，你会发现许多第三方框架的重量从 100k 到几兆不等。

我使用零第三方库。这有点极端，但我们的情况有点特殊。

没有多少第三方库能满足我们的需求。iOS dev 社区有太多的 JSON 映射器，但是没有用于 DNG 文件的底层操作。

但是我之前提到的视频处理呢？我能听到你喊，“GPUImage 是可扩展的！自己滚自己的真是疯了！”

根据我对 Periscope 堆栈的体验，我们看到了从 GPUImage 到内部解决方案的巨大收益。如果实时图像处理不是您业务的一部分，GPUImage 就很好。但是考虑到我们对 Halide 的长期愿景，以及实时渲染所扮演的角色，拥有这个组件是很重要的。

我从来没有传递过 GPUImage *，因为文件大小的*。但由于推出了我们自己的过滤器，我避免了在我们的应用中捆绑 125 个未使用的过滤器。

PSPDFKit 取代了一个做得太多的更大的框架，取得了类似的成功:

> 我们很高兴地告诉你，在 iOS 版 PSPDFKit 6.8 中，我们重写了数字签名实现的核心，以改进检测、验证和更好的错误报告。结果，我们也设法完全放弃了对 OpenSSL 的依赖，在这个过程中减少了二进制文件的大小。

不要染上“不在此发明”综合症，但是有[个好理由来避免去图书馆](https://sandofsky.com/blog/third-party-libraries.html)。

## 不要在分析和 A/B 测试上浪费资源

我们不使用任何第三方分析或崩溃报告服务。首先，我们对将用户数据发送给广告公司感到不舒服。但是让我们暂时把理想放在一边。

数据不是免费的。在大型应用中，每个动作都会记录一个分析事件。大型应用程序需要日志记录基础设施——stuff 唯一地识别用户、删除重复请求、缓冲日志、失败重试等。这一切都说明了。

A/B 测试更糟糕。你典型的社交网络应用充满了没有人回去清理的死 A/B 测试。

我们并没有因为代码膨胀而避免分析和 A/B 测试。这只是我们对产品的理念。知道太多的数据会扭曲你的思维。你发现自己在优化一个局部最大值，而不是下大赌注去移动指针。

所以我们使用苹果分析。它只是工作，没有任何代码变化。它是免费的。它尊重用户的隐私，要求选择加入。我们的选择加入率是 32%，正好满足我们的需求。

分析是有时间和地点的。我们不确定我们的最佳价格点，所以我们可以在那里试验。然而，我们在业务驱动的分析和产品开发之间筑起了一道墙。

# 你需要一致的目标

我们是两个人的团队。我们通过销售产品赚钱。我们的增长完全是有机的。用户高兴了，就把我们的事告诉朋友。小程序让我们开心，我们认为它会让用户开心。

我们的建议对最臃肿的应用程序没有帮助。社交网络从广告商那里赚钱，广告商需要详细的广告定位分析。

大型应用程序有数百名开发人员，组成几十个团队，每个团队都有独立的季度目标。你跑得越快，完成的目标越多，你升职的可能性就越大。

这种想法是可以理解的，“这个库为我们节省了一周的时间，但为我们的应用程序增加了一兆字节。嗯，我们已经是几百兆了，那还有什么？”

大型组织充满了合理的想法，却带来了意想不到的后果。

假设一名工程师想在技术阶梯上往上爬。运送功能不会让你得到提升。构建一个新的布局引擎需要。该公司甚至获得了工程博客的招聘诱饵。

唯一的解决办法是高层领导宣布，“我们要精简我们的应用程序。”不幸的是，科技公司的首席执行官们不会使用 8g 内存的 iPhones，他们也不会住在网速糟糕的地区。

这不是吃力不讨好的努力。自从 Halide 发布以来，我们已经收到了来自世界各地的大量信息，感谢我们为保持其小规模所做的努力。

减肥真的有一个奇怪的窍门:关注你的顾客。