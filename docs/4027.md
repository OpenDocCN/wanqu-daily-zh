# 使用速率限制器扩展您的 API

> 原文:[https://stripe.com/blog/rate-limiters?utm_source=wanqu.co&UTM _ campaign = Wanqu+Daily&UTM _ medium =网站](https://stripe.com/blog/rate-limiters?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)



可用性和可靠性对于所有 web 应用程序和 API 来说都是至关重要的。如果你提供一个 API，你可能已经经历过流量的突然增加，这会影响你的服务质量，甚至可能导致所有用户的服务中断。

最初几次出现这种情况时，合理的做法是向您的基础架构添加更多容量，以适应用户增长。然而，当你运行一个生产 API 时，你不仅要用像[幂等](https://stripe.com/blog/idempotency)这样的技术使它健壮，你还需要为规模而构建，并确保一个坏的参与者不会意外地或故意地影响它的可用性。

在以下情况下，速率限制有助于提高 API 的可靠性:

*   你的一个用户要对流量激增负责，你需要为其他人熬夜。
*   你的一个用户有一个行为不端的脚本，它意外地向你发送了很多请求。或者，更糟糕的是，您的某个用户故意试图淹没您的服务器。
*   一个用户向您发送了许多优先级较低的请求，您希望确保它不会影响您的高优先级流量。例如，用户发送大量分析数据请求可能会影响其他用户的关键交易。
*   您的系统内部出现了问题，因此您无法为所有常规流量提供服务，需要丢弃低优先级请求。

在 Stripe，我们发现仔细实现一些[速率限制](https://en.wikipedia.org/wiki/Rate_limiting)策略有助于保持 API 对每个人可用。在这篇文章中，我们将详细解释哪些速率限制策略最有用，我们如何优先考虑一些 API 请求，以及我们如何在不影响现有用户工作流的情况下安全地使用速率限制器。

## 限速器和负载粉碎机

*速率限制器*用于控制网络上发送或接收流量的速率。什么时候应该使用限速器？如果你的用户可以改变他们访问 API 端点的速度而不影响他们请求的结果，那么速率限制器是合适的。如果不考虑他们的请求(通常对于实时事件)，那么您将需要本文范围之外的另一种策略(大多数时候您只需要更多的基础设施容量)。

我们的用户可以提出很多请求:例如，批量处理付款会导致我们的 API 上持续的流量。我们发现，客户总是可以(除了一些极其罕见的情况)将他们的请求分散得更多一点，而不受我们的费率限制的影响。

速率限制器对于日常操作来说是惊人的，但在事故期间(例如，如果服务运行得比平时慢)，我们有时需要丢弃低优先级的请求，以确保更重要的请求能够通过。这被称为*减载*。这种情况很少发生，但它是保持条带可用的重要部分。

一个*负载卸载器*根据系统的整体状态而不是发出请求的用户做出决定。负载卸载程序可以帮助您处理紧急情况，因为它们可以让您的核心业务保持运转，而其他业务却陷入困境。

## 协调使用不同种类的限速器

一旦你知道速率限制器可以提高你的 API 的可靠性，你应该决定哪种类型是最相关的。

在 Stripe，我们在生产中使用 4 种不同类型的限制器。第一个是*请求速率限制器*，这是迄今为止最重要的一个。如果您想提高 API 的健壮性，我们建议您从这里开始。

### 请求速率限制器

这个速率限制器限制每个用户每秒只能有 *N* 个请求。请求速率限制器是大多数 API 可以用来有效管理大量流量的第一个工具。

我们对请求的速率限制是不断触发的。仅这个月，它就拒绝了数百万个请求，尤其是测试模式的请求，在这种情况下，用户无意中运行了一个失控的脚本。

我们的 API 在测试和实时模式下提供了相同的速率限制行为。这有助于开发人员获得良好的体验:从开发到生产，脚本不会因为特定的速率限制而遇到副作用。

在分析了我们的流量模式后，我们增加了在实时事件(如闪购)中使用量突然激增时短暂突破上限的能力。)





请求速率限制器限制用户每秒的最大请求数。





### 并发请求有限公司

这个速率限制器说的不是“你可以每秒使用我们的 API 1000 次”，而是“你只能同时有 20 个 API 请求在进行中”。一些端点比其他端点更消耗资源，用户通常会因为等待端点返回然后重试而感到沮丧。这些重试给已经超负荷的资源增加了更多的需求，使速度更慢。并发速率限制器很好地解决了这个问题。

我们的并发请求限制器被触发的频率要低得多(本月 12，000 个请求)，并且帮助我们保持对 CPU 密集型 API 端点的控制。在我们开始使用并发请求限制器之前，我们经常处理由于用户一次发出太多请求而导致的最昂贵的端点上的资源争用。并发请求限制器完全解决了这个问题。

调整这个限制器是完全合理的，因此它比请求速率限制器更经常地拒绝。它要求你的用户使用不同的编程模型“分叉掉 X 个作业并让它们处理队列”，而不是“敲打 API 并在得到 HTTP 429 时退出”。有些 API 更适合这两种模式中的一种，所以您可以随意选择最适合您的 API 用户的模式。





并发请求限制器管理 CPU 密集型 API 端点的资源争用。





### 车队使用负荷减荷器

使用这种类型的负载卸载器可以确保您的机群中总有一定比例的资源可用于您最重要的 API 请求。

我们将流量分为两种类型:关键的 API 方法(例如创建费用)和非关键的方法(例如列出费用)。)我们有一个 Redis 集群，它统计我们当前有多少每种类型的请求。

我们总是为关键请求保留一小部分基础设施。如果我们的预订数量是 20%，那么任何超过 80%分配的非关键请求都将被拒绝，状态代码为 503。

这个月，我们为非常少的请求触发了这个负载卸载器。这本身没什么大不了的，我们绝对有能力处理这些额外的请求。但是，在其他几个月中，这种方法防止了停机。





车队使用负载减载器为关键请求保留车队资源。





### 工人利用负荷减荷器

大多数 API 服务使用一组工作器以并行方式独立地响应传入的请求。这个减荷器是最后一道防线。如果您的员工开始收到请求，那么这将会减少优先级较低的流量。

这种情况很少发生，只有在重大事故中才会发生。

我们将流量分为 4 类:

*   批判方法
*   邮件
*   得到
*   测试模式流量

我们随时跟踪有可用能力的员工数量。如果一个机器太忙而无法处理它的请求量，它将从测试模式流量开始，慢慢地开始丢弃不太重要的请求。如果减少测试模式的流量能让它回到良好的状态，那就太好了！我们可以开始慢慢恢复交通。否则，它会升级，并开始脱落更多的流量。

很重要的一点是，卸载和加载要缓慢进行，否则你可能会以失败告终(“我摆脱了测试模式流量！一切都很好！我把它带回来了！一切都糟透了！”).我们使用了大量的试验和错误来调整我们减少流量的速率，并确定了我们在几分钟内减少大量流量的速率。

这个月只有 100 个请求被这个速率限制器拒绝，但是在过去，当我们遇到负载问题时，它做了很多来帮助我们更快地恢复。这种减载器限制了已经发生的事故的影响，并提供了损害控制，而前三者更具预防性。





工作人员利用率负载卸载程序为关键请求保留工作人员。





## 实践中的建筑限速器

既然我们已经概述了我们使用的四种基本速率限制器及其用途，那么让我们来谈谈它们的实现。有哪些限速算法？你在实践中是如何实现它们的呢？

我们使用[令牌桶算法](https://en.wikipedia.org/wiki/Token_bucket)进行速率限制。这种算法有一个集中的桶主机，在这里，您在每个请求上获取令牌，然后慢慢地将更多的令牌放入桶中。如果桶是空的，拒绝请求。在我们的示例中，每个条带化用户都有一个桶，每次他们发出请求时，我们都会从桶中删除一个令牌。

我们使用 Redis 实现我们的利率限制器。您可以自己操作 Redis 实例，或者，如果您使用 Amazon Web Services，您可以使用像[elastic cache](https://aws.amazon.com/elasticache/)这样的托管服务。

以下是实施限速器时需要考虑的重要事项:

*   将限速器安全地挂入您的中间件堆栈。确保如果速率限制代码中有错误(或者 Redis 关闭)，请求不会受到影响。这意味着捕捉所有级别的异常，这样任何编码或操作错误都不会被发现，API 仍然可以正常工作。
*   向用户清楚地展示例外情况。确定向用户显示什么样的异常。在实践中，你应该根据情况决定是要 [HTTP 429](https://tools.ietf.org/html/rfc6585#section-4) (请求太多)还是 [HTTP 503](https://tools.ietf.org/html/rfc7231#section-6.6.4) (服务不可用)以及哪个最准确。你回复的信息也应该是可操作的。
*   内置安全装置，这样你就可以关闭限制器。确保您有切断开关，以便在限速器错误启动时禁用限速器。如果你需要一个人类逃生阀，在适当的位置设置特征标志真的很有帮助。设置警报和指标，以了解它们的触发频率。
*   黑暗启动每一个限速器来观察它们会阻塞的交通。评估阻止该流量的决定是否正确，并做出相应调整。您希望找到合适的阈值，在不影响任何用户现有请求模式的情况下保持 API 正常运行。这可能包括与他们中的一些人一起修改他们的代码，以便新的速率限制能够为他们所用。

## 结论

速率限制是让您的 API 具备可伸缩性的最强大的方法之一。这篇文章中描述的不同速率限制策略在第一天并不都是必要的，一旦你意识到速率限制的必要性，你可以逐步引入它们。

我们的建议是按照以下步骤在您的基础架构中引入速率限制:

*   首先构建一个请求速率限制器。这是防止滥用的最重要的方法，也是我们最常用的方法。
*   随着时间的推移，引入接下来的三种限速器，以防止不同类别的问题。它们可以随着您的扩展而慢慢构建。
*   当您向基础架构添加新的速率限制器时，请遵循良好的发布实践。安全地处理任何错误，将它们放在特性标志后面，以便随时轻松地关闭它们，并依靠非常好的可观察性和度量来查看它们触发的频率。

为了帮助你开始，我们已经创建了一个 [GitHub gist](https://gist.github.com/ptarjan/e38f45f2dfe601419ca3af937fff574d) 来分享基于我们在 Stripe 生产中实际使用的代码的实现细节。

