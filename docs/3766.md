# 2017 年 1 月 9 日 Asana 断电详情

> 原文:[https://blog . asana . com/2017/01/2017-1-9-asana-outage/？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.asana.com/2017/01/january-9-2017-asana-outage/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

Asana 在 1 月 9 日星期一经历了不到三个小时的部分停机，从太平洋标准时间早上 7:30 左右开始。最直接的原因是太多的负载和没有足够的网络服务器。这是由三个因素共同造成的:

1.  我们的自动缩放流程未能将我们的 web 服务器从周末的水平提高到周一的水平。
2.  我们周一的使用量大大高于正常水平，可能是因为人们在新年后返回工作岗位。
3.  当我们的 web 服务器承担了过多的负载时，它们就会不优雅地倒下，并开始比正常情况下运行效率低得多。

一旦我们意识到这个问题，我们就开始手动扩大我们的 web 服务器群。我们还开始节流流量，最终导致 Asana 对所有付费用户和 90%的免费用户可用。一旦我们充分扩展了我们的 web 服务器，并且停止限制传入流量，事件就结束了。

### 领先了

事件的前奏开始于 1 月 6 日星期五，当时我们的 web 服务器供应器在试图向我们的机群添加一个坏的 ec2 节点时挂起。我们的大部分自动配置是由一个自动扩展组处理的，但是我们流程的最后一部分涉及到一个 cron 任务，它会发现新启动的 web 服务器，确保它们配置正确，并告诉我们的负载平衡器开始向它们发送流量。这个 cron 作业在运行时获取一个锁，以确保一次只有一个副本在运行。这意味着当作业在尝试与新的 web 服务器通信时挂起时，也不会运行新的作业副本。我们没有为该作业设置适当的超时，所以它准备无限期挂起。等待锁时超时的作业的其他副本注意到了这种行为，但是这些警报都不是分页的，它们在周末没有被注意到。

我们通常在周末缩小网络服务器的规模，在周日晚上扩大规模，为周一早上我们的流量再次增加做准备。我们的目的是将我们的 web 服务器缩减到一个保守的水平，因此即使扩展失败，我们也能够处理周一的负载——尽管性能会下降。不幸的是，一月份的第二个星期一对我们来说是一个交通特别繁忙的日子。事实上，我们在元旦后的第一周就为我们的车队提供了过多的供应，但这是第二周，我们再次依赖我们的自动化系统。这是一个额外的高流量日，加上我们未能扩大网络服务器，这意味着我们无法处理我们收到的所有流量。

### 发生了什么

当我们的网络服务器过载时，它们就不光彩地失败了。在正常操作下，我们的 web 服务器将有一个主进程，我们派生这个主进程来生成服务于用户请求的进程。这使我们能够以比从头开始更低的成本生成流程，因为当我们分叉主流程时，它已经解析了我们所有的服务器端 javascript 并运行了足够多的代码来 JIT 化相当多的代码。

当我们的 web 服务器开始接收太多的流量时，它们的反应是继续分叉进程，以便处理所有的传入请求。最终，他们遇到了内存限制，发现自己无法再派生进程了。他们的反应是试图从头开始旋转进程，但这导致它们的内存不足，以至于 OOM 杀手开始杀死进程。

这一开始就很糟糕，但是当它的受害者之一是主进程时，情况会变得更糟。当主进程终止时，web 服务器将尝试启动一个新的进程；但是网络服务器处于一种基本上永远不会成功的状态。随着主进程的死亡，启动新进程的成本高到足以耗尽 CPU。因此，web 服务器短暂地受到内存的限制，但是一旦 OOM 杀手参与进来，每个 web 服务器很快就会受到 CPU 的限制。

### 纠正问题

一旦我们了解了问题，我们就采取了两项纠正措施。首先是取消自动伸缩工作，并监控它以确保它尽快取得进展。第二是限制交通。对我们来说，启动新的 web 服务器一直是一个非常缓慢的过程。然而，在过去的两个月里，我们一直在努力改进这一点，周一的事件是一次不成熟的尝试。在该事件中，我们两次扩展了 web 服务器。第一次，我们手动干预以减少需要复制到新 web 服务器的代码量。干预是积极的，但我们在干预之前和干预期间都浪费了时间，结果，启动新服务器花了一小时四十分钟。我们第二次启用新服务器花了 22 分钟。

我们的流量调节在负载平衡器级别上通过阻止来自免费用户的一小部分流量来工作(高级用户没有被调节)。一旦我们开始节流，我们的 web 服务器几乎立即变得健康。这使得我们的付费用户和大部分免费用户在事件完全结束之前就可以回去工作了。

正如我们对所有生产事故所做的那样，我们运行了一个流程来确定事故发生的原因，以及我们可以做些什么来减轻或消除未来的事故。我们真诚地为此次中断道歉，并感谢您在我们处理此事件时的耐心。