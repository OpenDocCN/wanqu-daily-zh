# HTTPS 大迁徙

> 原文:[https://engineering blog . yelp . com/2016/09/great-https-migration . html？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://engineeringblog.yelp.com/2016/09/great-https-migration.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

Yelp 现在完全是在 HTTPS！虽然几个页面已经被保护了相当长一段时间(我们在 2008 年开始保护包含敏感信息的页面，如密码、信用卡号，甚至您提交的评论)，但我们最终在整个网站上过渡到使用 TLS。对于一些人来说，这听起来像是相当大的成就，而其他人可能会想为什么直到 2016 年年中才完成这一迁移。

### 为什么不

#### HTTPS 简史

Netscape 在 1994 年创建了 SSL，到 2000 年，TLS 成为默认的加密协议，现代的 HTTPS 规范也随之诞生。但直到 2010 年左右，HTTPS 才开始获得不仅仅是登录和支付页面的关注。例如，脸书在 2011 年将 HTTPS 作为一个[选项实施，到 2013 年年中](https://www.facebook.com/notes/facebook-engineering/486790652130)[它成为默认设置](https://www.facebook.com/notes/facebook-engineering/secure-browsing-by-default/10151590414803920/)。谷歌早在 2010 年就将 HTTPS 添加到搜索[中，并在接下来的几年里继续将其添加到他们的其他服务中。到 2014 年，谷歌宣布 HTTPS 将成为他们搜索排名算法中的一个次要因素。](https://googleblog.blogspot.com/2011/10/making-search-more-secure.html)

#### 保护所有页面的优势

Yelp 一直非常关心用户的安全。Yelp 的一个核心价值观不仅仅包括网络安全，还借鉴了新闻业的经验，那就是“保护信息来源”。通过在 HTTPS 提供所有内容，我们可以确保无论何时何地在 Yelp 上采取行动，都是在 TLS 保护的环境中进行的。

此外，通过 HTTPS 的所有页面，用户将能够从任何页面登录或提交评论，而不仅仅是针对这些具体行动的专用和安全页面。由于 HTTPS 网站默认情况下不会向 HTTP 页面发送推荐，我们实际上会通过转换看到更多的推荐。即使有这些优势，也有一些事情阻止我们在整个站点推广 HTTPS。

#### 未知事件

虽然我们知道请求的数量会增加，但我们不知道会增加到什么程度或持续多长时间。因为我们希望监控由迁移引起的任何更改，并且因为我们的部署切换设置的方式(下面将详细介绍)，我们实际上在服务器级别进行了重定向，在那里我们可以有更详细的日志记录，而不是在负载平衡器。因此，即使增加 301 也可能对操作负载产生重大影响。

当搜索引擎突然对其索引中的几乎每个 URL 发布 301 时，对流量的影响也不清楚。虽然谷歌现在有官方指南支持全网站或每个网址的转换，但当时还不清楚搜索引擎支持什么样的推广策略。

#### 阻塞问题

尽管我们已经在技术层面上支持 TLS，但在全球范围内推广它仍然需要开发人员付出巨大的努力。我们没有为过渡编写测试，我们需要确保所有 XHR 请求、内部链接、资产、元数据等都同时完全过渡。让事情更加复杂的是，发布永久重定向使得在出现问题时几乎不可能回滚更改。

然而，唯一真正的技术障碍是我们对展示广告的使用，这并不普遍支持 HTTPS，因此保护所有页面会对收入产生有意义的影响。然而，在 2015 年末，我们结束了展示广告业务，完全消除了这一障碍，因此是时候迈出这一大步，进行转型了。

### 需要什么

#### 推广战略

我们决定首先向登录用户推出 HTTPS，因为这样做不会影响搜索引擎抓取。确保我们没有忽略任何混合内容或 HTTP 端点，我们将继续在每个 TLD 的基础上，以避免任何潜在的搜索引擎问题，有一个跨两种协议的域分片。我们选择从加拿大开始(这是美国市场的一个很好的代表，但规模较小)，一旦我们有了更多关于影响的信息，就从那里继续。

#### 发展战略

为了确保我们已经正确地转换了一切，我们决定采用测试驱动的开发方法。我们编写了测试来捕捉页面上的任何混合内容警告或 HTTP 链接。然后，这些测试允许我们分析失败，以确定仍然需要转换的内容。然后，我们一页一页地迁移，将新代码交付到生产环境中，这个环境只为登录用户提供 HTTPS 页面服务。

确保安全地前滚更改非常重要。部署更改时，一些用户仍然有陈旧的页面(带有 HTTP 表单和链接),因此新的表单发布和 XHR 端点需要在翻转后的一段时间内支持 HTTP urls。我们的测试策略允许我们在开始向所有用户大规模推广之前，抓住我们的测试遗漏的少数混合内容端点。

#### 翻转三月的加拿大

在 Yelp，我们有各种工具来实时监控用户流量和搜索引擎抓取。在启用注销用户的瞬间，我们看到了许多我们预期的变化。对该网站的总体请求增加了 50%(非 XHR 请求增加了一倍多)。其中一些增长来自我们的用户使用 301 进入网站，很多是因为 Googlebot 和 Applebot 立即提高了他们的抓取率。翻转后一分钟，HTTPS 上的抓取就开始了，几周以来，我们看到对 HTTP 和 HTTPS URL 的有意义的抓取(下面的图 2 显示了美国的这种情况，美国也有类似的抓取模式)。但是我们了解到的最有趣的事情是这些变化持续了多长时间。实际上，bot 流量在两周后达到峰值。谷歌也在缓慢地更新它的索引，在翻转一个月后，我们从谷歌获得的大约一半的流量仍然被导向 HTTP。

尽管如此，过渡还是成功的。我们没有看到搜索引擎点击我们的流量，没有混合内容的警告，一切似乎都指向积极的方向。我们最初计划中唯一真正的变化是国家部署之间的时间，因为增加的流量达到平衡所需的时间比我们预期的稍长。我们花了四个星期才自信地迁移下一组国家。

#### 翻转八月的美国

到 6 月份，我们已经完成了在除美国以外的所有国家的推广，结果和在加拿大差不多。因为美国构成了我们的大部分流量，我们想知道增加的服务器负载会持续多久，因为搜索引擎会抓取每一个链接，导致数百万次 301 重定向。因此，我们等了几个月，直到 bot crawl 稳定下来，谷歌的用户在发布前大部分被定向到收到 200 条的 HTTPS 页面。

当我们做出改变时，我们对结果感到惊喜。虽然谷歌搜索我们的次数比我们推出其他顶级域名时多一些，但他们更新索引的速度也快得多。仅仅几天之内，大多数用户都被直接转到了 HTTPS(下图 1)，我们只有前几个阶段看到的 301 中的一小部分。

### ![Graph 1: US requests referred by Google and split by status code.](../Images/82c6c28ceb07772687d87fac8ba18bcf.png)

<small>图 1:谷歌提交的美国请求，并按状态代码分类。</small>

### ![Graph 2: Googlebot crawl rates in the US and split by scheme.](../Images/57317ea6bf8d945c687726282e528974.png)

图 2:谷歌机器人在美国的抓取率，并按计划划分。

### 经验教训

最重要的是，我们发现搜索引擎的流量几乎没有任何变化。现在还为时过早，我们将在未来对此进行密切监控，但搜索引擎似乎并没有因为这次大规模迁移而惩罚或奖励我们。对于那些考虑迁移的人来说，这显然是个好消息，因为他们会从搜索引擎获得大量流量。这也意味着，如果你只是因为谷歌宣布他们在其搜索算法中考虑到这一点而试图做出改变，那么在这个时候稍微降低你的期望可能是明智的。

有了这方面的知识，Google 关于按 URL 迁移的指导，并且整体请求只增加了大约 150%,我们可能已经跳过了切换和调整部署，而是一次性迁移整个站点，或者在我们完成工作时进行迁移。

我们也确实受到了移民的影响。由于我们设置页面缓存头的方式，我们的大多数 HTTP 页面被浏览器缓存，而我们的 HTTPS 页面没有。我们起初忽略了这一点，结果在一些内部指标中发现了一些差异。尽管如此，除了一些警报被触发，并没有什么真正的错误。

此外，由于我们现在是 HTTPS，默认情况下我们不再向 HTTP 页面发送推荐，我们需要实施一种新的方式向我们的一些业务和合作伙伴发送信息，让他们知道 Yelp 向他们推荐了什么流量(这可以通过一个 [meta referrer 标签](https://moz.com/blog/meta-referrer-tag)轻松完成)。

尽管如此，我们对结果感到高兴，并自豪地说，我们完全是 Yelp 的 HTTPS！

[回到博客](/)