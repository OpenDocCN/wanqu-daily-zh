# cyle:我如何评审代码

> 原文：<https://cyle.tumblr.com/post/170039642535/how-i-review-code?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

审查代码是 Tumblr 工程师工作中最重要的部分之一，甚至比编写代码更重要。我们的代码库由数百名工程师共享，因此确保我们不仅尽可能地编写最好的代码，而且确保其他人能够理解所编写的代码是至关重要的。花时间审查别人的代码是确保所有这些都发生的最重要的机会。

在 Tumblr，每次代码更改都发生在内部 Github 实例的[Pull 请求中。我们有 PHP 后端的存储库，我们的数据库模式，我们的 iOS (Swift/Obj-C)和 Android (Java/Kotlin)移动应用，用 Go、C/C++、Lua、Ruby、Perl 编写的基础设施项目，以及用 Scala、Node.js、Python 等编写的许多其他项目。我们所有的代码库都依赖于作者来编写拉取请求，并在将他们的更改合并到主分支并部署到生产环境之前获得同行的批准，在生产环境中，人们可以与主分支进行交互。](https://href.li/?https://help.github.com/articles/about-pull-requests/)

在 Tumblr 工作的几年里，我个人审查代码的方式发生了很大的变化。在 Tumblr 工作之前，我大部分时间都是自己写代码，和很少一部分人一起审查代码。转移到拥有数百名贡献者的巨大代码库是一个巨大的变化。谢天谢地，我有一些好老师。我从一个月审查一个拉取请求到现在平均一周审查 25 个拉取请求。以下是一些帮助我保持评论及时和有用的原则。

## 在考虑作者的情况下审查代码

在我被要求进行审查后，我问自己的第一件事是*这是谁写的？他们是初级工程师还是高级工程师？他们是这个代码库的新手还是经验丰富的老手？我以前审查过他们的代码吗？我对这个代码变更参与的项目熟悉吗？*

当我审查与我密切合作的人的代码时，我可能非常清楚他们写代码时的想法，并且我知道他们经历了什么。初级工程师有时需要更多的指导，这通常意味着在代码示例和参考方面给予他们更多的帮助。有时需要提醒高级工程师，高性能、抽象或巧妙的代码通常难以阅读和理解，这通常意味着要求他们提供更多的内联注释和文档。

审查代码也是非常重要的，就好像*任何人*都可以阅读你将要提交的审查，而不仅仅是作者。这主要有两个原因。首先，有些人通过阅读其他工程师写的评论来学习；作为一名更初级的工程师，这正是我如何发现 Tumblr 代码库的复杂性的。此外，在六个月的时间里，你很可能会再次查看这段代码，以弄清楚它是如何工作的。对其进行有益的代码审查可以让我们对进入*的决策有所了解，为什么*会以这种方式工作。

## 也在考虑其他人的情况下审查代码

我的审查的核心，不管是谁在编写代码变更，都是围绕着能够理解代码本身以及动机和它周围的环境。对我来说，理想情况下，任何人都应该能够突然进入拉请求，并期望有足够的上下文来理解代码更改，以及为什么要这样做，以及它是如何工作的。在一个旧的、共享的代码库中，这一点尤其重要，三年后有人可能会看着你的公关，想知道你为什么选择做你所做的事情。如果没有包括在内，或者至少没有相关上下文的链接，那就有问题了。越详细越好。

我不太担心代码风格或语法本身，因为我们有自动化的过程来确保新的或更改的代码符合我们商定的编码标准。类似于我在 [*我现在如何编码*](https://engineering.tumblr.com/post/156934724082/how-i-code-now) 中写的，我寻找有良好文档记录的代码(内联的和外部的)，以及清晰而不是聪明的代码。我宁愿阅读 10 行冗长但可以理解的代码，也不愿阅读某人的包含四个嵌套 ternaries 的忍者般的一行程序。特别是如果编写代码的人已经在这个街区呆过几次，并且被旧的、没有文档记录的、聪明的代码烧伤了。

一旦我觉得我可以理解代码的变化，我就试着把自己放在一个不经常处理代码库这一领域的人的位置上(当时我可能就是这种情况！)并思考如何审查代码，以帮助*他们*弄清楚。我试着想象一个六个月后被雇佣的新人，看着这些代码，想知道它是如何工作的。

## 了解公关的范围

有时，不是所有事情都能在一个拉请求中完成。在 Tumblr，我们努力让我们的 PR 保持较小，以便可以快速安全地审查它们，而不是将大量难以审查的工作捆绑到一个 5000 行的变更 PR 中。因此，有时必须将工作分解成块，用 PRs 构建基础，并通过完成的实现来引导未来的 PRs。

或者，对于 evergreen codepaths 来说，已知的问题或工作已经被安排在未来的 sprints 中是很常见的，所以在代码中留下一个`@todo`作为待办事项的名称已经成为一种很好的惯例。通过这种方式，我们可以避免代码更改必须在一个 pull 请求中完全完成。

## 掌握整个审核流程

帮助我及时审查代码并掌握 PRs 最新消息的第一件事是电子邮件。我检查我收到的每一封 Github 邮件；我确保[我不会收到回购](https://href.li/?https://help.github.com/articles/choosing-the-types-of-notifications-you-receive/)中发生的所有事情的通知，但我会收到与我相关的公关相关的每封电子邮件。这有助于我掌握评估过程中的每一步，因为这几乎总是一个来回，理想情况下不会超过一天。

在 Tumblr，当公关作者准备好接受评论时，我们的大多数评论者都是通过自动循环分配选出的。这个任务触发了一封电子邮件，让我订阅了所有与那个公关相关的事情。从那时起，我就要掌握我的电子邮件，确保我不仅尽快分配时间做评论，而且如果我留下评论，作者在回应我的评论时更新了它，我还要跟进 PR。

## 记得做一个人

审查代码(以及以其他方式编写代码)最重要的建议是记住[是一个人](https://href.li/?https://mtlynch.io/human-code-reviews-1/)。请记住，编写您正在审阅的代码的人也是人。假定他们是无辜的。当你写一个建议，或者有一个问题，或者找到一个他们似乎没有涉及到的边缘案例时，态度要友好。即使他们是经验丰富的资深程序员，已经编写了多年的防弹性能代码，也要像对待一个有时会犯错误的人一样对待他们。即使他们是你每天一起工作的人，你觉得开他们的玩笑很舒服，也要理解一个新人可能*不会*理解。

请记住，共享的、活的代码库通常是令人兴奋和奇怪的，尤其是那些已经存在了十年的代码库。记住有时候事情很急，你只能尽力而为。我们不能以完美代码的名义停止一切，但我们应该确保每个人都尽了最大努力，无论我们是在写代码还是评审代码。