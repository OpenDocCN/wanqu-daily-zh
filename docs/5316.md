# Travis CI 博客:事件事后分析和安全建议:travis-ci.com 停机后的数据暴露

> 原文:[https://blog.travis-ci.com/2018-04-03-incident-post-mortem?UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://blog.travis-ci.com/2018-04-03-incident-post-mortem?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

2018 年 3 月 13 日星期二，[travis-ci.com 在世界协调时 12:14 开始的约 5.5 小时内没有运行](https://www.traviscistatus.com/incidents/z2b3lz2kwcfp)。在系统返回运行状态后，又有 3.5 小时的构建积压。

这篇文章概述了所发生的事情，并解释了它对 travis-ci.com 客户的确切意义。

## 发生了什么

世界协调时 2018 年 3 月 13 日星期二 12:04，针对我们的生产数据库意外运行了数据库查询，截断了所有表。查询被阻塞了大约 10 分钟，最终在 UTC 时间 12:14 执行。

由于我们在此之后立即响应警报，我们的 API 保持运行大约 30 分钟，连接到一个几乎空的数据库。

任何人在这段时间登录 travis-ci.com，都会看到空白的用户资料。由于他们的旧用户记录已经从数据库中删除，我们的系统为他们创建了新记录，主键从现有序列中生成(PostgreSQL 不会在 truncate 时重置 id 序列)。

我们最终采取了让系统中的所有应用程序脱机的措施，几个小时后，数据库恢复到了原始状态。

当我们的系统最终恢复在线时，那些在数据库截断和我们的应用程序离线之间的 30 分钟内登录的用户发现他们作为错误的用户登录。他们的登录凭证——以本地存储中签名令牌的形式——对应于系统恢复后创建的用户记录。

由于全新客户不是唯一需要新用户记录的账户，因为我们定期从 GitHub 同步用户，这意味着 travis-ci.com 的新老用户都受到了这个问题的影响。

为了解决这种情况，所有受影响的令牌在 3 月 14 日星期三 14:22 UTC 时被撤销。

我们还意识到，一旦数据库恢复，我们没有重新启动我们的 cron 调度程序，导致触发预定的 cron 作业时出错。

## 关于安全

自停机以来，我们分析了可能受到令牌不匹配影响的客户帐户的应用程序日志。我们已经联系了所有受到技术影响的客户。其中一部分没有在 travis-ci.com 上运行过构建的存储库，也没有证据表明暴露了任何客户数据。另一个子集有可能暴露的存储库的构建日志，但是我们的访问日志表明在暴露期间没有用户访问构建日志。另一个子集可能会暴露，我们的访问日志显示，在暴露期间，至少有一个用户登录访问了数据。

我们已经告知受影响的客户，如果他们已经加密了所有机密(密码、API 令牌、敏感环境变量等)。)使用我们可用的加密功能，它们不会被暴露。我们还建议他们，明智的做法是轮换存储在 travis-ci.com 上的任何凭证，即使是加密的，并检查 travis-ci.com 上的存储库，以确保构建日志不包含其他形式的敏感信息，以此作为预防措施。

请检查您的电子邮件以获取我们的安全建议-主题行应以“Travis CI 安全建议:”开头。我们已经联系了 GitHub 仓库管理员用户。如果您没有收到这样的电子邮件，那么您的帐户没有受到影响。如有任何问题或疑虑，请联系[support@travis-ci.com](mailto:support@travis-ci.com?subject=Security%20Advisory%20Question)——我们很乐意帮助您解决任何相关问题。

## 我们学到了什么

我们召开了一次内部事故回顾会，以了解更多有关数据故障是如何发生的，我们可以改进哪些方面来防止此类故障，以及如果发生类似事故，如何更好地恢复和保护数据。

*   我们花了一天时间才发现原来数据库截断的根本原因。使用我们的 API 日志，以及来自上游提供商的关于查询所源自的 IP 地址的信息，我们能够使用[数据库清理器](https://github.com/DatabaseCleaner/database_cleaner) gem 识别测试期间运行的截断查询。测试运行的 shell 不知不觉地将 DATABASE_URL 环境变量设置为我们的生产数据库。这是一个 tmux 会话中的旧终端窗口，许多天前用于检查生产数据。开发人员返回到这个窗口，在仍然设置 DATABASE_URL 的情况下执行测试套件。

*   这就提出了一个问题*为什么*在需要调试或检查生产数据时，我们将开发环境连接到具有写访问权限的生产数据库。这个问题的答案是，我们的工具和流程使得连接到只读的 follower 变得困难，这就是为什么连接到主数据库是一个常见的捷径。

*   我们意识到，在试图理解问题，然后迅速采取措施纠正这种情况时，我们不小心让面向用户的应用程序处于运行状态。这是一个导致创建复制用户 id 的错误。

*   我们忽略了重新打开某些警报——这意味着我们不知道 cron 调度程序没有运行。

*   有人提醒我们，我们最有经验的开发人员可能会因疏忽而导致重大停机。

*   积极的一面是，我们能够恢复整个 travis-ci.com 生产数据库，并且只有大约 15 分钟的数据丢失。

我们为避免数据库表意外截断而采取的步骤:

*   撤销了数据库的 truncate 权限，有效地使表不可能被截断。
*   修补了我们的内部 spec_helpers 以检查 DATABASE_URL 环境变量。
*   在我们的开发人员工具中添加了一个 [shell 提示警告](https://github.com/travis-ci/prompt_warn_env),以使 shell 提示在设置 DATABASE_URL 时发出警告。
*   向数据库清理器 gem 提交了一个 [Pull 请求](https://github.com/DatabaseCleaner/database_cleaner/pull/521),以防止意外使用远程 DATABASE_URL。

我们为避免复杂问题而采取的措施:

*   为 follower 数据库创建了一个别名，以便在需要针对生产数据进行测试时更容易找到和连接到该数据库。
*   自动化数据库故障切换和维护，减少了从这种情况下恢复所需的时间和手动步骤。

除了上述措施之外，我们还在计划一些短期和长期的改进措施，旨在使我们的系统更具弹性，并防止类似的停机事件发生。

## 结论

在 Travis CI，我们非常重视安全性。我们经历的数据故障在范围和规模上都是前所未有的。不幸的是，在回应时，我们错过了一些本可以减少问题发生的步骤。

对于给您的业务和开发人员带来的任何不便，我们深表歉意。我们非常重视客户对我们的信任，并期待将学到的经验用于继续改善我们的服务。

如有任何疑问，请随时联系 support@travis-ci.com。