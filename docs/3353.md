# HotelTonight 如何扩展其堆栈-从 MVP 到 IPO | StackShare

> 原文：<http://stackshare.io/posts/how-hoteltonight-scaled-their-stack-from-mvp-to-ipo?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

*这是我们新播客 **[Stack Stories](https://soundcloud.com/stack-stories)** 的第一集，在这里我们将重点介绍世界上最好的软件工程团队以及他们是如何开发软件的。由 Siraj (Stack Stories 掌门人， [Sirajology](https://www.youtube.com/c/sirajology) )和 Yonas(Stack share 的 CEO)主持。 **[关注我们的 SoundCloud](https://soundcloud.com/stack-stories)** 。*

![](img/1b5b421a5e6c99a8d8f525ed142a3943.png)

HotelTonight 平台工程总监 Jatinder Singh

随着他们的 2017 年 IPO 迅速临近，我们与平台工程总监 [**贾廷德·辛格**](https://twitter.com/rubymerchant) 坐在一起，谈论他们实现这一目标的手段。从早期的 Appcelerator 到现在的 Rails/Node 栈。听听他们早期的扩展挑战以及即将成为独角兽的[的下一步计划。听完整段采访或查看下面的文字记录(为简洁起见进行了编辑)。](http://www.forbes.com/sites/amyfeldman/2016/10/19/next-billion-dollar-startups-2016/#161d7d4a554e)

* * *

内容

* * *

突出

[最低存活产品(MVP)](#infrastructure)

> 不到两个月，团队就推出了一款应用。我认为钛是他们使用的材料，还有很多 T2 咖啡脚本。
> 
> 在两个月内， [Rails](/rails) 后端成为酒店管理库存和员工的界面。不到两个月，他们就推出了这款产品，而且上市速度非常快。那是过去的事了。那是 iOS 应用和 Android，我想当时他们使用了 [HTML5](/html5) 和 [jQuery](/jquery) 。最终，在接下来的几年里，我们组建了 iOS 和 Android 团队，他们都是非常非常优秀的专家，并将这些应用程序转换为本地应用程序。

[当前堆栈](#current-stack)

> 随着时间的推移，我们已经将其发展成更多的 Rails 应用程序，最近，我们也开始将 Go 视为可以粘合的微小服务...你必须从一个地方到另一个地方获取信息，所以与其把代码放在我们一直试图拆开的整体中，我们为什么不尝试类似于 [Go](/go) 的东西。 [Node.js](/nodejs) 和我刚才提到的其他移动网络平台，Node.js 是我们开始投资的另一个平台……我们有一个应用程序(用于酒店)。当我说应用程序时，它实际上是一个桌面和移动网络应用程序，而不是一个本地应用程序，而是一个面向消费者的移动网络应用程序，它使用 [React](/react) 以及 Node 和 Rails 的组合。

[扩展 API](#scaling-challenges-apis)

> 早在 2014 年，我们曾经是预订酒店的当天服务。作为顾客，您只能在同一天预订酒店。你不能提前预订。今晚酒店会做的是我们会推送，我们会在上午 9 点向所有顾客发送推送通知。是自作自受的 DDoS。突然，在上午 9 点，你会看到这样一个流量高峰，客户试图来到应用程序，试图看看有什么可用的。

[数据库挑战](#scaling-challenges-database)

> 然后我们开始寻找堆栈中的瓶颈是什么？这是无法扩展的一个原因。瓶颈之一是 MySQL...我们开始寻找不同的技术。 [Elasticsearch](/elasticsearch) 引起了我们的注意……我们对此进行了探索，现在我们的堆栈中有了 Elasticsearch...然后，我们在 [MySQL](/mysql) 之上构建了一个无模式的仅追加存储。和 FriendFeed 做的差不多...这允许我们水平地拥有更多的分区和碎片，同时也是无模式的。存储同一个房间或库存的不同版本，因此您不会覆盖。您没有覆盖单个行，所以您基本上是在创建它的不同版本。

[下一步是什么](#whats-next)

> 在 Rails 模型中，我们摆脱了人们可能会遇到的那种“回调地狱”...我们开始研究的下一步是事件流。那么会发生什么呢，假设客户更改了他们的一个属性，现在其余的系统需要知道这个更改，以前我们会有第一个简单的实现，你有 5 或 10 个不同的回调做同样的事情。我们现在正在评估[卡夫卡](/kafka)和 [Kinesis](/amazon-kinesis) 。

* * *

Siraj:你今天过得怎么样？生活怎么样？

贾廷德:做得很好。再好不过了。就在这个季度开始的时候，今晚酒店有很多事情是我们期待参与的，所以再好不过了。

太棒了。就起床和进入状态而言，你有每天都做的例行公事吗？

J: 通常我很早就来了，所以精力充沛。是啊。我通常做的第一件事是查看[新遗迹](/new-relic)的性能，昨天怎么样，我们的平均响应时间是多少，我们的关键 API 有 95%的响应时间。同样在公司里，有一封电子邮件发给公司里的每个人，就像这样，“嘿，公司做得怎么样？作为一家企业，我们做得怎么样？”每天看着它是一种提醒，我们在这里有一个使命。

谁发的那封电子邮件？

这是一封自动发送的电子邮件。我们使用一个叫做 [Looker](/looker) 的工具。Looker 是一个分析工具，我们可以在像[红移](/amazon-redshift)这样的数据库上使用，你可以发送预定的报告。其中一个每天都有安排。

根据我对你的了解和你目前所说的，看起来你在这里有一份不错的工作。我们有春分，今晚在旧金山有酒店，短途通勤，都是好东西。是什么让你对计算机科学产生了兴趣？是什么让你决定想从事编程工作？

编程世界无疑让我兴奋不已。在 90 年代，用拨号上网，等 20 分钟才能听到一首歌，甚至更久。那些是有趣的时光。它从一开始就深深地吸引了我，在那之后，我开始关注 [C](/c) ，Unix 是我的入门。

听到程序员谈论他们开发的第一种语言总是很有趣的，通常会有一些参考资料，它仍然是最好的，但是我觉得你现在一定有不同的感觉，你不觉得现在的语言是最流行的语言。

绝对的。我认为没有放之四海而皆准的方法。尤其是要看他们所在公司的情况。如果他们刚刚起步，C 可能不是合适的工具，也不是合适的技术。甚至在《今夜酒店》和我之前工作过的一些初创公司，比如 [Ruby on Rails](/rails) ，也非常适合你刚刚起步的时候。最终你可能会遇到非常特殊的挑战。这就是 C 语言真正强大的地方，现在可能是 [Go](/go) 非常强大。

根据手头的工作，更大的技术。

有道理。说到工作，今晚酒店。为什么今晚去酒店？你有很多经验，你可以选择你想去的地方，你选择了这个地方。

J: 是的，我很喜欢今晚酒店开放的环境。是工程师今晚在酒店对整个企业的影响。看着那封邮件，就像我每天说的那样，然后做点什么，而不仅仅是看看。这是我从一开始就看到的东西。我在消费者领域已经呆了大约十年了。之前为几家初创公司工作过-

作为一名程序员。

在今晚入住酒店之前，我是梦多公司的创始工程师之一。是那里最早的工程师之一。我在那里工作了大约八年。我意识到工程不仅仅是写代码，我也看到了这一点。当我看《今夜酒店》的时候，我真的把它看作是另一个创业公司，从数量和规模上来说，它并不是一个创业公司，但从内部运作来看，它仍然是一个非常好的创业公司。人们真的很开放，每个人都有机会产生影响。这就是为什么，那时候，大约两年前，我今晚加入了酒店。

有趣的是，开放对你来说是一件重要的事情。当谈到工程文化时，具体来说，假设您团队中的一名工程师有一个关于某个特性的想法，如果他/她想要实现它，那么这个过程看起来像什么？

是的，当然可以。假设我有一个想法。我过去有很多想法，最重要的是你能多快证明这个想法是可行的。我认为有两种类型的创新。有一种技术创新，你可以在其中改进工具和技术。其他类型的创新是我们也需要弄清楚如何从中赚钱的东西。这是否是一项功能，以及该功能如何与之相适应。你不会想最后得到一个拼凑的东西，里面有来自不同大脑的一千个不同的想法。

回到这个想法。很快证明这将如何帮助我们的客户。移动应用程序网站上的客户可能是想要预订酒店房间的人。在供应方面，是酒店。这在我们现有的框架内如何运作。我们是一个移动应用，我们只做移动应用。我们在 iOS、Android 和移动网络上。如果你看看我们的产品，它非常非常简单。当你有了一个想法，你必须把它弄清楚，我们如何保持简单是其中之一。

逮到你了。太棒了。似乎有 DIY，do-er 文化，如果你有一个想法，你就把它做出来，如果它成功了，如果它有利可图，它就会发生。

是啊。

酷。就工程团队而言，这里的结构是什么。你们有小团队，大团队吗，工程结构是什么样的？

我们是小团队的坚定信仰者。无论何时你在一个项目中工作，我们强烈认为在那个项目中不应该有超过五或六个人。这些是我们在着手一个项目时组建的特色团队。就结构而言，我今晚在酒店领导的团队是平台团队。平台团队就像后端基础设施，API。我们拥有的任何基于网络的产品，都是由这个团队来处理的。有一个移动团队，包括 iOS 和 Android，还有 QA 和产品团队。这属于工程范畴，当然，在工程范畴之外，还有供应、营销、财务等等。

逮到你了。有多少工程师？

我们大约有 40 名工程师，包括移动、QA 和平台工程师。

尤纳斯:其中最大的团队是什么？

**J:** 平台是最大的团队之一。平台现在大约有 14 到 15 个人。

Y:很好。甚至安卓和 iOS 分裂？

**J:** 甚至在[安卓](/android)和 [iOS](/objective-c) 之间平分秋色，耶。

Y:有意思。

你认为目前哪个平台最受关注？iOS，Android，web，除了这三个。

**J:** 对我们来说，肯定是 iOS。那是我们实际上在 2010 年底开始的平台，但我们一直在 Android 和移动网络上寻找机会或合作伙伴。

给你一点背景知识，去年九月或八月我们推出了一个手机网络产品来预订酒店。当时，你只能在 iOS 或我们的 Android 应用程序上预订酒店房间。之后，你现在可以在任何移动设备上预订，但仍然只能在移动设备上预订。

你最初是在这里参加了 iOS 的发布会，还是在那之前？

这发生在我之前，但我可以从我听到的故事中给你一些背景知识。

是的，最有价值球员是什么？

成功了，这是当时最好的决定。不到两个月，团队就推出了一款应用。我认为他们用的是[钛](/appcelerator)和很多[咖啡脚本](/coffeescript)。

哦，我的上帝。

在两个月内， [Rails](/rails) 后端将成为酒店管理库存和员工的界面。不到两个月，他们就推出了这款产品，而且上市速度非常快。那是过去的事了。那是 iOS 应用和 Android，我想当时他们使用了 [HTML5](/html5) 和 [jQuery](/jquery) 。最终，在接下来的几年里，我们组建了 iOS 和 Android 团队，他们都是非常非常优秀的专家，并将这些应用程序转换为本地应用程序。

太棒了。这似乎是目前的趋势。我真正感兴趣的是数据存储。我知道不同的平台会有所不同，但是你们是如何存储数据的呢？

J: 它已经进化了很多年。当我们开始的时候，它是一个单独的 [MySQL](/mysql) 数据库，位于某个 [EC2 实例](/amazon-ec2)上。多年来，它已经演变。我们仍然使用 MySQL。这是我们的存储平台之一，但肯定已经发展成更加分区和更加隐蔽的方法。我们用来存储的其他东西有 [Elasticsearch](/elasticsearch) 、 [Redis](/redis) 、 [Memcached](/memcached) 。不同类型的存储。有些是持久存储，有些是缓存。我们使用许多排队系统。IronMQ 是我们用于军种间通信的工具之一。对于 ETL，对于数据仓库和其他东西，我们使用[红移](/amazon-redshift)，我们还使用其他数据库，如 Postgres，用于[地理支持](/postgis)。

MySQL 是大部分东西的起点，正如我所说，当你扩展时，存储状态是一个挑战。你可以横向扩展你的应用服务或网络服务，但存储才是最终的目标。这就是我们将单一数据库发展为从堆栈中消除单点故障的原因，其中之一就是 MySQL。

S:现在你们只是有多个失败点。

**J:** (笑)。

虽然你们有专门的数据存储来存储不同的东西，但这太棒了。通常是非此即彼。你用什么后端语言来处理存储和检索？

J: [Ruby on Rails](/rails) 是我们投入巨资的平台之一。这就是我们在 2010 年编写第一款应用的方式。

**Y:Appcelerator 的第一款 app？**

是的，是我们构建的 API 和酒店界面的后端，但随着时间的推移，我们已经将它发展成更多的 Rails 应用程序，而且最近，我们开始将 Go 视为微小的服务来粘合...你必须从一个地方到另一个地方获取信息，所以与其把代码放在我们一直试图拆开的整体中，我们为什么不尝试像 [Go](/go) 这样的东西。 [Node.js](/nodejs) 和我刚才提到的其他移动网络平台，Node.js 是我们开始投资的另一个平台。

Y:你认为 [Ruby](/ruby) 占代码库的百分比是多少？

J: 我觉得至少是 80%。

所有的 API，所有的 Ruby？

哦，是的。

**Y: [目标 C](/objective-c) ，[爪哇](/java)？**

**J:** 目标 C，[反应](/react)，移动 web app 又来了。此外，应用程序使用的酒店界面 React。

Y:你有不同的酒店应用程序。

哦，对了，我们有一个应用程序。当我说应用程序时，它实际上是一个桌面和移动 web 应用程序，而不是一个本地应用程序，而是一个面向消费者的移动 web 应用程序，它使用 [React](/react) 以及 Node 和 Rails 的组合。

**Y:反应过来，节点和轨道，好的。**

**S:你怎么看待[围棋](/go)？我很喜欢围棋，你是围棋爱好者吗？**

J: 再一次，回到正确的工具用于正确的工作，它可以在很多事情上表现出色，但是如果我们试图编写一个 CRUD 应用程序，不，那不是我要去的地方。

你只是想坚持使用 [JavaScript](/javascript) 。

对于一个 CRUD 应用程序，或者一个简单的应用程序，坚持使用类似于 [Rails](/rails) 的东西。如果您有特定的需求，或者您希望将数据从一个地方传输到另一个地方，并且希望速度非常非常快，那么 Go 将是一个不错的选择。你不希望垃圾收集之类的东西碍事，也不希望多层框架碍事，这时你就想开始做 Go 之类的事情。

我喜欢你在考虑划分不同的问题和使用技术解决特定问题时的细致程度。你最近解决了一个非常困难的工程问题吗？

有几个工程问题我可以谈谈。首先，让我来介绍一下第一个问题的背景。早在 2014 年，我们曾经是预订酒店的当天服务。作为顾客，您只能在同一天预订酒店。你不能提前预订。今晚酒店会做的是我们会推送，我们会在上午 9 点向所有顾客发送推送通知。是自作自受的 DDoS。突然，在上午 9 点，你会看到这样一个流量高峰，客户试图来到应用程序，试图看看有什么可用的。这真的很有趣，因为这实际上给数据库带来了很大的压力。数据库压力很大，而我们当时的缓存非常有限。

因为实际的推送通知还是因为他们开始使用这款应用？

因为推送通知，所有人都试图同时访问应用程序，结果发现我们没有一个针对所有客户的特定算法。我们有不同数量的因素可以选择，以确定我们向用户显示什么样的酒店。我们不会向客户展示数百种选择。我们只给他们看了 15 家酒店。对于顾客来说，位置是环境中非常重要的一个方面。如果用户在洛杉矶和旧金山打开应用程序，他们会看到不同的结果。这意味着 API 提供了有限的缓存能力。

这是一个有趣的挑战。有些重要的日子，比如 7 月 4 日，阵亡将士纪念日，人们会打开应用程序。会有更多的人同时打开这个应用。这是一个有趣的挑战，所以我们当时做的是引入一种叫做 [Fastly](/fastly) 的服务。我们开始使用它们。有一些 API 不能缓存很长时间，但我们开始缓存，例如，其中一个 API 在非常有限的时间内提供酒店列表，并且缓存是基于用户的位置。

你可以做地理定位。

J: 是的。

Y:基于地理的高速缓存。

J: 是的。我们是《T2》的超级粉丝。我以前用过[清漆](/varnish)。边缘缓存为您提供的动力是...那是你应该停止的地方。如果你可以通过引入清漆这样的东西来解决问题，你绝对应该使用它。讲述我们那时候的经历。还有其他 API 可以更积极地缓存，我记得当我们引入 Fastly 时，我们通过引入 fast ly 将服务减少了大约 3 到 4 倍。

Y:响应时间。

**J:** 不，服务器数量。响应时间缩短了...快速响应，这取决于有效载荷的大小。当然，我们已经看到了 40 毫秒、30 毫秒的响应，这也取决于用户的位置。他们的节点网络与我们客户的位置非常吻合。

另一方面，API，请求必须通过整个堆栈。它必须通过所有负载平衡器、Rails 和所有数据库。它切断了一切。

**Y:核心 app 托管在哪里。**

我们最近搬到了 [AWS](/amazon-ec2) 。我们曾经使用一个平台，它的服务叫做[发动机场](/engine-yard)。我想今年早些时候，我们开始...我们已经为 web 容器和后台容器使用 AWS 很长时间了。我们转向 AWS，开始使用 [ECS，亚马逊 EC2 容器服务](/amazon-ec2-container-service)。

我们对我们的应用程序进行了分类，并使用 ECS 运行它，ECS 就像是容器的调度服务。这种转变也非常好。

是的，我们必须回到那个话题。听起来很有趣。回到 Fastly，您正在减少 Engine Yard 上的服务器数量，对吗？

**J:** 对。

你什么时候介绍的？

J: 是的。

你是如何发现 Fastly 的，又是如何做出这个决定的？那个过程是什么样的？

这不是一个艰难的过程。我认为我们在 Varnish 的工程团队中有大量的粉丝。我们已经看到了清漆的力量。另一方面，我们一直试图摆脱自托管工具。例如，MySQL，我们曾经在 EC2 实例上托管它。我们摆脱了这种情况，开始使用 [RDS](/amazon-rds-for-mysql) 。同样，我们也在寻找清漆服务。有没有提供清漆服务的产品？法斯特丽是个名字。我们试着四处看看。

Y:开始谷歌搜索。开始共享堆栈。我喜欢它。内部是否已经有人听说过 Fastly，并说“我们应该选择 Fastly”或考虑其他选择？

我想我们在 Fastly 停了下来，有一些关于 [CloudFlare](/cloudflare) 的讨论，但我想在 Fastly 也有一些共同的朋友。我认为，通常，当我们评估工具时，它只是回到这样一个问题，如果你有一个想法，你如何去做？我们来证明一下。让我们注册一个免费试用，看看什么工作，与 Fastly 它是如此简单，所有我们必须做的是改变我们的[路由 53](/amazon-route-53) DNS 指向 Fastly 和改变 TTL，指定 TTL 或缓存头对我们的回应。就这样，它在几天内就开始运行了。

Y:你开始发送一些请求，但没有自动发送...或者一夜之间。

**J:** 没错。我们开始首先推出一些不太重要的流量，以确保一切正常，但随着时间的推移，它已经成为我们的一个工具。

您只能缓存这么多，因此我们通过确保在上午 9 点积极缓存来解决上午 9 点的问题。你不能长时间缓存，尤其是像酒店列表这样的东西，因为我们的业务是最后一分钟。人们在最后一刻来到我们这里寻找酒店，而在最后一刻，酒店一直在改变他们的价格和分配。它们每分钟都在变化，这意味着我们只能缓存这么多。

然后我们开始寻找堆栈中的瓶颈是什么？这是无法扩展的一个原因。瓶颈之一是 MySQL。当有顾客来的时候，我们基本上...假设我们的数据库中有数百万条库存记录。我们将在它们的基础上运行地理查询，试图从数百万条记录中选出 15 家最好的酒店。

为什么是 15 号？

**J:** 为什么是 15 家，因为我们认为顾客的选择应该是有限的，只要向他们展示最好的 15 家酒店，就会让他们更容易选择。我们还确保有不同种类的酒店，不同的社区，以及很多与 algo 相关的东西。我们过去在 MySQL 中做了一些，在 Ruby 中做了很多，这是一个瓶颈。MySQL 正在成为瓶颈。

我们开始寻找不同的技术。弹性搜索引起了我们的注意。很多人都是其他后来技术的粉丝，比如 [Solr](/solr) 等等，用于酒店排名的 [Lucene](/lucene) 看起来是个有趣的想法。我们对此进行了探索，现在我们的堆栈中有了 Elasticsearch。

你在哪里举办？你自己？

**J:** 我们用一个[基金](/found)来托管 Elasticsearch。我想提到的一件事是，通过结合 [Ruby](/ruby) 和 [MySQL](/mysql) ，挑选出 15 家最好的酒店，这通常需要 500 毫秒到 1 秒的时间，取决于客户的位置和供应水平。

**Y:正在通过活动记录对吗？**

J: 肯定是通过 ORM，然后是 MySQL，然后是后期处理，在 Ruby 中有很多后期处理来混合和匹配酒店。和我们在 Ruby 和 MySQL 中做的一样，Elasticsearch 现在只需要 15 毫秒。这是一个有趣的挑战。

我可以继续谈论弹性搜索，因为我们发现了弹性搜索的另一个问题。就像“好吧，这太棒了。我们谈完了吗？”不，事实证明，这是在消费者方面，很多消费者进来并试图查看酒店列表。现在在酒店方面，我们已经与许多酒店合作，他们正在改变他们的库存，他们经常改变可用性和价格。现在会发生的是，数据必须从 MySQL 传播到 Elasticsearch。

Y:顺便说一下，他们正在输入数据，对吗？你没有刮脸之类的吗？

不，他们正在输入数据。我们还直接与它们连接，所以它也像我们使用的 API 一样。这意味着数据在不断变化，并且必须传播到所有存储系统，包括 [Elasticsearch](/elasticsearch) 。哇哦。对于弹性搜索来说，这确实是一个沉重的负担。典型的 Elasticsearch 用途是日志和分析。这个和那个不一样。文档的数量可能并不多，但它们一直在变化的事实引入了一些我们在开始使用 Elasticsearch 时没有意识到的行为。

Elasticsearch 会悄悄地删除一些写的内容。如果您使用其中一个名为`bulk update`的 API，您可以观察这些错误。那时我们就像“哦，它会扩展的，弹性搜索会扩展，对吗？”然后我们发现了它们，现在我们要确保抑制写入。在 Elasticsearch 和我们的系统之间有一个队列。

Y:队伍排得多长？

J: [IronMQ](/ironmq) 。

它会知道什么时候需要使用它，还是它的背后有人类？就像一个在观察和等待的工程师。

**J:** 我们还在这些排队系统中内置了许多监控功能，几乎所有的系统都是如此。我们将[数据狗](/datadog)用于许多指标和所有这些服务。如果队列中的消息数量超过了某个阈值，则提醒该人待命。

Y: Datadog 就像你的仪表板，对吗？

我认为仪表盘看起来很有趣，但很多时候你无法从中获得有意义的见解，或者可操作的见解。行动是关键。警戒是 [Datadog](/datadog) 真正擅长于我们的地方。我们已经为系统设置了警报。我们从所有数据库到所有缓存的负载平衡开始。我们有检查和平衡，以确保待命人员得到提醒。例如，如果 RDS 数据库的 CPU 超出某个限制。

Y:听起来很多工具都在帮助你实现这种方法，对吗？你可以说我们不需要仅仅是 [DevOps](/devops) 和 [Docker](/docker) 一起工作的人。很多工具听起来都有帮助，对吗？

绝对的。 [ECS](/amazon-ec2-container-service) 让它变得超级简单，我们使用 [Terraform](/terraform) 作为代码来模板化我们的基础设施。我们所有人都知道基础设施是什么样子的，以前有很多系统，关于这些系统的文档很少，现在基础设施是代码，比如 Terraform。

这个领域有很多创新。这个领域发生了很多很酷的事情。

你们到底有没有使用[云形成](/aws-cloudformation)？

不，我们不使用云形成。[地形](/terraform)。它提供了我们所有的依赖关系。所有的弹性缓存和 RDS 等等。太棒了。我们还有多种暂存环境。这几乎是同样的方法，我们可以上下旋转，上下旋转这些新环境。

Y:你的构建、测试和部署流程是什么样的？每个人都在本地使用 [Docker](/docker) 吗？

J: 目前还没有。有些是，但这是我们接下来要评估的事情之一。

Y:你个人使用 Docker 吗？

哦，是的。是啊。还是那句话，有一定的依赖性。随着服务数量的增加，我们试图弄清楚的是，我们如何提取外部服务的接口，这是我们正在考虑的事情之一。

我们典型的工作流程是这样的。我们用[索拉诺](/solano-ci)。一旦你签入某样东西，一旦你清除了 PR 或者清除了分支，它就会通过 Solano CI 并确保一切正常。

所有的测试都通过了，并确保它们在几分钟内运行，而不是 30、40 分钟。这就是索拉诺 CI 的威力所在。

你做一个公关，测试索拉诺。团队中还有其他人在审核，审核你的 PR，然后你将 PR 合并到 master。然后[詹金斯](/jenkins)和[索拉诺](/solano-ci)的组合开始部署到暂存集群，这时，根据功能，我们对 QA 进行某种手动测试，然后将其投入生产。

Y:[码头工人](/docker)如何融入 it 流程？一旦你把它运到 [GitHub](/github) ，它就会被装进集装箱，然后放进索拉诺？

J: 是的。它正在被集装箱化。我们使用 Jenkins 创建 Docker 版本，并创建我们需要的图像。通过 ECS，然后是 ECS，我们定义的所有任务定义。这就是我们的构建管道。

Y:测试需要多长时间？我只是好奇。

J: 如果你在本地运行，需要一段时间。我想这是我们几年前开始探索的事情之一。[圈慈](/circle-ci)和[索拉诺](/solano-ci)。我记得在索拉诺，我想需要 5 分半钟。

Y:哇，那太好了。

J: 这又是一个我们试图摆脱的庞然大物。就平台而言，进展非常顺利。只是看看不同的东西，我们可以提取出来，封装在不同的服务。

Y:在构建和部署方面，mobile 是否有不同的流程？

**J:** 了解平台，特别是 iOS，提交一个应用程序的审批周期。每两个星期，我们会试着发布一些东西，一个新的版本和热补丁，当然，一旦我们发现了什么。我们喜欢在这些平台上发布一个版本。不是特性驱动的发布，它更像是一个发布框架，我们必须发布一些东西。

我没有提到的一件事，回到挑战。我们通过引入缓存和迁移到 [Elasticsearch](/elasticsearch) 解决了客户方面的问题，还写了 Elasticsearch 正在发生的事情，但请记住，当所有这些酒店都在改变它们的价格和可用性时，所有这些仍然会转到一个数据库。那里有一个热点。这是我们研究不同公司如何实现这一目标的一些解决方案的地方之一。我们在 [MySQL](/mysql) 之上构建了一个无模式的仅附加存储。就像 FriendFeed 一样...FriendFeed 上有一个很好的[博客帖子](http://backchannel.org/blog/friendfeed-schemaless-mysql)，这就像是 2009 年。然后优步最近也[转移到了相同的模型](https://eng.uber.com/schemaless-part-one/)，无模式只追加存储。

这允许我们水平地拥有更多的分区和碎片，同时也是无模式的。无模式和仅追加是关键。存储同一个房间或库存的不同版本，因此您不会覆盖。您没有覆盖单个行，所以您基本上是在创建它的不同版本。然后是无模式，因为所有的东西都在变化，所以你不必去改变。您不必运行在线模式更改。

Y:哇。太棒了。

我们还有几分钟。还有其他有用的工具和东西吗？我们不需要在移动端接触太多，因为你在平台上，但有很多关于 Ruby 的具体问题的讨论。我知道你提到了 [Go](/go) ，但是你们有没有考虑任何其他的新技术，或者你们已经在 Ruby 上取得了成功，并且能够让它在高水平上运行？

对我们来说，Ruby 的表现相当不错。人们已经开始关注一些使用案例。屋子里有很多 Ruby 爱好者，包括我，我从 2006 年就加入了 Ruby 社区，而 [Elixir](/elixir) 是很多 Ruby 社区加入的东西之一。团队里有很多人在探索长生不老药。

你是它的粉丝吗？你玩过吗？

J: 我还没和它玩过。

Y:好吧，所以你和露比在一起很开心。

J: 我对 Ruby 很满意，但同时，我的时间表是，我甚至不会说编码和管理各占一半。现在甚至更多的是在管理方面。确保团队文化和项目顺利完成。基础设施真的让我兴奋。就像我说的，这让我更加兴奋。尤其是在存储系统上。你可以扩展 Ruby，你可以添加更多的 web 服务器，但是扩展状态真的很有挑战性。

**Y:是的，听起来你遇到的很多问题都是因为供应商方面有很多写操作，但我想在客户方面你不会遇到这种问题，对吗？**

是的。不是很多。在 Rails 模型中，我们摆脱了人们可能会遇到的那种“回调地狱”。

**Y: `after_save`。**

J: `after_save`在我们的一些 Rails 模型中，有一个长长的回调列表。我们不再那样做，开始尽可能多地了解他们的背景。

Y:一堆耙子任务。

**J:** 不是 rake 测试，而是使用类似 [Sidekiq](/sidekiq) 的东西，只是将其离线排队。我们开始研究的下一步是事件流。因此，假设一个客户改变了他们的一个属性，现在系统的其余部分需要知道这个改变，以前我们会有第一个天真的实现，就是你有 5 或 10 个不同的回调，它们做同样的事情。另一种观点是生产者和消费者。生产者将生产这种药物并将其放入队列中，就像[驱动](/amazon-kinesis)或[卡夫卡](/kafka)一样，然后世界上所有的消费者都将消费这种药物并对其触发采取行动。这就是我们正在进入的模式。从概念上讲，更容易理解系统中正在发生的事情。

是的，这意味着你有一个中心位置，在那里你可以看到正在发生的一切。

**J:** 对。

你现在在介绍卡夫卡，还是你已经有了？

我们现在正在评估[卡夫卡](/kafka)和 Kinesis。 [Kinesis](/amazon-kinesis) 是团队的东西...这是 AWS 的一项服务，所以你不必担心你必须与 Kafka 一起应对的一些主机挑战，但同时我们试图比较我们将与 Kinesis 和 Kafka 一起遇到的其他边缘情况。接了这个电话，然后决定我们应该使用 Kinesis 还是我们应该自己主持卡夫卡，然后去。

Heroku 最近推出了他们的 [Kafka 即服务](https://www.heroku.com/kafka?ref=stackshare.io)，这也是我们正在研究的事情之一。

Y:有意思。很好。我想现在我们已经把一切都处理好了。 [Looker](/looker) 对你们都有帮助？

毫无疑问，Looker 帮了很大的忙。我认为我们如何民主化...我们有如此多的数据，我们如何访问这些数据。不仅仅是我，我也可以运行 SQL 查询。团队的其他成员，公司的其他成员需要方便的访问。Looker 就是设计用来做这件事的工具之一。

当你描述上午 9 点的推送通知时，我想到了一件事。你能简单描述一下如果服务器在半夜停机会发生什么吗？流量是多少？你们在用[传呼机](/pagerduty)发短信吗？

J: 我们有平台团队。平台团队的每个成员都要待命一周。有一个主要和次要的，主要得到传呼，无论它是什么时候，如果他们不回答，它去次要的，然后我是第三级。我也是每 14 或 15 周轮换一次，但我也是第三级，如果没有人接听电话，我就会上场。

根据通知设置，我们当然希望人们接到电话，而不是短信，这取决于问题的性质。如果有来自数据库的警报，那么最好查看...这是一个电话。我们一直在努力通过警报来降低那里的噪音。

所有的噪音。确保高度警戒、关键的呼叫得到寻呼，我认为我们要考虑的下一步是如何将警戒提升到一个新的水平。不仅仅是发出警报，而是想出一种方法来解决这个问题。例如，假设我们的排队系统出现故障，我们是否可以在运行中增加更多的工作人员，而不是有一个随叫随到的人。

没有干预。这需要仔细完成，因为您不希望不得不启动更多的工人，最终导致您的数据库崩溃。

听起来这可能是机器学习。

是的，异常检测是机器学习的一部分...很多公司都在用它。我认为[相扑逻辑](/sumo-logic)是展示它的公司之一。他们几周前来到现场，其中一些看起来真的很有趣。

有太多要谈的了。我有很多问题要问你，但我知道你的时间有限，我们想结束这个话题。对我来说，从你今晚所说的关于酒店的话来看，这似乎是一种非常酷的文化，如果我申请工作，我会申请，但我的一个想法是整个行业。你知道在 Airbnb 和所有这些共享服务中有一种共享经济。你对住宿业或酒店的未来有什么看法？你认为人们会继续想要酒店，还是会朝这个方向或那个方向发展？你对此有什么看法？

**J:** 我认为不同的使用案例取决于客户处于其生命周期的哪个阶段。如果你要去度假，如果你和你的家人在一起，并且提前一年计划你的假期，那么我认为像 Airbnb 这样的住宿服务会更好。很多其他的使用案例，如果你想随性而为，如果你像我一样忙碌，我会在下午 6 点从南湾到旧金山旅行很多次，我只是想“嘿，我应该在这里就到此为止，还是应该延长我的夜晚，在这里订一个酒店房间，明天再回来？”《今夜酒店》开启了许多这样的意外经历。这是千禧一代的一个用例，手机的出现。我们才刚刚开始。

只是一个离别的问题。什么事情让你兴奋，什么事情让你期待？它可能是技术性的，也可能只是一般的生活，比如我有一只狗，我要去买什么的。后天，下周，甚至下个月。

好的。我个人喜欢缩放。当我在解决一个关于缩放的问题时，我会兴奋。它可以是一个存储系统，或者只是根据用户数量进行扩展。我问自己，什么让我兴奋。扩展公司是真正让我兴奋的事情。扩大客户群，如何留住用户，你可以做到每分钟 100，000 转，但如果你的用户不坚持...留存是另一回事。商业和技术的结合让我兴奋。

太棒了。非常感谢。

是的，非常感谢。谢谢你们。

![HotelTonight World](img/fa985f8c171e348f153edd440fb743ec.png)

* * *