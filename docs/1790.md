# 脸书如何在五分钟内告诉你的朋友你在灾难中是安全的——高可扩展性——

> 原文:[http://high scalability . com/blog/2015/9/28/how-Facebook-tell-your-friends-you-safe-in-a-disaster-in . html？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://highscalability.com/blog/2015/9/28/how-facebook-tells-your-friends-youre-safe-in-a-disaster-in.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

![](../Images/85230d9f3f018016ed7b6b3de14d1500.png)

这里有一篇文章更新:[脸书的安全检查是如何运作的](http://highscalability.com/blog/2015/11/14/how-facebooks-safety-check-works.html)。

在灾难中，人们有一种原始而迫切的需要，那就是知道自己所爱的人是安全的。911 期间我也有这种感觉。我知道在我们地区下一次野火中，我会有这种感觉。我清楚地记得 1989 年洛马普列塔地震 期间的这种感觉。

大多数地震都被忽视了。不是这个，每个人都知道。在计算机实验室的天花板不再像雪花一样落下后，我们确信大楼不会倒塌，所有的想法都转向了亲人的安全。对其他人来说也一样。打电话出去几乎是不可能的，因为全国各地的电话涌入海湾地区，所有的电话线都很忙。信息被卡住了。许多紧张的时间是在无知中度过的，因为电视上不断播放着死亡和毁灭的画面。

四分之一世纪过去了，我们还能做得更好吗？

脸书可以。通过一款名为 [安全检查](https://www.facebook.com/about/safetycheck/) 的产品，在灾难发生时连接朋友和亲人。当灾难发生时，安全检查会提示该区域的人们表明他们是否安全。然后，脸书通过告诉他们的朋友他们过得怎么样来结束担忧循环。

[Brian Sa](https://www.linkedin.com/pub/brian-sa/2/7a7/a3b) ，脸书的工程师经理，根据他在 2011 年 [日本福岛](http://www.telegraph.co.uk/news/worldnews/asia/japan/8953574/Japan-earthquake-tsunami-and-Fukushima-nuclear-disaster-2011-review.html) 毁灭性地震中的经历，创造了安全检查。他在@Scale 的演讲中讲述了自己非常感人的故事。

地震期间，Brian 在脸书挂了一面写有有用信息来源的横幅，但他被感动去寻找更好的方法来帮助需要帮助的人。那个冲动变成了安全检查。

我对安全检查的第一反应是该死，为什么以前没人想到这一点？这是一个非常强大的想法。

答案变得清晰起来，因为我听了脸书软件工程师彼得·科特 在 [同一视频](https://www.youtube.com/watch?v=ptsCWGZW_P8) 中的演讲，他也谈到了建筑安全检查。

很可能只有脸书能创建安全检查。这一观察与 Brian 在他的演讲中的主要教训非常吻合:

只有脸书可以创建安全检查，这并不是因为你可能会想到的资源，而是因为 Facebook 让员工可以创建像安全检查这样疯狂的东西，还因为只有脸书有 15 亿地理分布的用户，他们之间的分离度只有 4.74 边，只有脸书有狂热阅读他们的新闻订阅的用户。稍后会详细介绍。

事实上，彼得谈到了在脸书的产品开发中，资源是一个怎样的问题。负责安全检查的团队很小，也没有太多的资源。他们必须在没有资源的情况下构建产品并证明其成功，然后才能获得构建产品的资源。这个问题必须在不投入大量资金和资源的情况下大规模有效解决。

通常情况下，约束会导致巧妙的解决方案。一个小团队不能建立一个大的管道和索引，所以他们写了一些 hacky PHP，有效地完成了大规模的工作。

那么脸书是如何建立安全检查的呢？以下是我对布莱恩和彼得谈话的注释:

*   你可以把脸书想象成这个巨大的原始汤。数十亿人使用脸书，随着时间的推移，行为开始出现，有一些趋势会像病毒一样传播。

    *   一个病毒式的例子是，用户开始将他们的个人资料图片更新为红色的平等标志，以此来代表婚姻平等。

    *   作为支持，脸书开发了一个彩虹叠加工具，使得使用个人资料图片作为交流方式变得更加容易。这种做法起源于最早的脸书。在发明状态消息之前，用户会改变他们的个人资料图片来传达他们当前的时代精神。

    *   轻松定制个人资料图片**采用率提高 1000 倍**。

*   这让他们产生了 **的想法，让人们在灾难中更容易告诉他们的朋友他们没事** 。

    *   在灾难中，人们会更新他们的状态，说他们没事。

    *   对于让人们知道你很好的问题，这不是一个理想的解决方案。

    *   它不是很有条理。两个方向都有问题，告诉别人你很好的方向和你的朋友得到你很好的信息的方向。

    *   首先，不是你所有的朋友都会看到更新。

    *   其次，用户没有办法获得他们所有受灾难影响的朋友的名单。

    *   把更结构化的思维运用到灾情通报的问题上，产生了 [安全检查](https://www.facebook.com/about/safetycheck/) 。

*   工作原理:

    *   如果你在受灾难影响的地区，脸书会向你发送推送通知，询问你是否安好。(没有提到灾难发生时由谁来决定)。

    *   点击“我是安全的”按钮表示你是安全的。

    *   你所有的朋友都被告知你是安全的。

    *   朋友们还可以看到所有受灾难影响的人的名单以及他们的情况。

*   你如何在某个地区建立受灾难影响的人才库？建立地理索引是显而易见的解决方案，但它也有弱点。

    *   人们总是在移动，所以这个指数会过时。

    *   15 亿人的地理指数是巨大的，会占用他们原本没有的大量资源。请记住，这是一个没有很多资源的小团队在尝试实现一个解决方案。

    *   该解决方案应该只在发生事故时才起作用，而不是让很少使用的数据管道一直处于活动状态。这就要求能够进行查询的是 **动态和即时的** 。

*   解 **利用了社交图的形状及其性质** 。

    *   当发生灾难时，比如说尼泊尔发生地震，安全检查的一个钩子是 **在每一个单独的消息馈送负载** 中打开。

    *   当人们查看他们的新闻提要时，钩子执行。如果查看他们新闻的人不在尼泊尔，那么什么也不会发生。

    *   当尼泊尔人查看他们的新闻时，奇迹就发生了。

    *   安全检查 **粉丝在自己的社交图上向所有好友** 。如果一个朋友在同一个区域，就会发送一个推送通知，询问他们是否安好。

    *   **过程不断递归重复** 。对于在灾区找到的每一个朋友，都会产生一个检查他们朋友的工作。根据需要发送通知。

*   在实践中，这个**解决方案是** **非常有效的**。产品体验感觉是实时和即时的，因为算法在寻找人方面是如此之快。例如，同一个房间里的每个人似乎都会同时收到通知。为什么？

    *   使用新闻提要给出了用户的随机抽样，偏向于最活跃的用户 **和最多的朋友**。它过滤掉不活跃的用户，这是数十亿行不需要执行的计算。

    *   图中的 **图中的**图中的 图中的密集且相互关联。 [六度凯文·贝肯](https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon) 是错误的，至少在脸书上是这样。脸书 15 亿用户中任意两个人之间的平均距离是 4.74 边。抱歉凯文。对于 15 亿用户，整个图表可以在 5 跳内被探索。大多数人都可以通过跟踪社交图谱有效地联系到。

    *   有 **大量并行** 免费使用社交图方法。可以将好友分配到不同的机器上并行处理。他们的朋友也可以，等等。

*   **竞态条件成了问题** 做到了分布式自然解。

    *   两个不同数据中心的两台机器有一个用户是同一个人的朋友。这意味着两条边都被遍历，最终向同一个人发送两个通知。

    *   我并不认为这有什么大不了的，但实际上用户发现在灾难场景中收到多个通知真的很有压力。用户认为，如果他们同时收到两个通知，他们一定会遇到真正的麻烦。你也不希望你的安全相关项目在灾难中出现问题。

    *   数据库被用来存储状态，所以只有一台机器会检查用户。问题是，当您有多个数据中心时，比如一个在欧洲，一个在美国，传播延迟会花费太长时间来确定用户是否正在被处理。

    *   为两层解决方案添加了内存锁定结构。检查内存锁，如果为用户设置了该位，则该用户的作业被中止。

*   最大的产品发布会是为尼泊尔地震举办的。

    *   不到 5 分钟，300 万人被邀请提供他们的状态。尼泊尔人太多，检查了 10 亿行。

    *   **在大约 5 分钟内发掘了脸书 2/3 的用户群**。

*   构建第一版安全检查时遇到了一些问题。

    *   桌面、移动网络和原生应用的碎片化给跨多个平台管理内容、功能和运营带来了巨大的复杂性。

    *   想要对需要手工编码的内容进行个性化处理，这既慢又繁琐，而且容易出错。

    *   当一个系统只在紧急情况下运行时，很难说它在紧急情况下是否还能工作。

    *   那么，为了构建一个跨平台但仍能本地响应的系统，应该采用什么样的客户机-服务器模型呢？如何收录动态内容？如何测试系统以确保其可靠性？

*   选择让服务器负责文本、图像和配置信息。客户端将预取数据，处理实时失效，并本地响应客户端事件。

*   实时失效。

    *   无论何时处理预取的数据，指定该数据何时到期都很重要。例如，如果用户打开应用程序并上传了一些数据，那么他们会关闭应用程序，并在几天后再打开它。如果上传的数据是选举公告，那么如果选举通过，用户就不会看到该公告。

    *   TTL(生存时间)参数告诉客户端在数据需要刷新之前可以使用多长时间。

    *   交互计数表示用户可以与数据交互的次数。

    *   更多可选过滤器，如 remaining_battery_percentage，它会告诉客户端如果设备处于低电量状态，就不要向用户显示消息。

*   实施内容限制

    *   指定文本中的最大行数不是一个好主意。翻译成其他语言时，字符串可能会急剧增长。

    *   不同的平台和设备有不同的屏幕尺寸，所以一个固定的限制是行不通的。

    *   因此，在服务器上定义内容长度限制，并建立一个缓冲区来处理长翻译。

*   动态内容

    *   这使得安全检查信息可以个性化，比如在文本中插入用户名。

    *   想出了一种语言，比如邮件合并，来指定“危机名称”和“危机网址”之类的替换。

*   正向缓存

    *   哪里还记得以前符合条件的单位

    *   安全检查是一种与用户保持固定沟通渠道的装置。对于活动持续时间，没有查看限制。如果它在星期五被打开，那么在星期五被关闭之前会有持续的发送。

    *   正缓存有益于长期运行的单元，因为你不必评估任何单元的合格性。您必须检查缓存单元的合格性，因为您不想显示它超过预期的次数。

*   负缓存

    *   你记得没有单位是合格的。

    *   安珀警报是一次性信息。这种类型单元的负载曲线非常不同。例如，如果它在上午 8:50 打开，到上午 9:00 时它已经达到峰值传输，然后它衰减得非常快。在一个小时内，一半的人被触及，在三个小时内，几乎所有的目标观众都被触及。

    *   负缓存有利于短期运行的单元，因为大多数时候没有符合条件的单元可以显示。负缓存会记住这个事实。

*   黑暗发射

    *   使用实时流量测试系统，以发现意外问题。一个标志被用来对用户隐藏它，所以没有用户影响。

    *   运行 24 小时的测试发现了一些意想不到的问题。其中一个生成社会句子的子系统容量不足。

*   断路开关

    *   脸书由数百个联锁系统组成。

    *   有时，在灾难性故障的情况下，你需要快速卸载。

    *   断路开关允许你完全关闭整个系统。你也可以杀死特定的应用程序版本或设备。

## 相关文章