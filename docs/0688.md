# Swiftype 如何以及为什么从 EC2 转向真正的硬件-高可扩展性-

> 原文:[http://high scalability . com/blog/2015/3/16/how-and-why-swift type-moved-from-ec2-to-real-hardware . html？UTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](http://highscalability.com/blog/2015/3/16/how-and-why-swiftype-moved-from-ec2-to-real-hardware.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)

![](../Images/bd13f7a734bb8c2326b8a527a50cfa1f.png)

*这是一篇客座博文，由 [奥莱克西](https://twitter.com/kovyrin)[swift type](https://swiftype.com/)负责技术运营。Swiftype 目前为超过 100，000 个网站的搜索提供支持，每月提供超过 10 亿次查询。T15】*

当 Matt 和 Quin 在 2012 年创建 Swiftype 时，他们选择使用亚马逊网络服务来构建公司的基础设施。云似乎是最合适的，因为添加新服务器很容易，无需管理硬件，也没有前期成本。

不幸的是，虽然有些服务(如 Route53 和 S3)最终对我们来说非常有用而且非常稳定，但使用 EC2 的决定在我们的第一年就给团队带来了几个大问题。

Swiftype 的客户要求卓越的性能和不间断的可用性，而我们提供这种性能和可用性的能力在很大程度上取决于我们基础设施的稳定性和可靠性。在 Amazon 上，我们**经历了网络问题、挂起的 VM 实例、不可预测的性能下降(可能是由于吵闹的邻居共享我们的硬件**，但没有办法知道)和许多其他问题。无论我们经历了什么问题，亚马逊总是有相同的解决方案:通过购买冗余或更高端的服务向亚马逊支付更多的钱。

我们花在解决 EC2 问题上的时间越多，我们花在为客户开发新功能上的时间就越少。我们知道让我们的基础设施在云中运行是可能的，但是这样做所花费的精力、时间和资源要比迁移出去多得多。

经过一年与云的斗争，**我们决定放弃 EC2，选择真正的硬件**。幸运的是，这不再意味着购买您自己的服务器并将其安装在 colo 中。托管主机提供商促进了物理硬件、虚拟化实例和快速配置之间的良好平衡。鉴于我们之前与主机提供商的合作经验，我们决定选择 SoftLayer。他们出色的服务和基础设施质量、供应速度和客户支持使他们成为我们的最佳选择。

经过一个多月的艰苦工作准备数据中心间的迁移，我们能够在零宕机的情况下执行迁移，并且对我们的客户没有负面影响。**向真实硬件的迁移从第一天起就极大地提高了服务稳定性，为所有关键基础设施组件提供了巨大的(~ 2 倍)性能提升，并将我们每月的托管费用降低了约 50%** 。

本文将解释我们如何规划和实施迁移流程，详细介绍我们在迁移后看到的性能提升，并为年轻公司提供关于何时进行同样操作的见解。

## 准备切换

在迁移之前，我们在 Amazon EC2 上有大约 40 个实例。我们每周至少会遇到 2-3 次严重的生产问题(实例中断、网络问题等)，有时甚至每天都会遇到。一旦我们决定转移到真正的硬件，我们知道我们的工作已经完成，因为我们需要在不中断服务的情况下切换数据中心。准备过程包括两个主要步骤，每个步骤在下面的章节中都有专门的解释:

1.  **连接 EC2 和软层**。首先，我们在 SoftLayer 的数据中心构建了新基础设施的框架(能够以开发级负载运行所有关键生产服务的最小服务器子集)。新数据中心建立后，我们在新旧数据中心之间构建了一个 VPN 隧道系统，以确保两个数据中心组件之间的透明网络连接。

2.  **我们应用的架构变化**。接下来，我们需要对我们的应用程序进行更改，使它们既可以在云中工作，也可以在我们的新基础架构上工作。一旦应用程序可以同时驻留在两个数据中心，我们就构建了一个数据复制管道，以确保云基础架构和软层部署(数据库、搜索索引等)始终保持同步。

### 第一步:连接 EC2 和 Softlayer

为我们的迁移做准备，我们首先要做的事情之一就是想出如何将我们的 EC2 和我们的软层网络连接在一起。不幸的是，将一组 EC2 服务器连接到另一个专用网络的“正确”方式——使用 EC2 的虚拟专用云(VPC)功能——并不是我们的选择，因为我们无法在不停机的情况下将现有的一组实例转换为 VPC。经过一些考虑和仔细的规划，我们意识到真正需要能够跨越数据中心边界相互连接的服务器是我们的 MongoDB 节点。我们可以将所有其他东西都放在数据中心本地(Redis 集群、搜索服务器、应用集群等)。

![diagram_1.png](../Images/db67558249d985fb5bb46058eabda8ee.png)T2】

由于我们需要互连的实例数量相对较少，我们实施了一个非常简单的解决方案，该解决方案被证明是稳定且有效的，能够满足我们的需求:

*   每个数据中心都部署了专用的 OpenVPN 服务器，将所有客户端流量转换到其专用网络地址。

*   需要能够连接到另一个数据中心的每个节点将在那里建立一个 VPN 通道，并建立本地路由，以正确地将指向另一个 DC 的所有连接转发到该通道。

以下是一些使这种配置对我们来说非常方便的功能:

*   由于我们不控制任何一端的网络基础设施，我们无法强迫任何一端的所有服务器通过连接到另一台 DC 的中央路由器来传输流量。在我们的解决方案中，每个 VPN 服务器(在某种自动化的帮助下)决定通过隧道路由哪些流量，以确保其所有客户端的完整 DC 间连接。

*   即使 VPN 隧道崩溃(令人惊讶的是，这种情况在项目的几周内只发生过几次)，这也仅仅意味着一台服务器失去了与另一台 DC 的连接(一个节点脱离了 MongoDB 集群，一些工作服务器失去了与中央资源箱的连接，等等)。这些一次性的连接损失都不会影响我们的基础架构，因为所有重要的基础架构组件两端都有冗余服务器。

### 步骤 2:对我们的应用程序进行架构变更

在为迁移做准备的几周里，我们不得不在基础设施上做了许多小的改变，但是对其每一个组成部分的深刻理解帮助我们做出了适当的决策，降低了在过渡期间发生灾难的可能性。我认为，只要有足够的时间和工程资源，仔细考虑应用程序和后端服务之间建立的每一个网络连接，几乎任何复杂性的基础设施都可以迁移。

![diagram_2.png](../Images/a6eaf06da9cd2cef1e72de6700d336fa.png)T2】

以下是我们为确保平稳透明的迁移而必须采取的主要步骤:

*   所有无状态服务(缓存、应用集群、web 层)都独立部署在每一端。

*   对于每个有状态的后端服务(数据库、搜索集群、异步队列等)，我们必须考虑我们是否想要(或负担得起)将数据复制到另一端，或者我们是否必须为所有连接带来数据中心间的延迟。依赖 VPN 一直被认为是最后的选择，最终我们能够将数据中心之间的流量减少到几个小的复制流(主要是 MongoDB)和无法复制的服务的主/主要副本的连接。

*   如果服务可以被复制，我们会这样做，然后让应用服务器总是使用或偏好服务的本地副本，而不是去另一端。

*   对于我们无法使用其内部复制功能复制的服务(如我们的搜索后端)，我们在应用程序中进行了更改，以实现数据中心之间的复制，其中每一端的异步工作人员将从各自的队列中提取数据，我们将始终将所有异步作业写入两个数据中心的队列中。

### 第三步:扳动开关

当双方都准备好为我们的 100%流量提供服务时，我们通过将 DNS TTL 减少到几秒钟来为最终切换做准备，以确保流量的快速变化。

最后，我们将流量转移到新的数据中心。请求转移到新的基础架构，对我们的客户没有任何影响。EC2 的流量耗尽后，我们禁用了旧的数据中心，并将所有剩余的连接从旧的基础设施转发到新的基础设施。DNS 更新需要时间，因此在截止时间后的至少一周内，我们的旧服务器上仍有一些剩余流量。

### 明显改善:从 EC2 转移到真实硬件后的结果

**稳定性提高**。我们从每周 2-3 次严重停机(其中大多数是客户看不到的，因为我们尽了最大努力使系统对故障具有弹性，但许多停机会吵醒某人或迫使某人放弃家庭时间)减少到每月 1-2 次停机，我们通过投入工程资源来提高系统对故障的弹性，并降低它们对客户可见的可用性产生任何影响的可能性，从而能够更彻底地处理这些停机。

**性能提升**。得益于 SoftLayer 提供的现代硬件，我们看到了所有后端服务的持续性能提升(特别是数据库和搜索集群等受 IO 限制的服务，但也包括受 CPU 限制的应用服务器)，更重要的是，性能更加可预测:没有与我们自己的软件活动无关的突然下降或峰值。这使我们能够开始进行真正的容量规划，而不是在所有性能问题上抛出更慢的实例。

**成本下降**。最后，但同样重要的是，对于一家年轻的初创公司来说，我们基础架构的每月成本至少下降了 50%，这使我们能够过度调配一些服务，以进一步提高性能和稳定性，从而使我们的客户受益匪浅。

**配置灵活性提高，但配置时间增加**。我们现在能够精确地指定服务器来满足它们的工作负载(大量的磁盘并不意味着我们需要强大的 CPU)。然而，我们不能再通过 API 调用在几分钟内启动新的服务器。SoftLayer 通常可以在 1-2 小时内为我们的设备添加新的服务器。对于一些公司来说，这是一个很大的权衡，但对于 Swiftype 来说，这是一个很好的选择。

## 结论T3】

自从改用真正的硬件以来，我们已经有了相当大的增长——我们的数据和查询量增加了 20 倍——但是我们的 API 性能比以往任何时候都要好。准确了解我们的服务器将如何运行，让我们能够以一种前所未有的方式规划增长。

根据我们的经验，当你需要快速提升新硬件时，云可能是一个好主意，但只有当你付出巨大努力(网飞水平)才能在其中生存时，它才会发挥作用。如果你的目标是从第一天就开始创业，而你没有多余的工程资源来支付“云税”，那么使用真正的硬件可能是一个更好的主意。

如果你对软件和基础设施交叉领域的工程充满热情，Swiftype 正在招聘高级技术运营工程师。T3】

[上黑客新闻](https://news.ycombinator.com/item?id=9212467)

[在 reddit 上](http://www.reddit.com/r/programming/comments/2z9xwp/how_and_why_swiftype_moved_from_ec2_to_real/)