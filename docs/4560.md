# 生产测试:是的，你可以(也应该)| Opensource.com

> 原文：<https://opensource.com/article/17/8/testing-production?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

我最近写了一篇关于为什么[我们现在都是分布式系统工程师](https://opensource.com/article/17/7/state-systems-administration)的文章。令我惊讶的是，很多人反对你*用*来测试生产中的大型分布式系统。

生产中的测试似乎受到了不好的指责——尽管事实上我们一直都在做。

也许我们会联想到牛仔工程。我们听到“生产中的测试”，并假设这意味着没有单元测试、功能测试或持续集成。

在生产之前尝试捕捉事物是很好的——我们也应该这样做！但是这些事情并不互相排斥。以下是在生产中测试时需要考虑的一些事情。

## 1.你已经做了

prod 中已经测试了很多东西——因为没有其他方法可以测试它们。当然，您可以克隆各种系统组件或整个系统，并捕获真实流量以离线回放(系统测试的黄金标准)。但是许多系统太大、太复杂、成本太高，无法克隆。

想象一下，试着旋转脸书的一个副本进行测试(有多个分布在全球的数据中心)。想象一下，试着复制一份国家电网。即使你成功了，接下来你需要同样数量的客户端，同样的并发性，同样的流水线和使用模式，等等。用户流量的不可预测性使得无法嘲讽；即使你能完美再现昨天的交通状况，你也无法预测明天的交通状况。

人们很容易陷入关于克隆环境的争论，而忽略了真正的要点:**只有** **生产才是生产**，每次在那里部署时，您都在测试部署代码+软件+环境的独特组合。(只要问问那些曾经自信地部署到“准备阶段”和“生产阶段”的人就知道了)。)

## 2.其他人也一样

你不能复制脸书。你不能复制一个国家电网。有些东西不适合克隆。这很好。你根本无法有效地模仿大小和混乱的特性，这些特性梳理出你所关心的 bug 或行为的细长尾巴。

你不应该尝试。

脸书也没有试图复制脸书。他们投资工具，让成千上万的工程师每天安全地部署到生产中，观察人们与他们编写的代码进行交互。网飞也是。每一个足够幸运的人也是如此，他们不再认为这是一个容易解决的问题。

## 3.可能没问题

测试有很多价值...在某种程度上。但是如果你能用 10%到 20%的努力捕捉到 80%到 90%的 bug，你就可以用剩下的精力让你的系统更有弹性，而不是防止失败。

你应该**定期练习失败**。理想情况下，有权使用生产环境的每个人都知道如何进行部署和回滚，或者如何快速达到已知的良好状态。他们应该知道正常的操作系统是什么样子，以及如何调试基本问题。知道如何应对失败的人应该不少。

如果你在生产中测试，处理失败不会是罕见的。我说的是这样的事情，“这有内存泄漏吗？”也许可以像金丝雀一样在五个主机上运行一夜看看。“这项功能是否按计划运行？”在某种程度上，只需将它与一个功能标志一起发布，这样只有特定的用户才能使用它。诸如此类的东西。练习发布和修复许多小问题，而不是几个大的戏剧性的发布。

## 4.你有更大的问题

您每天都在发布代码，并对常规代码造成自我伤害，而且您无法知道它在之前、期间或之后做了什么。问题不在于破碎的材料；你可以安全地打碎东西。这是第二部分——不知道它在做什么——这是不对的。这个更大的问题可以通过以下方式解决:

*   金丝雀。自动鸭式飞行。自动升级的自动分级加那利。多只金丝雀同时飞行！
*   使部署更加自动化、健壮和快速(上限为 5 分钟是好的)
*   使回滚非常快速和可靠
*   使用仪器、可观测性和其他早期预警信号对分级鸭翼进行预警
*   对关键端点进行端到端运行状况检查
*   选择好的默认值、特性标志、开发人员工具
*   教育、分享最佳实践、标准化实践、让简单/快速的方式成为正确的方式
*   从关键路径中取出尽可能多的代码和后端组件
*   限制任何给定用户或变化的爆炸半径
*   探索生产，验证预期的变化是实际发生的。知道正常是什么样子

这些事情都是对你时间的极大利用。与众所周知的脆弱、易变且难以与生产保持同步的试运行和测试环境不同。

## 做那些事情

在超过 50 人的公司中，发布工程是一个系统性投资不足的技能组合。你的部署几乎是你所有失败的原因，因为它们给你的系统注入了混乱。拥有生产的暂存副本并不能改变这一点(它增加了一大类问题，俗称“它看起来就像生产，所以我就放弃了那个表……”).

拥抱失败。混乱和失败是你的朋友。问题不是*如果*你会失败，而是*什么时候*你会失败，以及*是否*你会注意到。这是在是否会因为整个网站瘫痪而惹恼所有用户之间，还是在你第二天早上空闲时修复它之前，只会惹恼少数用户。

曾几何时，这些都是可选技能，甚至是特长。不再是了。作为一名分布式系统工程师，这些是你新职业的赌注。

向它倾斜。很可能没事。