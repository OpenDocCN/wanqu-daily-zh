# AWS 提示、技巧和技术

> 原文：<https://launchbylunch.com/posts/2014/Jan/29/aws-tips/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website>

## 背景

AWS 是最流行的云计算平台之一。它提供了一切，从对象存储( *S3* )、弹性供应服务器( *EC2* )、数据库即服务( *RDS* )、支付处理( *DevPay* )、虚拟化网络( *VPC 和 AWS 直连*)、内容交付网络( *CDN* )、监控( *CloudWatch* )、排队( *SQS* )等等。

在这篇文章中，我将介绍一些开始使用亚马逊网络服务(AWS)的技巧、窍门和一般建议。其中大部分是我们在部署和运行我们的云 SaaS 产品 [JackDB](https://www.jackdb.com/) 时学到的经验，它完全运行在 AWS 上。

## 演员表

AWS 账单在月末开具，AWS 服务通常按“每次使用”计费。例如，EC2 服务器以美元/小时报价。如果您启动服务器 6 小时，然后关闭它，您将只支付这 6 小时的费用。

不幸的是，AWS 不提供限制你每月开销的方法。如果你不小心启动了太多的服务器，却忘了关掉它们，那么你可能会在月末受到一点惊吓。同样，AWS 会根据使用的总出站带宽向您收费。如果你有一个 AWS 托管的网站的活动高峰，或者只是过度使用 S3，你可能会面临一笔相当大的账单。

AWS*是否允许你设置计费提醒。Amazon CloudWatch 允许你使用预计的月账单作为提醒的指标。当金额超过预设金额时，您可以收到通知。*

 ****马上做这个！*T3】**

说真的，马上去添加这个。更好的是，以各种美元数字添加几个这样的项目。一个好的起点是:每月 1 美元、每月 10 美元、每月 50 美元、每月 100 美元、每月 250 美元、每月 500 美元和每月 1，000 美元

如果您最终得到了一个失控的服务器，或者意外地提供了 10 个服务器而不是 1 个(*,这在编写自动化部署脚本时非常容易...*)，那么你会很高兴你设置了这些账单提醒。

我们的公司 [JackDB](https://www.jackdb.com/) 完全由 AWS 托管，我们的账单每月都相当一致。一旦每月账单稳定下来，我们就按照预期值以及 1/3 和 2/3 的金额设置账单提醒，如上所述。这意味着大约在每个月的 10 号和 20 号，我们会收到一个通知，说我们的账单是我们预计每月花费的 1/3 或 2/3。

如果这些警报中的任何一个在此之前被触发，这将是每月上升的迹象。

## 安全性

安全性是一个大问题，尤其是在云中。关于它的文章不计其数，这里的建议只是几个要点。以后我想写一篇更详细的文章。

### 多因素认证

[多因素身份认证](https://en.wikipedia.org/wiki/Multi-factor_authentication)，也称为双因素身份认证或 2FA，是一种增强的身份认证方法，需要结合多个独立的身份认证因素。最常见的是**你知道的东西** ( *例如:密码*)和**你拥有的东西** ( *例如:你手机上的硬件令牌或虚拟令牌生成器*)。

如果其中一个受到威胁(*例如:有人窃取了你的密码*)，他们仍然需要其他因素才能登录。单单一个因素是不够的。

AWS 支持使用标准 TOTP pin 码的[多因素认证](http://aws.amazon.com/iam/details/mfa/)。它既支持免费软件 pin 码(*例如:智能手机上的谷歌认证器*)也支持硬件令牌(*2014 年 1 月*起 12.99 美元)。

***马上做这个！*T3】**

没有理由不启用它，我建议立即启用它。事实上，你应该在你使用的每个支持 2FA 的服务上启用 2FA。如果你使用的是谷歌应用程序，甚至只是普通的 Gmail，你也应该在那里启用它。

### 嘘

对不相关的项目使用唯一的 SSH 密钥是一个好主意。这使得以后取消对它们的供应变得容易得多。您应该生成一对新的 SSH 密钥(*和一个[长的密码短语](https://xkcd.com/936/)* )以用于您的新服务器。如果有多个人共享对相同服务器的访问，每个人都应该有自己唯一的 SSH 密钥。

您应该将密钥文件添加到~/中，而不是在命令行中指定它们。ssh/config 文件，这样它们将被自动使用。q

```
Host ec2-10-20-30-40.compute-1.amazonaws.com
  User ubuntu
  IdentityFile "~/.ssh/my-ec2-private-key"

```

默认情况下，SSH 会将密匙环中或配置文件中列出的所有可用的 SSH 密钥发送到远程服务器。如果您有很多 SSH 密钥，那么当您尝试通过 SSH 访问远程服务器时，可能会收到一个错误:

```
Too many authentication failures for username

```

从远程服务器的角度来看，每一次都被视为一次连接尝试。如果你有太多的 SSH 密钥让它尝试，那么它可能不会找到正确的。要强制它只发送您的配置文件中列出的特定于您正在连接的服务器的 SSH 密钥，请将以下内容添加到您的`~/.ssh/config`的顶部:

```
Host *
  IdentitiesOnly yes

```

这将迫使您明确列出用于所有远程服务器的 SSH 密钥。如果您想将其限制为其中的一个子集，您可以用一个与服务器的 DNS 名称匹配的通配符来替换**主机**部分中的“*”。比如`*.example.com`。

### VPC

[Amazon Virtual Private Coud(VPC)](http://aws.amazon.com/vpc/)是 EC2 的一个网络特性，允许你为一组服务器定义一个私有网络。使用它可以极大地简化隔离基础架构组件的工作，并最大限度地减少面向外部的组件。

基本思想是将您的基础设施分成两半，公有一半和私有一半。你所创建的任何东西的外部端点都在公共部分。对于 web 应用程序，这将是您的 web 服务器或负载平衡器。

只在内部使用的服务，如数据库或缓存服务器，属于私有的那一半。私有部分的组件不能从公共互联网直接访问。

这是最小特权原则的一种形式，实现它是个好主意。如果你的服务器基础设施包含不止一台**服务器，那么你可能应该使用 VPC。**

### 堡垒主机

要访问 VPC 私有部分的内部组件，你需要一台堡垒主机。这是一个专用服务器，将作为 SSH 代理连接到您的其他内部组件。它位于你的 VPC 的公共区域。

当在 AWS 上工作时，使用带有 VPC 的 bastion 主机极大地简化了网络安全，因为它极大地减少了您需要管理的外部防火墙规则的数量。下面是如何设置一个:

1.  在 VPC 的公共区域安装一台新的服务器
2.  创建一个安全组 **Bastion SG** 并将其分配给新服务器
3.  编辑您的私有半服务器的安全组，以允许来自**堡垒 SG** 的**入站**访问端口 22 (SSH)
4.  将您的白名单 IP 添加到 **Bastion SG** 的入站 ACL 中(*见下一节*)

SSH 代理服务器不使用那么多 CPU，几乎不使用磁盘。一个 m1.micro 实例(*AWS 提供的最便宜的实例*)就足够了。截至 2014 年 1 月，按需费率约为 15 美元/月。通过预订实例，您可以将这一成本降低到每月 7 美元左右。

与它为您的整体环境带来的简单性和安全性相比，增加的成本算不了什么。

### 防火墙白名单

任何向公共互联网开放端口 22 (SSH)的服务器都会受到大量黑客攻击。在打开这样一个服务器的 24 小时内，你应该会在你的 SSH 日志中看到很多试图暴力登陆的机器人的条目。如果你只允许基于 SSH 密钥的认证，这将是一个毫无意义的练习，但是看到日志中的所有条目仍然很烦人。是额外噪音。

避免这种情况的一种方法是将可以连接到您的服务器的 IP 地址列入白名单。如果您的办公室有一个静态 IP 地址，或者如果它“基本上是静态的”(*例如:大多数用于电缆调制解调器和 DSL 的动态 IP 不经常改变*)，那么您可以为您的服务器设置防火墙规则，只允许来自这些 IP 的入站 SSH 访问。其他 IP 地址甚至不知道有一个 SSH 服务器在运行。SSH 服务器的端口扫描将会失败，因为初始 TCP 套接字将永远不会建立。

通常情况下，在多台服务器上进行管理是一件痛苦的事情，但是通过使用堡垒主机，只需要在一个地方就可以完成。稍后，如果您的 IP 地址发生变化，或者您需要从一个新的位置连接到您的服务器(*例如:在酒店的路上*)，那么只需将您当前的 IP 地址添加到白名单中。完成后，只需将其从列表中删除即可。

## 电子邮件

亚马逊[简单电子邮件服务(SES)](http://aws.amazon.com/ses/) 是亚马逊为 AWS 提供的仅发送电子邮件服务。您可以使用它从您的应用程序或命令行脚本发送电子邮件。它包括一个 AWS 特定的编程 API 和一个标准的 STMP 接口。两者价格相同(*按使用付费*)，但出于可移植性的考虑，我推荐使用 SMTP 接口。这可以让你以后更换你的电子邮件提供商。

如果你只是发送少量的邮件，那么 SES 可以免费使用。从 EC2 服务器发送的前 2000 封电子邮件是免费的。对很多人来说，这已经足够了。在每天的第一个 2000 封邮件之后，每 1000 封邮件的费用为 0.10 美元，外加出站带宽费用。

### 确认

当你第一次设置它时，你需要验证你将要发送的电子邮件地址的所有权。例如，如果你想从**hello@example.com**发送电子邮件，那么你需要证明你实际控制着**example.com**。这可以通过验证您是否可以在该地址接收电子邮件来实现。您还可以通过设置 TXT 记录来验证域所有权，从而验证整个域。

在此验证完成之前，您不能发送电子邮件，它可能需要一段时间才能在系统中传播。此外，为了防止垃圾邮件发送者出于恶意目的使用 ses，Amazon 限制您最初使用 SES。您的发送限额逐渐增加。如果你打算从你的应用程序发送电子邮件，你应该立即设置 SES，以便在你需要的时候可以使用。

### DKIM 和 SPF

为了确保你的电子邮件确实被你的收件人收到，而不是被他们的垃圾邮件过滤器拒绝，你应该为你的域名设置 [DKIM](https://en.wikipedia.org/wiki/Dkim) 和 [SPF](https://en.wikipedia.org/wiki/Sender_Policy_Framework) 。每一种都是收件人验证 Amazon SES 是您的域名的合法发件人的一种方式。

你可以在这里阅读更多关于在 SES [上设置 SPF 的信息。](http://docs.aws.amazon.com/ses/latest/DeveloperGuide/spf.html)

你可以点击阅读更多关于在 SES [上设置 DKIM 的信息。](http://docs.aws.amazon.com/ses/latest/DeveloperGuide/easy-dkim.html)

此外，如果你还没有，你应该为你的域的电子邮件服务器设置 DKIM 和 SPF。如果你正在使用谷歌应用程序管理电子邮件，更多详情请点击[这里](https://support.google.com/a/answer/174124?hl=en)。

### 通过端口 25 进行测试

一旦你设置好了，测试 DKIM 和 SPF 的一个简单方法就是使用由[端口 25](http://www.port25.com/support/authentication-center/email-verification/) 提供的电子邮件验证服务。只需给他们发一封电子邮件，过一会儿他们就会回复一份报告，说明 SPF 和 DKIM 是否配置正确。他们还会指出他们的垃圾邮件过滤器是否会将您的邮件标记为垃圾邮件。

请注意，您也可以使用端口 25 来验证您的个人电子邮件地址，而不仅仅是 Amazon SES。只需手动发送一封电子邮件到端口 25，等待响应。

## EC2(价格便宜)

Amazon EC2 允许你按需启动服务器，你只需按使用量付费，按小时计费。这意味着它特别适合于在短时间内扩展到大量服务器的使用模式。

EC2 的细粒度计费的另一面是，服务器的按需价格比其他云提供商更贵。这里有一些降低成本的建议。

### 保留实例

如果您正在运行一个总是在线的服务器，您应该查看保留的实例。在预约的情况下，你需要预付一笔费用，以换取大大降低的时薪。亚马逊提供三种级别的预订实例，**轻型** ( *最便宜的*)、**中型**和**重型** ( *最贵的*)，每种都提供 1 年期(*较便宜的*)或 3 年期(*较贵的*)。

每台服务器的成本越来越高，但运行服务器的每小时成本也越来越低。例如，一个标准的 m1.small 实例按需每小时花费 0.06 美元。如果您以 96 美元的价格购买了 3 年的轻量级保留实例，每小时的价格将降至 0.027 美元/小时。将前期成本考虑在内，并假设服务器一天 24 小时运行，与按需付费相比，保留实例大约需要 4 个月才能实现收支平衡。

对**重型**实例的计费与**轻型**或**中型**实例略有不同，因为您将为底层实例**计费，而不管它是否实际运行。这意味着，如果您购买了一个为期 3 年的重度保留实例，您就同意在接下来的 3 年内 24 小时运行该实例。**

与按需定价相比，保留实例可以节省 25%到 65%的成本。盈亏平衡点在 3 个月到一年之间。一旦您的 AWS 使用稳定下来，就值得花时间调查购买保留实例的成本节约。

如果您不确定一两年后是否会运行实例类型，我建议您坚持使用轻型或中型实例。储蓄差额只有 10-15%,但他们允许你更便宜地改变你的基础设施。

### 保留的实例市场

还有一个保留实例市场，你可以从第三方那里购买保留实例，或者出售那些你不再需要的实例。由于保留的实例只影响计费，所以通过第三方市场购买它们在功能上没有区别。事实上，它们都是管理控制台中同一个 UI 的一部分。

第三方保留实例的唯一真正区别是保留的持续时间可以是任意的。如果您预计使用期限除了 1 年或 3 年之外，这可能非常有用。只要确保检查实际价格，因为通常有几个列出的价格比亚马逊提供的价格高得多。

### 定点实例

Spot 实例允许您对多余的 EC2 容量进行投标。只要您的出价高于当前的现货价格，您的实例将继续运行，您将支付两者中较低的每小时费用。如果现货价格超过你的出价，你的实例可能会被终止。这种终止随时可能发生。

由于它们可以在任何时候被终止，当应用程序状态和结果存储在实例本身之外时，spot 实例工作得最好。幂等运算和可再现或可并行化的工作通常是 spot 实例的绝佳选择。it 最流行的一个用例是运行持续集成(CI)服务器。如果 CI 服务器崩溃并在一小时后重新启动，也没什么大不了的。我们真正关心的唯一结果是最终的应用程序构建/测试是否成功。

使用聚光灯实例也可以进行更复杂的设置。如果你完全自动化他们的供应。自动化安全组、用户数据、启动脚本，您甚至可以让它们通过 Route53 DNS 自动注册自己，然后加入现有的负载平衡器。在后面的一篇文章中，我将介绍如何构建这样一个设置，通过一组 spot 实例廉价地扩展无状态 web 服务，同时对它们的随机终止具有容错能力。

## S3

S3 是亚马逊的对象商店。它允许你存储任意对象(*到 5TB 大小*)并通过 HTTP 或 HTTPS 访问它们。据说它被设计成提供 99.999999999%的耐用性和 99.99%的可用性。就它所提供的而言，S3 真的是便宜的 T2。亚马逊也定期降低它的价格。最近一次是在[一周前](http://aws.amazon.com/s3/pricing/effective-february-2014/)。

S3 API 允许您创建带签名的 URL，这些 URL 提供对具有自定义过期的 S3 资源的细粒度访问。例如，您可以将一个不公开可读的对象存储在 S3，以便通过签名的 URL 临时访问。这是让用户从 webapps 访问存储在私有 S3 存储桶中的对象的好方法。

### 每加仑格令数(Grains Per Gallon)

如果你使用 S3 存储敏感数据(*例如:数据库备份*)，那么你应该在将数据上传到 S3 之前对数据**进行加密。这样，亚马逊的服务器上只存储加密数据。**

最简单的方法是使用 [GPG](https://en.wikipedia.org/wiki/GNU_Privacy_Guard) 。在本地机器上为您的备份服务器生成一个 GPG 密钥对，并将密钥对中的**公钥**添加到服务器中。然后，在上传到 S3 之前，使用公共密钥加密任何数据。

```
# Set the bucket/path on S3 where we will put the backup:
$ S3_PATH="s3://my-s3-bucket/path/to/backup/backup-$(date +%Y%M%d)"

# Temp file for encryption:
$ GPG_TEMP_FILE=$(mktemp)

# Encrypt it with GPG:
$ gpg --recipient aws.backup@example.com --output "$GPG_TEMP_FILE" --encrypt mydata.foo

# Upload it via s3cmd:
$ s3cmd put "$GPG_TEMP_FILE" "$S3_PATH"

# Clean up temp file:
$ rm "$GPG_TEMP_FILE"

```

在 S3 上存储之前对数据进行加密的唯一缺点是，你需要解密才能读取它。你不能向其他人提供 S3 网址来下载数据(*例如:直接链接到你代表他们存储的用户内容*)，因为他们将无法解密。对于备份来说，这是正确的方法，因为只有**您** ( *或您的公司、您的团队，...*)应该可以读取你的数据。

S3 CLI 工具 [s3cmd](http://s3tools.org/s3cmd) 包括一个指定 GPG 密钥的选项。如果设置了，那么它会自动加密你放到 S3 的对象。这是一个方便的选项，因为你只需要在一个地方设置它(*s3cmd 配置文件*)。不过，我更喜欢明确地将 GPG 步骤添加到我的备份脚本中。

### 静态加密

S3 还支持被称为 [**的服务器端加密**](http://aws.typepad.com/aws/2011/10/new-amazon-s3-server-side-encryption.html) 。启用此选项后，Amazon 会在将数据保存到磁盘之前对其进行加密，并在将数据返回给有效的 S3 请求之前对其进行透明解密。它的文档描述了它们如何将解密密钥与 S3 API 服务器分开，并在需要时请求它们。

由于亚马逊仍然可以读取你的数据，我不认为这是一个有用的功能。如果你想确保没有人能读取你的数据，那么你需要加密。如果您信任第三方来做这件事，那么根据定义，该第三方能够读取您的未加密数据。

尽管如此，启用它也没有坏处。显然，[启用它](http://aws.typepad.com/aws/2011/10/new-amazon-s3-server-side-encryption.html#comment-6a00d8341c534853ef014e8c19308e970d)并没有真正的性能损失。

### 对象过期

一旦您开始使用 S3 进行备份，您会发现您的 S3 账单将呈线性增长(*或更快！*)。默认情况下，S3 永久保存对象，所以你需要采取一些额外的步骤来清理。

显而易见的解决方案是在对象变旧时将其删除。如果您使用 S3 进行自动备份，那么您可以让备份脚本删除较旧的条目。通过额外的逻辑，您可以让您的备份脚本保留不同时间的备份(*例如:一年中的每月、一个月中的每周、一周中的每天*)。

一种更简单但更粗糙的方法是使用 S3 对象过期。它允许您定义 S3 对象的最大年龄。一旦达到该期限，对象将自动删除，无需用户干预。您可以在 S3 备份存储桶上设置 6 个月的过期时间，它会自动删除比这更早的条目。

***警告:*** *如果您使用 S3 对象过期，请确保您的备份实际工作。它将删除您的旧对象，而不管您的最新备份实际上是否有效。确保定期测试您的备份！*

对象到期也是删除 S3 存储桶中所有对象的简单方法。从 AWS S3 控制台，只需将整个时段的到期时间设置为 1 天。这些对象将在一天后自动删除。S3 过期是异步的，所以在 24 小时后的一小段时间内，你仍然可以在 S3 看到这些物品，但你不会为此付费。

### 冰川

[Glacier](http://aws.amazon.com/glacier/) 是亚马逊的长期持久存储服务。它比 S3 便宜一个数量级，但是访问时间要慢得多(*大约几个小时*)。

您可以将 S3 配置为自动终止旧的 S3 对象，而不是将其删除到 Glacier。存储成本将减少约 10 倍，如果你真的需要数据(*例如:你不小心销毁了你所有的 S3 备份*)，你可以慢慢地从 Glacier 恢复它们。

## 最后的想法

这篇文章比最初计划的要长，但是它仍然是一个非常不完整的列表。AWS 还有很多其他的技巧、诀窍和技术可以使用，这只是一个(*希望有帮助*)的开始。

你有什么要添加到这个列表中的吗，有没有解决这些问题的更好的方法，或者只是想在我有新帖子时得到通知？[让我知道](mailto:sehrope@jackdb.com)！*